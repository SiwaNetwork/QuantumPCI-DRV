# Добавление новых устройств

Руководство для разработчиков по добавлению поддержки новых устройств в драйвер `ptp_ocp.c`.

## Основные шаги

### 1. Добавление PCI ID

```c
#define PCI_VENDOR_ID_MYCOMPANY 0xXXXX
#define PCI_DEVICE_ID_MYCOMPANY_TIMECARD 0xYYYY
```

### 2. Создание таблицы ресурсов

```c
static struct ocp_resource ocp_mydevice_resource[] = {
    {
        OCP_MEM_RESOURCE(reg),
        .offset = 0x01000000, .size = 0x10000,
    },
    { }
};
```

### 3. Создание структуры драйвера

```c
static struct ocp_driver_data ocp_mydevice_driver_data[] = {
    {
        .ocp_resource_msi = (struct ocp_resource *) (&ocp_mydevice_resource),
        .ocp_resource_msix = (struct ocp_resource *) (&ocp_mydevice_resource),
    },
    { }
};
```

### 4. Добавление в таблицу PCI

```c
static const struct pci_device_id ptp_ocp_pcidev_id[] = {
    { PCI_DEVICE_DATA(QUANTUM_PCI, TIMECARD, &ocp_quantum_pci_driver_data) },
    { PCI_DEVICE_DATA(OROLIA, ARTCARD, &ocp_art_driver_data) },
    { PCI_DEVICE_DATA(ADVA, TIMECARD, &ocp_adva_driver_data) },
    { PCI_DEVICE_DATA(MYCOMPANY, TIMECARD, &ocp_mydevice_driver_data) },
    { }
};
```

## Типы ресурсов

- `OCP_MEM_RESOURCE(name)` — регистры памяти
- `OCP_SERIAL_RESOURCE(name)` — последовательные порты (UART)
- `OCP_I2C_RESOURCE(name)` — шины I2C
- `OCP_SPI_RESOURCE(name)` — шины SPI
- `OCP_EXT_RESOURCE(name)` — внешние временные метки

## Проверка и отладка

После добавления нового устройства:

1. Скомпилируйте драйвер: `make`
2. Загрузите модуль: `sudo insmod ptp_ocp.ko`
3. Проверьте dmesg на наличие ошибок
4. Используйте `lspci -vvv` для проверки обнаружения устройства
5. Проверьте создание устройства в `/dev/ptp*`

## Важные замечания

- Убедитесь, что смещения (offset) и размеры (size) соответствуют вашему устройству
- Векторы прерываний (irq_vec) должны быть уникальными для каждого ресурса
- Для устройств с MSI-X может потребоваться отдельная таблица ресурсов