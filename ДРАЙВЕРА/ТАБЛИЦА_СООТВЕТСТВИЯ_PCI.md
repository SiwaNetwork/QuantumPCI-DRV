# Таблица соответствия функций драйвера ptp_ocp требованиям PCI

## 1. Соответствие PCI функций

| PCI Функция | Требование спецификации | Реализация в драйвере | Статус |
|-------------|------------------------|---------------------|---------|
| **Идентификация устройства** | | | |
| Vendor ID | Уникальный ID производителя | 0x1d9b (Quantum-PCI), 0x0b0b (ADVA), 0x1ad7 (Orolia) | ✅ |
| Device ID | Уникальный ID устройства | 0x0400 (TimeCard), 0x0410 (ADVA Timecard), 0xa000 (ART Card) | ✅ |
| PCI Class | Класс устройства | Сетевое устройство | ✅ |
| **Инициализация** | | | |
| pci_enable_device() | Включение PCI устройства | Строка 5619 | ✅ |
| pci_request_regions() | Резервирование регионов памяти | Внутри ptp_ocp_device_init() | ✅ |
| pci_set_master() | Включение bus mastering | Строка 5644 | ✅ |
| pci_alloc_irq_vectors() | Выделение прерываний | Строка 5635 | ✅ |
| **Управление памятью** | | | |
| BAR0 | Основные регистры | Mapped via pci_iomap() | ✅ |
| BAR1-5 | Дополнительные регионы | По необходимости | ✅ |
| DMA | Прямой доступ к памяти | Через pci_set_master() | ✅ |
| **Прерывания** | | | |
| Legacy IRQ | Традиционные прерывания | Не используется | ➖ |
| MSI | Message Signaled Interrupts | Поддерживается | ✅ |
| MSI-X | Extended MSI | Поддерживается (до 64 векторов) | ✅ |
| **Управление питанием** | | | |
| D0 | Полностью активное состояние | Поддерживается | ✅ |
| D3hot | Состояние сна | Не реализовано | ❌ |
| Wake-up | Пробуждение устройства | Поддерживается | ✅ |

## 2. Соответствие регистров устройства

| Регистр | Адрес/Смещение | Назначение | Функции драйвера |
|---------|---------------|------------|------------------|
| **Основные регистры времени** | | | |
| ocp_reg | BAR0 + 0x0000 | Управление часами | ptp_ocp_gettime(), ptp_ocp_settime() |
| tod_reg | BAR0 + 0x0100 | Time of Day | Чтение/запись времени суток |
| ts_reg | BAR0 + 0x0200 | Временные метки | Обработка временных меток |
| pps_reg | BAR0 + 0x0300 | PPS контроль | Управление PPS сигналами |
| signal_reg | BAR0 + 0x0400 | Генератор сигналов | Генерация временных сигналов |
| **Интерфейсные регистры** | | | |
| uart_gnss | BAR0 + 0x1000 | GNSS UART | Последовательный порт GPS |
| uart_mac | BAR0 + 0x1100 | MAC UART | Порт атомных часов |
| uart_nmea | BAR0 + 0x1200 | NMEA UART | NMEA выход |
| i2c_ctrl | BAR0 + 0x2000 | I2C контроллер | Управление I2C шиной |
| spi_ctrl | BAR0 + 0x3000 | SPI контроллер | Доступ к flash памяти |
| gpio_ctrl | BAR0 + 0x4000 | GPIO контроллер | Управление GPIO |

## 3. Соответствие функциональных возможностей

| Функция | Требование OCP | Реализация драйвера | Проверка |
|---------|---------------|-------------------|----------|
| **PTP функции** | | | |
| gettime | IEEE 1588 | ptp_ocp_gettime() | ✅ |
| settime | IEEE 1588 | ptp_ocp_settime() | ✅ |
| adjtime | IEEE 1588 | ptp_ocp_adjtime() | ✅ |
| adjfreq | IEEE 1588 | ptp_ocp_adjfine() | ✅ |
| **Источники времени** | | | |
| GNSS | GPS/GLONASS/Galileo | Полная поддержка | ✅ |
| MAC | Атомные часы | Поддерживается | ✅ |
| IRIG-B | Временной код | Декодер реализован | ✅ |
| DCF77 | Радиосигнал | Декодер реализован | ✅ |
| External | Внешний источник | Через SMA входы | ✅ |
| **Выходные сигналы** | | | |
| PPS | 1 импульс/сек | 4 выхода SMA | ✅ |
| 10MHz | Опорная частота | Генератор | ✅ |
| Programmable | Программируемые | signal_reg | ✅ |
| **Интерфейсы** | | | |
| UART | 3+ порта | GNSS, MAC, NMEA | ✅ |
| I2C | Множественные | До 10 шин | ✅ |
| SPI | Flash доступ | Для прошивки | ✅ |
| GPIO | Универсальные | 26+ линий | ✅ |

## 4. Соответствие sysfs атрибутов

| Атрибут sysfs | Функция | PCI/HW связь | Статус |
|---------------|---------|--------------|---------|
| /sys/class/timecard/ocpN/ | | | |
| ├── device | Ссылка на PCI устройство | /sys/devices/pci*/XXXX:XX:XX.X | ✅ |
| ├── clock_source | Источник времени | Регистр выбора источника | ✅ |
| ├── gnss_sync | Статус GNSS | UART GNSS статус | ✅ |
| ├── ts_window_adjust         | коррекция окна (PCIe оценка) | регистры времени | ✅ |
| ├── sma1 | SMA1 конфигурация | GPIO регистры | ✅ |
| ├── sma2 | SMA2 конфигурация | GPIO регистры | ✅ |
| ├── sma3 | SMA3 конфигурация | GPIO регистры | ✅ |
| ├── sma4 | SMA4 конфигурация | GPIO регистры | ✅ |
| └── serialnum | Серийный номер | EEPROM/Flash | ✅ |

## 5. Проверочный список соответствия

| Категория | Требование | Реализовано | Примечание |
|-----------|------------|-------------|------------|
| **PCI совместимость** | | | |
| PCI 2.3 | Базовая совместимость | ✅ | Полная поддержка |
| PCIe 1.1+ | PCIe поддержка | ✅ | Включая PTM |
| Hot-plug | Горячее подключение | ❌ | Не требуется |
| **Прерывания** | | | |
| INTx | Legacy прерывания | ➖ | Не используется |
| MSI | Поддержка MSI | ✅ | Основной режим |
| MSI-X | Поддержка MSI-X | ✅ | До 64 векторов |
| **Управление питанием** | | | |
| ACPI | ACPI состояния | ⚠️ | Только D0; D3hot не реализован |
| Wake-on-LAN | Пробуждение по сети | ➖ | Не применимо |
| PCI PM | PCI Power Management | ✅ | Стандартная |
| **Производительность** | | | |
| DMA | Direct Memory Access | ✅ | Bus mastering |
| Burst | Пакетные передачи | ✅ | Оптимизировано |
| Prefetch | Предварительная выборка | ✅ | Для регистров |

## Легенда:
- ✅ - Полностью реализовано и соответствует спецификации
- ➖ - Не применимо или не требуется
- ❌ - Не реализовано
- ⚠️ - Частичная реализация или требует доработки