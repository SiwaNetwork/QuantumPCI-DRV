# Инструкция по работе с прошивками Quantum Platforms и Meta Platforms

## Обзор

Данная инструкция описывает работу с двумя типами прошивок для устройства ptp_ocp:
- **Quantum Platforms** — магический заголовок "SHIW"
- **Meta Platforms (OCP)** — магический заголовок "OCPC"

## Принцип работы

Вместо изменения базы данных PCI ID (`/usr/share/misc/pci.ids`) используются разные магические заголовки в прошивке для идентификации типа устройства. Это позволяет:

1. **Сохранить совместимость** с существующими Meta Platforms картами
2. **Добавить поддержку** Quantum Platforms карт
3. **Избежать изменений** в системных файлах
4. **Обеспечить уникальность** названий в терминале

## Инструменты

- `simple_modify_firmware.sh`: создание прошивок Quantum/Meta и прошивка устройства
- `check_firmware_type.sh`: определение текущего типа прошивки на устройстве
- `switch_firmware_type.sh`: переключение типа прошивки и вывод статуса
- `modify_firmware.sh`: извлечение исходной прошивки (опционально)

## Пошаговая инструкция

### Шаг 1 (опционально): извлечение исходной прошивки

```bash
sudo ./modify_firmware.sh extract firmware_original.bin
```

### Шаг 2: создание прошивок с разными заголовками

```bash
# Создать прошивку Quantum Platforms
sudo ./simple_modify_firmware.sh quantum firmware_original.bin firmware_quantum.bin

# Создать прошивку Meta Platforms
sudo ./simple_modify_firmware.sh meta firmware_original.bin firmware_meta.bin
```

### Шаг 3: прошивка устройства

```bash
# Прошить Quantum Platforms прошивкой
sudo ./simple_modify_firmware.sh flash firmware_quantum.bin "Quantum Platforms"

# Прошить Meta Platforms прошивкой
sudo ./simple_modify_firmware.sh flash firmware_meta.bin "Meta Platforms"
```

## Проверка результата

### 1. Скрипт проверки типа прошивки

```bash
sudo ./check_firmware_type.sh
```

### 2. Проверка через sysfs (если доступно)

```bash
cat /sys/devices/pci0000:00/0000:00:01.0/0000:01:00.0/timecard/ocp0/firmware_type
# Ожидаемый результат: Quantum Platforms или Meta Platforms (OCP)
```

### 3. Проверка через lspci (необязательно)

```bash
lspci | grep -i 'meta\|quantum\|ocp'
# Название в lspci может оставаться Meta Platforms, если не менять базу PCI ID
```

## Преимущества данного подхода

1. **Совместимость**: работает с существующими Meta Platforms картами
2. **Гибкость**: позволяет переключаться между типами прошивок
3. **Безопасность**: не изменяет системные файлы
4. **Уникальность**: обеспечивает разные названия для разных типов
5. **Простота**: управление через простые скрипты

## Ограничения

1. **Зависимость от драйвера**: для отображения типа в sysfs требуется поддержка в драйвере
2. **Название в lspci**: по умолчанию остаётся Meta Platforms (меняется через базу PCI ID)
3. **Перезагрузка драйвера**: может потребоваться при смене типа прошивки

## Рекомендации

1. **Тестируйте прошивки** на тестовом оборудовании перед продакшеном
2. **Делайте резервные копии** исходных прошивок
3. **Фиксируйте изменения** и используйте версионирование
4. **Проверяйте совместимость** с версиями драйвера

## Устранение неполадок

### Ошибка "No firmware header found"
- Проверьте правильность магического заголовка
- Убедитесь, что драйвер поддерживает оба типа заголовков

### Ошибка "Firmware image compatibility check failed"
- Проверьте Vendor ID и Device ID в заголовке
- Убедитесь, что размер образа указан правильно

### Ошибка при прошивке
- Проверьте права доступа к MTD-устройству
- Убедитесь, что устройство не занято другими процессами
