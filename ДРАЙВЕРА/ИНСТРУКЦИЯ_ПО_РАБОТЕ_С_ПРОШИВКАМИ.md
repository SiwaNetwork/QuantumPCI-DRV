# Инструкция по работе с прошивками Quantum Platforms и Meta Platforms

## Обзор

Данная инструкция описывает, как работать с двумя типами прошивок для устройства ptp_ocp:
- **Quantum Platforms** - с магическим заголовком "SHIW"
- **Meta Platforms (OCP)** - с магическим заголовком "OCPC"

## Принцип работы

Вместо изменения базы данных PCI ID (`/usr/share/misc/pci.ids`), мы используем разные магические заголовки в прошивке для идентификации типа устройства. Это позволяет:

1. **Сохранить совместимость** с существующими Meta Platforms картами
2. **Добавить поддержку** Quantum Platforms карт
3. **Избежать изменений** в системных файлах
4. **Обеспечить уникальность** названий в терминале

## Структура заголовка прошивки

```
struct ptp_ocp_firmware_header {
    char magic[4];           // "SHIW" или "OCPC"
    __be16 pci_vendor_id;    // 0x1d9b (little-endian)
    __be16 pci_device_id;    // 0x0400 (little-endian)
    __be32 image_size;       // Размер данных прошивки
    __be16 hw_revision;      // Ревизия оборудования
    __be16 crc;              // CRC16 данных прошивки
};
```

## Инструменты

### 1. Скрипт для модификации прошивок

**Файл:** `simple_modify_firmware.sh`

**Использование:**
```bash
# Создать прошивку Quantum Platforms
sudo ./simple_modify_firmware.sh quantum firmware_original.bin firmware_quantum.bin

# Создать прошивку Meta Platforms
sudo ./simple_modify_firmware.sh meta firmware_original.bin firmware_meta.bin

# Прошить устройство
sudo ./simple_modify_firmware.sh flash firmware_quantum.bin "Quantum Platforms"
```

### 2. Скрипт для проверки типа прошивки

**Файл:** `check_firmware_type.sh`

**Использование:**
```bash
sudo ./check_firmware_type.sh
```

### 3. Скрипт для переключения типов

**Файл:** `switch_firmware_type.sh`

**Использование:**
```bash
sudo ./switch_firmware_type.sh quantum  # Переключиться на Quantum Platforms
sudo ./switch_firmware_type.sh meta     # Переключиться на Meta Platforms
sudo ./switch_firmware_type.sh status   # Показать статус
```

## Пошаговая инструкция

### Шаг 1: Извлечение исходной прошивки

```bash
# Извлечь прошивку с устройства
sudo ./modify_firmware.sh extract firmware_original.bin
```

### Шаг 2: Создание прошивок с разными заголовками

```bash
# Создать прошивку Quantum Platforms
sudo ./simple_modify_firmware.sh quantum firmware_original.bin firmware_quantum.bin

# Создать прошивку Meta Platforms
sudo ./simple_modify_firmware.sh meta firmware_original.bin firmware_meta.bin
```

### Шаг 3: Проверка заголовков

```bash
# Проверить заголовок Quantum Platforms
dd if=firmware_quantum.bin bs=1 count=16 | hexdump -C
# Ожидаемый результат: 53 48 49 57 (SHIW)

# Проверить заголовок Meta Platforms
dd if=firmware_meta.bin bs=1 count=16 | hexdump -C
# Ожидаемый результат: 4f 43 50 43 (OCPC)
```

### Шаг 4: Прошивка устройства

```bash
# Прошить Quantum Platforms прошивкой
sudo ./simple_modify_firmware.sh flash firmware_quantum.bin "Quantum Platforms"

# Прошить Meta Platforms прошивкой
sudo ./simple_modify_firmware.sh flash firmware_meta.bin "Meta Platforms"
```

## Проверка результата

### 1. Проверка через lspci

```bash
lspci | grep "01:00.0"
# Результат: 01:00.0 Memory controller: Meta Platforms, Inc. Device 0400
# (Название остается Meta Platforms, так как мы не изменяем базу данных PCI ID)
```

### 2. Проверка через sysfs (если доступно)

```bash
cat /sys/devices/pci0000:00/0000:00:01.0/0000:01:00.0/timecard/ocp0/firmware_type
# Ожидаемый результат: Quantum Platforms или Meta Platforms (OCP)
```

### 3. Проверка заголовка прошивки на устройстве

```bash
sudo dd if=/dev/mtd0 bs=1 count=4 | hexdump -C
# Ожидаемый результат: 53 48 49 57 (SHIW) или 4f 43 50 43 (OCPC)
```

## Модификация драйвера

Для полной поддержки двух типов прошивок необходимо модифицировать драйвер:

### 1. Добавить поддержку магического заголовка "SHIW"

В файле `ptp_ocp.c`:

```c
#define OCP_FIRMWARE_MAGIC_HEADER "OCPC"
#define QUANTUM_FIRMWARE_MAGIC_HEADER "SHIW"
```

### 2. Изменить функцию проверки заголовка

```c
if (memcmp(hdr->magic, OCP_FIRMWARE_MAGIC_HEADER, 4) && 
    memcmp(hdr->magic, QUANTUM_FIRMWARE_MAGIC_HEADER, 4)) {
    // Ошибка: заголовок не найден
}
```

### 3. Добавить sysfs атрибут

```c
static ssize_t firmware_type_show(struct device *dev, struct device_attribute *attr, char *buf)
{
    struct ptp_ocp *bp = dev_get_drvdata(dev);
    
    if (bp->is_quantum_firmware) {
        return sprintf(buf, "Quantum Platforms\n");
    } else {
        return sprintf(buf, "Meta Platforms (OCP)\n");
    }
}
static DEVICE_ATTR_RO(firmware_type);
```

## Преимущества данного подхода

1. **Совместимость**: Работает с существующими Meta Platforms картами
2. **Гибкость**: Позволяет переключаться между типами прошивок
3. **Безопасность**: Не изменяет системные файлы
4. **Уникальность**: Обеспечивает уникальные названия для разных типов
5. **Простота**: Простые скрипты для управления

## Ограничения

1. **Требует модификации драйвера** для полной поддержки
2. **Название в lspci остается Meta Platforms** (можно изменить через базу данных PCI ID)
3. **Необходимость перезагрузки драйвера** при смене типа прошивки

## Рекомендации

1. **Тестируйте прошивки** на тестовом оборудовании перед использованием в продакшене
2. **Сохраняйте резервные копии** исходных прошивок
3. **Документируйте изменения** в прошивках
4. **Используйте версионирование** для прошивок
5. **Проверяйте совместимость** с различными версиями драйвера

## Устранение неполадок

### Ошибка "No firmware header found"
- Проверьте правильность магического заголовка
- Убедитесь, что драйвер поддерживает оба типа заголовков

### Ошибка "Firmware image compatibility check failed"
- Проверьте Vendor ID и Device ID в заголовке
- Убедитесь, что размер образа указан правильно

### Ошибка при прошивке
- Проверьте права доступа к MTD устройству
- Убедитесь, что устройство не используется другими процессами
