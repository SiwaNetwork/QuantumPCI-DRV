# Р”СЂР°Р№РІРµСЂ PTP OCP

Р”СЂР°Р№РІРµСЂ СЏРґСЂР° Linux РґР»СЏ PTP OCP СѓСЃС‚СЂРѕР№СЃС‚РІ.

## РџРѕРґРґРµСЂР¶РёРІР°РµРјС‹Рµ СѓСЃС‚СЂРѕР№СЃС‚РІР°

- Quantum-PCI TimeCard (PCI ID: 0x1d9b:0x0400)
- Orolia ART Card (PCI ID: 0x1ad7:0xa000)
- ADVA Timecard (PCI ID: 0x0b0b:0x0410)

Р”Р»СЏ РґРѕР±Р°РІР»РµРЅРёСЏ РїРѕРґРґРµСЂР¶РєРё РЅРѕРІС‹С… СѓСЃС‚СЂРѕР№СЃС‚РІ СЃРј. [Р”РћР‘РђР’Р›Р•РќРР•_РќРћР’Р«РҐ_РЈРЎРўР РћР™РЎРўР’.md](Р”РћР‘РђР’Р›Р•РќРР•_РќРћР’Р«РҐ_РЈРЎРўР РћР™РЎРўР’.md)

## Р”РѕРєСѓРјРµРЅС‚Р°С†РёСЏ

### РђРЅР°Р»РёР· Рё СЃС‚СЂСѓРєС‚СѓСЂР° РґСЂР°Р№РІРµСЂР°
- [РђРќРђР›РР—_Р”Р РђР™Р’Р•Р Рђ.md](РђРќРђР›РР—_Р”Р РђР™Р’Р•Р Рђ.md) - РѕР±С‰РёР№ Р°РЅР°Р»РёР· С„СѓРЅРєС†РёРѕРЅР°Р»СЊРЅРѕСЃС‚Рё РґСЂР°Р№РІРµСЂР°
- [РЎРўР РЈРљРўРЈР Рђ_Р”Р РђР™Р’Р•Р Рђ.md](РЎРўР РЈРљРўРЈР Рђ_Р”Р РђР™Р’Р•Р Рђ.md) - Р°СЂС…РёС‚РµРєС‚СѓСЂР° Рё РєРѕРјРїРѕРЅРµРЅС‚С‹ РґСЂР°Р№РІРµСЂР°

### РЎРѕРѕС‚РІРµС‚СЃС‚РІРёРµ PCI СЃРїРµС†РёС„РёРєР°С†РёРё
- [РЎРћРџРћРЎРўРђР’Р›Р•РќРР•_PCI_Р”Р РђР™Р’Р•Р Рђ.md](РЎРћРџРћРЎРўРђР’Р›Р•РќРР•_PCI_Р”Р РђР™Р’Р•Р Рђ.md) - РґРµС‚Р°Р»СЊРЅРѕРµ СЃРѕРїРѕСЃС‚Р°РІР»РµРЅРёРµ С„СѓРЅРєС†РёРѕРЅР°Р»СЊРЅРѕСЃС‚Рё РґСЂР°Р№РІРµСЂР° СЃ С‚СЂРµР±РѕРІР°РЅРёСЏРјРё PCI СѓСЃС‚СЂРѕР№СЃС‚РІ
- [РўРђР‘Р›РР¦Рђ_РЎРћРћРўР’Р•РўРЎРўР’РРЇ_PCI.md](РўРђР‘Р›РР¦Рђ_РЎРћРћРўР’Р•РўРЎРўР’РРЇ_PCI.md) - С‚Р°Р±Р»РёС†С‹ СЃРѕРѕС‚РІРµС‚СЃС‚РІРёСЏ С„СѓРЅРєС†РёР№, СЂРµРіРёСЃС‚СЂРѕРІ Рё С‚СЂРµР±РѕРІР°РЅРёР№ PCI

### РРЅС‚РµСЂС„РµР№СЃС‹ Рё РёСЃРїРѕР»СЊР·РѕРІР°РЅРёРµ
- [SYSFS_РРќРўР•Р Р¤Р•Р™РЎ.md](SYSFS_РРќРўР•Р Р¤Р•Р™РЎ.md) - РїРѕРґСЂРѕР±РЅРѕРµ РѕРїРёСЃР°РЅРёРµ РІСЃРµС… sysfs Р°С‚СЂРёР±СѓС‚РѕРІ Рё РїСЂРёРјРµСЂС‹ РёСЃРїРѕР»СЊР·РѕРІР°РЅРёСЏ

### Р РµРєРѕРјРµРЅРґР°С†РёРё Рё РїСЂРёРјРµСЂС‹
- [Р Р•РљРћРњР•РќР”РђР¦РР_РџРћ_РЈР›РЈР§РЁР•РќРР®.md](Р Р•РљРћРњР•РќР”РђР¦РР_РџРћ_РЈР›РЈР§РЁР•РќРР®.md) - РІРѕР·РјРѕР¶РЅС‹Рµ СѓР»СѓС‡С€РµРЅРёСЏ РґСЂР°Р№РІРµСЂР°
- [РџР РРњР•Р _Р”РћР‘РђР’Р›Р•РќРРЇ_РЈРЎРўР РћР™РЎРўР’Рђ.c](РџР РРњР•Р _Р”РћР‘РђР’Р›Р•РќРРЇ_РЈРЎРўР РћР™РЎРўР’Рђ.c) - РїСЂРёРјРµСЂ РєРѕРґР° РґР»СЏ РґРѕР±Р°РІР»РµРЅРёСЏ РЅРѕРІРѕРіРѕ СѓСЃС‚СЂРѕР№СЃС‚РІР°
- [РџР РРњР•Р _POWER_MANAGEMENT.c](РџР РРњР•Р _POWER_MANAGEMENT.c) - РїСЂРёРјРµСЂ СЂРµР°Р»РёР·Р°С†РёРё СѓРїСЂР°РІР»РµРЅРёСЏ РїРёС‚Р°РЅРёРµРј

## Р РµРєРѕРјРµРЅРґР°С†РёРё РїРѕ СѓР»СѓС‡С€РµРЅРёСЋ
Р”Р»СЏ РѕР·РЅР°РєРѕРјР»РµРЅРёСЏ СЃ РІРѕР·РјРѕР¶РЅС‹РјРё СѓР»СѓС‡С€РµРЅРёСЏРјРё РґСЂР°Р№РІРµСЂР° СЃРј. [Р Р•РљРћРњР•РќР”РђР¦РР_РџРћ_РЈР›РЈР§РЁР•РќРР®.md](Р Р•РљРћРњР•РќР”РђР¦РР_РџРћ_РЈР›РЈР§РЁР•РќРР®.md)

## Р”РѕРєСѓРјРµРЅС‚Р°С†РёСЏ РїРѕ sysfs РёРЅС‚РµСЂС„РµР№СЃСѓ
РџРѕРґСЂРѕР±РЅРѕРµ РѕРїРёСЃР°РЅРёРµ РІСЃРµС… Р°С‚СЂРёР±СѓС‚РѕРІ Рё РїСЂРёРјРµСЂС‹ РёСЃРїРѕР»СЊР·РѕРІР°РЅРёСЏ СЃРј. [SYSFS_РРќРўР•Р Р¤Р•Р™РЎ.md](SYSFS_РРќРўР•Р Р¤Р•Р™РЎ.md)

# РРЅСЃС‚СЂСѓРєС†РёСЏ
РЈР±РµРґРёС‚РµСЃСЊ, С‡С‚Рѕ РѕРїС†РёСЏ vt-d РІРєР»СЋС‡РµРЅР° РІ BIOS.
Р’С‹РїРѕР»РЅРёС‚Рµ РїРµСЂРµРєРѕРјРїРёР»СЏС†РёСЋ (remake), Р·Р°С‚РµРј РІС‹РїРѕР»РЅРёС‚Рµ modprobe ptp_ocp.

## Р РµР·СѓР»СЊС‚Р°С‚
```
$ ls -g /sys/class/timecard/ocp0/
total 0
-r--r--r--. 1 root 4096 Sep  8 18:20 available_clock_sources
-r--r--r--. 1 root 4096 Sep  8 18:20 available_sma_inputs
-r--r--r--. 1 root 4096 Sep  8 18:20 available_sma_outputs
-rw-r--r--. 1 root 4096 Sep  8 18:20 clock_source
lrwxrwxrwx. 1 root    0 Sep  8 18:20 device -> ../../../0000:02:00.0
-rw-r--r--. 1 root 4096 Sep  8 18:20 external_pps_cable_delay
-r--r--r--. 1 root 4096 Sep  8 18:20 gnss_sync
-rw-r--r--. 1 root 4096 Sep  8 18:20 internal_pps_cable_delay
-rw-r--r--. 1 root 4096 Sep  8 18:20 irig_b_mode
drwxr-xr-x. 2 root    0 Sep  8 18:20 power
lrwxrwxrwx. 1 root    0 Sep  8 18:20 ptp -> ../../ptp/ptp4
-r--r--r--. 1 root 4096 Sep  8 18:20 serialnum
-rw-r--r--. 1 root 4096 Sep  8 18:20 sma1
-rw-r--r--. 1 root 4096 Sep  8 18:20 sma2
-rw-r--r--. 1 root 4096 Sep  8 21:04 sma3
-rw-r--r--. 1 root 4096 Sep  8 21:04 sma4
lrwxrwxrwx. 1 root    0 Sep  8 18:20 subsystem -> ../../../../../../class/timecard
lrwxrwxrwx. 1 root    0 Sep  8 18:20 ttyGNSS -> ../../tty/ttyS5
lrwxrwxrwx. 1 root    0 Sep  8 18:20 ttyGNSS2 -> ../../tty/ttyS?
lrwxrwxrwx. 1 root    0 Sep  8 18:20 ttyMAC -> ../../tty/ttyS6
lrwxrwxrwx. 1 root    0 Sep  8 18:20 ttyNMEA -> ../../tty/ttyS7
-rw-r--r--. 1 root 4096 Sep  8 18:20 uevent
-rw-r--r--. 1 root 4096 Sep  8 18:20 utc_tai_offset
```

РћСЃРЅРѕРІРЅРѕР№ РєР°С‚Р°Р»РѕРі СЂРµСЃСѓСЂСЃРѕРІ РґРѕСЃС‚СѓРїРµРЅ РїРѕ Р°РґСЂРµСЃСѓ `/sys/class/timecard/ocpN/`, РіРґРµ N - РЅРѕРјРµСЂ СѓСЃС‚СЂРѕР№СЃС‚РІР° (РЅР°РїСЂРёРјРµСЂ, ocp0, ocp1), РїСЂРµРґРѕСЃС‚Р°РІР»СЏСЏ СЃСЃС‹Р»РєРё РЅР° СЂР°Р·Р»РёС‡РЅС‹Рµ СЂРµСЃСѓСЂСЃС‹ TimeCard. РЎСЃС‹Р»РєРё РЅР° СѓСЃС‚СЂРѕР№СЃС‚РІР° Р»РµРіРєРѕ РёСЃРїРѕР»СЊР·РѕРІР°С‚СЊ РІ СЃС†РµРЅР°СЂРёСЏС…:

```
  tty=$(basename $(readlink /sys/class/timecard/ocp0/ttyGNSS))
  ptp=$(basename $(readlink /sys/class/timecard/ocp0/ptp))

  echo "/dev/$tty"
  echo "/dev/$ptp"
```

РџРѕСЃР»Рµ СѓСЃРїРµС€РЅРѕР№ Р·Р°РіСЂСѓР·РєРё РґСЂР°Р№РІРµСЂР° РїРѕСЏРІСЏС‚СЃСЏ:
* PTP POSIX clock, СЃРІСЏР·Р°РЅРЅС‹Р№ СЃ С„РёР·РёС‡РµСЃРєРёРј Р°РїРїР°СЂР°С‚РЅС‹Рј С‡Р°СЃР°РјРё (PHC) РЅР° Qantum Card  (`/dev/ptp4`) 
* GNSS serial `/dev/ttyS5`
* GNSS2 serial `/dev/ttyS?` (РµСЃР»Рё РїРѕРґРґРµСЂР¶РёРІР°РµС‚СЃСЏ)
* Atomic clock serial `/dev/ttyS6`
* NMEA Master serial `/dev/ttyS7`
* i2c (`/dev/i2c-*`) device

РўРµРїРµСЂСЊ РјРѕР¶РЅРѕ РёСЃРїРѕР»СЊР·РѕРІР°С‚СЊ СЃС‚Р°РЅРґР°СЂС‚РЅС‹Рµ РёРЅСЃС‚СЂСѓРјРµРЅС‚С‹ linuxptp, С‚Р°РєРёРµ РєР°Рє phc2sys РёР»Рё ts2phc РґР»СЏ РєРѕРїРёСЂРѕРІР°РЅРёСЏ, СЃРёРЅС…СЂРѕРЅРёР·Р°С†РёРё, РЅР°СЃС‚СЂРѕР№РєРё Рё С‚.Рґ. 

## Р”СЂР°Р№РІРµСЂ РІРєР»СЋС‡РµРЅ РІ РѕСЃРЅРѕРІРЅРѕРµ СЏРґСЂРѕ Linux
* РџРµСЂРІРѕРЅР°С‡Р°Р»СЊРЅР°СЏ РїСЂРёРјРёС‚РёРІРЅР°СЏ РІРµСЂСЃРёСЏ ([5.2](https://git.kernel.org/pub/scm/linux/kernel/git/netdev/net-next.git/commit/?id=a7e1abad13f3f0366ee625831fecda2b603cdc17))
* Р’РµСЂСЃРёСЏ, СЂР°СЃРєСЂС‹РІР°СЋС‰Р°СЏ РІСЃРµ СѓСЃС‚СЂРѕР№СЃС‚РІР° ([5.15](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=773bda96492153e11d21eb63ac814669b51fc701)) 
