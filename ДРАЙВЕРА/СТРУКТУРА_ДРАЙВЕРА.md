# Структура драйвера PTP OCP

## Основные компоненты

### 1. PCI идентификация устройств

Драйвер использует стандартный механизм Linux для идентификации PCI устройств:

- **Vendor ID** - идентификатор производителя (например, 0x1d9b для Facebook)
- **Device ID** - идентификатор конкретного устройства (например, 0x0400 для TimeCard)

### 2. Архитектура ресурсов

Каждое устройство описывается через таблицу ресурсов (`struct ocp_resource`), которая содержит:

- **Регистры памяти** (OCP_MEM_RESOURCE) - основные регистры управления
- **Временные метки** (OCP_EXT_RESOURCE) - входы для внешних сигналов времени
- **Последовательные порты** (OCP_SERIAL_RESOURCE) - UART для GNSS, MAC, NMEA
- **I2C шины** (OCP_I2C_RESOURCE) - для подключения периферийных устройств
- **SPI шины** (OCP_SPI_RESOURCE) - обычно для flash памяти

### 3. Структура данных драйвера

```
ptp_ocp_pcidev_id[]
    ↓
ocp_driver_data
    ├── ocp_resource_msi[]   (ресурсы для MSI прерываний)
    └── ocp_resource_msix[]  (ресурсы для MSI-X прерываний)
```

### 4. Основные функции регистрации

- `ptp_ocp_register_mem()` - регистрация областей памяти
- `ptp_ocp_register_serial()` - создание последовательных портов
- `ptp_ocp_register_i2c()` - создание I2C шин
- `ptp_ocp_register_spi()` - создание SPI шин
- `ptp_ocp_register_ext()` - регистрация внешних временных меток

### 5. Прерывания

Каждый ресурс может иметь свой вектор прерывания (`irq_vec`). Драйвер поддерживает:
- MSI (Message Signaled Interrupts)
- MSI-X (Extended Message Signaled Interrupts)

### 6. Специфичные функции устройств

Некоторые устройства требуют специальной инициализации:
- `ptp_ocp_fb_board_init()` - для Quantum-PCI TimeCard
- `ptp_ocp_art_board_init()` - для Orolia ART Card

## Поток инициализации

1. **Обнаружение PCI устройства** - ядро находит устройство по Vendor/Device ID
2. **Выбор структуры драйвера** - выбирается соответствующая `ocp_driver_data`
3. **Выделение ресурсов** - выделяется память под структуру `ptp_ocp`
4. **Регистрация ресурсов** - проход по таблице ресурсов и вызов функций регистрации
5. **Инициализация платы** - вызов специфичной функции init если указана
6. **Создание sysfs интерфейса** - создание файлов в `/sys/class/timecard/`
7. **Регистрация PTP часов** - создание устройства `/dev/ptp*`

## Интерфейсы пользователя

### sysfs (/sys/class/timecard/ocpN/)

Драйвер создает класс устройства `timecard` в sysfs. Каждое обнаруженное устройство TimeCard получает уникальный номер N, начиная с 0. Полный путь к интерфейсу устройства: `/sys/class/timecard/ocpN/`

Основные атрибуты и функции:
- **Настройка источников синхронизации** - выбор и конфигурация источников времени
- **Управление SMA коннекторами** - настройка входов и выходов SMA1-SMA4
- **Чтение состояния устройства** - получение информации о синхронизации и ошибках
- **Настройка задержек кабелей** - компенсация задержек для точной синхронизации
- **Символические ссылки на связанные устройства** - быстрый доступ к tty, ptp, i2c устройствам

Примеры атрибутов:
- `clock_source` - текущий источник часов
- `available_clock_sources` - список доступных источников
- `sma[1-4]_in/out` - конфигурация SMA коннекторов
- `gnss_sync` - статус синхронизации GNSS
- `serialnum` - серийный номер устройства
- `ptp` -> `../../ptp/ptpX` - ссылка на PTP устройство
- `ttyGNSS` -> `../../tty/ttyX` - ссылка на GNSS порт

### Символьные устройства
- `/dev/ptp*` - PTP часы для синхронизации времени
- `/dev/ttyS*` - последовательные порты (GNSS, MAC, NMEA)
- `/dev/i2c-*` - I2C шины

## Особенности реализации

### SMA коннекторы
Устройства TimeCard обычно имеют 4 SMA коннектора, которые могут быть настроены как входы или выходы для различных сигналов времени.

### Временные метки
Драйвер поддерживает до 5 источников временных меток (ts0-ts4) плюс отдельный вход PPS.

### GNSS интеграция
Большинство устройств имеют встроенный GNSS приемник для синхронизации с GPS/GLONASS/Galileo.

## Отладка

Для отладки драйвера используйте:
- `dmesg` - сообщения ядра
- `/sys/kernel/debug/ptp_ocp/` - отладочная информация (если включен debugfs)
- `lspci -vvv` - информация о PCI устройстве
- Инструменты linuxptp (ptp4l, phc2sys, ts2phc)