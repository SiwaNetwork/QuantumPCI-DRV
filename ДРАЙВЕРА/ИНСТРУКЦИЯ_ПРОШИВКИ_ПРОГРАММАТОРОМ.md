# Прошивка программатором

## MTD устройства

```bash
/dev/mtd0      # BIOS
/dev/mtd1      # spi512.0 (основная прошивка)
```

## Варианты прошивки

### 1. Прямая прошивка (РЕКОМЕНДУЕТСЯ)

```bash
# Сырой файл
sudo dd if=./QuantumPCI-Firmware-Tool/Factory_TimeCard.bin of=/dev/mtd1 bs=1M status=progress
```

**Преимущества:**
- Простота — никаких модификаций не нужно
- Совместимость — это "родная" прошивка FPGA
- Надежность — проверенный формат

### 2. Прошивка с заголовком

```bash
# Quantum Platforms
sudo dd if=Factory_TimeCard_quantum.bin of=/dev/mtd1 bs=1M status=progress

# Meta Platforms
sudo dd if=Factory_TimeCard_meta.bin of=/dev/mtd1 bs=1M status=progress
```

## Пошаговая инструкция

### 1. Резервное копирование

```bash
# Создать резервную копию
sudo dd if=/dev/mtd1 of=backup_firmware_$(date +%Y%m%d_%H%M%S).bin bs=1M
```

### 2. Прошивка

```bash
# Выбрать файл прошивки
FIRMWARE_FILE="./QuantumPCI-Firmware-Tool/Factory_TimeCard.bin"

# Прошить устройство
sudo dd if="$FIRMWARE_FILE" of=/dev/mtd1 bs=1M status=progress
sync
```

### 3. Проверка результата

```bash
# Перезагрузить драйвер
sudo modprobe -r ptp_ocp
sudo modprobe ptp_ocp

# Проверить состояние устройства
lspci | grep "01:00.0"
```

## Важные предупреждения

### Безопасность
- Всегда делайте резервную копию перед прошивкой
- Не прерывайте процесс прошивки
- Используйте ИБП для защиты от отключения питания

### Совместимость
- Сырая прошивка — самый безопасный вариант
- Размер прошивки должен соответствовать размеру MTD устройства

### Восстановление
```bash
# В случае проблем восстановить из резервной копии
sudo dd if=backup_firmware_YYYYMMDD_HHMMSS.bin of=/dev/mtd1 bs=1M
```

## Проверка MTD устройства

```bash
# Информация о MTD устройствах
cat /proc/mtd

# Размер MTD устройства
cat /sys/class/mtd/mtd1/size
```

## Устранение неполадок

### Ошибка "No space left on device"
```bash
# Проверить размер MTD устройства
cat /sys/class/mtd/mtd1/size

# Проверить размер файла прошивки
ls -la "$FIRMWARE_FILE"
```

### Устройство не загружается после прошивки
```bash
# Восстановить из резервной копии
sudo dd if="$BACKUP_FILE" of="$MTD_DEVICE" bs=1M
sudo reboot
```
