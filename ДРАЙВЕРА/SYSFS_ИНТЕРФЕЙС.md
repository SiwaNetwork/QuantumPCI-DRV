# Sysfs интерфейс PTP OCP драйвера

## Обзор

Драйвер PTP OCP создает класс устройств `/sys/class/timecard/ocpN/`, где N - порядковый номер обнаруженного устройства (начиная с 0). Этот интерфейс предоставляет полный доступ ко всем функциям TimeCard через файловую систему sysfs.

## Структура интерфейса

```
/sys/class/timecard/ocpN/
├── available_clock_sources          (RO) - доступные источники синхронизации
├── available_sma_inputs             (RO) - доступные входные сигналы SMA
├── available_sma_outputs            (RO) - доступные выходные сигналы SMA
├── available_tod_protocols          (RO) - доступные TOD протоколы
├── available_tod_baud_rates         (RO) - доступные скорости TOD UART
├── clock_source                     (RW) - текущий источник синхронизации
├── clock_status_drift               (RO) - статус дрейфа часов (ppb)
├── clock_status_offset              (RO) - статус смещения часов (нс)
├── config                          (RW) - бинарная конфигурация устройства
├── disciplining_config             (RW) - бинарная конфигурация дисциплинирования
├── external_pps_cable_delay        (RW) - задержка внешнего PPS кабеля (нс)
├── gnss_sync                        (RO) - статус синхронизации GNSS
├── holdover                         (RW) - режим holdover
├── internal_pps_cable_delay        (RW) - задержка внутреннего PPS кабеля (нс)
├── irig_b_mode                      (RW) - режим работы IRIG-B
├── mac_i2c                          (RW) - управление I2C для MAC
├── serialnum                        (RO) - серийный номер устройства
├── sma1                             (RW) - конфигурация SMA1
├── sma2                             (RW) - конфигурация SMA2
├── sma3                             (RW) - конфигурация SMA3
├── sma4                             (RW) - конфигурация SMA4
├── temperature_table               (RW) - температурная таблица
├── tod_baud_rate                    (RW) - скорость UART для TOD
├── tod_correction                   (RW) - коррекция TOD (нс)
├── tod_protocol                     (RW) - протокол TOD
├── ts_window_adjust                 (RW) - коррекция окна временных меток (нс)
├── uevent                          (RW) - события устройства
├── utc_tai_offset                   (RW) - смещение UTC относительно TAI
├── device -> ../../../XXXX:XX:XX.X   (L) - ссылка на PCI устройство
├── ptp -> ../../ptp/ptpX             (L) - ссылка на PTP устройство
├── ttyGNSS -> ../../tty/ttyX         (L) - ссылка на GNSS порт
├── ttyGNSS2 -> ../../tty/ttyX        (L) - ссылка на вторичный GNSS порт
├── ttyMAC -> ../../tty/ttyX          (L) - ссылка на MAC порт
├── ttyNMEA -> ../../tty/ttyX         (L) - ссылка на NMEA порт
└── power/                           (D) - директория управления питанием
```

## Описание атрибутов

### Основные атрибуты конфигурации

#### `clock_source` (RW)
**Тип:** строка
**Описание:** Управление источником синхронизации часов
**Допустимые значения:**
- `GNSS` - глобальная навигационная система
- `MAC` - атомные часы (Miniature Atomic Clock)
- `IRIG-B` - сигнал IRIG-B
- `external` - внешний источник
- `RTC` - часы реального времени
- `DCF` - сигнал DCF77
- `REGS` - регистры (отладка)

#### `available_clock_sources` (RO)
**Тип:** строка (список через запятую)
**Описание:** Список всех доступных источников синхронизации
**Пример:** `GNSS,MAC,IRIG-B,external,RTC,DCF,REGS`

### SMA коннекторы

#### `sma[1-4]` (RW)
**Тип:** строка
**Описание:** Конфигурация SMA коннекторов (вход/выход)
**Допустимые значения:**
- `disable` - отключен
- `10MHz` - сигнал 10 МГц
- `PPS` - импульс PPS
- `GNSS` - GNSS сигналы
- `IRIG` - IRIG-B сигнал
- `DCF` - DCF77 сигнал
- `GEN1` - генератор 1
- `TS2` - временная метка 2
- `TS3` - временная метка 3

**Примеры:**
```bash
# Настройка SMA1 как вход 10MHz
echo "10MHz" > /sys/class/timecard/ocp0/sma1

# Настройка SMA3 как выход PPS
echo "PPS" > /sys/class/timecard/ocp0/sma3
```

#### `available_sma_inputs` (RO)
**Тип:** строка (список через запятую)
**Описание:** Список сигналов, доступных для входов SMA
**Пример:** `disable,10MHz,PPS,GNSS,IRIG,DCF,TS2,TS3`

#### `available_sma_outputs` (RO)
**Тип:** строка (список через запятую)
**Описание:** Список сигналов, доступных для выходов SMA
**Пример:** `disable,10MHz,PPS,GNSS,IRIG,DCF,GEN1`

### Атрибуты синхронизации и калибровки

#### `gnss_sync` (RO)
**Тип:** строка
**Описание:** Статус синхронизации с GNSS спутниками
**Допустимые значения:**
- `locked` - синхронизирован
- `unlocked` - не синхронизирован
- `holdover` - режим удержания

#### `external_pps_cable_delay` (RW)
**Тип:** целое число (нс)
**Описание:** Задержка внешнего PPS кабеля для компенсации
**Диапазон:** 0-999999999
**Пример:** `125`

#### `internal_pps_cable_delay` (RW)
**Тип:** целое число (нс)
**Описание:** Задержка внутреннего PPS кабеля для компенсации
**Диапазон:** 0-999999999
**Пример:** `50`

#### `utc_tai_offset` (RW)
**Тип:** целое число (секунды)
**Описание:** Смещение UTC относительно TAI (обычно 37 секунд)
**Диапазон:** 0-255
**Пример:** `37`

#### `holdover` (RW)
**Тип:** целое число (0/1)
**Описание:** Включение/выключение режима holdover
**Допустимые значения:**
- `0` - выключен
- `1` - включен

### TOD (Time of Day) атрибуты

#### `tod_protocol` (RW)
**Тип:** строка
**Описание:** Протокол для передачи TOD данных
**Допустимые значения:**
- `TOD` - стандартный TOD
- `IRIG` - IRIG-B
- `PPS` - PPS только
- `RTC` - RTC
- `DCF` - DCF77
- `REGS` - регистры

#### `available_tod_protocols` (RO)
**Тип:** строка (список через запятую)
**Описание:** Список доступных TOD протоколов
**Пример:** `TOD,IRIG,PPS,RTC,DCF,REGS`

#### `tod_baud_rate` (RW)
**Тип:** целое число
**Описание:** Скорость UART для TOD (бит/с)
**Допустимые значения:** 9600, 19200, 38400, 57600, 115200

#### `available_tod_baud_rates` (RO)
**Тип:** строка (список через запятую)
**Описание:** Список доступных скоростей TOD UART
**Пример:** `9600,19200,38400,57600,115200`

#### `tod_correction` (RW)
**Тип:** целое число (нс)
**Описание:** Коррекция TOD для компенсации задержек
**Диапазон:** -999999999 до 999999999

### IRIG-B управление

#### `irig_b_mode` (RW)
**Тип:** целое число
**Описание:** Режим работы IRIG-B
**Допустимые значения:** 0-7
- `0` - отключен
- `1` - B000
- `2` - B001
- `3` - B010
- `4` - B011
- `5` - B100
- `6` - B101
- `7` - B110

### Служебные атрибуты

#### `serialnum` (RO)
**Тип:** строка
**Описание:** Серийный номер устройства
**Пример:** `TC-2024-001`

#### `mac_i2c` (RW)
**Тип:** строка
**Описание:** Управление I2C интерфейсом для MAC (атомных часов)
**Допустимые значения:** специфично для устройства

#### `ts_window_adjust` (RW)
**Тип:** целое число (нс)
**Описание:** Коррекция окна временных меток для точной синхронизации
**Диапазон:** -999999999 до 999999999

#### `clock_status_drift` (RO)
**Тип:** целое число (ppb)
**Описание:** Текущий дрейф часов в частях на миллиард
**Пример:** `-15`

#### `clock_status_offset` (RO)
**Тип:** целое число (нс)
**Описание:** Текущее смещение часов в наносекундах
**Пример:** `132`

### Бинарные файлы

#### `config` (RW)
**Тип:** бинарный файл
**Размер:** OCP_CONFIG_SIZE байт (обычно 4096)
**Описание:** Основная конфигурация устройства
**Использование:**
```bash
# Чтение конфигурации
dd if=/sys/class/timecard/ocp0/config of=config.bin

# Запись конфигурации
dd if=config.bin of=/sys/class/timecard/ocp0/config
```

#### `disciplining_config` (RW)
**Тип:** бинарный файл
**Размер:** OCP_ART_CONFIG_SIZE байт (обычно 144)
**Описание:** Конфигурация алгоритма дисциплинирования осциллятора
**Примечание:** Доступно только для устройств ART (Orolia)

#### `temperature_table` (RW)
**Тип:** бинарный файл
**Размер:** OCP_ART_TEMP_TABLE_SIZE байт (обычно 368)
**Описание:** Температурная таблица для компенсации
**Примечание:** Доступно только для устройств ART (Orolia)

## Примеры использования

### Базовая настройка

```bash
# Проверка доступных устройств
ls /sys/class/timecard/

# Настройка источника синхронизации
echo "GNSS" > /sys/class/timecard/ocp0/clock_source

# Проверка статуса GNSS
cat /sys/class/timecard/ocp0/gnss_sync

# Настройка SMA коннекторов
echo "10MHz" > /sys/class/timecard/ocp0/sma1
echo "PPS" > /sys/class/timecard/ocp0/sma3

# Калибровка задержек
echo "125" > /sys/class/timecard/ocp0/external_pps_cable_delay
```

### Работа с TOD

```bash
# Настройка протокола TOD
echo "TOD" > /sys/class/timecard/ocp0/tod_protocol

# Настройка скорости UART
echo "115200" > /sys/class/timecard/ocp0/tod_baud_rate

# Коррекция TOD
echo "50" > /sys/class/timecard/ocp0/tod_correction
```

### Работа с бинарными файлами

```bash
# Создание резервной копии конфигурации
cp /sys/class/timecard/ocp0/config ./backup_config.bin

# Восстановление конфигурации
cp ./backup_config.bin /sys/class/timecard/ocp0/config
```

## Уведомления и события

Драйвер поддерживает uevent уведомления при изменении атрибутов:

```bash
# Просмотр событий
cat /sys/class/timecard/ocp0/uevent

# Мониторинг изменений
udevadm monitor --kernel
```

## Диагностика

Для диагностики проблем используйте:

```bash
# Проверка всех атрибутов
find /sys/class/timecard/ocp0/ -name "*" -type f -exec sh -c 'echo -n "$1: "; cat "$1" 2>/dev/null || echo "N/A"' _ {} \;

# Проверка символьных ссылок
ls -la /sys/class/timecard/ocp0/ | grep "^l"
```

## Замечания по совместимости

- Некоторые атрибуты доступны только для определенных моделей устройств
- Бинарные файлы `disciplining_config` и `temperature_table` доступны только для устройств ART (Orolia)
- Вторичный GNSS порт (`ttyGNSS2`) может отсутствовать на некоторых устройствах
- I2C ссылка создается только при наличии соответствующего контроллера
