# РРЅС‚РµСЂС„РµР№СЃ sysfs РґСЂР°Р№РІРµСЂР° PTP OCP TimeCard

## РћР±С‰РµРµ РѕРїРёСЃР°РЅРёРµ

Р”СЂР°Р№РІРµСЂ PTP OCP СЃРѕР·РґР°РµС‚ РєР»Р°СЃСЃ СѓСЃС‚СЂРѕР№СЃС‚РІР° `timecard` РІ С„Р°Р№Р»РѕРІРѕР№ СЃРёСЃС‚РµРјРµ sysfs Linux. РљР°Р¶РґРѕРµ РѕР±РЅР°СЂСѓР¶РµРЅРЅРѕРµ СѓСЃС‚СЂРѕР№СЃС‚РІРѕ TimeCard РїРѕР»СѓС‡Р°РµС‚ СѓРЅРёРєР°Р»СЊРЅС‹Р№ РёРґРµРЅС‚РёС„РёРєР°С‚РѕСЂ Рё СЃРѕР·РґР°РµС‚СЃСЏ РІ РґРёСЂРµРєС‚РѕСЂРёРё:

```
/sys/class/timecard/ocpN/
```

РіРґРµ `N` - РїРѕСЂСЏРґРєРѕРІС‹Р№ РЅРѕРјРµСЂ СѓСЃС‚СЂРѕР№СЃС‚РІР°, РЅР°С‡РёРЅР°СЏ СЃ 0 (ocp0, ocp1, ocp2, Рё С‚.Рґ.).

> рџ“Њ **РџСЂРёРјРµС‡Р°РЅРёРµ**: Р”Р»СЏ Р±Р°Р·РѕРІС‹С… РїСЂРёРјРµСЂРѕРІ РёСЃРїРѕР»СЊР·РѕРІР°РЅРёСЏ sysfs СЃРј. СЂР°Р·РґРµР» "РЈРїСЂР°РІР»РµРЅРёРµ С‡РµСЂРµР· sysfs" РІ [TIMECARD_РРќРЎРўР РЈРљР¦РРЇ_РћРџРўРРњРР—РР РћР’РђРќРќРђРЇ.md](../docs/architecture.md)

## РџРѕР»РЅР°СЏ СЃС‚СЂСѓРєС‚СѓСЂР° РґРёСЂРµРєС‚РѕСЂРёРё

РўРёРїРёС‡РЅР°СЏ СЃС‚СЂСѓРєС‚СѓСЂР° РґРёСЂРµРєС‚РѕСЂРёРё `/sys/class/timecard/ocp0/`:

```
/sys/class/timecard/ocp0/
в”њв”Ђв”Ђ available_clock_sources      # (r) Р”РѕСЃС‚СѓРїРЅС‹Рµ РёСЃС‚РѕС‡РЅРёРєРё С‡Р°СЃРѕРІ
в”њв”Ђв”Ђ available_sma_inputs         # (r) Р”РѕСЃС‚СѓРїРЅС‹Рµ РІС…РѕРґРЅС‹Рµ СЃРёРіРЅР°Р»С‹ РґР»СЏ SMA
в”њв”Ђв”Ђ available_sma_outputs        # (r) Р”РѕСЃС‚СѓРїРЅС‹Рµ РІС‹С…РѕРґРЅС‹Рµ СЃРёРіРЅР°Р»С‹ РґР»СЏ SMA
в”њв”Ђв”Ђ clock_source                 # (rw) РўРµРєСѓС‰РёР№ РёСЃС‚РѕС‡РЅРёРє С‡Р°СЃРѕРІ
в”њв”Ђв”Ђ device -> ../../../0000:02:00.0  # РЎСЃС‹Р»РєР° РЅР° PCI СѓСЃС‚СЂРѕР№СЃС‚РІРѕ
в”њв”Ђв”Ђ external_pps_cable_delay     # (rw) Р—Р°РґРµСЂР¶РєР° РІРЅРµС€РЅРµРіРѕ PPS РєР°Р±РµР»СЏ (РЅСЃ)
в”њв”Ђв”Ђ gnss_sync                    # (r) РЎС‚Р°С‚СѓСЃ СЃРёРЅС…СЂРѕРЅРёР·Р°С†РёРё GNSS
в”њв”Ђв”Ђ internal_pps_cable_delay     # (rw) Р—Р°РґРµСЂР¶РєР° РІРЅСѓС‚СЂРµРЅРЅРµРіРѕ PPS РєР°Р±РµР»СЏ (РЅСЃ)
в”њв”Ђв”Ђ irig_b_mode                  # (rw) Р РµР¶РёРј СЂР°Р±РѕС‚С‹ IRIG-B
в”њв”Ђв”Ђ ts_window_adjust             # (rw) РљРѕСЂСЂРµРєС†РёСЏ РѕРєРЅР° РІСЂРµРјРµРЅРЅРѕР№ РјРµС‚РєРё (РЅСЃ)
в”њв”Ђв”Ђ power/                       # Р”РёСЂРµРєС‚РѕСЂРёСЏ СѓРїСЂР°РІР»РµРЅРёСЏ РїРёС‚Р°РЅРёРµРј
в”њв”Ђв”Ђ ptp -> ../../ptp/ptp4        # РЎСЃС‹Р»РєР° РЅР° PTP СѓСЃС‚СЂРѕР№СЃС‚РІРѕ
в”њв”Ђв”Ђ serialnum                    # (r) РЎРµСЂРёР№РЅС‹Р№ РЅРѕРјРµСЂ СѓСЃС‚СЂРѕР№СЃС‚РІР°
в”њв”Ђв”Ђ sma1                          # (rw) РљРѕРЅС„РёРіСѓСЂР°С†РёСЏ SMA1 (IN:/OUT: <signal>)
в”њв”Ђв”Ђ sma2                          # (rw) РљРѕРЅС„РёРіСѓСЂР°С†РёСЏ SMA2 (IN:/OUT: <signal>)
в”њв”Ђв”Ђ sma3                          # (rw) РљРѕРЅС„РёРіСѓСЂР°С†РёСЏ SMA3 (IN:/OUT: <signal>)
в”њв”Ђв”Ђ sma4                          # (rw) РљРѕРЅС„РёРіСѓСЂР°С†РёСЏ SMA4 (IN:/OUT: <signal>)
в”њв”Ђв”Ђ subsystem -> ../../../../../../class/timecard  # РЎСЃС‹Р»РєР° РЅР° РєР»Р°СЃСЃ
в”њв”Ђв”Ђ ttyGNSS -> ../../tty/ttyS5   # РЎСЃС‹Р»РєР° РЅР° GNSS РїРѕСЂС‚
в”њв”Ђв”Ђ ttyMAC -> ../../tty/ttyS6    # РЎСЃС‹Р»РєР° РЅР° MAC РїРѕСЂС‚
в”њв”Ђв”Ђ ttyNMEA -> ../../tty/ttyS7   # РЎСЃС‹Р»РєР° РЅР° NMEA РїРѕСЂС‚
в”њв”Ђв”Ђ uevent                       # (r) РЎРѕР±С‹С‚РёСЏ СѓСЃС‚СЂРѕР№СЃС‚РІР°
в””в”Ђв”Ђ utc_tai_offset               # (rw) РЎРјРµС‰РµРЅРёРµ UTC РѕС‚РЅРѕСЃРёС‚РµР»СЊРЅРѕ TAI
```

*РћР±РѕР·РЅР°С‡РµРЅРёСЏ: (r) - С‚РѕР»СЊРєРѕ С‡С‚РµРЅРёРµ, (rw) - С‡С‚РµРЅРёРµ Рё Р·Р°РїРёСЃСЊ*

## Р”РµС‚Р°Р»СЊРЅРѕРµ РѕРїРёСЃР°РЅРёРµ Р°С‚СЂРёР±СѓС‚РѕРІ

### РђС‚СЂРёР±СѓС‚С‹ РёСЃС‚РѕС‡РЅРёРєРѕРІ РІСЂРµРјРµРЅРё

#### `clock_source` (rw)
РўРµРєСѓС‰РёР№ РёСЃС‚РѕС‡РЅРёРє СЃРёРЅС…СЂРѕРЅРёР·Р°С†РёРё С‡Р°СЃРѕРІ. Р’РѕР·РјРѕР¶РЅС‹Рµ Р·РЅР°С‡РµРЅРёСЏ:
- `GNSS` - СЃРёРЅС…СЂРѕРЅРёР·Р°С†РёСЏ СЃ GNSS СЃРїСѓС‚РЅРёРєР°РјРё
- `MAC` - СЃРёРЅС…СЂРѕРЅРёР·Р°С†РёСЏ СЃ Р°С‚РѕРјРЅС‹РјРё С‡Р°СЃР°РјРё
- `IRIG-B` - СЃРёРЅС…СЂРѕРЅРёР·Р°С†РёСЏ СЃ СЃРёРіРЅР°Р»РѕРј IRIG-B
- `external` - РІРЅРµС€РЅРёР№ РёСЃС‚РѕС‡РЅРёРє СЃРёРЅС…СЂРѕРЅРёР·Р°С†РёРё

#### `available_clock_sources` (r)
РЎРїРёСЃРѕРє РІСЃРµС… РґРѕСЃС‚СѓРїРЅС‹С… РёСЃС‚РѕС‡РЅРёРєРѕРІ СЃРёРЅС…СЂРѕРЅРёР·Р°С†РёРё РґР»СЏ РґР°РЅРЅРѕРіРѕ СѓСЃС‚СЂРѕР№СЃС‚РІР°.

### РђС‚СЂРёР±СѓС‚С‹ SMA РєРѕРЅРЅРµРєС‚РѕСЂРѕРІ

#### `sma[1-4]` (rw)
РљРѕРЅС„РёРіСѓСЂР°С†РёСЏ SMA РєРѕРЅРЅРµРєС‚РѕСЂРѕРІ. Р¤РѕСЂРјР°С‚ Р·РЅР°С‡РµРЅРёСЏ:

```
IN: <signal>
OUT: <signal>
```

РЎРїРёСЃРєРё РґРѕРїСѓСЃС‚РёРјС‹С… Р·РЅР°С‡РµРЅРёР№ СЃРј. РІ `available_sma_inputs`/`available_sma_outputs`.

Р’РѕР·РјРѕР¶РЅС‹Рµ РІС…РѕРґРЅС‹Рµ СЃРёРіРЅР°Р»С‹:
- `10MHz` - РѕРїРѕСЂРЅР°СЏ С‡Р°СЃС‚РѕС‚Р° 10 РњР“С†
- `PPS` - РёРјРїСѓР»СЊСЃ СЂР°Р· РІ СЃРµРєСѓРЅРґСѓ
- `TS1-TS4` - РІСЂРµРјРµРЅРЅС‹Рµ РјРµС‚РєРё
- `IRIG-B` - СЃРёРіРЅР°Р» IRIG-B
- `DCF77` - СЂР°РґРёРѕСЃРёРіРЅР°Р» РІСЂРµРјРµРЅРё DCF77

Р”РѕРїРѕР»РЅРёС‚РµР»СЊРЅРѕ:
- `tod_protocol`/`available_tod_protocols` вЂ” РІС‹Р±РѕСЂ РїСЂРѕС‚РѕРєРѕР»Р° TOD
- `clock_status_drift`, `clock_status_offset` вЂ” СЃС‚Р°С‚СѓСЃ С‡Р°СЃС‚РѕС‚С‹/СЃРјРµС‰РµРЅРёСЏ
- `tod_baud_rate` вЂ” СЃРєРѕСЂРѕСЃС‚СЊ UART РґР»СЏ TOD
- `holdover` вЂ” РїСЂРёР·РЅР°Рє СѓРґРµСЂР¶Р°РЅРёСЏ
- `mac_i2c` вЂ” РґРѕСЃС‚СѓРї Рє I2C MAC

Р’РѕР·РјРѕР¶РЅС‹Рµ РІС‹С…РѕРґРЅС‹Рµ СЃРёРіРЅР°Р»С‹:
- `10MHz` - РіРµРЅРµСЂР°С†РёСЏ РѕРїРѕСЂРЅРѕР№ С‡Р°СЃС‚РѕС‚С‹
- `PPS` - РіРµРЅРµСЂР°С†РёСЏ PPS
- `GEN[1-4]` - РїСЂРѕРіСЂР°РјРјРёСЂСѓРµРјС‹Рµ РіРµРЅРµСЂР°С‚РѕСЂС‹

#### `available_sma_inputs/outputs` (r)
РЎРїРёСЃРєРё РІСЃРµС… РґРѕСЃС‚СѓРїРЅС‹С… РІС…РѕРґРЅС‹С… Рё РІС‹С…РѕРґРЅС‹С… СЃРёРіРЅР°Р»РѕРІ РґР»СЏ SMA РєРѕРЅРЅРµРєС‚РѕСЂРѕРІ.

### РђС‚СЂРёР±СѓС‚С‹ РєР°Р»РёР±СЂРѕРІРєРё Р·Р°РґРµСЂР¶РµРє

#### `external_pps_cable_delay` (rw)
Р—Р°РґРµСЂР¶РєР° РІРЅРµС€РЅРµРіРѕ PPS РєР°Р±РµР»СЏ РІ РЅР°РЅРѕСЃРµРєСѓРЅРґР°С… (ns). РСЃРїРѕР»СЊР·СѓРµС‚СЃСЏ РґР»СЏ РєРѕРјРїРµРЅСЃР°С†РёРё Р·Р°РґРµСЂР¶РєРё СЂР°СЃРїСЂРѕСЃС‚СЂР°РЅРµРЅРёСЏ СЃРёРіРЅР°Р»Р° РїРѕ РєР°Р±РµР»СЋ.

#### `internal_pps_cable_delay` (rw)
Р—Р°РґРµСЂР¶РєР° РІРЅСѓС‚СЂРµРЅРЅРµРіРѕ PPS СЃРёРіРЅР°Р»Р° РІ РЅР°РЅРѕСЃРµРєСѓРЅРґР°С… (ns).

#### `ts_window_adjust` (rw)
РљРѕСЂСЂРµРєС†РёСЏ РѕРєРЅР° РІСЂРµРјРµРЅРЅРѕР№ РјРµС‚РєРё РІ РЅР°РЅРѕСЃРµРєСѓРЅРґР°С… (ns) вЂ” РєРѕРјРїРµРЅСЃР°С†РёСЏ РѕС†РµРЅРєРё Р·Р°РґРµСЂР¶РєРё PCIe.

### РђС‚СЂРёР±СѓС‚С‹ СЃРёРЅС…СЂРѕРЅРёР·Р°С†РёРё

#### `gnss_sync` (r)
РЎС‚Р°С‚СѓСЃ СЃРёРЅС…СЂРѕРЅРёР·Р°С†РёРё СЃ GNSS. Р’РѕР·РјРѕР¶РЅС‹Рµ Р·РЅР°С‡РµРЅРёСЏ Рё С„РѕСЂРјР°С‚:

```
SYNC
LOST @ <timestamp>
```

#### `utc_tai_offset` (rw)
РЎРјРµС‰РµРЅРёРµ UTC РѕС‚РЅРѕСЃРёС‚РµР»СЊРЅРѕ TAI (РњРµР¶РґСѓРЅР°СЂРѕРґРЅРѕРµ Р°С‚РѕРјРЅРѕРµ РІСЂРµРјСЏ) РІ СЃРµРєСѓРЅРґР°С….

### РЎР»СѓР¶РµР±РЅС‹Рµ Р°С‚СЂРёР±СѓС‚С‹

#### `serialnum` (r)
РЎРµСЂРёР№РЅС‹Р№ РЅРѕРјРµСЂ СѓСЃС‚СЂРѕР№СЃС‚РІР° TimeCard.

#### `irig_b_mode` (rw)
Р РµР¶РёРј СЂР°Р±РѕС‚С‹ СЃ СЃРёРіРЅР°Р»РѕРј IRIG-B:
- `B003` - СЃС‚Р°РЅРґР°СЂС‚РЅС‹Р№ С„РѕСЂРјР°С‚ IRIG-B
- `B006` - IEEE-1344 С„РѕСЂРјР°С‚
- `disabled` - РѕС‚РєР»СЋС‡РµРЅ

## РЎРёРјРІРѕР»РёС‡РµСЃРєРёРµ СЃСЃС‹Р»РєРё

### `device`
РЎСЃС‹Р»РєР° РЅР° СЃРѕРѕС‚РІРµС‚СЃС‚РІСѓСЋС‰РµРµ PCI СѓСЃС‚СЂРѕР№СЃС‚РІРѕ РІ `/sys/devices/pci*/`.

### `ptp`
РЎСЃС‹Р»РєР° РЅР° PTP СѓСЃС‚СЂРѕР№СЃС‚РІРѕ РІ `/sys/class/ptp/`. РСЃРїРѕР»СЊР·СѓРµС‚СЃСЏ РґР»СЏ РґРѕСЃС‚СѓРїР° Рє Р°РїРїР°СЂР°С‚РЅС‹Рј С‡Р°СЃР°Рј (PHC).

### `ttyGNSS`, `ttyGNSS2`, `ttyMAC`, `ttyNMEA`
РЎСЃС‹Р»РєРё РЅР° РїРѕСЃР»РµРґРѕРІР°С‚РµР»СЊРЅС‹Рµ СѓСЃС‚СЂРѕР№СЃС‚РІР° РґР»СЏ РѕР±РјРµРЅР° РґР°РЅРЅС‹РјРё СЃ СЂР°Р·Р»РёС‡РЅС‹РјРё РєРѕРјРїРѕРЅРµРЅС‚Р°РјРё TimeCard.

## Р Р°СЃС€РёСЂРµРЅРЅС‹Рµ РїСЂРёРјРµСЂС‹ РёСЃРїРѕР»СЊР·РѕРІР°РЅРёСЏ

### РђРІС‚РѕРјР°С‚РёР·Р°С†РёСЏ РєРѕРЅС„РёРіСѓСЂР°С†РёРё

РџСЂРёРјРµСЂ СЃРєСЂРёРїС‚Р° РґР»СЏ Р°РІС‚РѕРјР°С‚РёС‡РµСЃРєРѕР№ РЅР°СЃС‚СЂРѕР№РєРё:

```bash
#!/bin/bash
TIMECARD="/sys/class/timecard/ocp0"

# РџСЂРѕРІРµСЂРєР° СЃСѓС‰РµСЃС‚РІРѕРІР°РЅРёСЏ СѓСЃС‚СЂРѕР№СЃС‚РІР°
if [ ! -d "$TIMECARD" ]; then
    echo "TimeCard not found!"
    exit 1
fi

# РќР°СЃС‚СЂРѕР№РєР°
echo "GNSS" > "$TIMECARD/clock_source"
echo "IN: 10MHz" > "$TIMECARD/sma1"
echo "OUT: PPS" > "$TIMECARD/sma3"
echo "100" > "$TIMECARD/external_pps_cable_delay"

echo "TimeCard configured successfully"
```

### Р”РѕРїРѕР»РЅРёС‚РµР»СЊРЅС‹Рµ РїСЂРёРјРµСЂС‹

#### РќР°СЃС‚СЂРѕР№РєР° TOD

```bash
# РџСЂРѕС‚РѕРєРѕР» TOD (РІС‹Р±РѕСЂ РёР· available_tod_protocols)
echo "NMEA" > /sys/class/timecard/ocp0/tod_protocol

# РЎРєРѕСЂРѕСЃС‚СЊ UART РґР»СЏ TOD (РІС‹Р±РѕСЂ РёР· available_tod_baud_rates)
echo "9600" > /sys/class/timecard/ocp0/tod_baud_rate

# РљРѕСЂСЂРµРєС†РёСЏ TOD РІ СЃРµРєСѓРЅРґР°С… (РјРѕР¶РµС‚ Р±С‹С‚СЊ РѕС‚СЂРёС†Р°С‚РµР»СЊРЅРѕР№)
echo "-1" > /sys/class/timecard/ocp0/tod_correction
```

#### Р РµР¶РёРј IRIG-B

```bash
# Р РµР¶РёРј IRIG-B, СЃРј. РґРѕСЃС‚СѓРїРЅС‹Рµ Р·РЅР°С‡РµРЅРёСЏ (0..7)
echo "3" > /sys/class/timecard/ocp0/irig_b_mode
```

#### Holdover

```bash
# РЈСЃС‚Р°РЅРѕРІРєР° СЂРµР¶РёРјР° СѓРґРµСЂР¶Р°РЅРёСЏ (0..3)
echo "1" > /sys/class/timecard/ocp0/holdover
```

### РњРѕРЅРёС‚РѕСЂРёРЅРі РёР·РјРµРЅРµРЅРёР№

РњРѕР¶РЅРѕ РѕС‚СЃР»РµР¶РёРІР°С‚СЊ РёР·РјРµРЅРµРЅРёСЏ Р°С‚СЂРёР±СѓС‚РѕРІ СЃ РїРѕРјРѕС‰СЊСЋ inotify РёР»Рё udev РїСЂР°РІРёР». 
