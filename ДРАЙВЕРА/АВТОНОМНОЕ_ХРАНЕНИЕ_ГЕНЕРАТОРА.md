# Управление автономным хранением генератора (Holdover)

## Обзор

Драйвер PTP OCP поддерживает функцию автономного хранения генератора (holdover), которая позволяет устройству продолжать работу с высокой точностью времени даже при потере внешнего источника синхронизации (например, GNSS).

## Функциональность

### Режимы работы

1. **Нормальный режим (0)** - Синхронизация с внешним источником (GNSS/PPS)
2. **Автономный режим (1-3)** - Работа от внутреннего генератора с сохраненной калибровкой

### Доступные команды

Скрипт `holdover_control.sh` предоставляет следующие команды:

- `status` - Проверка текущего статуса
- `set <режим>` - Установка режима (0-3)
- `save` - Сохранение калибровки в EEPROM
- `info` - Информация об устройстве

## Использование

### Проверка статуса

```bash
sudo ./holdover_control.sh status
```

### Переключение в автономный режим

```bash
# Включить автономный режим
sudo ./holdover_control.sh set 1

# Вернуться в нормальный режим
sudo ./holdover_control.sh set 0
```

### Сохранение калибровки

```bash
sudo ./holdover_control.sh save
```

## Технические детали

### Реализация в драйвере

Драйвер поддерживает следующие функции для управления holdover:

1. **IOCTL команды MRO50**:
   - `MRO50_SAVE_COARSE` - Сохранение калибровки в EEPROM
   - `MRO50_READ_COARSE` - Чтение калибровки
   - `MRO50_ADJUST_COARSE` - Корректировка калибровки

2. **Sysfs атрибуты**:
   - `clock_source` - Выбор источника часов
   - `gnss_sync` - Статус синхронизации с GNSS
   - `clock_status_drift` - Дрифт часов
   - `clock_status_offset` - Смещение времени

### Альтернативный метод управления

Поскольку атрибут `holdover` может отсутствовать в некоторых версиях драйвера, скрипт использует альтернативный метод через изменение источника часов:

- **PPS** - Нормальный режим (синхронизация с внешним источником)
- **REGS** - Автономный режим (работа от внутреннего генератора)

### Источники часов

Доступные источники часов (из `available_clock_sources`):
- `NONE` - Нет источника
- `TOD` - Time of Day
- `IRIG` - IRIG-B сигнал
- `PPS` - Pulse Per Second
- `PTP` - Precision Time Protocol
- `RTC` - Real Time Clock
- `DCF` - DCF77 радиосигнал
- `REGS` - Внутренние регистры (автономный режим)
- `EXT` - Внешний источник

## Мониторинг

### Статус синхронизации

```bash
# Проверка статуса GNSS
cat /sys/class/timecard/ocp0/gnss_sync

# Проверка дрифта часов
cat /sys/class/timecard/ocp0/clock_status_drift

# Проверка смещения времени
cat /sys/class/timecard/ocp0/clock_status_offset
```

### PTP статус

```bash
# Информация о PTP устройстве
cat /sys/class/ptp/ptp2/clock_name

# Максимальная коррекция
cat /sys/class/ptp/ptp2/max_adjustment
```

## Примеры использования

### Сценарий 1: Плановое переключение в автономный режим

```bash
# 1. Проверить текущий статус
sudo ./holdover_control.sh status

# 2. Сохранить текущую калибровку
sudo ./holdover_control.sh save

# 3. Переключить в автономный режим
sudo ./holdover_control.sh set 1

# 4. Проверить, что режим изменился
cat /sys/class/timecard/ocp0/clock_source
```

### Сценарий 2: Восстановление после потери GNSS

```bash
# 1. Проверить статус GNSS
cat /sys/class/timecard/ocp0/gnss_sync

# 2. Если GNSS потерян, переключить в автономный режим
sudo ./holdover_control.sh set 2

# 3. Мониторить дрифт часов
watch -n 1 'cat /sys/class/timecard/ocp0/clock_status_drift'
```

### Сценарий 3: Возврат к нормальной работе

```bash
# 1. Проверить восстановление GNSS
cat /sys/class/timecard/ocp0/gnss_sync

# 2. Переключить обратно в нормальный режим
sudo ./holdover_control.sh set 0

# 3. Проверить синхронизацию
sudo ./holdover_control.sh status
```

## Требования

- Права root для изменения sysfs атрибутов
- Загруженный драйвер `ptp_ocp`
- Устройство PTP OCP в системе

## Устранение неполадок

### Устройство не найдено

```bash
# Проверить загрузку драйвера
lsmod | grep ptp_ocp

# Загрузить драйвер
sudo modprobe ptp_ocp

# Проверить PCI устройство
lspci | grep -i ptp
```

### Нет прав на запись

```bash
# Запустить с правами root
sudo ./holdover_control.sh set 1

# Проверить права на sysfs
ls -la /sys/class/timecard/ocp0/clock_source
```

### Атрибут holdover отсутствует

Скрипт автоматически использует альтернативный метод через `clock_source`. Это нормальное поведение для некоторых версий драйвера.

## Безопасность

- Всегда сохраняйте калибровку перед переключением в автономный режим
- Мониторьте дрифт часов в автономном режиме
- Возвращайтесь к нормальному режиму при восстановлении внешней синхронизации
- Используйте права root только при необходимости

## Связанные файлы

- `holdover_control.sh` - Основной скрипт управления
- `ptp_ocp.c` - Исходный код драйвера
- `/sys/class/timecard/ocp0/` - Sysfs интерфейс устройства
- `/dev/ptp2` - PTP устройство
