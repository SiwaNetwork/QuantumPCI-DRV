# Оптимизированная конфигурация Chrony для TimeCard
# /etc/chrony/chrony.conf
# Версия: 4.5+
# Дата: 2025-09-16

# =============================================================================
# ОСНОВНЫЕ ИСТОЧНИКИ ВРЕМЕНИ
# =============================================================================

# TimeCard PHC как основной источник времени
# poll 3 - оптимальное значение для стабильной работы
# dpoll -2 - динамический polling для экономии ресурсов
# precision 1e-9 - наносекундная точность
# prefer - предпочтительный источник
refclock PHC /dev/ptp0 poll 3 dpoll -2 offset 0 stratum 1 precision 1e-9 prefer

# Резервные NTP серверы для обеспечения надежности
server 0.pool.ntp.org iburst
server 1.pool.ntp.org iburst
server 2.pool.ntp.org iburst
server 3.pool.ntp.org iburst

# =============================================================================
# НАСТРОЙКИ СИНХРОНИЗАЦИИ
# =============================================================================

# Быстрая начальная синхронизация
# makestep 1.0 3 - корректировка времени до 1 секунды в первых 3 обновлениях
makestep 1.0 3

# Синхронизация RTC с системными часами
rtcsync

# Файл для сохранения информации о дрейфе часов
driftfile /var/lib/chrony/drift

# =============================================================================
# НАСТРОЙКИ ТОЧНОСТИ
# =============================================================================

# Максимальное отклонение частоты (ppm)
maxupdateskew 100.0

# Соотношение коррекции времени
corrtimeratio 3

# Максимальный дрейф частоты (ppm)
maxdrift 500

# Максимальная дистанция до источника (секунды)
maxdistance 1.0

# =============================================================================
# ЛОГИРОВАНИЕ И МОНИТОРИНГ
# =============================================================================

# Директория для логов
logdir /var/log/chrony

# Типы логируемой информации
log tracking measurements statistics

# Логирование изменений больше указанного значения (секунды)
logchange 0.001

# =============================================================================
# СЕТЕВЫЕ НАСТРОЙКИ
# =============================================================================

# Разрешение доступа для локальной сети
allow 192.168.0.0/16
allow 10.0.0.0/8
allow 172.16.0.0/12

# Локальный NTP сервер
local stratum 2

# Порт NTP
port 123

# =============================================================================
# БЕЗОПАСНОСТЬ
# =============================================================================

# Адреса для команд управления
bindcmdaddress 127.0.0.1
bindcmdaddress ::1

# Разрешение команд
cmdallow 127.0.0.1
cmdallow ::1

# =============================================================================
# ДОПОЛНИТЕЛЬНЫЕ НАСТРОЙКИ
# =============================================================================

# Минимальное количество источников
minsources 1

# Плавная коррекция времени
smoothtime 400 0.01 leaponly

# Обработка leap seconds
leapsecmode slew
maxslewrate 83333.333

# Ограничения для клиентов
clientloglimit 1048576

# =============================================================================
# НАСТРОЙКИ ДЛЯ ВЫСОКОЙ НАГРУЗКИ
# =============================================================================

# Ограничение скорости запросов
ratelimit interval 1 burst 16 leak 2

# =============================================================================
# КОММЕНТАРИИ ПО НАСТРОЙКЕ
# =============================================================================

# 1. Убедитесь, что PTP устройство /dev/ptp0 доступно
# 2. Проверьте права доступа: sudo chmod 666 /dev/ptp0
# 3. Для мониторинга используйте: chronyc tracking
# 4. Для проверки источников: chronyc sources -v
# 5. Для перезапуска: sudo systemctl restart chronyd
