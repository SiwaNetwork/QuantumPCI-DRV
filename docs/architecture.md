# Архитектура PTP драйвера

## Обзор

Драйвер PTP представляет собой комплексное решение для работы с картами точного времени в Linux. Он обеспечивает высокоточную синхронизацию времени, поддерживает множество стандартов и протоколов, и предоставляет гибкий интерфейс для управления всеми функциями карты.

## Поддерживаемые устройства

- **Quantum-PCI TimeCard** (PCI ID: 0x1d9b:0x0400)
- **Orolia ART Card** (PCI ID: 0x1ad7:0xa000)
- **ADVA Timecard** (PCI ID: 0x0b0b:0x0410)

## Функциональные возможности

### Временная синхронизация
- Поддержка PTP (Precision Time Protocol)
- Аппаратные часы PHC (Physical Hardware Clock)
- Синхронизация с GNSS (GPS/ГЛОНАСС)
- Поддержка атомных часов (MAC - Miniature Atomic Clock)

### Интерфейсы
- **Последовательные порты**: GNSS, MAC, NMEA
- **I2C шина**: для управления внешними устройствами
- **SPI**: для работы с flash-памятью
- **GPIO**: для управления сигналами

### Сигналы времени
- **PPS (Pulse Per Second)**: генерация и прием импульсов раз в секунду
- **IRIG-B**: поддержка временного кода IRIG-B
- **DCF77**: поддержка радиосигнала времени DCF77
- **10 МГц**: опорная частота

## Архитектура драйвера

### Регистры управления
- `ocp_reg`: основные регистры управления часами
- `tod_reg`: регистры Time of Day
- `ts_reg`: регистры временных меток
- `pps_reg`: регистры PPS
- `signal_reg`: регистры генератора сигналов

### Ресурсы устройства
Драйвер использует систему ресурсов для динамического обнаружения и инициализации компонентов карты:
- Память MMIO для регистров
- Векторы прерываний MSI/MSI-X
- Вспомогательные устройства (UART, I2C, SPI)

## Основные функции

### Управление временем
- `ptp_ocp_gettime()`: чтение текущего времени
- `ptp_ocp_settime()`: установка времени
- `ptp_ocp_adjtime()`: корректировка времени
- `ptp_ocp_adjfine()`: точная подстройка частоты

### PTM (Precision Time Measurement)
- Поддержка PCIe PTM для синхронизации времени через шину PCIe
- Автоматический расчет задержек передачи

### Управление сигналами
- Настройка входов/выходов SMA (SubMiniature version A)
- Генерация периодических сигналов
- Обработка внешних временных меток

## Интерфейс sysfs

Драйвер создает класс устройства `/sys/class/timecard/ocpN/`, где N - порядковый номер обнаруженного устройства (начиная с 0). Этот интерфейс предоставляет следующие атрибуты:

### Основные атрибуты конфигурации:
- `clock_source` - выбор источника часов (GNSS, MAC, IRIG-B, external)
- `available_clock_sources` - список доступных источников времени
- `sma[1-4]_in/out` - конфигурация SMA коннекторов как входов или выходов
- `available_sma_inputs/outputs` - доступные сигналы для SMA портов

### Атрибуты синхронизации и калибровки:
- `gnss_sync` - статус синхронизации с GNSS спутниками
- `external_pps_cable_delay` - задержка внешнего PPS кабеля (нс)
- `internal_pps_cable_delay` - задержка внутреннего PPS кабеля (нс)
- ~~`pci_delay`~~ - задержка PCIe шины (**НЕ ПОДДЕРЖИВАЕТСЯ** в текущем драйвере)
- `utc_tai_offset` - смещение UTC относительно TAI (секунды)

### Служебные атрибуты:
- `serialnum` - серийный номер устройства
- `irig_b_mode` - режим работы IRIG-B
- `uevent` - события устройства

### Символические ссылки на связанные устройства:
- `device` -> `../../../XXXX:XX:XX.X` - ссылка на PCI устройство
- `ptp` -> `../../ptp/ptpX` - ссылка на PTP часы
- `ttyGNSS` -> `../../tty/ttyX` - ссылка на GNSS последовательный порт
- `ttyMAC` -> `../../tty/ttyX` - ссылка на MAC последовательный порт
- `ttyNMEA` -> `../../tty/ttyX` - ссылка на NMEA последовательный порт
- `subsystem` -> `../../../../../../class/timecard` - ссылка на класс устройства

### Директории:
- `power/` - управление питанием устройства

## Особенности реализации

### Поддержка прошивок
- Загрузка прошивки через devlink
- Проверка совместимости прошивки с оборудованием
- Поддержка обновления FPGA и SOM

### Обработка ошибок
- Сторожевой таймер для контроля работоспособности
- Автоматическое восстановление при сбоях
- Детальное логирование ошибок

### Оптимизация производительности
- Использование MSI-X для минимизации задержек прерываний
- Прямой доступ к регистрам через MMIO
- Кэширование часто используемых значений

### Примечание по управлению питанием
- На текущий момент `suspend/resume` не реализованы; см. раздел с рекомендациями по улучшению.

## Заключение

Драйвер ptp_ocp представляет собой комплексное решение для работы с картами точного времени в Linux. Он обеспечивает высокоточную синхронизацию времени, поддерживает множество стандартов и протоколов, и предоставляет гибкий интерфейс для управления всеми функциями карты.
