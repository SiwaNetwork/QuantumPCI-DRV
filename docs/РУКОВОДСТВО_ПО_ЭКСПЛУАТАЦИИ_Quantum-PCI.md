# РУКОВОДСТВО ПО ЭКСПЛУАТАЦИИ
## Quantum-PCI

**Версия документа:** 2.0  
**Дата:** 2025  
**Назначение:** эксплуатация платы Quantum‑PCI под Linux

---

## СОДЕРЖАНИЕ

1. [НАЗНАЧЕНИЕ](#1-назначение)
   - 1.1 [Назначение и область применения](#11-назначение-и-область-применения)
   - 1.2 [Условия эксплуатации](#12-условия-эксплуатации)

2. [ТЕХНИЧЕСКИЕ ХАРАКТЕРИСТИКИ](#2-технические-характеристики)
   - 2.1 [Основные технические данные](#21-основные-технические-данные)
   - 2.2 [Показатели надежности](#22-показатели-надежности)
   - 2.3 [Система электропитания](#23-система-электропитания)

3. [СОСТАВ](#3-состав)
   - 3.1 [Состав изделия](#31-состав-изделия)

4. [УСТРОЙСТВО И РАБОТА](#4-устройство-и-работа)

5. [ПОДГОТОВКА ИЗДЕЛИЯ К ИСПОЛЬЗОВАНИЮ](#5-подготовка-изделия-к-использованию)
   - 5.1 [Указания мер безопасности](#51-указания-мер-безопасности)
   - 5.2 [Исходное состояние](#52-исходное-состояние)
   - 5.3 [Включение](#53-включение)
   - 5.4 [Выключение](#54-выключение)

6. [ИСПОЛЬЗОВАНИЕ](#6-использование)
   - 6.1 [Требования к обслуживающему персоналу](#61-требования-к-обслуживающему-персоналу)
   - 6.2 [Перечень основных операций](#62-перечень-основных-операций)
   - 6.3 [Проверка работоспособности](#63-проверка-работоспособности)
   - 6.4 [Настройка сетевых карт в паре с Quantum-PCI](#64-настройка-сетевых-карт-в-паре-с-quantum-pci)
   - 6.5 [Профессиональное тестирование и измерения](#65-профессиональное-тестирование-и-измерения)
   - 6.6 [Оптимизация производительности](#66-оптимизация-производительности)

7. [ТЕКУЩИЙ РЕМОНТ](#7-текущий-ремонт)
   - 7.1 [Восстановление работоспособности](#71-восстановление-работоспособности)
   - 7.2 [Перечень возможных неисправностей](#72-перечень-возможных-неисправностей)

8. [ТЕХНИЧЕСКОЕ ОБСЛУЖИВАНИЕ](#8-техническое-обслуживание)
   - 8.1 [Общие указания](#81-общие-указания)
   - 8.2 [Виды и периодичность технического обслуживания](#82-виды-и-периодичность-технического-обслуживания)
   - 8.3 [Подготовка к проведению технического обслуживания](#83-подготовка-к-проведению-технического-обслуживания)
   - 8.4 [Порядок технического обслуживания](#84-порядок-технического-обслуживания)
   - 8.5 [Маркировка и опломбирование](#85-маркировка-и-опломбирование)

9. [ТЕХНИЧЕСКОЕ ОСВИДЕТЕЛЬСТВОВАНИЕ](#9-техническое-освидетельствование)

10. [КОНСЕРВАЦИЯ](#10-консервация)

11. [ХРАНЕНИЕ](#11-хранение)

12. [ТРАНСПОРТИРОВАНИЕ](#12-транспортирование)

13. [УТИЛИЗАЦИЯ ПОСЛЕ ИСПОЛЬЗОВАНИЯ](#13-утилизация-после-использования)

---

## 1. НАЗНАЧЕНИЕ

### 1.1 Назначение и область применения

Плата Quantum‑PCI предназначена для высокоточного времени и синхронизации по протоколам PTP/IEEE‑1588 и NTP. Настоящее руководство описывает установку, подключение, установку драйвера и настройку системного времени в Linux.

### 1.2 Условия эксплуатации

**Климатические условия:**
- Рабочая температура: -20°C до +65°C (стандартное исполнение)
- Рабочая температура: -30°C до +65°C (расширенное исполнение)  
- Рабочая температура: -10°C до +55°C (для исполнения с рубидиевым генератором)
- Влажность воздуха: не более 80% при температуре 25°C
- Категория размещения: УХЛ4.1 (умеренно-холодный климат)

**Эксплуатационные требования:**
- Наличие PCIe слота в системе
- Операционная система Linux
- Права администратора для установки драйверов
- Сетевое подключение для PTP/NTP синхронизации

---

## 2. ТЕХНИЧЕСКИЕ ХАРАКТЕРИСТИКИ

### 2.1 Основные технические данные

**Форм-фактор и конструкция:**
- Форм-фактор: Стандартная карта PCIe с пассивным охлаждением размером один слот
- Размеры: Стандартные размеры PCIe карты
- Потребляемая мощность: не более 36 Вт

**Функциональное описание:**
Функционал изделия разделен на две основные части: полезная нагрузка и доставка. Полезная нагрузка — это точное время, которое представляет собой систему интерполяции, управляемую локальным генератором для создания измерения времени с точностью наносекунды между последовательными сигналами PPS, принимаемыми приемником GNSS.

**Временные характеристики:**
- Точность синхронизации от GNSS: ±70 нс
- Точность синхронизации от высокоточного стандарта частоты: ±5 нс
- Уход часов в автономном режиме (QUANTUM-Q-01): не более ±1.8 мкс в сутки
- Уход часов в автономном режиме (QUANTUM-Q-02): не более ±22 мкс в сутки
- Уход часов в автономном режиме (QUANTUM-Q-03): не более ±1.5 мкс в сутки
- Уход часов в автономном режиме (QUANTUM-R-01 рубидиевый): не более ±0.3 мкс в сутки
- Уход часов в автономном режиме (QUANTUM-C-01 цезиевый): не более ±0.1 мкс в сутки
- Время восстановления: не более 10 минут (при наличии приема сигнала GNSS)

### 2.2 Показатели надежности

- Средняя наработка на отказ: не менее 50,000 часов
- MTBF компонентов: не менее 500,000 часов (при 25°C)
- Время восстановления: не более 10 минут (при наличии приема сигнала GNSS)

### 2.3 Система электропитания

- Потребляемая мощность: не более 36 Вт
- Напряжение питания: от PCIe слота (3.3V, 12V)
- Защита от перегрузок: встроенная

---

## 3. СОСТАВ

### 3.1 Состав изделия

**Таблица 3.1 - Комплект поставки:**

| № п.п | Наименование | Кол. | Заводской номер |
|-------|--------------|------|-----------------|
| 1 | Quantum-PCI -V1.1-xx-yy-zz | 1 | - |
| 2 | Антенна ГЛОНАСС/GPS/BeiDou** | 1 | - |

**Кабели антенные соединительные:**
| № | Наименование | Кол. |
|---|--------------|------|
| 1 | Кабель антенный соединительный РК 50-7-311 с установленными разъемами N – N (длина определяется при заказе) | 1 |
| 2 | Кабель антенный соединительный РК 50-7-11 с установленными разъемами N – N (длина определяется при заказе) | 1 |
| 3 | Кабель антенный соединительный РК 50-4,8-32 с установленными разъемами N – N (длина определяется при заказе) | 1 |

**Документация:**
| № | Наименование | Кол. |
|---|--------------|------|
| 1 | Паспорт | 1 |
| 2 | Руководство по эксплуатации (в электронном виде) | 1 |

**Разрядник грозозащиты:**
| № | Наименование | Кол. |
|---|--------------|------|
| 1 | Грозозащитный элемент Р8АХ09 N/MF | 1 |
| 2 | Грозозащитный элемент N-712Q | 1 |

**Монтажные принадлежности:**
| № | Наименование | Кол. |
|---|--------------|------|
| 1 | Кронштейн для установки антенного блока универсальный | 1 |

**Примечание:** ** - поставляется по запросу, состав и тип уточняется при заказе.

#### Коды для заказа

**Таблица 3.2 - Коды заказа по типу опорного генератора:**

| Наименование | Тип опорного генератора | Описание |
|--------------|-------------------------|----------|
| **QUANTUM-Q-01** | Кварцевый генератор | Уход времени в автономном режиме не более ±1.8 мкс в сутки (стандартная поставка) |
| **QUANTUM-Q-02** | Кварцевый генератор | Уход времени в автономном режиме не более ±22 мкс в сутки (экономичная поставка) |
| **QUANTUM-Q-03** | Высокоточный кварцевый генератор | Уход времени в автономном режиме не более ±1.5 мкс в сутки (премиум поставка) |
| **QUANTUM-R-01** | Рубидиевый стандарт | Уход времени в автономном режиме не более ±0.3 мкс в сутки (поставка под заказ) |
| **QUANTUM-C-01** | Цезиевый стандарт | Уход времени в автономном режиме не более ±0.1 мкс в сутки (поставка под заказ) |

**Примечание:** Вариант поставки указывается на титульном листе Паспорта.

#### Определение комплекта поставки

Комплект поставки оборудования определяется при заключении контракта на поставку. Состав может варьироваться в зависимости от требований заказчика и условий эксплуатации.

---

## 4. УСТРОЙСТВО И РАБОТА

### 4.1 Общее устройство

Quantum-PCI представляет собой PCIe карту с интегрированным высокоточным генератором времени, GNSS приемником и программируемой логической интегральной схемой (FPGA).

**Основные компоненты:**
- **FPGA**: управляет всеми функциями синхронизации времени
- **Генератор опорной частоты**: обеспечивает стабильную частоту для синхронизации
- **GNSS приемник**: получает сигналы спутниковых систем навигации
- **PCIe интерфейс**: обеспечивает связь с хост-системой
- **SMA разъемы**: для подключения внешних сигналов синхронизации

### 4.2 Принцип работы

**Алгоритм синхронизации:**
1. GNSS приемник получает сигналы спутников и генерирует 1PPS
2. FPGA сравнивает локальный генератор с GNSS сигналом
3. Система дисциплинирования корректирует частоту генератора
4. Синхронизированное время передается через PCIe в хост-систему
5. При потере GNSS сигнала система переходит в режим автономного хранения

**Режимы работы:**
- **Дисциплинированный режим**: активная синхронизация с GNSS
- **Автономный режим**: работа по внутреннему генератору
- **Режим калибровки**: настройка параметров синхронизации

**Интерфейсы и разъемы:**
- **PCIe**: x1 (18 контактов) поколения 2.0 или выше в форм-факторе x4
- **Выходные SMA**: PPS/10МГц 50 Ом, перестраиваемые 4 шт
- **Входные SMA**: PPS/10МГц 50 Ом, перестраиваемые 4 шт
- **Антенные разъемы**: 50 Ом (SMA) – 2 шт
- **Вход-выход**: IRIG-B, 50 Ом SMA
- **Вход-выход**: DCF77, 50 Ом SMA
- **Порт управления**: UDP, USB, PCIe
- **Последовательные порты**: GNSS, MAC, NMEA (UART)
- **I2C**: для управления внешними устройствами
- **SPI**: для работы с flash-памятью

#### Параметры входных сигналов

**Сигналы 1PPS (1 Гц) и Synch:**
- **Сопротивление нагрузки**: 50 Ом
- **Полярность импульса**: положительная
- **Длительность импульса на уровне 0,5**: в пределах (100-0,01) мс
- **Длительность фронта на уровне 0,1-0,9**: не более 10 нс
- **Уровень логической единицы**: не менее 2,0 В и не более 5 В
- **Уровень логического нуля**: не более 0,4 В

**Сигнал 10 МГц:**
- **Сопротивление нагрузки**: 50 Ом
- **Уровень логической единицы**: не менее 2,0 В и не более 5 В
- **Уровень логического нуля**: не более 0,4 В
- **Суммарное отклонение долговременной частотной стабильности за 1 час**: не более 1×10⁻⁹

#### Параметры выходных сигналов

**Сигналы 1PPS (1 Гц) и Synch:**
- **Сопротивление нагрузки**: 50 Ом
- **Полярность импульса**: положительная
- **Длительность импульса на уровне 0,5**: в пределах 100 мс
- **Длительность фронта на уровне 0,1-0,9**: не более 1 нс
- **Уровень логической единицы**: не менее 2,0 В и не более 5 В
- **Уровень логического нуля**: не более 0,4 В

**Сигнал 10 МГц:**
- **Сопротивление нагрузки**: 50 Ом
- **Уровень логической единицы**: не менее 2,0 В и не более 5 В
- **Уровень логического нуля**: не более 0,4 В

**Протоколы времени:**
- **PTP**: IEEE 1588-2008, IEEE 1588-2019
- **NTP**: RFC 5905, RFC 5906, RFC 5907
- **IRIG**: IRIG-B временные коды
- **TOD**: Time of Day
- **NMEA**: стандартные GNSS сообщения

**GNSS возможности:**
- **Приемники**: ГЛОНАСС/GPS/BeiDou
- **Режим приема**: выбор режима приема/приоритета
- **Количество приемников**: до 2 приемников на карту (в зависимости от заказа)
- **Типы приемников**: прецизионные и обычные модели
- **Защита от подмены**: защищен от явных подмен (spoofing) сигналов GNSS

#### Системные требования

**Операционные системы:**
- **Ubuntu**: 22.04 LTS, 24.04 LTS (рекомендуется)
- **Debian**: 12 (Bookworm), 13 (Trixie)
- **RHEL/CentOS Stream**: 9, 10
- **Fedora**: 40+, 41+
- **openSUSE**: Leap 15.5+, Tumbleweed
- **Ядро**: Linux ≥ 5.4 (рекомендуется 6.1+)

**Аппаратные требования:**
- **Процессор**: x86_64, ARM64
- **Память**: минимум 512 МБ RAM
- **Диск**: 100 МБ свободного места
- **PCIe**: слот x1 (электрически), совместим с x4/x8/x16 (механически)
- **Права**: root/`sudo` для установки драйверов и конфигурации

**Сетевые требования:**
- **Ethernet**: 1 Гбит/с (рекомендуется) с поддержкой hardware timestamping
- **Порты**: UDP 319 (PTP Event), UDP 320 (PTP General)
- **Multicast**: поддержка IGMP для PTP сообщений

#### Настройки BIOS/UEFI

**Обязательные настройки:**
- **Для Intel CPU**: 
  - VT-d (Virtualization Technology for Directed I/O)
  - VT-x (Virtualization Technology)
  - SR-IOV (Single Root I/O Virtualization)
- **Для AMD CPU**: 
  - IOMMU (Input-Output Memory Management Unit)
  - AMD-V (Virtualization)

**Рекомендуемые настройки:**
- **Power Management**: отключить C-states, P-states
- **CPU Frequency**: фиксированная частота (отключить Turbo Boost)
- **PCIe**: включить ASPM (Active State Power Management)
- **Secure Boot**: отключить для загрузки неподписанных модулей

#### Пакеты для сборки и работы

**Ubuntu/Debian:**
```bash
sudo apt-get update
sudo apt-get install -y \
    build-essential \
    linux-headers-$(uname -r) \
    libncurses-dev \
    flex \
    bison \
    openssl \
    vim \
    libssl-dev \
    dkms \
    libelf-dev \
    libudev-dev \
    libpci-dev \
    libiberty-dev \
    autoconf \
    zstd \
    linuxptp \
    chrony \
    ethtool \
    pciutils \
    kmod \
    i2c-tools \
    gpsd \
    gpsd-clients \
    python3-gps \
    tio \
    python3-pip
```

**RHEL/CentOS Stream/Fedora:**
```bash
# Для RHEL/CentOS Stream 9+
sudo dnf groupinstall -y "Development Tools"
sudo dnf install -y \
    kernel-devel \
    kernel-headers \
    ncurses-devel \
    flex \
    bison \
    openssl-devel \
    dkms \
    elfutils-libelf-devel \
    libudev-devel \
    pciutils-devel \
    autoconf \
    zstd \
    linuxptp \
    chrony \
    ethtool \
    pciutils \
    kmod \
    i2c-tools \
    gpsd \
    gpsd-clients \
    python3-gps \
    tio \
    python3-pip

# Для Fedora 40+
sudo dnf install -y \
    @development-tools \
    kernel-devel \
    kernel-headers \
    ncurses-devel \
    flex \
    bison \
    openssl-devel \
    dkms \
    elfutils-libelf-devel \
    libudev-devel \
    pciutils-devel \
    autoconf \
    zstd \
    linuxptp \
    chrony \
    ethtool \
    pciutils \
    kmod \
    i2c-tools \
    gpsd \
    gpsd-clients \
    python3-gps \
    tio \
    python3-pip
```

#### Конфигурация ядра (для оптимальной работы)

**Обязательные модули ядра:**
```
CONFIG_I2C_XILINX=m
CONFIG_MTD=y
CONFIG_MTD_SPI_NOR=m
CONFIG_SPI=y
CONFIG_SPI_ALTERA=m
CONFIG_SPI_BITBANG=m
CONFIG_SPI_MASTER=y
CONFIG_SPI_MEM=y
CONFIG_SPI_XILINX=m
CONFIG_I2C=y
CONFIG_I2C_OCORES=m
CONFIG_IKCONFIG=y
CONFIG_EEPROM_AT24=m
```

**PTP и временная синхронизация:**
```
CONFIG_PTP_INTEL_PMC_TGPIO=y    # TGPIO поддержка
CONFIG_PCIE_PTM=y               # PTM поддержка
CONFIG_PTP_1588_CLOCK=y         # PTP подсистема
CONFIG_PPS=y                    # Pulse Per Second
CONFIG_PPS_CLIENT_LDISC=y       # PPS line discipline
CONFIG_PTP_OCP=y                # PTP OCP драйвер (если встроен в ядро)
CONFIG_PTP_SYNC=y               # PTP синхронизация
CONFIG_PTP_DEBUGFS=y            # PTP debugfs поддержка
```

**Сетевые возможности:**
```
CONFIG_NETWORK_FILESYSTEMS=y
CONFIG_NFS_FS=y
CONFIG_CIFS=y
CONFIG_IP_MULTICAST=y
CONFIG_IP_MROUTE=y
```

**Real-time возможности:**
```
CONFIG_PREEMPT=y                # Preemptible kernel
CONFIG_HIGH_RES_TIMERS=y        # High resolution timers
CONFIG_NO_HZ=y                  # Tickless system
CONFIG_CPU_FREQ_GOV_PERFORMANCE=y
```

#### Совместимость и ограничения

**Поддерживаемые стандарты:**
- **PTP**: IEEE 1588-2008, IEEE 1588-2019
- **NTP**: RFC 5905, RFC 5906, RFC 5907
- **GNSS**: GPS, GLONASS, Galileo, BeiDou
- **Временные коды**: IRIG-B, DCF77, SMPTE
- **Сетевые**: Ethernet 10/100/1000 Мбит/с

---

### 4.3 Меры безопасности

#### Соответствие стандартам безопасности

**4.1.1** Сервер точного времени Quantum-PCI соответствует общим требованиям безопасности по ГОСТ Р 51350-99.

**4.1.2** По способу защиты человека от поражения электрическим током сервер соответствует классу II по ГОСТ Р 51350-99.

**4.1.3** Испытания, наладка, ввод в эксплуатацию и эксплуатация сервера должны производиться с учетом требований безопасности, изложенных в ГОСТ 12.3.019.

**4.1.4** При эксплуатации сервера должны выполняться общие требования пожарной безопасности.

**4.1.5** Качество воздуха рабочей зоны при эксплуатации сервера должно соответствовать требованиям ГОСТ 12.1.005.

#### Требования к установке и эксплуатации

**4.1.6** Антенна и антенный кабель сервера должны иметь молниезащиту.

**4.1.7** Сервер должен быть заземлен.

**4.1.8** До начала работы с сервером внимательно изучите настоящее руководство.

**4.1.9** Если сервер подвергался воздействию низких температур, то перед включением необходимо выдержать его в рабочих условиях не менее 2 часов.

**4.1.10** Сервер должен быть заземлен в составе сервера через клемму заземления.

#### Требования к антенной системе

**4.1.11** Рекомендуется использовать антенну ГЛОНАСС/GPS/Beidou с длиной кабеля РК50-3-34/35 (до 80 м) или РК50-7-311/314 (до 180м).

**4.1.12** Антенна должна устанавливаться в зоне защиты молниеотвода и иметь встроенный, а, при значительной длине кабеля, и внешний грозоразрядник.

**4.1.13** Заземление антенны и грозоразрядника следует выполнять отдельной, изолированной от молниеотвода, медной шиной сечением не менее 4 кв.мм.

**4.1.14** Конус обзора антенны в верхней полусфере шириной 120º должен быть свободен от соседних зданий («открытое» небо).

**4.1.15** Не следует устанавливать антенну в створе главного лепестка других передающих антенн.

**4.1.16** Вода с кровли не должна стекать на антенну и кабели. После подключения к антенне ВЧ кабеля, герметизируйте стыки разъемов клейкой лентой для герметизации.

#### Общие требования безопасности

- Перед установкой отключайте питание сервера и используйте антистатические средства.
- Избегайте изгиба платы, усилий на разъемы и кабели.
- При работе с прошивками используйте стабильное питание и не прерывайте процесс записи.

---

### 4.4 Описание изделия и архитектура

#### Структурная схема сервера времени

Quantum-PCI представляет собой PCIe‑карту высокоточной синхронизации, обеспечивающую:

**Основные компоненты:**
- **Управляющая материнская плата (HW)** с набором расширяемых интерфейсных плат
- **Приемник ГНСС** для получения опорного времени от спутников
- **Платы генератора** с различными типами опорных генераторов
- **Платы ПЛИС** для обработки временных сигналов

**Архитектура системы:**
- **Полезная нагрузка**: точное время с системой интерполяции, управляемой локальным генератором
- **Доставка**: механизм хранения времени с наносекундной точностью между последовательными сигналами PPS
- **ПЛИС (FPGA)**: основная логика механизма времени, включающая:
  - Различные фильтры
  - Механизмы синхронизации
  - Проверку ошибок
  - Отметку времени
  - Подсистемы, связанные с PCIe

**Принцип работы:**
1. **Приемник GNSS** обеспечивает ToD (Time of Day) в дополнение к сигналу 1 PPS
2. **Механизм определения времени** интерполирует последовательные импульсы PPS с наносекундной точностью
3. **В случае потери приема GNSS** механизм полагается на текущую синхронизацию атомных часов на основе усредненного набора последовательных импульсов PPS
4. **Управляющая PCIe плата** работает под управлением ПЛИС и совместима с операционной системой Linux
5. **Настройка изделия** может быть произведена удаленно с помощью терминала и встроенного WEB-интерфейса

**Технические возможности:**
- Аппаратные часы PHC, доступные в Linux как `/dev/ptpX`
- Вход/выход сигналов точного времени (1PPS и 10MHz) через SMA‑разъемы
- Интерфейсы временных кодов (IRIG‑B/DCF)
- Дисциплинирование высокостабильного генератора от GNSS или внешних опор
- **PTM (Precision Time Measurement)**: поддержка PCIe PTM для высокоточной синхронизации
- **TGPIO (Time-Aware GPIO)**: временно-управляемые GPIO для прецизионного вывода сигналов
- **Модульная конструкция**: упрощает ремонт и модернизацию сервера

#### Типы внутренних генераторов (Хранитель времени)

Quantum-PCI поддерживает различные типы высокостабильных генераторов в зависимости от требований к точности и стоимости:

**1. QUANTUM-Q-01 (Кварцевый генератор)**
- **Тип**: Кварцевый OCXO
- **Частотная стабильность**: ±5,00E-9 (±5 ppb) [-40...+85°C]
- **Частотный дрейф за сутки**: ±7,00E-10 (±0,7 ppb)
- **Уход времени в автономном режиме**: не более ±1.8 мкс в сутки
- **Старение за 1 год**: ±8,00E-8 (±80 ppb)
- **Срок службы**: 20 лет
- **Время прогрева**: 150 сек
- **Применение**: стандартные требования к точности времени

**2. QUANTUM-Q-02 (Кварцевый генератор)**
- **Тип**: Кварцевый OCXO
- **Частотная стабильность**: ±2,50E-8 (±25 ppb) [-40...+85°C]
- **Частотный дрейф за сутки**: ±2,00E-9 (±2 ppb)
- **Уход времени в автономном режиме**: не более ±22 мкс в сутки
- **Старение за 1 год**: ±1,00E-6 (±1 ppm)
- **Срок службы**: 20 лет
- **Время прогрева**: 180 сек
- **Применение**: экономичные решения с базовыми требованиями к точности

**3. QUANTUM-Q-03 (Высокоточный кварцевый генератор)**
- **Тип**: Кварцевый OCXO
- **Частотная стабильность**: ±5,00E-10 (±0,5 ppb) [-40...+85°C]
- **Частотный дрейф за сутки**: ±2,00E-11 (±0,02 ppb)
- **Уход времени в автономном режиме**: не более ±1.5 мкс в сутки
- **Старение за 1 год**: ±2,50E-8 (±25 ppb)
- **Срок службы**: 10 лет
- **Время прогрева**: 180 сек
- **Применение**: высокоточные системы с требованиями к стабильности

**4. QUANTUM-R-01 (Рубидиевый стандарт)**
- **Тип**: Рубидиевый стандарт частоты
- **Частотная стабильность**: ≤1,00E-10 (±0,1 ppb) [-10...+75°C]
- **Частотный дрейф за сутки**: <1,00E-12 (±1 ppt)
- **Уход времени в автономном режиме**: не более ±0.3 мкс в сутки
- **Старение за 1 год**: <5,00E-10 (±0,5 ppb)
- **Срок службы**: 20 лет
- **Время прогрева**: <480 сек
- **Рабочая температура**: -40°C до +75°C
- **Применение**: высокоточные системы с максимальными требованиями к стабильности

**5. QUANTUM-C-01 (Цезиевый стандарт)**
- **Тип**: Цезиевый стандарт частоты
- **Частотная стабильность**: ±5,00E-10 (±0,5 ppb) [-10...+70°C]
- **Частотный дрейф за сутки**: <3,00E-11 (±10 ppt)
- **Уход времени в автономном режиме**: не более ±0.1 мкс в сутки
- **Старение за 1 год**: <1,00E-6 (±1 ppm)
- **Срок службы**: 10 лет
- **Время прогрева**: <180 сек
- **Рабочая температура**: -10°C до +70°C
- **Применение**: системы с максимальными требованиями к точности

**Выбор типа генератора:**
- **QUANTUM-Q-01**: Кварцевый генератор (стандартная поставка) - ±1.8 мкс в сутки
- **QUANTUM-Q-02**: Кварцевый генератор (экономичная поставка) - ±22 мкс в сутки
- **QUANTUM-Q-03**: Высокоточный кварцевый генератор (премиум поставка) - ±1.5 мкс в сутки
- **QUANTUM-R-01**: Рубидиевый стандарт (поставка под заказ) - ±0.3 мкс в сутки
- **QUANTUM-C-01**: Цезиевый стандарт (поставка под заказ) - ±0.1 мкс в сутки

---

### 4.5 Интерфейсы и разъемы

#### PCIe интерфейс
- **Слот**: электрически x1 (механический разъем x4/x8/x16 совместим)
- **ОС**: Linux
- **Устройства в системе**: PHC `/dev/ptpX`, при наличии — PPS `/dev/ppsY`

#### SMA разъемы
Карта имеет **4 конфигурируемых SMA разъема** + **1 GNSS антенный вход**.

**Детальная конфигурация SMA разъемов:**
Изделие имеет 4 разъема SMA, которые могут быть сконфигурированы как выходы для различных устройств:
- **Выходные сигналы**: 10 МГц, PHC, MAC, GNSS, GNSS2, IRIG, DCF
- **Входные сигналы**: 10 МГц, PPS1, PPS2, TS1, TS2, IRIG, DCF

**Базовая конфигурация при старте:**
- **SMA1** (OUTPUT): Default FPGA PPS — выход PPS от FPGA (Time of the Local Clock via PPS Master)
- **SMA2** (OUTPUT): Default GNSS PPS — выход PPS от GNSS приемника
- **SMA3** (INPUT): Default PPS1 — вход опорного импульса 1PPS
- **SMA4** (INPUT): Default 10MHz — вход опорной частоты 10 МГц
- **GNSS**: SMA‑вход под активную GNSS антенну

**Дополнительные возможности конфигурации:**
- **Выходные сигналы**: GEN1, GEN2, GEN3, GEN4, GND, VCC
- **Входные сигналы**: TS3, TS4, FREQ1, FREQ2, FREQ3, FREQ4, None

#### Конфигурирование SMA
Направление (вход/выход) и назначение SMA разъемов может быть изменено через:
- **TC SMA Selector IP core** (2 AXI slaves)
- Интерфейс sysfs: `/sys/class/timecard/ocp0/sma*_in` и `/sys/class/timecard/ocp0/sma*_out`

Примеры команд конфигурирования:
```bash
# Просмотр доступных сигналов
cat /sys/class/timecard/ocp0/available_sma_inputs
cat /sys/class/timecard/ocp0/available_sma_outputs

# Настройка SMA1 как вход для 10MHz
echo "10MHz" > /sys/class/timecard/ocp0/sma1

# Настройка SMA4 как выход PPS (используем GNSS1 для PPS от GNSS)
echo "GNSS1" > /sys/class/timecard/ocp0/sma4

# Проверка текущей конфигурации
cat /sys/class/timecard/ocp0/sma1
cat /sys/class/timecard/ocp0/sma4
```

#### Рекомендации по подключению
- Используйте **50‑омные коаксиальные кабели** и качественные переходники
- Соблюдайте согласование и уровни сигналов
- Избегайте длинных трасс возле ВЧ‑источников помех
- Для точных измерений учитывайте задержки кабелей и калибруйте их через sysfs

#### Тестирование сигналов с помощью осциллографа

**Подготовка к тестированию:**

1. **Включите сервер** и убедитесь, что драйвер загружен:
```bash
lsmod | grep ptp_ocp
ls /sys/class/timecard/ocp0/
```

2. **Настройте выходные сигналы** для тестирования:
```bash
# Переход в директорию sysfs
cd /sys/class/timecard/ocp0

# Настройка всех SMA выходов на 10 МГц для тестирования
echo "10Mhz" > sma1
echo "10Mhz" > sma2
echo "10Mhz" > sma3
echo "10Mhz" > sma4

# Проверка конфигурации
cat sma1 sma2 sma3 sma4
```

3. **Настройка осциллографа:**
   - **Полоса пропускания**: не менее 100 МГц
   - **Частота дискретизации**: не менее 1 ГС/с
   - **Входное сопротивление**: 50 Ом
   - **Связь**: DC
   - **Пороговые уровни**: Tr=30%, Tf=70%

**Тестирование сигнала 10 МГц:**

4. **Подключение осциллографа:**
   - Подключите коаксиальный кабель 50 Ом к SMA разъему
   - Второй конец подключите к входу осциллографа
   - Убедитесь в надежности соединений

5. **Настройка осциллографа для 10 МГц:**
   - **Временная база**: 10 нс/дел
   - **Вольтовая база**: 1 В/дел
   - **Триггер**: по фронту, уровень 2.5 В
   - **Режим**: автоматический

6. **Критерии правильности сигнала 10 МГц:**
   - **Частота**: 10,000,000 ± 0.1 Гц
   - **Амплитуда**: 2.0-5.0 В (логическая единица)
   - **Уровень нуля**: не более 0.4 В
   - **Длительность фронта (10%-90%)**: не более 1 нс
   - **Длительность спада (90%-10%)**: не более 1 нс
   - **Джиттер**: не более 100 пс RMS
   - **Скважность**: 50% ± 5%

**Тестирование сигнала 1PPS:**

7. **Настройка выходов на 1PPS:**
```bash
echo "PHC" > sma1    # PPS от FPGA
echo "GNSS1" > sma2  # PPS от GNSS
echo "PHC" > sma3    # PPS от FPGA
echo "GNSS1" > sma4  # PPS от GNSS
```

8. **Настройка осциллографа для 1PPS:**
   - **Временная база**: 100 мс/дел
   - **Вольтовая база**: 1 В/дел
   - **Триггер**: по фронту, уровень 2.5 В
   - **Режим**: одиночный захват

9. **Критерии правильности сигнала 1PPS:**
   - **Период**: 1.000000 ± 0.000001 сек
   - **Амплитуда**: 2.0-5.0 В (логическая единица)
   - **Уровень нуля**: не более 0.4 В
   - **Длительность импульса**: 100 мс ± 10 мс
   - **Длительность фронта (10%-90%)**: не более 1 нс
   - **Длительность спада (90%-10%)**: не более 1 нс
   - **Джиттер**: не более 1 нс RMS

**Тестирование входных сигналов:**

10. **Настройка входов:**
```bash
echo "10MHz" > sma1
echo "PPS1" > sma2
```

11. **Подача тестовых сигналов:**
    - Используйте генератор сигналов с параметрами согласно техническим требованиям
    - Подайте сигнал 10 МГц на SMA1
    - Подайте сигнал 1PPS на SMA2

12. **Проверка принятия сигналов:**
```bash
# Проверка статуса входных сигналов
cat clock_source
cat gnss_sync

# Мониторинг через PTP
sudo phc_ctl /dev/ptp0 cmp
```

**Диагностика проблем:**

13. **Типичные проблемы и решения:**
    - **Нет сигнала**: проверьте подключение, настройки sysfs
    - **Неправильная амплитуда**: проверьте согласование 50 Ом
    - **Высокий джиттер**: проверьте качество кабелей, заземление
    - **Искажения формы**: проверьте полосу пропускания осциллографа

14. **Документирование результатов:**
    - Зафиксируйте все измеренные параметры
    - Сделайте скриншоты осциллограмм
    - Запишите отклонения от нормы
    - Укажите используемое оборудование

**Требования к измерительному оборудованию:**
- **Осциллограф**: полоса не менее 100 МГц, вход 50 Ом
- **Генератор сигналов**: точность частоты не хуже 1×10⁻⁶
- **Кабели**: 50 Ом, низкие потери на частоте 10 МГц
- **Переходники**: качественные SMA-BNC или SMA-N

> **Примечание:** Для более детального анализа временных характеристик, измерения джиттера, фазового шума и температурной стабильности см. раздел [6.5 Расширенное тестирование с осциллографом](#65-расширенное-тестирование-с-осциллографом).

---

### 4.6 Световая индикация

Карта имеет 4 светодиода (LED1-LED4), которые управляются непосредственно FPGA и показывают состояние различных компонентов:

#### Назначение светодиодов
- **LED1**: Индикатор работы FPGA — мигает с частотой внутренних часов FPGA (50MHz)
- **LED2**: Индикатор тактирования PCIe — мигает с частотой PCIe clock (62.5MHz)  
- **LED3**: PPS от FPGA — мигает синхронно с 1PPS от локальных часов (PPS Master)
- **LED4**: PPS от MAC — мигает синхронно с 1PPS от MAC (через дифференциальный буфер)

#### Диагностика по светодиодам
**Нормальная работа:**
- LED1: быстрое мигание (50MHz) — FPGA работает
- LED2: быстрое мигание (62.5MHz) — PCIe тактирование в норме
- LED3: мигание 1 раз в секунду — PPS от FPGA генерируется
- LED4: мигание 1 раз в секунду — PPS от MAC поступает

**Проблемы:**
- LED1 не мигает — проблема с FPGA или питанием
- LED2 не мигает — проблема с PCIe тактированием
- LED3 не мигает — нет PPS от локальных часов FPGA
- LED4 не мигает — нет PPS от MAC или проблема с входным сигналом

#### Проверка через команды
```bash
# Проверка состояния через dmesg
dmesg | grep -i "ptp_ocp\|led"

# Проверка PPS сигналов
cat /sys/class/timecard/ocp0/clock_source
cat /sys/class/timecard/ocp0/gnss_sync

# Проверка PTP устройства
ls -la /dev/ptp*
```

**Примечание**: Светодиоды подключены напрямую к FPGA (не через AXI GPIO Ext), поэтому их состояние отражает аппаратную работу компонентов в реальном времени.

---

### 4.7 Ресурсы, сроки службы и хранения и гарантии изготовителя (поставщика)

#### 4.7.1. Ресурсы, сроки службы и хранения

**4.7.1.1** Срок службы – 10 лет с момента приемки представителем ОТК на предприятии-изготовителе.

**4.7.1.2** Указанные срок службы и срок хранения действительны при соблюдении потребителем требований настоящего паспорта.

#### 4.7.2. Гарантии изготовителя (поставщика)

**4.7.2.1** Предприятие-изготовитель (поставщик) гарантирует соответствие требований при соблюдении потребителем условий и правил хранения, транспортирования и эксплуатации, установленных настоящим паспортом.

**4.7.2.2** Гарантийный срок эксплуатации – пять лет с момента ввода блока в эксплуатацию.

**4.7.2.3** Гарантийный срок хранения, предшествующий гарантийному сроку эксплуатации – три года с момента приемки изделия на предприятии-изготовителе.

**4.7.2.4** Предприятие изготовитель (поставщик) в пределах срока действия гарантий поставщика производит безвозмездное восстановление.

---

### 4.8 Режимы работы и сценарии эксплуатации

#### Режимы работы

- **Режим Grandmaster**: карта синхронизирована от GNSS или внешнего 1PPS/10MHz и раздаёт время по PTP.
- **Режим Ordinary/Slave**: карта принимает время по PTP, может копировать PHC → системные часы.
- **Режим Boundary**: при наличии нескольких интерфейсов может ретранслировать время между сегментами сети.
- **Удержание (holdover)**: при потере опоры поддерживается стабильность за счёт OCXO/CSAC; длительность и точность зависят от аппаратуры.

#### Типовые сценарии эксплуатации

**1) Grandmaster с GNSS:**
   - Подключите GNSS‑антенну, дождитесь фиксирования.
   - Настройте PTP‑домен и приоритеты в `ptp4l` для роли мастера.
   - Пример (фрагмент `ptp4l.conf`):

```ini
[global]
time_stamping         hardware
twoStepFlag           1
domainNumber          0
gmCapable             1
priority1             10
priority2             10
```

**2) Клиент PTP (Ordinary/Slave):**
   - Используйте запуск из раздела 15; PHC → системные часы через `phc2sys`.

**3) Внешняя опора 10MHz/1PPS:**
   - Подайте сигналы на входные SMA, включите соответствующий режим в прошивке/настройках.
   - Проверьте стабильность и задержки по журналам `ptp4l`/`phc2sys`.

#### Контрольные вопросы
- [ ] Какой режим работы подходит для вашей сети?
- [ ] Есть ли доступ к GNSS сигналу?
- [ ] Какие внешние источники времени доступны?

---

### 4.9 Базовая конфигурация FPGA

При инициализации карты **TC ConfMaster** автоматически применяет базовую конфигурацию из файла `DefaultConfigFile.txt`. Эта конфигурация включает:

#### Компоненты, настраиваемые при старте

| **IP Core**          | **Конфигурация при старте**                                    |
|----------------------|---------------------------------------------------------------|
| **Adjustable Clock** | Включен с источником синхронизации 1 (ToD+PPS)               |
| **PPS Generator**     | Включен с высокой полярностью выходного импульса             |
| **PPS Slave**         | Включен с высокой полярностью входного импульса              |
| **ToD Slave**         | Включен с высокой полярностью UART входа                     |
| **SMA Selector**      | Настроен на вывод FPGA PPS и GNSS PPS через SMA разъемы     |

#### Проверка базовой конфигурации

```bash
# Проверка источника синхронизации
cat /sys/class/timecard/ocp0/clock_source

# Проверка доступных источников
cat /sys/class/timecard/ocp0/available_clock_sources

# Проверка конфигурации SMA
cat /sys/class/timecard/ocp0/sma3  # должно показать "10MHz"
cat /sys/class/timecard/ocp0/sma4  # должно показать "PPS"

# Проверка статуса PPS генератора
cat /sys/class/timecard/ocp0/pps_generator_enable 2>/dev/null || echo "PPS generator status not available"
```

#### Изменение базовой конфигурации

Для изменения конфигурации по умолчанию можно:

1. **Через sysfs интерфейс** (временно, до перезагрузки):
```bash
# Изменение источника синхронизации
echo "GNSS" > /sys/class/timecard/ocp0/clock_source

# Переназначение SMA выходов
echo "IRIG" > /sys/class/timecard/ocp0/sma3
echo "DCF" > /sys/class/timecard/ocp0/sma4
```

2. **Через модификацию прошивки** (постоянно):
   - Изменить `DefaultConfigFile.txt` в прошивке
   - Перепрошить карту с новой конфигурацией

#### Сброс к базовой конфигурации

```bash
# Перезагрузка драйвера для применения базовой конфигурации
sudo rmmod ptp_ocp
sudo modprobe ptp_ocp

# Или полная перезагрузка системы
sudo reboot
```

### 4.10 Технические примечания

- Количество и назначение SMA‑портов могут отличаться по ревизиям; уточняйте маркировку на панели.
- Экспорт признака високосной секунды и дополнительные каналы (IRIG‑B, DCF77, SMPTE) зависят от прошивки.
- Для критичных применений рекомендуется резервирование опор времени и регулярная калибровка задержек кабелей.
- Базовая конфигурация применяется автоматически, но может быть изменена через sysfs или модификацией прошивки.

---

### 4.11 Установка платы и первичная проверка

1) **Подготовка системы**: убедитесь, что в BIOS включены VT-d/IOMMU (см. раздел 3).

2) **Проверка информации о системе** (полезно для диагностики):
```bash
# Информация о материнской плате
sudo dmidecode -t baseboard

# Информация о системе
sudo dmidecode -t system
```

3) Установите плату в совместимый слот PCIe и зафиксируйте винтом.
4) Подключите GNSS‑антенну (если предусмотрено) согласно маркировке.
5) Включите сервер и в Linux проверьте обнаружение устройства:

```bash
# Проверка обнаружения карты
sudo lspci -nn | grep -i 'ptp\|time\|quantum\|xilinx\|fpga' || true

# Детальная информация о карте (после загрузки драйвера)
sudo lspci -vvv | grep -A 20 -B 5 "ptp_ocp"

# Проверка поддержки PTM
sudo lspci -vvv | grep -A 10 "Precision Time Measurement"
```

6) **Проверка PTM поддержки** (если доступно):
```bash
# Поиск PTM возможностей
sudo lspci -vvv | grep -A 5 "PTMCap"
```

Ожидаемый вывод для карты с PTM:
```
PTMCap: Requester:+ Responder:- Root:-
PTMClockGranularity: 8ns
PTMControl: Enabled:+ RootSelected:-
PTMEffectiveGranularity: 4ns
```

Сверьтесь с `ДРАЙВЕРА/ТAБЛИЦА_СООТВЕТСТВИЯ_PCI.md` и `ДРАЙВЕРА/СОПОСТАВЛЕНИЕ_PCI_ДРАЙВЕРА.md` при необходимости.

---

### 4.12 Установка и загрузка драйвера

#### 4.12.1. Установка системы и настройка (CentOS)

**Для использования Quantum-PCI требуется система со слотом PCIe.**

##### Настройки BIOS

Включите виртуализацию ввода-вывода вашего процессора в BIOS:
- **Для процессоров Intel**: включить VT-d или VT-x
- **Для процессоров AMD**: включить IOMMU

##### Настройка операционной системы и установка драйвера (CentOS)

**Шаг 1: Подготовка системы**
```bash
# Переход в папку с установочными файлами
cd ~/Quantum
```

**Шаг 2: Установка последних ключей ядра**
```bash
# Для RHEL/CentOS Stream 9+
sudo dnf -y install https://www.elrepo.org/elrepo-release-9.el9.elrepo.noarch.rpm
sudo rpm --import https://www.elrepo.org/RPM-GPG-KEY-elrepo.org
dnf --enablerepo=elrepo-kernel install kernel-ml
reboot

# Для Ubuntu/Debian (альтернативный способ)
# sudo apt install -y linux-image-generic linux-headers-generic
```

**Шаг 3: Установка необходимых пакетов**
```bash
# Для RHEL/CentOS Stream 9+
dnf install -y ncurses-devel make gcc bc bison flex elfutils-libelf-devel openssl-devel grub2 i2c-tools git

# Для Ubuntu/Debian
# sudo apt install -y build-essential linux-headers-$(uname -r) libncurses-dev libssl-dev i2c-tools git
```

**Шаг 4: Загрузка полного исходного кода ядра**
```bash
cd /usr/src/kernels
wget https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-6.15.11.tar.xz
tar -xvf linux-6.15.11.tar.xz
rm linux-6.15.11.tar.xz
mv linux-6.15.11/ 6.15.11/
cd 6.15.11/
```

**Шаг 5: Копирование существующей конфигурации ядра**
```bash
cp -v /boot/config-6.15.11-1.el9.elrepo.x86_64 .config
vim .config
# Вам нужно будет отредактировать .config и указать вновь установленное ядро
```

**Шаг 6: Изменение параметров сборки ядра в .config**
```bash
# Добавьте следующие параметры в .config:
CONFIG_I2C_XILINX=m
CONFIG_MTD=m
CONFIG_MTD_SPI_NOR=m
CONFIG_SPI=y
CONFIG_SPI_ALTERA=m
CONFIG_SPI_BITBANG=m
CONFIG_SPI_MASTER=y
CONFIG_SPI_MEM=y
CONFIG_SPI_XILINX=m
CONFIG_I2C=y
CONFIG_I2C_OCORES=m
CONFIG_IKCONFIG=y
CONFIG_EEPROM_AT24=m

# Затем выполните:
make oldconfig
# Ответьте на y или n на все вопросы
```

**Шаг 7: Применение патчей**
```bash
patch -p1 < ~/Time-Appliance-Project/Time-Card/DRV/0001-spi-xilinx-Inhibit-transmitter-while-filling-TX-FIFO.patch
patch -p1 < ~/Quantum/Time-Card/DRV/0001-spi-nor-Send-soft-reset-before-probing-flash.patch
```

**Шаг 8: Сборка и установка ядра**
```bash
make bzImage -j4
make modules -j4
make -j4
make INSTALL_MOD_STRIP=1 modules_install
make install
reboot
```

**Шаг 9: Включение всех периферийных устройств UART**
```bash
grubby --update-kernel=ALL --args=8250.nr_uarts=8
reboot
```

**Шаг 10: Подтверждение перечисления всех включенных периферийных устройств UART**
```bash
cat /proc/cmdline
# Пример вывода:
# BOOT_IMAGE=(hd1,gpt2)/vmlinuz-5.16.0 root=/dev/mapper/cs-root ro crashkernel=auto resume=/dev/mapper/cs-swap rd.lvm.lv=cs/root rd.lvm.lv=cs-swap rhgb quiet 8250.nr_uarts=8
```

**Шаг 11: Установка драйверов**
```bash
cd ~/Quantum/Time-Card/DRV/
./remake
modprobe ptp_ocp
```

**Шаг 12: Подтверждение установки**
Просмотрите выходные данные dmesg, чтобы подтвердить, что устройство Time Card установлено и драйвер ядра успешно перечислил устройство.

**Пример вывода, подтверждающий ptp_ocp драйвер ядра:**
```
[ 1491.440223] 0000:02:00.0: ttyS5 at MMIO 0x70161000 (irq = 180, base_baud = 3125000) is a 16550A
[ 1491.440278] 0000:02:00.0: ttyS6 at MMIO 0x70171000 (irq = 181, base_baud = 3125000) is a 16550A
[ 1491.440322] 0000:02:00.0: ttyS7 at MMIO 0x70181000 (irq = 182, base_baud = 3125000) is a 16550A
[ 1491.440362] 0000:02:00.0: ttyS0 at MMIO 0x70191000 (irq = 187, base_baud = 3125000) is a 16550A
[ 1491.441702] xilinx_spi xilinx_spi.1024: at [mem 0x70310000-0x7031ffff], irq=186
[ 1491.442678] spi-nor spi1024.0: n25q128a13 (16384 Kbytes)
[ 1491.447310] pps pps1: new PPS source ptp2
[ 1491.449374] ptp_ocp 0000:02:00.0: Version 1.2.0, clock PPS, device ptp2
[ 1491.449388] ptp_ocp 0000:02:00.0: Time: 1647548640.775286647, in-sync
[ 1491.449390] ptp_ocp 0000:02:00.0: version 8005
[ 1491.449392] ptp_ocp 0000:02:00.0: regular image, version 32773
[ 1491.449393] ptp_ocp 0000:02:00.0: GNSS: /dev/ttyS5 @ 115200
[ 1491.449394] ptp_ocp 0000:02:00.0: GNSS2: /dev/ttyS6 @ 115200
[ 1491.449396] ptp_ocp 0000:02:00.0: MAC: /dev/ttyS7 @ 57600
[ 1491.449399] ptp_ocp 0000:02:00.0: NMEA: /dev/ttyS0 @ 115200
```

**Шаг 13: Использование**
Карта учета рабочего времени подключается через sysfs.

**Просмотр всех sysfs представленных параметров:**
```bash
ls /sys/class/timecard/ocp0/
```

Дополнительные устройства для учета рабочего времени будут перечислены в порядке `ocpN`, где N указан порядок устройств.

**Последовательные порты и номер PHC:**
Последовательные порты и номер PHC можно найти через dmesg или ls -l.

**Шаг 14: Использование ввода-вывода Quantum-PCI**

**Выходные данные:**
Все возможные результаты доступны через `available_sma_outputs`:
```bash
cat available_sma_outputs
```

Отобразит все возможные типы выходных данных, такие как:
10Mhz PHC MAC GNSS1 GNSS2 IRIG DCF GEN1 GEN2 GEN3 GEN4 GND VCC

**Примеры настройки выходных сигналов:**
```bash
# Вывод PPS ПЛИС на SMA
echo "PHC" > sma1

# Вывод PPS атомных часов на SMA
echo "MAC" > sma1

# Вывод PPS модуля GPS на SMA
echo "GNSS1" > sma1
```

**Входные данные:**
Все возможные входные данные доступны через `available_sma_inputs`:
```bash
cat available_sma_inputs
```

Отобразит все возможные типы входных данных, такие как:
10Mhz PPS1 PPS2 TS1 TS2 IRIG DCF TS3 TS4 FREQ1 FREQ2 FREQ3 FREQ4 None

**Настройка портов SMA:**
Используйте порт для ввода временных меток входящих сигналов, это настроено SMA1 с помощью timestamper-1 TS1:
```bash
echo "TS1" > sma1
```

**Для обратного считывания сигналов с отметкой времени используйте testptp:**
```bash
# Загрузить testptp исходный код
# Источник доступен в этих местах:
# https://www.mjmwired.net/kernel/Documentation/ptp/testptp.c
# https://github.com/torvalds/linux/blob/master/tools/testing/selftests/ptp/testptp.c

# Считывание сигналов с отметкой времени
# Примечание: -1 для начальных показаний используйте положительное число для фиксированного количества событий, начиная с Timestamper 1 -i 1 с временной карты /dev/ptp1
./testptp -d /dev/ptp1 -e -1 -i 1
```

#### 4.12.2. Установка и загрузка драйвера (Ubuntu)

Исходники и готовые артефакты расположены в каталоге `ДРАЙВЕРА/` (файлы `ptp_ocp.c`, `ptp_ocp.ko`, `Makefile` и др.).

- **Установка зависимостей (Ubuntu):**

```bash
sudo apt update
sudo apt install -y build-essential linux-headers-$(uname -r) ethtool linuxptp chrony pciutils dkms kmod
```

- **Сборка (если требуется):**

```bash
cd ДРАЙВЕРА
make -j"$(nproc)"
```

- **Загрузка модуля (временная, до перезагрузки):**

```bash
cd ДРАЙВЕРА
sudo insmod ptp_ocp.ko 2>/dev/null || sudo modprobe ptp_ocp
```

- **Автозагрузка модуля (после перезагрузки):**

```bash
echo ptp_ocp | sudo tee /etc/modules-load.d/quantum-pci.conf
```

- **Проверка статуса драйвера:**

```bash
lsmod | grep ptp_ocp || true
dmesg -T | grep -i ptp_ocp || true
ls -l /dev/ptp*
```

Если используется Secure Boot, может потребоваться подпись модуля и регистрация ключа (MOK). Обратитесь к документации дистрибутива.

— Подпись модуля для Secure Boot (Ubuntu):

```bash
# 1) Создаём ключи
sudo mkdir -p /root/module-signing
cd /root/module-signing
openssl req -new -x509 -newkey rsa:2048 -keyout MOK.priv -outform DER -out MOK.der -nodes -days 36500 -subj "/CN=PTP OCP Module/"

# 2) Регистрируем ключ (потребуется подтверждение при перезагрузке в MOK Manager)
sudo mokutil --import MOK.der
sudo reboot

# 3) Подписываем модуль после сборки
sudo /usr/src/linux-headers-$(uname -r)/scripts/sign-file sha256 \
  /root/module-signing/MOK.priv /root/module-signing/MOK.der \
  ДРАЙВЕРА/ptp_ocp.ko

# 4) Загружаем модуль
sudo insmod ДРАЙВЕРА/ptp_ocp.ko || sudo modprobe ptp_ocp
```

---


### 4.13 Работа с GNSS приемником

#### Описание GNSS модуля

**Базовый модуль изделия:**
- **Модуль времени ГНСС**: U-blox NEO-M9N
- **Поддерживаемые системы**: ГЛОНАСС/GPS/BeiDou
- **Разработка**: модули российской разработки (НАВИС, НАВИА, ГЕОСТАР) и иностранной u-blox (Швейцария)

**Продвинутые возможности:**
- **Обнаружение подмены**: защита от spoofing атак
- **Обнаружение спуффинга**: защита от подделки сигналов
- **Обнаружение помех**: защита от радиочастотных помех
- **Фильтр SAW**: в сочетании с усилителем входного сигнала (LNA) в радиочастотном спектре
- **Устойчивость к помехам**: нормальное функционирование даже при сильных радиочастотных помехах (например, при расположении модема сотовой связи рядом с модулем)

**Антенная система:**
- **Прием сигналов**: осуществляется на отдельную всепогодную наружную антенну
- **Подключение**: коаксиальным антенным кабелем к изделию
- **Требования к установке**: конус обзора антенны в верхней полусфере шириной 120° должен быть свободен от соседних зданий («открытое» небо)

**Возможности установки:**
- **Количество приемников**: до 2 приемников на карту (в зависимости от заказа)
- **Типы приемников**: прецизионные и обычные модели
- **Выбор режима**: выбор режима приема/приоритета
- **Совместимость**: возможность установки любого другого приемника при условии обеспечения вывода PPS и TOD в подходящем формате

После установки драйвера необходимо проверить и настроить работу с GNSS приемником (если присутствует на карте).

#### Проверка доступности GNSS портов

```bash
# Проверка доступных последовательных портов
ls -la /dev/ttyS* /dev/ttyGNSS* /dev/ttyMAC* /dev/ttyNMEA* 2>/dev/null

# Проверка связанных с картой портов (после загрузки драйвера)
find /sys/class/timecard/ocp* -name "tty*" -exec readlink {} \; 2>/dev/null
```

#### Метод 1: Использование gpsd (рекомендуется)

**Установка gpsd на Ubuntu:**

```bash
sudo apt update
sudo apt install gpsd gpsd-clients python3-gps
```

**Настройка и запуск:**

```bash
# Настройка скорости порта (обычно ttyS5 или ttyGNSS)
sudo stty -F /dev/ttyS5 speed 115200

# Запуск gpsd (замените /dev/ttyS5 на актуальный порт)
sudo gpsd /dev/ttyS5

# Проверка работы GNSS через cgps
cgps
```

**Пример вывода cgps при работающем GNSS:**
```
┌─────────────────────────────────────────────────┐
│    Time: 2024-01-15T12:34:56.000Z              │
│ Latitude:  55.123456789 N                      │
│Longitude:  37.987654321 E                      │
│ Altitude:    156.78 m                          │
│    Speed:      0.12 kph                        │
│  Heading:     45.6 deg (true)                  │
│    Climb:      0.0 m/min                       │
│   Status:      3D FIX (5 secs)                 │
│Satellites: 12 used, 15 in view                 │
└─────────────────────────────────────────────────┘
```

#### Метод 2: Прямое подключение через tio

**Установка tio на Ubuntu:**

```bash
sudo apt install tio
```

**Проверка сообщений GPS:**

```bash
# Мониторинг сообщений от GPS модуля
tio -b 115200 /dev/ttyS5

# Проверка NMEA сообщений от FPGA
tio -b 115200 /dev/ttyS7
```

**Пример NMEA сообщений:**
```
$GPGGA,123456.00,5512.34567,N,03759.87654,E,1,12,0.8,156.78,M,15.2,M,,*5A
$GPRMC,123456.00,A,5512.34567,N,03759.87654,E,0.12,45.6,150124,,,A*7B
$GPGSV,3,1,12,01,45,123,42,02,67,234,45,03,23,345,38,04,78,456,41*7C
```

Для выхода из tio нажмите `Ctrl+T`, затем `q`.

#### Метод 3: GUI инструмент pygpsclient

**Установка на Ubuntu:**

```bash
# Установка зависимостей
sudo apt update
sudo apt install python3 python3-pip python3-tkinter

# Обновление pip
python3 -m pip install --upgrade pip

# Установка необходимых библиотек
python3 -m pip install --upgrade Pillow
python3 -m pip install pygpsclient

# Для работы через VNC (если требуется удаленный доступ)
sudo apt install tigervnc-standalone-server tigervnc-xorg-extension
```

**Настройка VNC (если требуется удаленный GUI доступ):**

```bash
# Настройка VNC сервера
vncserver :1 -geometry 1024x768 -depth 24

# Установка пароля VNC (при первом запуске)
vncpasswd
```

**Запуск pygpsclient:**

```bash
# Локально (с GUI)
pygpsclient

# Через VNC
DISPLAY=:1 pygpsclient
```

#### Диагностика GNSS

**Проверка состояния GNSS через sysfs:**

```bash
# Проверка статуса GNSS синхронизации
cat /sys/class/timecard/ocp0/gnss_sync 2>/dev/null || echo "GNSS sysfs недоступен"

# Проверка источника времени
cat /sys/class/timecard/ocp0/clock_source 2>/dev/null || echo "Clock source недоступен"

# Проверка доступных источников времени
cat /sys/class/timecard/ocp0/available_clock_sources 2>/dev/null || echo "Available sources недоступны"

# Дополнительные атрибуты TOD (Time of Day)
cat /sys/class/timecard/ocp0/tod_protocol 2>/dev/null || echo "TOD protocol недоступен"
cat /sys/class/timecard/ocp0/available_tod_protocols 2>/dev/null || echo "Available TOD protocols недоступны"
cat /sys/class/timecard/ocp0/tod_baud_rate 2>/dev/null || echo "TOD baud rate недоступен"

# Проверка режима holdover
cat /sys/class/timecard/ocp0/holdover 2>/dev/null || echo "Holdover status недоступен"

# Статус дрейфа и смещения часов
cat /sys/class/timecard/ocp0/clock_status_drift 2>/dev/null || echo "Clock drift недоступен"
cat /sys/class/timecard/ocp0/clock_status_offset 2>/dev/null || echo "Clock offset недоступен"
```

**Возможные статусы GNSS:**
- `locked` - GNSS синхронизирован
- `unlocked` - GNSS не синхронизирован
- `holdover` - режим удержания времени

#### Устранение проблем с GNSS

**Частые проблемы:**

1. **GNSS порт не найден:**
```bash
# Проверка всех последовательных портов
dmesg | grep -i "tty\|uart\|serial"

# Проверка загруженного драйвера
lsmod | grep ptp_ocp
```

2. **Нет NMEA сообщений:**
```bash
# Проверка скорости порта
sudo stty -F /dev/ttyS5 -a

# Попробуйте разные скорости
for speed in 9600 38400 115200; do
    echo "Trying speed $speed"
    sudo stty -F /dev/ttyS5 speed $speed
    timeout 10s tio -b $speed /dev/ttyS5
done
```

3. **GNSS не получает фиксацию:**
   - Убедитесь, что GNSS антенна подключена и имеет питание
   - Проверьте, что антенна установлена с хорошим обзором неба
   - Дождитесь "холодного старта" (может занять до 15 минут)

#### Автоматизация запуска gpsd

**Создание systemd сервиса:**

```bash
sudo tee /etc/systemd/system/gpsd-timecard.service << EOF
[Unit]
Description=GPS daemon for TimeCard
After=network.target

[Service]
Type=forking
ExecStartPre=/bin/stty -F /dev/ttyS5 speed 115200
ExecStart=/usr/sbin/gpsd -n /dev/ttyS5
ExecReload=/bin/kill -HUP \$MAINPID
KillMode=mixed
Restart=on-failure

[Install]
WantedBy=multi-user.target
EOF

# Включение и запуск сервиса
sudo systemctl daemon-reload
sudo systemctl enable gpsd-timecard
sudo systemctl start gpsd-timecard

# Проверка статуса
sudo systemctl status gpsd-timecard
```

---

### 4.14 Настройка системного времени: варианты

- **PTP (linuxptp):** точная синхронизация через аппаратные метки времени (PHC, `/dev/ptpX`).
- **NTP (chrony/ntpd):** синхронизация с NTP‑серверами или локальным PHC как референсом.

Роль карты Quantum‑PCI:
- Предоставляет PHC‑часы (`/dev/ptpX`) и аппаратные метки времени для `ptp4l`.
- Может выступать как Grandmaster/Ordinary/Boundary в зависимости от конфигурации сети и прошивки.

---

### 4.15 Быстрый старт: PTP (linuxptp)

Установка:

```bash
sudo apt install -y linuxptp
```

Определите сетевой интерфейс с поддержкой аппаратной отметки (пример: `eno1`), проверьте возможности:

```bash
sudo ethtool -T eno1
```

Запуск `ptp4l` (Ordinary Clock, двухступенчатый, аппаратные метки):

```bash
sudo ptp4l -i eno1 -m -2 -s
# -m: лог в консоль, -2: two-step, -s: slaveOnly (пример для клиента)
```

Синхронизация системных часов от PHC:

```bash
sudo phc2sys -s /dev/ptp0 -c CLOCK_REALTIME -O 0 -m
```

Альтернативно указать интерфейс:

```bash
sudo phc2sys -s eno1 -c CLOCK_REALTIME -O 0 -m
```

Проверка статуса и параметров через `pmc`:

```bash
sudo pmc -u -b 0 'GET GRANDMASTER_SETTINGS_NP' 'GET TIME_STATUS_NP'
```

Пример минимального конфига `ptp4l` (создайте файл, например `/etc/linuxptp/ptp4l.conf`):

```ini
[global]
verbose               1
twoStepFlag           1
time_stamping         hardware
tx_timestamp_timeout  50
logging_level         6

[eno1]
network_transport     UDPv4
delay_mechanism       E2E
```

Запуск с конфигом:

```bash
sudo ptp4l -f /etc/linuxptp/ptp4l.conf -m
```

Автозапуск можно настроить через systemd‑юниты `ptp4l.service` и `phc2sys.service` (примеры в документации `linuxptp`).

---

### 4.17 Быстрый старт: NTP (chrony)

Установка:

```bash
sudo apt install -y chrony
```

**Вариант 1: Базовая конфигурация клиента NTP** (`/etc/chrony/chrony.conf`):

```conf
pool pool.ntp.org iburst
rtcsync
makestep 1.0 3
```

**Вариант 2: Использование локального PHC как референс** (при наличии GNSS/точного PHC):

**⚠️ ВАЖНО: Перед настройкой chrony с PHC необходимо настроить права доступа:**

```bash
# Настройка прав доступа для PTP устройств
sudo usermod -a -G ptp _chrony
sudo chgrp ptp /dev/ptp1
```

```conf
refclock PHC /dev/ptp0 poll 2 dpoll -2 offset 0.0 prefer
rtcsync
makestep 1.0 3
```

**Вариант 3: Прямая синхронизация PHC → система (рекомендуется)**

Согласно официальной документации Time Card, наиболее точный способ:

```bash
# Остановить конфликтующие службы
sudo systemctl stop systemd-timesyncd.service

# Установить PHC время от системного времени (однократно при первом запуске)
sudo phc_ctl /dev/ptp0 set

# Запустить непрерывную синхронизацию система ← PHC
sudo phc2sys -c CLOCK_REALTIME -s /dev/ptp0 -O 0 -R 16 -u 8 -m
```

При корректной работе PTM вывод `phc2sys` должен показывать **delay 0 +/-**:
```
phc2sys[4503.063]: CLOCK_REALTIME rms 26 max 40 freq -17250 +/- 17 delay 0+/- 0
phc2sys[4503.564]: CLOCK_REALTIME rms 46 max 85 freq -17346 +/- 17 delay 0+/- 0
```

Применение настроек и проверка (для вариантов 1-2):

```bash
sudo systemctl restart chrony
chronyc tracking
chronyc sources -v
```

**Важно**: избегайте одновременного управления временем несколькими службами. Отключите `systemd-timesyncd`:

```bash
sudo systemctl stop systemd-timesyncd
sudo systemctl disable systemd-timesyncd
```

---

### 4.17.1. Настройка прав доступа для PTP устройств

**Критически важно**: Для корректной работы chrony с PHC устройствами необходимо правильно настроить права доступа.

#### Проверка текущих прав доступа

```bash
# Проверка прав доступа к PTP устройствам
ls -la /dev/ptp*

# Проверка групп пользователя _chrony
id _chrony
```

**Ожидаемый результат:**
```
crw-rw---- 1 root ptp      246, 0 сен  8 11:59 /dev/ptp0
crw-rw-r-- 1 root ptpusers 246, 1 сен  8 11:59 /dev/ptp1
uid=122(_chrony) gid=124(_chrony) группы=124(_chrony),1001(ptpusers),1002(ptp)
```

#### Настройка прав доступа

```bash
# Добавление пользователя _chrony в группу ptp
sudo usermod -a -G ptp _chrony

# Изменение прав на PTP устройства (если необходимо)
sudo chgrp ptp /dev/ptp1

# Перезапуск chrony для применения изменений
sudo systemctl restart chrony
```

#### Проверка доступа пользователя _chrony

```bash
# Проверка доступа к PTP устройствам от имени пользователя _chrony
sudo -u _chrony testptp -d /dev/ptp0 -g
sudo -u _chrony testptp -d /dev/ptp1 -g
```

**Ожидаемый результат:** Команды должны выполниться без ошибок и показать время.

### 4.17.2. Выбор правильного PTP устройства

#### Определение PTP устройства, создаваемого драйвером

```bash
# Проверка, какое PTP устройство создает драйвер
sudo dmesg | grep ptp_ocp

# Проверка соответствия через sysfs
readlink /sys/class/timecard/ocp0/ptp
```

**Пример вывода dmesg:**
```
[   16.330257] ptp_ocp 0000:01:00.0: Version 1.4.0, clock TOD, device ptp1
```

**Пример вывода sysfs:**
```
../../ptp/ptp1
```

#### Рекомендации по выбору PTP устройства

- **`/dev/ptp0`** - обычно работает лучше с chrony, рекомендуется для NTP синхронизации
- **`/dev/ptp1`** - основное устройство, создаваемое драйвером, может требовать дополнительной настройки

#### Тестирование PTP устройств

```bash
# Проверка возможностей PTP устройств
sudo testptp -d /dev/ptp0 -c
sudo testptp -d /dev/ptp1 -c

# Проверка времени на PTP устройствах
sudo testptp -d /dev/ptp0 -g
sudo testptp -d /dev/ptp1 -g
```

### 4.17.3. Диагностика проблем с PHC в chrony

#### Типичные проблемы и решения

**Проблема 1: PHC показывает `?` (unusable) в `chronyc sources -v`**

**Причины:**
- Неправильные права доступа к PTP устройству
- Пользователь `_chrony` не в группе `ptp`
- Неправильный выбор PTP устройства

**Решение:**
```bash
# 1. Проверка прав доступа
ls -la /dev/ptp*
id _chrony

# 2. Настройка прав доступа
sudo usermod -a -G ptp _chrony
sudo chgrp ptp /dev/ptp1

# 3. Проверка доступа
sudo -u _chrony testptp -d /dev/ptp1 -g

# 4. Перезапуск chrony
sudo systemctl restart chrony
```

**Проблема 2: PHC не синхронизируется**

**Причины:**
- GNSS не синхронизирован
- Неправильный источник часов

**Решение:**
```bash
# 1. Проверка GNSS синхронизации
cat /sys/class/timecard/ocp0/gnss_sync

# 2. Проверка источника часов
cat /sys/class/timecard/ocp0/clock_source

# 3. Установка правильного источника часов
echo "TOD" | sudo tee /sys/class/timecard/ocp0/clock_source
```

**Проблема 3: Высокий offset между системным и PHC временем**

**Решение:**
```bash
# 1. Измерение смещения времени
sudo testptp -d /dev/ptp0 -k 5

# 2. Настройка offset в chrony.conf
echo "refclock PHC /dev/ptp0 poll 3 dpoll -2 offset <измеренное_смещение> stratum 1 precision 1e-9 prefer" | sudo tee /etc/chrony/chrony.conf

# 3. Перезапуск chrony
sudo systemctl restart chrony
```

#### Команды для диагностики

```bash
# Проверка статуса chrony
chronyc sources -v
chronyc tracking

# Проверка логов chrony
sudo journalctl -u chrony -n 20 --no-pager

# Проверка PTP устройств
sudo testptp -d /dev/ptp0 -g
sudo testptp -d /dev/ptp1 -g

# Проверка GNSS статуса
cat /sys/class/timecard/ocp0/gnss_sync
cat /sys/class/timecard/ocp0/clock_source
```

---

### 4.18 Диагностика и мониторинг

#### Система мониторинга Quantum-PCI

В репозитории предоставляется комплексная система мониторинга для отслеживания состояния карты Quantum-PCI в реальном времени.

**Запуск системы мониторинга:**
```bash
cd ptp-monitoring
python3 quantum-pci-monitor.py
```

**Доступ к веб-интерфейсу:**
- **Основной дашборд**: http://localhost:8080/realistic-dashboard
- **API**: http://localhost:8080/api/
- **Roadmap**: http://localhost:8080/api/roadmap

#### Мониторинг аппаратного состояния

**Проверка состояния карты:**
```bash
# Проверка обнаружения устройства
sudo lspci -nn | grep -i '1d9b:0400'

# Проверка загрузки драйвера
lsmod | grep ptp_ocp

# Проверка sysfs интерфейса
ls -la /sys/class/timecard/ocp*/

# Проверка PTP устройств
ls -la /dev/ptp*
```

**Мониторинг через sysfs:**
```bash
#!/bin/bash
# Скрипт мониторинга состояния TimeCard

TIMECARD_BASE="/sys/class/timecard/ocp0"

if [ ! -d "$TIMECARD_BASE" ]; then
    echo "❌ TimeCard устройство не найдено"
    exit 1
fi

echo "=== Мониторинг TimeCard ==="
echo "📅 Время: $(date)"
echo

# Основная информация
echo "🔧 Основная информация:"
echo "  Серийный номер: $(cat $TIMECARD_BASE/serialnum 2>/dev/null || echo 'N/A')"
echo "  Источник времени: $(cat $TIMECARD_BASE/clock_source 2>/dev/null || echo 'N/A')"
echo "  GNSS синхронизация: $(cat $TIMECARD_BASE/gnss_sync 2>/dev/null || echo 'N/A')"
echo

# Статус часов
echo "⏰ Статус часов:"
echo "  Смещение: $(cat $TIMECARD_BASE/clock_status_offset 2>/dev/null || echo 'N/A') нс"
echo "  Дрейф: $(cat $TIMECARD_BASE/clock_status_drift 2>/dev/null || echo 'N/A') ppb"
echo "  Режим удержания: $(cat $TIMECARD_BASE/holdover 2>/dev/null || echo 'N/A')"
echo

# Конфигурация SMA
echo "🔌 Конфигурация SMA:"
for i in {1..4}; do
    if [ -f "$TIMECARD_BASE/sma$i" ]; then
        echo "  SMA$i: $(cat $TIMECARD_BASE/sma$i)"
    fi
done
echo

# Связанные устройства
echo "🔗 Связанные устройства:"
if [ -L "$TIMECARD_BASE/ptp" ]; then
    PTP_DEV=$(basename $(readlink $TIMECARD_BASE/ptp))
    echo "  PTP: /dev/$PTP_DEV"
fi

if [ -L "$TIMECARD_BASE/ttyGNSS" ]; then
    GNSS_TTY=$(basename $(readlink $TIMECARD_BASE/ttyGNSS))
    echo "  GNSS: /dev/$GNSS_TTY"
fi
echo

# Проверка PTP синхронизации
if [ -c "/dev/ptp0" ]; then
    echo "📡 PTP синхронизация:"
    sudo phc_ctl /dev/ptp0 cmp 2>/dev/null | head -3
fi
```

#### Мониторинг производительности

**Мониторинг точности синхронизации:**
```bash
#!/bin/bash
# Скрипт мониторинга точности PTP

PTP_DEV="/dev/ptp0"
LOG_FILE="/var/log/ptp_accuracy.log"

if [ ! -c "$PTP_DEV" ]; then
    echo "PTP устройство не найдено"
    exit 1
fi

echo "Мониторинг точности PTP - $PTP_DEV"
echo "Лог: $LOG_FILE"
echo "Нажмите Ctrl+C для остановки"
echo

while true; do
    TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
    
    # Получение offset между системным временем и PHC
    OFFSET=$(sudo phc_ctl $PTP_DEV cmp 2>/dev/null | grep "offset" | awk '{print $2}')
    
    # Получение частоты
    FREQ=$(sudo phc_ctl $PTP_DEV freq 2>/dev/null | grep "frequency" | awk '{print $2}')
    
    # Статус ptp4l (если запущен)
    PTP4L_STATUS=""
    if pgrep ptp4l > /dev/null; then
        PTP4L_STATUS="running"
    else
        PTP4L_STATUS="stopped"
    fi
    
    # Запись в лог
    echo "$TIMESTAMP,offset=$OFFSET,freq=$FREQ,ptp4l=$PTP4L_STATUS" >> $LOG_FILE
    
    # Вывод на экран
    printf "\r%s | Offset: %8s ns | Freq: %8s ppb | PTP4L: %s" \
           "$TIMESTAMP" "$OFFSET" "$FREQ" "$PTP4L_STATUS"
    
    sleep 1
done
```

**Мониторинг сетевого трафика PTP:**
```bash
#!/bin/bash
# Мониторинг PTP трафика

INTERFACE="eth0"
DURATION=60

echo "Мониторинг PTP трафика на интерфейсе $INTERFACE"
echo "Длительность: $DURATION секунд"
echo

# Запуск tcpdump в фоне
sudo tcpdump -i $INTERFACE -n -c 1000 \
    'port 319 or port 320' \
    -tt \
    > /tmp/ptp_traffic.log 2>/dev/null &
TCPDUMP_PID=$!

sleep $DURATION

# Остановка tcpdump
sudo kill $TCPDUMP_PID 2>/dev/null

# Анализ трафика
echo "=== Анализ PTP трафика ==="
echo "Общее количество пакетов: $(wc -l < /tmp/ptp_traffic.log)"

echo
echo "Типы PTP сообщений:"
grep -o "port 319\|port 320" /tmp/ptp_traffic.log | sort | uniq -c

echo
echo "Источники PTP трафика:"
awk '{print $3}' /tmp/ptp_traffic.log | cut -d. -f1-4 | sort | uniq -c | head -10

echo
echo "Назначения PTP трафика:"
awk '{print $5}' /tmp/ptp_traffic.log | cut -d. -f1-4 | sort | uniq -c | head -10

# Очистка
rm -f /tmp/ptp_traffic.log
```

#### Мониторинг GNSS

**Мониторинг GNSS статуса:**
```bash
#!/bin/bash
# Мониторинг GNSS приемника

GNSS_PORT="/dev/ttyS5"
GPSD_HOST="localhost"
GPSD_PORT="2947"

echo "=== Мониторинг GNSS ==="

# Проверка gpsd
if pgrep gpsd > /dev/null; then
    echo "✅ gpsd запущен"
    
    # Получение статуса через gpsmon
    timeout 10s gpsmon -n 1 2>/dev/null | head -20
else
    echo "❌ gpsd не запущен"
fi

# Проверка GNSS порта
if [ -c "$GNSS_PORT" ]; then
    echo "✅ GNSS порт доступен: $GNSS_PORT"
    
    # Проверка NMEA сообщений
    echo "Проверка NMEA сообщений (5 секунд)..."
    timeout 5s tio -b 115200 $GNSS_PORT 2>/dev/null | head -5
else
    echo "❌ GNSS порт недоступен: $GNSS_PORT"
fi

# Проверка через sysfs
if [ -d "/sys/class/timecard/ocp0" ]; then
    echo
    echo "=== Статус через sysfs ==="
    echo "GNSS синхронизация: $(cat /sys/class/timecard/ocp0/gnss_sync 2>/dev/null || echo 'N/A')"
    echo "Источник времени: $(cat /sys/class/timecard/ocp0/clock_source 2>/dev/null || echo 'N/A')"
fi
```

#### Системный мониторинг

**Мониторинг системных ресурсов:**
```bash
#!/bin/bash
# Мониторинг системных ресурсов для PTP

echo "=== Системный мониторинг ==="
echo "Время: $(date)"
echo

# CPU и память
echo "💻 Ресурсы системы:"
echo "  CPU загрузка: $(uptime | awk -F'load average:' '{print $2}')"
echo "  Память: $(free -h | grep '^Mem:' | awk '{print $3"/"$2}')"
echo "  Диск: $(df -h / | tail -1 | awk '{print $3"/"$2" ("$5")"}')"
echo

# Сетевые интерфейсы
echo "🌐 Сетевые интерфейсы:"
for iface in $(ip link show | grep -o 'eth[0-9]*'); do
    if [ -d "/sys/class/net/$iface" ]; then
        speed=$(cat /sys/class/net/$iface/speed 2>/dev/null || echo "unknown")
        duplex=$(cat /sys/class/net/$iface/duplex 2>/dev/null || echo "unknown")
        echo "  $iface: ${speed}Mbps, $duplex"
    fi
done
echo

# PTP процессы
echo "⚙️ PTP процессы:"
ps aux | grep -E "(ptp4l|phc2sys|ts2phc)" | grep -v grep | while read line; do
    echo "  $line"
done
echo

# IRQ статистика
echo "🔧 IRQ статистика:"
grep -E "(eth0|ptp)" /proc/interrupts | head -5
echo

# Температура (если доступно)
if [ -f "/sys/class/thermal/thermal_zone0/temp" ]; then
    temp=$(cat /sys/class/thermal/thermal_zone0/temp)
    temp_c=$((temp / 1000))
    echo "🌡️ Температура CPU: ${temp_c}°C"
fi
```

#### Автоматизированный мониторинг

**Создание systemd сервиса для мониторинга:**
```bash
# Создание сервиса мониторинга
sudo tee /etc/systemd/system/quantum-pci-monitor.service << 'EOF'
[Unit]
Description=Quantum-PCI Monitoring Service
After=network.target

[Service]
Type=simple
User=root
ExecStart=/usr/local/bin/quantum-pci-monitor.sh
Restart=always
RestartSec=30
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
EOF

# Создание скрипта мониторинга
sudo tee /usr/local/bin/quantum-pci-monitor.sh << 'EOF'
#!/bin/bash

LOG_DIR="/var/log/quantum-pci"
mkdir -p $LOG_DIR

while true; do
    TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
    
    # Проверка состояния TimeCard
    if [ -d "/sys/class/timecard/ocp0" ]; then
        STATUS="OK"
        GNSS_SYNC=$(cat /sys/class/timecard/ocp0/gnss_sync 2>/dev/null || echo "unknown")
        CLOCK_SOURCE=$(cat /sys/class/timecard/ocp0/clock_source 2>/dev/null || echo "unknown")
    else
        STATUS="ERROR"
        GNSS_SYNC="N/A"
        CLOCK_SOURCE="N/A"
    fi
    
    # Проверка PTP
    if [ -c "/dev/ptp0" ]; then
        PTP_STATUS="OK"
        OFFSET=$(sudo phc_ctl /dev/ptp0 cmp 2>/dev/null | grep "offset" | awk '{print $2}' || echo "N/A")
    else
        PTP_STATUS="ERROR"
        OFFSET="N/A"
    fi
    
    # Запись в лог
    echo "$TIMESTAMP,$STATUS,$GNSS_SYNC,$CLOCK_SOURCE,$PTP_STATUS,$OFFSET" >> $LOG_DIR/monitor.log
    
    sleep 60
done
EOF

sudo chmod +x /usr/local/bin/quantum-pci-monitor.sh

# Включение сервиса
sudo systemctl daemon-reload
sudo systemctl enable quantum-pci-monitor
sudo systemctl start quantum-pci-monitor
```

---

### 4.19 Эксплуатация и обслуживание

#### Плановое обслуживание

**Ежедневные проверки:**
- Мониторинг статуса синхронизации GNSS
- Проверка точности PTP синхронизации
- Контроль системных ресурсов
- Анализ логов на наличие ошибок

**Еженедельные проверки:**
- Проверка целостности прошивки
- Калибровка задержек кабелей
- Обновление логов мониторинга
- Проверка резервных копий конфигураций

**Ежемесячные проверки:**
- Полная диагностика системы
- Проверка температурных характеристик
- Анализ производительности
- Обновление документации

#### Резервное копирование

**Автоматическое резервное копирование конфигураций:**
```bash
#!/bin/bash
# Скрипт резервного копирования

BACKUP_DIR="/backup/quantum-pci"
DATE=$(date +%Y%m%d_%H%M%S)

mkdir -p $BACKUP_DIR

# Резервное копирование конфигураций
if [ -d "/sys/class/timecard/ocp0" ]; then
    TIMECARD_BASE="/sys/class/timecard/ocp0"
    
    # Конфигурация устройства
    if [ -f "$TIMECARD_BASE/config" ]; then
        cp $TIMECARD_BASE/config $BACKUP_DIR/config_$DATE.bin
    fi
    
    # Конфигурация дисциплинирования
    if [ -f "$TIMECARD_BASE/disciplining_config" ]; then
        cp $TIMECARD_BASE/disciplining_config $BACKUP_DIR/disciplining_config_$DATE.bin
    fi
    
    # Температурная таблица
    if [ -f "$TIMECARD_BASE/temperature_table" ]; then
        cp $TIMECARD_BASE/temperature_table $BACKUP_DIR/temperature_table_$DATE.bin
    fi
fi

# Резервное копирование конфигураций PTP
if [ -f "/etc/ptp4l.conf" ]; then
    cp /etc/ptp4l.conf $BACKUP_DIR/ptp4l_$DATE.conf
fi

# Резервное копирование конфигураций Chrony
if [ -f "/etc/chrony/chrony.conf" ]; then
    cp /etc/chrony/chrony.conf $BACKUP_DIR/chrony_$DATE.conf
fi

# Очистка старых резервных копий (старше 30 дней)
find $BACKUP_DIR -name "*.bin" -o -name "*.conf" | xargs ls -t | tail -n +31 | xargs rm -f

echo "Резервное копирование завершено: $BACKUP_DIR"
```


### 4.20 Интеграция с различными системами

#### Интеграция с Kubernetes

**Создание DaemonSet для PTP синхронизации:**
```yaml
# ptp-daemonset.yaml
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: ptp-sync
  namespace: kube-system
spec:
  selector:
    matchLabels:
      name: ptp-sync
  template:
    metadata:
      labels:
        name: ptp-sync
    spec:
      hostNetwork: true
      hostPID: true
      containers:
      - name: ptp4l
        image: quantum-pci/ptp4l:latest
        securityContext:
          privileged: true
        volumeMounts:
        - name: dev
          mountPath: /dev
        - name: sys
          mountPath: /sys
        - name: config
          mountPath: /etc/ptp4l.conf
          subPath: ptp4l.conf
        command: ["/usr/sbin/ptp4l"]
        args: ["-f", "/etc/ptp4l.conf", "-i", "eth0"]
      - name: phc2sys
        image: quantum-pci/phc2sys:latest
        securityContext:
          privileged: true
        volumeMounts:
        - name: dev
          mountPath: /dev
        command: ["/usr/sbin/phc2sys"]
        args: ["-s", "/dev/ptp0", "-c", "CLOCK_REALTIME", "-O", "0"]
      volumes:
      - name: dev
        hostPath:
          path: /dev
      - name: sys
        hostPath:
          path: /sys
      - name: config
        configMap:
          name: ptp-config
```

#### Интеграция с Docker

**Docker Compose для PTP стека:**
```yaml
# docker-compose.ptp.yml
version: '3.8'

services:
  ptp4l:
    build:
      context: .
      dockerfile: Dockerfile.ptp
    container_name: ptp4l
    privileged: true
    network_mode: host
    volumes:
      - /dev:/dev
      - /sys:/sys
    environment:
      - PTP_INTERFACE=eth0
      - PTP_DOMAIN=0
    command: ["ptp4l", "-i", "eth0", "-f", "/etc/ptp4l.conf"]

  phc2sys:
    build:
      context: .
      dockerfile: Dockerfile.ptp
    container_name: phc2sys
    privileged: true
    network_mode: host
    volumes:
      - /dev:/dev
    depends_on:
      - ptp4l
    command: ["phc2sys", "-s", "/dev/ptp0", "-c", "CLOCK_REALTIME", "-O", "0"]
```

#### Интеграция с Prometheus/Grafana

**Prometheus конфигурация:**
```yaml
# prometheus.yml
global:
  scrape_interval: 15s

scrape_configs:
  - job_name: 'quantum-pci'
    static_configs:
      - targets: ['localhost:8080']
    metrics_path: '/api/metrics'
    scrape_interval: 5s

  - job_name: 'ptp4l'
    static_configs:
      - targets: ['localhost:9090']
    scrape_interval: 10s
```

#### Интеграция с Ansible

**Ansible playbook для развертывания:**
```yaml
# quantum-pci-deploy.yml
---
- name: Deploy Quantum-PCI TimeCard
  hosts: timecard_servers
  become: yes
  vars:
    ptp_domain: 0
    ptp_interface: eth0

  tasks:
    - name: Install dependencies
      apt:
        name:
          - build-essential
          - linux-headers-{{ ansible_kernel }}
          - linuxptp
          - chrony
          - ethtool
          - pciutils
        state: present

    - name: Load PTP driver
      modprobe:
        name: ptp_ocp
        state: present

    - name: Start and enable PTP services
      systemd:
        name: "{{ item }}"
        state: started
        enabled: yes
      loop:
        - ptp4l
        - phc2sys
        - chrony
```

---

### 4.21 Расширенное устранение неполадок

#### Диагностическая матрица проблем

| Проблема | Симптомы | Возможные причины | Решения |
|----------|----------|-------------------|---------|
| **Карта не обнаружена** | `lspci` не показывает устройство | Неправильная установка, проблемы с питанием, BIOS | Проверить установку, питание, BIOS настройки |
| **Драйвер не загружается** | `lsmod \| grep ptp_ocp` пустой | Несовместимость ядра, отсутствие зависимостей | Обновить ядро, установить зависимости |
| **PTP не синхронизируется** | Большой offset, нестабильная работа | Проблемы с сетью, неправильная конфигурация | Проверить сеть, конфигурацию PTP |
| **GNSS не работает** | Нет NMEA сообщений, статус "unlocked" | Проблемы с антенной, портом, питанием | Проверить антенну, порт, питание |
| **Низкая точность** | Высокий джиттер, нестабильный offset | Проблемы с кабелями, температурой, питанием | Калибровка, стабилизация условий |

#### Автоматизированная диагностика

**Скрипт полной диагностики:**
```bash
#!/bin/bash
# full-diagnostics.sh

LOG_FILE="/var/log/quantum-pci-diagnostics.log"
TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')

echo "=== Полная диагностика Quantum-PCI ===" | tee -a $LOG_FILE
echo "Время: $TIMESTAMP" | tee -a $LOG_FILE

# Проверка аппаратуры
if lspci -nn | grep -q "1d9b:0400"; then
    echo "✅ Аппаратура: TimeCard обнаружена" | tee -a $LOG_FILE
else
    echo "❌ Аппаратура: TimeCard не обнаружена" | tee -a $LOG_FILE
fi

# Проверка драйвера
if lsmod | grep -q "ptp_ocp"; then
    echo "✅ Драйвер: ptp_ocp загружен" | tee -a $LOG_FILE
else
    echo "❌ Драйвер: ptp_ocp не загружен" | tee -a $LOG_FILE
fi

# Проверка PTP устройств
if [ -c "/dev/ptp0" ]; then
    echo "✅ PTP устройство: /dev/ptp0 доступен" | tee -a $LOG_FILE
else
    echo "❌ PTP устройство: /dev/ptp0 недоступен" | tee -a $LOG_FILE
fi

# Проверка GNSS
if [ -c "/dev/ttyS5" ]; then
    GNSS_STATUS=$(cat /sys/class/timecard/ocp0/gnss_sync 2>/dev/null || echo "unknown")
    echo "✅ GNSS: Порт доступен, статус: $GNSS_STATUS" | tee -a $LOG_FILE
else
    echo "❌ GNSS: Порт недоступен" | tee -a $LOG_FILE
fi

# Проверка PTP процессов
if pgrep ptp4l > /dev/null; then
    echo "✅ PTP4L: Процесс запущен" | tee -a $LOG_FILE
else
    echo "❌ PTP4L: Процесс не запущен" | tee -a $LOG_FILE
fi

# Проверка точности
if [ -c "/dev/ptp0" ]; then
    OFFSET=$(sudo phc_ctl /dev/ptp0 cmp 2>/dev/null | grep "offset" | awk '{print $2}' || echo "N/A")
    if [ "$OFFSET" != "N/A" ] && [ "${OFFSET#-}" -lt 1000000 ]; then
        echo "✅ Точность: Offset: ${OFFSET}ns" | tee -a $LOG_FILE
    else
        echo "⚠️  Точность: Offset: ${OFFSET}ns (высокий)" | tee -a $LOG_FILE
    fi
else
    echo "❌ Точность: PTP устройство недоступно" | tee -a $LOG_FILE
fi

echo "Полный лог сохранен в: $LOG_FILE" | tee -a $LOG_FILE
```

#### Частые проблемы и решения

**1. Карта не обнаружена системой:**
```bash
# Проверка BIOS настроек
# - Включить VT-d/IOMMU
# - Отключить Secure Boot
# - Проверить PCIe слот

# Проверка физической установки
lspci -nn | grep -i time
dmesg | grep -i ptp
```

**2. Драйвер не загружается:**
```bash
# Проверка зависимостей
sudo modprobe --show-depends ptp_ocp

# Принудительная загрузка
sudo insmod /path/to/ptp_ocp.ko

# Проверка версии ядра
uname -r
```

**3. PTP не синхронизируется:**
```bash
# Проверка сетевого интерфейса
ethtool -T eth0

# Проверка firewall
sudo ufw status | grep -E "(319|320)"

# Проверка PTP трафика
sudo tcpdump -i eth0 port 319 or port 320
```

**4. GNSS не работает:**
```bash
# Проверка антенны
# - Подключена к GNSS разъему
# - Имеет питание (активная антенна)
# - Хороший обзор неба

# Проверка порта
sudo stty -F /dev/ttyS5 speed 115200
tio -b 115200 /dev/ttyS5
```

**5. Низкая точность синхронизации:**
```bash
# Калибровка задержек кабелей
echo "100" > /sys/class/timecard/ocp0/external_pps_cable_delay

# Проверка температуры
cat /sys/class/thermal/thermal_zone0/temp

# Оптимизация сети
sudo ethtool -s eth0 speed 1000 duplex full autoneg off
```

---

### 4.22 Производительность и оптимизация

#### Оптимизация системы для максимальной точности

**Настройка ядра для real-time работы:**
```bash
# /etc/default/grub
GRUB_CMDLINE_LINUX_DEFAULT="quiet splash isolcpus=1,2 nohz_full=1,2 rcu_nocbs=1,2"

# Обновление grub
sudo update-grub
```

**Оптимизация CPU:**
```bash
# Отключение энергосбережения
echo performance | sudo tee /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor

# Отключение C-states
echo 1 | sudo tee /sys/devices/system/cpu/cpu*/cpuidle/state*/disable

# Привязка IRQ к определенным CPU
echo 2 > /proc/irq/$(grep eth0 /proc/interrupts | cut -d: -f1 | tr -d ' ')/smp_affinity
```

**Оптимизация сети:**
```bash
# Настройка сетевого интерфейса
sudo ethtool -s eth0 speed 1000 duplex full autoneg off
sudo ethtool -G eth0 rx 4096 tx 4096
sudo ethtool -C eth0 rx-usecs 1 tx-usecs 1

# Отключение offloading
sudo ethtool -K eth0 gro off gso off tso off
```

#### Профили производительности

**Высокая точность (для критичных применений):**
```ini
# /etc/ptp4l.conf - High Accuracy Profile
[global]
time_stamping         hardware
twoStepFlag           1
domainNumber          0
priority1             128
priority2             128
clockClass            6
clockAccuracy         0x20
offsetScaledLogVariance 0x436A
free_running          0
freq_est_interval     1
assume_two_step       0
tx_timestamp_timeout  1
check_fup_sync        0
clock_servo           pi
step_threshold        0.000000002
first_step_threshold  0.000000020
max_frequency         900000000
pi_proportional_const 0.0
pi_integral_const     0.0
pi_proportional_scale 0.0
pi_proportional_exponent -0.3
pi_proportional_norm_max 0.7
pi_integral_scale     0.0
pi_integral_exponent  0.4
pi_integral_norm_max  0.3
servo_num_offset_values 10
servo_offset_threshold 0
write_phase_mode      0
network_transport     UDPv4
delay_mechanism       E2E
summary_interval      0
kernel_leap           1
check_fup_sync        0

[eth0]
logAnnounceInterval   -2
logSyncInterval       -5
logMinDelayReqInterval -5
announceReceiptTimeout 3
syncReceiptTimeout    3
delay_mechanism       E2E
network_transport     UDPv4
```

**Сбалансированная производительность:**
```ini
# /etc/ptp4l.conf - Balanced Profile
[global]
time_stamping         hardware
twoStepFlag           1
domainNumber          0
priority1             128
priority2             128
clockClass            248
clockAccuracy         0xFE
offsetScaledLogVariance 0xFFFF
free_running          0
freq_est_interval     1
assume_two_step       0
tx_timestamp_timeout  10
check_fup_sync        0
clock_servo           pi
step_threshold        0.000002
first_step_threshold  0.000020
max_frequency         900000000
pi_proportional_const 0.0
pi_integral_const     0.0
pi_proportional_scale 0.0
pi_proportional_exponent -0.3
pi_proportional_norm_max 0.7
pi_integral_scale     0.0
pi_integral_exponent  0.4
pi_integral_norm_max  0.3
servo_num_offset_values 10
servo_offset_threshold 0
write_phase_mode      0
network_transport     UDPv4
delay_mechanism       E2E
summary_interval      0
kernel_leap           1
check_fup_sync        0

[eth0]
logAnnounceInterval   1
logSyncInterval       0
logMinDelayReqInterval 0
announceReceiptTimeout 3
syncReceiptTimeout    0
delay_mechanism       E2E
network_transport     UDPv4
```

#### Мониторинг производительности

**Скрипт мониторинга производительности:**
```bash
#!/bin/bash
# performance-monitor.sh

LOG_FILE="/var/log/ptp-performance.log"
INTERVAL=1

echo "Мониторинг производительности PTP (нажмите Ctrl+C для остановки)"
echo "Лог: $LOG_FILE"
echo

while true; do
    TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S.%3N')
    
    # PTP offset
    OFFSET=$(sudo phc_ctl /dev/ptp0 cmp 2>/dev/null | grep "offset" | awk '{print $2}' || echo "N/A")
    
    # PTP frequency
    FREQ=$(sudo phc_ctl /dev/ptp0 freq 2>/dev/null | grep "frequency" | awk '{print $2}' || echo "N/A")
    
    # CPU загрузка
    CPU_LOAD=$(uptime | awk -F'load average:' '{print $2}' | awk '{print $1}' | tr -d ',')
    
    # Память
    MEM_USED=$(free | grep '^Mem:' | awk '{printf "%.1f", $3/$2*100}')
    
    # Сетевая статистика
    RX_PACKETS=$(cat /proc/net/dev | grep eth0 | awk '{print $2}')
    TX_PACKETS=$(cat /proc/net/dev | grep eth0 | awk '{print $10}')
    
    # Запись в лог
    echo "$TIMESTAMP,$OFFSET,$FREQ,$CPU_LOAD,$MEM_USED,$RX_PACKETS,$TX_PACKETS" >> $LOG_FILE
    
    # Вывод на экран
    printf "\r%s | Offset: %8s ns | Freq: %8s ppb | CPU: %5s%% | Mem: %5s%%" \
           "$TIMESTAMP" "$OFFSET" "$FREQ" "$CPU_LOAD" "$MEM_USED"
    
    sleep $INTERVAL
done
```

#### Бенчмарки и тестирование

### 4.14 Тест задержки PCIe (Single PCIE delay test)

**Требование:** Проверить, что смещение при синхронизации карты времени с сетевой картой через шину PCIe составляет менее ±5 мкс.

**Метод тестирования:**

1. **Подключение измерительного оборудования:**
   - Подключите Calnex Sentinel к выходу PPS карты времени
   - Подключите второй порт Calnex Sentinel к выходу PPS сетевой карты Mellanox

2. **Запуск утилиты синхронизации:**
   ```bash
   # Синхронизация PHC карты времени с PHC сетевой карты
   sudo phc2sys -s /dev/ptp0 -c ens1f0 -O 0 -m
   ```

3. **Наблюдение за смещением:**
   - Мониторьте вывод `phc2sys` для отслеживания значений `phc offset`
   - Значения должны стабилизироваться в пределах ±5 мкс

**Критерии оценки:**

| Параметр | Требование | Критерий прохождения |
|----------|------------|---------------------|
| `ens1f0 PHC offset` | < ±5 мкс | PHC offset < ±5 мкс |

**Пример вывода при успешном тесте:**
```
phc2sys [18497.409]: ens1f0 phc offset 2 s2 freq +1175 delay 9400
phc2sys [18498.410]: ens1f0 phc offset 1 s2 freq +1130 delay 9312
phc2sys [18499.411]: ens1f0 phc offset 4 s2 freq +1041 delay 11904
```

**Интерпретация результатов:**
- ✅ **Тест пройден**: если значения `phc offset` стабильно находятся в диапазоне ±5 мкс
- ❌ **Тест не пройден**: если значения превышают ±5 мкс или нестабильны

---

### 4.23 Тестирование и валидация

#### Бенчмарки и тестирование

### 4.23.1 Тест автономного хранения 1PPS (24 часа)

**Требование:** Проверить, что сигнал 1PPS от карты времени не отклоняется более чем на ±500 мкс за 24-часовой период при потере сигнала GNSS.

**Метод тестирования:**

1. **Подключение измерительного оборудования:**
   - Подключите SMA кабель от SMA3 (по умолчанию = OUT PHC) карты времени к входу CH-C оборудования Calnex Sentinel
   - Настройте Calnex Sentinel для тестирования 1PPS

2. **Подготовка системы:**
   - Прогрейте сервер HPE ~18 часов
   - Установите параметр `{set,Disciplining,0}` для режима автономного хранения

3. **Проведение теста:**
   - Запустите тест на 24 часа
   - Мониторьте дрейф сигнала 1PPS

**Критерии оценки:**

| Параметр | Требование | Критерий прохождения |
|----------|------------|---------------------|
| Дрейф 1PPS за 24 часа | < ±500 мкс | Дрейф < ±500 мкс |

**Конфигурация теста:**
- **Карта времени**: Остановка дисциплинирования (`Stop disciplining`)
- **Sentinel**: Дисциплинирование (Internal Reference Disciplining Mode: Always, Disciplining source: GNSS)
- **Антенна GNSS**: Внутри здания рядом с окном

**Результат:** ✅ **ПРОЙДЕН**

### 4.23.2 Тест автономного хранения 1PPS (24 часа) - расширенный

**Требование:** Проверить, что сигнал 1PPS от карты времени не отклоняется более чем на ±500 мкс за 24-часовой период при потере сигнала GNSS с предварительным дисциплинированием.

**Метод тестирования:**

1. **Подключение измерительного оборудования:**
   - Подключите SMA кабель от SMA4 (по умолчанию = OUT PHC) карты времени к входу CH-B оборудования Calnex Sentinel
   - Настройте Calnex Sentinel для тестирования 1PPS

2. **Предварительное дисциплинирование:**
   - Время дисциплинирования ≥ 6 часов 56 минут
   - Рекомендуемое время дисциплинирования ~12 часов
   - Установите параметр `{set,Disciplining,0}` для режима автономного хранения

3. **Проведение теста:**
   - Запустите тест на 24 часа
   - Мониторьте дрейф сигнала 1PPS

**Критерии оценки:**

| Параметр | Требование | Критерий прохождения |
|----------|------------|---------------------|
| Дрейф 1PPS за 24 часа | < ±500 мкс | Дрейф < ±500 мкс |

**Конфигурация теста:**
- **Карта времени**: Остановка дисциплинирования (`Stop disciplining`)
- **Sentinel**: Дисциплинирование (Internal Reference Disciplining Mode: Stop discipline during measurement, Disciplining source: GNSS)
- **Антенна GNSS**: Снаружи здания рядом с окном

**Особенности теста:**
- Мониторинг цифрового значения настройки и среднего значения
- При времени дисциплинирования > 5Tau, отправка команды остановки дисциплинирования когда цифровое значение настройки приближается к средней точке

**Результат:** ✅ **ПРОЙДЕН**

### 4.23.3 Тест PTP с одним клиентом (phc2sys) - внутренняя антенна

**Требование:** Проверить точность PTP синхронизации с одним клиентом через команду phc2sys в течение 12 часов.

**Метод тестирования:**

1. **Подключение оборудования:**
   - Подключите SFP+ кабель от SFP+ порта Calnex Sentinel к QSFP порту сетевой карты Mellanox на сервере
   - Настройте Calnex Sentinel для PTP тестирования

2. **Настройка MAC модуля:**
   ```bash
   # Переключение на консольный порт MAC модуля
   tio -b 57600 /dev/ttyS6
   
   # Установка параметров
   {set,Disciplining,1}
   {set,PpsWidth,80000000}
   {set,TauPps0,10000}
   {set,PpsOffset,-30}
   {set,DisciplineThresholdPps0,20}
   {store}
   ```

3. **Подготовка и запуск теста:**
   - Прогрев сервера ~18 часов
   - Запуск ptp4l: `ptp4l -i ens1f0 -f unicast-master.cfg -m`
   - Запуск phc2sys: `phc2sys -s /dev/ptp6 -c ens1f0 -O 0 -m`
   - Тест в течение 12 часов

**Критерии оценки:**

| Параметр | Требование | Критерий прохождения |
|----------|------------|---------------------|
| PTP точность | < ±2.5 мкс | PTP times < ±2.5 мкс |

**Конфигурация теста:**
- **Карта времени**: Дисциплинирование (`Disciplining`)
- **Sentinel**: Дисциплинирование (Internal Reference Disciplining Mode: Always, Disciplining source: GNSS)
- **Антенна GNSS**: Внутри здания рядом с окном

**Результат:** ✅ **ПРОЙДЕН**

### 4.23.4 Тест PTP с одним клиентом (phc2sys) - внешняя антенна

**Требование:** Проверить точность PTP синхронизации с одним клиентом через команду phc2sys в течение 12 часов с внешней антенной.

**Метод тестирования:**

1. **Подключение оборудования:**
   - Подключите SFP+ кабель от SFP+ порта Calnex Sentinel к QSFP порту сетевой карты Mellanox на сервере
   - Настройте Calnex Sentinel для PTP тестирования

2. **Настройка MAC модуля:**
   ```bash
   # Переключение на консольный порт MAC модуля
   tio -b 57600 /dev/ttyS6
   
   # Установка параметров
   {set,Disciplining,1}
   {set,PpsWidth,80000000}
   {set,TauPps0,10000}
   {set,PpsOffset,-30}
   {set,DisciplineThresholdPps0,20}
   {store}
   ```

3. **Подготовка и запуск теста:**
   - Прогрев сервера ~18 часов
   - Запуск ptp4l: `ptp4l -i ens1f0 -f unicast-master.cfg -m`
   - Запуск phc2sys: `phc2sys -s /dev/ptp6 -c ens1f0 -O 0 -m`
   - Тест в течение 12 часов

**Критерии оценки:**

| Параметр | Требование | Критерий прохождения |
|----------|------------|---------------------|
| PTP точность | < ±2.5 мкс | PTP times < ±2.5 мкс |

**Конфигурация теста:**
- **Карта времени**: Дисциплинирование (`Disciplining`)
- **Sentinel**: Дисциплинирование (Internal Reference Disciplining Mode: Always, Disciplining source: GNSS)
- **Антенна GNSS**: Снаружи здания рядом с окном

**Результаты тестирования:**
- **При PpsOffset = -30**: PTP 2WayTE mean value ≈ -2.501 мкс (превышает критерий на ≈0.001 мкс)
- **При PpsOffset = -2500**: PTP 2WayTE mean value ≈ 9.069 нс

**Результат:** ✅ **ПРОЙДЕН** (с условием корректировки параметра PpsOffset на MAC модуле)

### 4.23.5 Тест PTP с одним клиентом (ts2phc) - внутренняя антенна

**Требование:** Проверить точность PTP синхронизации с одним клиентом через команду ts2phc в течение 12 часов.

**Метод тестирования:**

1. **Подключение оборудования:**
   - Подключите SFP+ кабель от SFP+ порта Calnex Sentinel к QSFP порту сетевой карты Mellanox на сервере
   - Подключите выход 1PPS от карты времени к входу сетевой карты
   - Настройте Calnex Sentinel для PTP тестирования

2. **Настройка MAC модуля:**
   ```bash
   # Переключение на консольный порт MAC модуля
   tio -b 57600 /dev/ttyS6
   
   # Установка параметров
   {set,Disciplining,1}
   {set,PpsWidth,80000000}
   {set,TauPps0,1000}
   {set,PpsOffset,-30}
   {set,DisciplineThresholdPps0,20}
   {store}
   ```

3. **Подготовка и запуск теста:**
   - Прогрев сервера ~18 часов
   - Синхронизация TOD: `phc2sys -s /dev/ptp6 -c CLOCK_REALTIME -O 0 -m`
   - Настройка 1PPS входа: `./testptp -d /dev/ptp4 -L 0,1`
   - Остановка phc2sys и запуск ts2phc: `ts2phc -s generic -c ens1f0 -m -l 7`
   - Запуск ptp4l: `ptp4l -i ens1f0 -f unicast-master.cfg -m`
   - Тест в течение 12 часов

**Критерии оценки:**

| Параметр | Требование | Критерий прохождения |
|----------|------------|---------------------|
| PTP точность | < ±500 нс | PTP times < ±500 нс |

**Конфигурация теста:**
- **Карта времени**: Дисциплинирование (`Disciplining`)
- **Sentinel**: Дисциплинирование (Internal Reference Disciplining Mode: Always, Disciplining source: GNSS)
- **Антенна GNSS**: Внутри здания рядом с окном

**Результат:** ✅ **ПРОЙДЕН**

### 4.23.6 Тест PTP с одним клиентом (ts2phc) - внешняя антенна

**Требование:** Проверить точность PTP синхронизации с одним клиентом через команду ts2phc в течение 12 часов с внешней антенной.

**Метод тестирования:**

1. **Подключение оборудования:**
   - Подключите SFP+ кабель от SFP+ порта Calnex Sentinel к QSFP порту сетевой карты Mellanox на сервере
   - Подключите выход 1PPS от карты времени к входу сетевой карты
   - Настройка Calnex Sentinel для PTP тестирования

2. **Настройка MAC модуля:**
   ```bash
   # Переключение на консольный порт MAC модуля
   tio -b 57600 /dev/ttyS6
   
   # Установка параметров
   {set,Disciplining,1}
   {set,PpsWidth,80000000}
   {set,TauPps0,1000}
   {set,PpsOffset,-30}
   {set,DisciplineThresholdPps0,20}
   {store}
   ```

3. **Подготовка и запуск теста:**
   - Прогрев сервера ~18 часов
   - Синхронизация TOD: `phc2sys -s /dev/ptp6 -c CLOCK_REALTIME -O 0 -m`
   - Настройка 1PPS входа: `./testptp -d /dev/ptp4 -L 0,1`
   - Остановка phc2sys и запуск ts2phc: `ts2phc -s generic -c ens1f0 -m -l 7`
   - Запуск ptp4l: `ptp4l -i ens1f0 -f unicast-master.cfg -m`
   - Тест в течение 12 часов

**Критерии оценки:**

| Параметр | Требование | Критерий прохождения |
|----------|------------|---------------------|
| PTP точность | < ±500 нс | PTP times < ±500 нс |

**Конфигурация теста:**
- **Карта времени**: Дисциплинирование (`Disciplining`)
- **Sentinel**: Дисциплинирование (Internal Reference Disciplining Mode: Always, Disciplining source: GNSS)
- **Антенна GNSS**: Снаружи здания рядом с окном

**Результат:** ✅ **ПРОЙДЕН**

### 4.23.7 Тестирование PTM (Precision Time Measurement)

**Требование:** Проверить работу PTM (Precision Time Measurement) для точного измерения времени через PCIe.

**Предварительные условия:**
- Хост-система должна поддерживать PTM
- Установлена версия linuxptp v4.3 или новее
- Остальные службы времени отключены

**Метод тестирования:**

1. **Проверка поддержки PTM:**
   ```bash
   # Проверка возможностей PTM через lspci
   lspci -vvv | grep -A 20 "Precision Time Measurement"
   ```

2. **Остановка служб времени:**
   ```bash
   sudo systemctl stop systemd-timesyncd.service
   ```

3. **Синхронизация хоста:**
   ```bash
   # Установка времени PHC
   sudo phc_ctl /dev/ptp2 set
   
   # Синхронизация системного времени с PHC
   sudo phc2sys -c CLOCK_REALTIME -s /dev/ptp2 -O 0 -R 16 -u 8 -m
   ```

**Критерии оценки:**

| Параметр | Требование | Критерий прохождения |
|----------|------------|---------------------|
| PTM задержка | 0 ± 0 | delay 0+/- 0 |
| RMS отклонение | < 50 нс | rms < 50 |
| Максимальное отклонение | < 100 нс | max < 100 |

**Пример успешного вывода PTM:**
```
phc2sys[4503.063]: CLOCK_REALTIME rms 26 max 40 freq -17250 +/- 17 delay 0+/- 0
phc2sys[4503.564]: CLOCK_REALTIME rms 46 max 85 freq -17346 +/- 17 delay 0+/- 0
phc2sys[4504.066]: CLOCK_REALTIME rms 25 max 54 freq -17316 +/- 25 delay 0+/- 0
phc2sys[4504.567]: CLOCK_REALTIME rms 29 max 53 freq -17277 +/- 24 delay 0+/- 0
phc2sys[4505.069]: CLOCK_REALTIME rms 29 max 63 freq -17219 +/- 20 delay 0+/- 0
```

**Интерпретация результатов:**
- ✅ **PTM работает корректно**: если `delay 0+/- 0` стабильно отображается
- ✅ **Высокая точность**: RMS < 50 нс, max < 100 нс
- ❌ **PTM не работает**: если задержка не равна 0 или нестабильна

**Конфигурация PTM:**
- **PTMCap**: Requester:+, Responder:-, Root:-
- **PTMClockGranularity**: 8 нс
- **PTMControl**: Enabled:+, RootSelected:-
- **PTMEffectiveGranularity**: 4 нс

**Результат:** ✅ **ПРОЙДЕН** (PTM обеспечивает точность измерения времени с задержкой 0 ± 0)

**Скрипт тестирования точности:**
```bash
#!/bin/bash
# accuracy-benchmark.sh

DURATION=300  # 5 минут
LOG_FILE="/var/log/ptp-accuracy-benchmark.log"

echo "Тестирование точности PTP в течение $DURATION секунд"
echo "Лог: $LOG_FILE"
echo

# Очистка предыдущего лога
> $LOG_FILE

# Запуск мониторинга в фоне
{
    for ((i=0; i<$DURATION; i++)); do
        TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S.%3N')
        OFFSET=$(sudo phc_ctl /dev/ptp0 cmp 2>/dev/null | grep "offset" | awk '{print $2}' || echo "N/A")
        echo "$TIMESTAMP,$OFFSET" >> $LOG_FILE
        sleep 1
    done
} &

MONITOR_PID=$!

# Ожидание завершения
wait $MONITOR_PID

# Анализ результатов
echo
echo "=== Анализ результатов ==="

# Статистика offset
if [ -f "$LOG_FILE" ]; then
    # Среднее значение
    AVG_OFFSET=$(awk -F',' '{sum+=$2; count++} END {if(count>0) print sum/count; else print "N/A"}' $LOG_FILE)
    
    # Минимальное значение
    MIN_OFFSET=$(awk -F',' '$2 != "N/A" {print $2}' $LOG_FILE | sort -n | head -1)
    
    # Максимальное значение
    MAX_OFFSET=$(awk -F',' '$2 != "N/A" {print $2}' $LOG_FILE | sort -n | tail -1)
    
    # Стандартное отклонение
    STD_DEV=$(awk -F',' -v avg="$AVG_OFFSET" '$2 != "N/A" {sum+=($2-avg)^2; count++} END {if(count>0) print sqrt(sum/count); else print "N/A"}' $LOG_FILE)
    
    echo "Средний offset: ${AVG_OFFSET} нс"
    echo "Минимальный offset: ${MIN_OFFSET} нс"
    echo "Максимальный offset: ${MAX_OFFSET} нс"
    echo "Стандартное отклонение: ${STD_DEV} нс"
    
    # Оценка качества
    if [ "$AVG_OFFSET" != "N/A" ] && [ "${AVG_OFFSET#-}" -lt 1000 ]; then
        echo "✅ Отличная точность (< 1 мкс)"
    elif [ "$AVG_OFFSET" != "N/A" ] && [ "${AVG_OFFSET#-}" -lt 10000 ]; then
        echo "✅ Хорошая точность (< 10 мкс)"
    elif [ "$AVG_OFFSET" != "N/A" ] && [ "${AVG_OFFSET#-}" -lt 100000 ]; then
        echo "⚠️  Удовлетворительная точность (< 100 мкс)"
    else
        echo "❌ Низкая точность (> 100 мкс)"
    fi
else
    echo "❌ Лог файл не найден"
fi
```

#### Оптимизация для различных сценариев

**Телекоммуникационные применения:**
```bash
# Настройки для телекома
echo "Настройка для телекоммуникационных применений..."

# Отключение всех ненужных сервисов
sudo systemctl stop bluetooth
sudo systemctl disable bluetooth
sudo systemctl stop cups
sudo systemctl disable cups

# Оптимизация сети
sudo ethtool -s eth0 speed 1000 duplex full autoneg off
sudo ethtool -G eth0 rx 8192 tx 8192
sudo ethtool -C eth0 rx-usecs 1 tx-usecs 1

# Настройка PTP для телекома
sudo tee /etc/ptp4l.conf << 'EOF'
[global]
dataset_comparison         G.8275.x
G.8275.defaultDS.localPriority 128
domainNumber               24
priority1                  128
priority2                  128
clockClass                 165
clockAccuracy              0x21
offsetScaledLogVariance    0x4E5D
free_running               0
freq_est_interval          1
assume_two_step            0
tx_timestamp_timeout       10
check_fup_sync             0
clock_servo                linreg
step_threshold             0.000002
first_step_threshold       0.000020
max_frequency              900000000
sanity_freq_limit          200000000
network_transport          L2
ptp_dst_mac                01:1B:19:00:00:00
p2p_dst_mac                01:80:C2:00:00:0E
verbose                    0
use_syslog                 1
logging_level              6

[eth0]
logAnnounceInterval        0
logSyncInterval           -4
logMinDelayReqInterval    -4
logMinPdelayReqInterval   -4
announceReceiptTimeout     3
syncReceiptTimeout         3
delay_mechanism            P2P
network_transport          L2
masterOnly                 0
G.8275.portDS.localPriority 128
EOF
```

**Промышленные применения:**
```bash
# Настройки для промышленности
echo "Настройка для промышленных применений..."

# Отключение GUI и ненужных сервисов
sudo systemctl set-default multi-user.target

# Оптимизация для стабильности
echo 'vm.swappiness=10' | sudo tee -a /etc/sysctl.conf
echo 'vm.dirty_ratio=15' | sudo tee -a /etc/sysctl.conf
echo 'vm.dirty_background_ratio=5' | sudo tee -a /etc/sysctl.conf

# Настройка PTP для промышленности
sudo tee /etc/ptp4l.conf << 'EOF'
[global]
dataset_comparison         ieee1588
domainNumber               0
priority1                  128
priority2                  128
clockClass                 248
clockAccuracy              0xFE
offsetScaledLogVariance    0xFFFF
free_running               0
freq_est_interval          1
assume_two_step            0
tx_timestamp_timeout       50
check_fup_sync             0
clock_servo                pi
step_threshold             0.000002
first_step_threshold       0.000020
max_frequency              900000000
pi_proportional_const      0.0
pi_integral_const          0.0
pi_proportional_scale      0.0
pi_proportional_exponent   -0.3
pi_proportional_norm_max   0.7
pi_integral_scale          0.0
pi_integral_exponent       0.4
pi_integral_norm_max       0.3
servo_num_offset_values    10
servo_offset_threshold     0
write_phase_mode           0
network_transport          UDPv4
delay_mechanism            E2E
verbose                    1
use_syslog                 1
summary_interval           0
kernel_leap                1
check_fup_sync             0

[eth0]
logAnnounceInterval        1
logSyncInterval            0
logMinDelayReqInterval     0
announceReceiptTimeout     3
syncReceiptTimeout         0
delay_mechanism            E2E
network_transport          UDPv4
EOF
```

---

### 4.24 Безопасность и соответствие стандартам

#### Соответствие стандартам

**Поддерживаемые стандарты:**
- **IEEE 1588-2008**: Precision Time Protocol (PTP) v2
- **IEEE 1588-2019**: Precision Time Protocol (PTP) v2.1
- **ITU-T G.8275.1**: PTP Profile for Phase/Timing Applications with Full Timing Support from the Network
- **ITU-T G.8275.2**: PTP Profile for Phase/Timing Applications with Partial Timing Support from the Network
- **RFC 5905**: Network Time Protocol Version 4: Protocol and Algorithms Specification
- **RFC 5906**: Network Time Protocol Version 4: Autokey Specification
- **RFC 5907**: Definitions of Managed Objects for Network Time Protocol Version 4 (NTPv4)

**Сертификации и соответствие:**
- **CE Marking**: Соответствие европейским директивам
- **FCC Part 15**: Соответствие требованиям FCC для цифровых устройств
- **RoHS**: Соответствие директиве RoHS по ограничению опасных веществ
- **ISO 9001**: Система менеджмента качества

#### Безопасность системы

**Физическая безопасность:**
```bash
# Ограничение физического доступа к серверу
# - Размещение в защищенном помещении
# - Контроль доступа к серверной комнате
# - Видеонаблюдение
# - Защита от электромагнитных помех
```

**Сетевая безопасность:**
```bash
# Настройка firewall для PTP
sudo ufw allow 319/udp comment "PTP Event"
sudo ufw allow 320/udp comment "PTP General"

# Ограничение доступа к PTP портам
sudo iptables -A INPUT -p udp --dport 319 -s 192.168.1.0/24 -j ACCEPT
sudo iptables -A INPUT -p udp --dport 320 -s 192.168.1.0/24 -j ACCEPT
sudo iptables -A INPUT -p udp --dport 319 -j DROP
sudo iptables -A INPUT -p udp --dport 320 -j DROP

# Настройка VPN для удаленного доступа
sudo openvpn --config /etc/openvpn/server.conf
```

**Контроль доступа:**
```bash
# Создание группы для PTP администраторов
sudo groupadd ptp-admin
sudo usermod -a -G ptp-admin ptp-user

# Настройка sudo для PTP команд
sudo tee /etc/sudoers.d/ptp-admin << 'EOF'
%ptp-admin ALL=(ALL) NOPASSWD: /usr/sbin/ptp4l, /usr/sbin/phc2sys, /usr/sbin/ts2phc
%ptp-admin ALL=(ALL) NOPASSWD: /bin/cat /sys/class/timecard/ocp*/*
%ptp-admin ALL=(ALL) NOPASSWD: /bin/echo * > /sys/class/timecard/ocp*/*
EOF

# Ограничение доступа к sysfs
sudo chmod 640 /sys/class/timecard/ocp0/*
sudo chown root:ptp-admin /sys/class/timecard/ocp0/*
```

#### Аудит и логирование

**Настройка аудита:**
```bash
# Установка auditd
sudo apt install auditd audispd-plugins

# Настройка правил аудита
sudo tee /etc/audit/rules.d/ptp.rules << 'EOF'
# Аудит PTP операций
-w /usr/sbin/ptp4l -p x -k ptp
-w /usr/sbin/phc2sys -p x -k ptp
-w /usr/sbin/ts2phc -p x -k ptp

# Аудит доступа к sysfs
-w /sys/class/timecard/ocp0/ -p rwxa -k timecard

# Аудит конфигурационных файлов
-w /etc/ptp4l.conf -p wa -k ptp-config
-w /etc/chrony/chrony.conf -p wa -k chrony-config
EOF

# Перезапуск auditd
sudo systemctl restart auditd
```

**Централизованное логирование:**
```bash
# Настройка rsyslog для централизованного логирования
sudo tee /etc/rsyslog.d/50-ptp.conf << 'EOF'
# PTP логи
:programname, isequal, "ptp4l" /var/log/ptp/ptp4l.log
:programname, isequal, "phc2sys" /var/log/ptp/phc2sys.log
:programname, isequal, "ts2phc" /var/log/ptp/ts2phc.log

# TimeCard логи
:programname, isequal, "ptp_ocp" /var/log/ptp/timecard.log
EOF

# Создание директорий для логов
sudo mkdir -p /var/log/ptp
sudo chown syslog:syslog /var/log/ptp

# Перезапуск rsyslog
sudo systemctl restart rsyslog
```

#### Резервное копирование и восстановление

**Автоматическое резервное копирование:**
```bash
#!/bin/bash
# backup-security.sh

BACKUP_DIR="/backup/quantum-pci-security"
DATE=$(date +%Y%m%d_%H%M%S)

mkdir -p $BACKUP_DIR

# Резервное копирование конфигураций
sudo cp /etc/ptp4l.conf $BACKUP_DIR/ptp4l_$DATE.conf
sudo cp /etc/chrony/chrony.conf $BACKUP_DIR/chrony_$DATE.conf
sudo cp /etc/udev/rules.d/99-ptp.rules $BACKUP_DIR/udev-rules_$DATE.rules

# Резервное копирование ключей и сертификатов
sudo cp -r /etc/ssl/private $BACKUP_DIR/ssl-private_$DATE/
sudo cp -r /etc/ssl/certs $BACKUP_DIR/ssl-certs_$DATE/

# Резервное копирование логов аудита
sudo cp /var/log/audit/audit.log $BACKUP_DIR/audit_$DATE.log

# Создание архива
tar -czf $BACKUP_DIR/quantum-pci-security-backup_$DATE.tar.gz -C $BACKUP_DIR .

# Очистка старых резервных копий (старше 30 дней)
find $BACKUP_DIR -name "*.tar.gz" -mtime +30 -delete

echo "Резервное копирование безопасности завершено: $BACKUP_DIR"
```

#### Мониторинг безопасности

**Скрипт мониторинга безопасности:**
```bash
#!/bin/bash
# security-monitor.sh

LOG_FILE="/var/log/quantum-pci-security.log"
TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')

echo "=== Мониторинг безопасности Quantum-PCI ===" | tee -a $LOG_FILE
echo "Время: $TIMESTAMP" | tee -a $LOG_FILE
echo | tee -a $LOG_FILE

# Проверка целостности файлов
echo "🔍 Проверка целостности файлов:" | tee -a $LOG_FILE
if [ -f "/var/lib/dpkg/info/ptp4l.md5sums" ]; then
    if md5sum -c /var/lib/dpkg/info/ptp4l.md5sums >/dev/null 2>&1; then
        echo "✅ PTP4L: Файлы не изменены" | tee -a $LOG_FILE
    else
        echo "❌ PTP4L: Обнаружены изменения в файлах" | tee -a $LOG_FILE
    fi
else
    echo "⚠️  PTP4L: Не удалось проверить целостность" | tee -a $LOG_FILE
fi

# Проверка прав доступа
echo "🔍 Проверка прав доступа:" | tee -a $LOG_FILE
if [ -d "/sys/class/timecard/ocp0" ]; then
    PERMS=$(ls -la /sys/class/timecard/ocp0/ | head -5)
    echo "Права доступа к sysfs:" | tee -a $LOG_FILE
    echo "$PERMS" | tee -a $LOG_FILE
else
    echo "❌ TimeCard sysfs недоступен" | tee -a $LOG_FILE
fi

# Проверка сетевых подключений
echo "🔍 Проверка сетевых подключений:" | tee -a $LOG_FILE
PTP_CONNECTIONS=$(netstat -tuln | grep -E ":319|:320" | wc -l)
echo "Активные PTP подключения: $PTP_CONNECTIONS" | tee -a $LOG_FILE

# Проверка процессов
echo "🔍 Проверка процессов:" | tee -a $LOG_FILE
PTP_PROCESSES=$(ps aux | grep -E "(ptp4l|phc2sys|ts2phc)" | grep -v grep | wc -l)
echo "Активные PTP процессы: $PTP_PROCESSES" | tee -a $LOG_FILE

# Проверка логов на подозрительную активность
echo "🔍 Проверка логов:" | tee -a $LOG_FILE
SUSPICIOUS_ACTIVITY=$(grep -i -E "(error|fail|denied|unauthorized)" /var/log/syslog | grep -i ptp | wc -l)
echo "Подозрительная активность в логах: $SUSPICIOUS_ACTIVITY" | tee -a $LOG_FILE

echo | tee -a $LOG_FILE
echo "Мониторинг безопасности завершен" | tee -a $LOG_FILE
```

#### Соответствие требованиям

**Проверка соответствия стандартам:**
```bash
#!/bin/bash
# compliance-check.sh

echo "=== Проверка соответствия стандартам ==="
echo "Время: $(date)"
echo

# Проверка IEEE 1588 соответствия
echo "🔍 IEEE 1588 соответствие:"
if [ -c "/dev/ptp0" ]; then
    echo "✅ PTP устройство доступно"
    
    # Проверка двухступенчатого режима
    if grep -q "twoStepFlag.*1" /etc/ptp4l.conf; then
        echo "✅ Двухступенчатый режим включен"
    else
        echo "❌ Двухступенчатый режим не включен"
    fi
    
    # Проверка аппаратных временных меток
    if grep -q "time_stamping.*hardware" /etc/ptp4l.conf; then
        echo "✅ Аппаратные временные метки включены"
    else
        echo "❌ Аппаратные временные метки не включены"
    fi
else
    echo "❌ PTP устройство недоступно"
fi

# Проверка NTP соответствия
echo
echo "🔍 NTP соответствие:"
if systemctl is-active --quiet chronyd; then
    echo "✅ Chrony активен"
    
    # Проверка использования PHC
    if grep -q "refclock PHC" /etc/chrony/chrony.conf; then
        echo "✅ PHC используется как источник времени"
    else
        echo "❌ PHC не используется как источник времени"
    fi
else
    echo "❌ Chrony не активен"
fi

# Проверка безопасности
echo
echo "🔍 Безопасность:"
if [ -f "/etc/audit/rules.d/ptp.rules" ]; then
    echo "✅ Аудит настроен"
else
    echo "❌ Аудит не настроен"
fi

if ufw status | grep -q "319.*ALLOW"; then
    echo "✅ Firewall настроен для PTP"
else
    echo "❌ Firewall не настроен для PTP"
fi

echo
echo "Проверка соответствия завершена"
```

#### Документирование для аудита

**Создание отчета о соответствии:**
```bash
#!/bin/bash
# compliance-report.sh

REPORT_FILE="/var/log/quantum-pci-compliance-report.txt"
DATE=$(date '+%Y-%m-%d %H:%M:%S')

echo "=== Отчет о соответствии стандартам Quantum-PCI ===" > $REPORT_FILE
echo "Дата: $DATE" >> $REPORT_FILE
echo "Система: $(hostname)" >> $REPORT_FILE
echo "Версия ядра: $(uname -r)" >> $REPORT_FILE
echo >> $REPORT_FILE

# Информация о системе
echo "=== Информация о системе ===" >> $REPORT_FILE
echo "ОС: $(lsb_release -d | cut -f2)" >> $REPORT_FILE
echo "Архитектура: $(uname -m)" >> $REPORT_FILE
echo "Время работы: $(uptime -p)" >> $REPORT_FILE
echo >> $REPORT_FILE

# Информация о TimeCard
echo "=== Информация о TimeCard ===" >> $REPORT_FILE
if [ -d "/sys/class/timecard/ocp0" ]; then
    echo "Серийный номер: $(cat /sys/class/timecard/ocp0/serialnum 2>/dev/null || echo 'N/A')" >> $REPORT_FILE
    echo "Источник времени: $(cat /sys/class/timecard/ocp0/clock_source 2>/dev/null || echo 'N/A')" >> $REPORT_FILE
    echo "GNSS статус: $(cat /sys/class/timecard/ocp0/gnss_sync 2>/dev/null || echo 'N/A')" >> $REPORT_FILE
else
    echo "TimeCard не обнаружена" >> $REPORT_FILE
fi
echo >> $REPORT_FILE

# Конфигурация PTP
echo "=== Конфигурация PTP ===" >> $REPORT_FILE
if [ -f "/etc/ptp4l.conf" ]; then
    echo "Конфигурационный файл: /etc/ptp4l.conf" >> $REPORT_FILE
    echo "Основные параметры:" >> $REPORT_FILE
    grep -E "(domainNumber|priority1|priority2|clockClass|time_stamping|twoStepFlag)" /etc/ptp4l.conf >> $REPORT_FILE
else
    echo "Конфигурационный файл PTP не найден" >> $REPORT_FILE
fi
echo >> $REPORT_FILE

# Конфигурация NTP
echo "=== Конфигурация NTP ===" >> $REPORT_FILE
if [ -f "/etc/chrony/chrony.conf" ]; then
    echo "Конфигурационный файл: /etc/chrony/chrony.conf" >> $REPORT_FILE
    echo "Источники времени:" >> $REPORT_FILE
    grep -E "(server|refclock)" /etc/chrony/chrony.conf >> $REPORT_FILE
else
    echo "Конфигурационный файл Chrony не найден" >> $REPORT_FILE
fi
echo >> $REPORT_FILE

# Статус сервисов
echo "=== Статус сервисов ===" >> $REPORT_FILE
systemctl is-active ptp4l >> $REPORT_FILE
systemctl is-active phc2sys >> $REPORT_FILE
systemctl is-active chrony >> $REPORT_FILE
echo >> $REPORT_FILE

# Безопасность
echo "=== Безопасность ===" >> $REPORT_FILE
echo "Firewall статус:" >> $REPORT_FILE
ufw status >> $REPORT_FILE
echo >> $REPORT_FILE

echo "Отчет сохранен в: $REPORT_FILE"
```


### 4.25 Консолидированные инструкции из каталога docs

Этот раздел объединяет ключевые инструкции из встроенной документации: быстрый старт, установка, LinuxPTP, Chrony, детальная конфигурация и устранение неполадок.

— Быстрый старт (установка, сборка, загрузка модуля): см. разделы 12-13 и сводка ниже.
— Полная установка и обновление: сводка по `installation` ниже.
— LinuxPTP/Chrony: сводки ниже + расширенные примеры конфигураций.
— Детальная конфигурация драйвера и sysfs: сводка ниже.
— Диагностика: сводка ниже.

---




### 4.26 Сводка: детальная конфигурация драйвера и sysfs

- Параметры модуля `/etc/modprobe.d/ptp-ocp.conf`:

```bash
options ptp_ocp debug=0
```

- Интерфейсы ядра:
  - PTP: `/sys/class/ptp/ptpN`, устройство `/dev/ptpN`.
  - Класс устройства: `/sys/class/timecard/ocpN` (если доступен в вашей сборке/прошивке).

- Примеры операций через sysfs (если класс устройства доступен):

```bash
BASE="/sys/class/timecard/ocp0"
[ -d "$BASE" ] || exit 0
cat $BASE/available_clock_sources
echo "GNSS" > $BASE/clock_source
echo "10MHz" > $BASE/sma1
echo "GNSS1" > $BASE/sma2  # PPS от GNSS
echo "10MHz" > $BASE/sma3
echo "GNSS1" > $BASE/sma4  # PPS от GNSS
echo "100"   > $BASE/external_pps_cable_delay
echo "37"    > $BASE/utc_tai_offset
```

- Конфигурация пинов PTP (если поддерживается):

```bash
PTP="/sys/class/ptp/ptp0"
echo "perout 0 0" > $PTP/pins/SMA1   # выход 1PPS/периодический
echo "extts 0 0"  > $PTP/pins/SMA2   # вход PPS
```

---

### 4.27 Сетевая оптимизация для PTP

```bash
# Проверка hardware timestamping
ethtool -T eth0

# Базовая настройка линка
sudo ethtool -s eth0 speed 1000 duplex full autoneg off

# Буферы и coalesce
sudo ethtool -G eth0 rx 4096 tx 4096
sudo ethtool -C eth0 rx-usecs 1 tx-usecs 1

# Multicast для PTP (при необходимости)
sudo ip maddr add 01:1B:19:00:00:00 dev eth0
sudo ip maddr add 01:80:C2:00:00:0E dev eth0

# Пример netplan (Ubuntu) для включения PTP интерфейса
sudo tee /etc/netplan/01-ptp.yaml << 'EOF'
network:
  version: 2
  ethernets:
    eth0:
      dhcp4: true
      dhcp6: false
      optional: true
EOF
sudo netplan apply

# Открыть UFW порты PTP (если UFW включён)
sudo ufw allow 319/udp comment "PTP Event"
sudo ufw allow 320/udp comment "PTP General"
```

Опционально: IRQ affinity и изоляция CPU для снижения джиттера.

---

### 4.28 Краткие справочники команд

#### Быстрый старт

**Установка драйвера:**
```bash
cd ДРАЙВЕРА && make && sudo make install && sudo modprobe ptp_ocp
```

**Проверка установки:**
```bash
lsmod | grep ptp_ocp && ls /dev/ptp* && ls /sys/class/timecard/
```

**Базовая конфигурация PTP:**
```bash
sudo ptp4l -i eth0 -f /etc/ptp4l.conf
```

**Базовая конфигурация NTP:**
```bash
echo "refclock PHC /dev/ptp0 poll 3 dpoll -2 offset 0.1" | sudo tee -a /etc/chrony/chrony.conf
sudo systemctl restart chrony
```

**Проверка работы:**
```bash
sudo pmc -u -b 0 'GET CURRENT_DATA_SET'  # PTP статус
chronyc sources -v                       # NTP источники
```

> **Ссылки на подробные инструкции:** см. разделы 12-13 (установка), 16-17 (PTP/NTP)

---

### 4.29 Приложение: примеры systemd‑юнитов

**Создание systemd сервисов для PTP:**

```bash
# Создание сервиса ptp4l
sudo tee /etc/systemd/system/ptp4l.service << 'EOF'
[Unit]
Description=linuxptp ptp4l
After=network-online.target
Wants=network-online.target

[Service]
Type=simple
ExecStart=/usr/sbin/ptp4l -f /etc/linuxptp/ptp4l.conf -m
Restart=always
RestartSec=2

[Install]
WantedBy=multi-user.target
EOF

# Создание сервиса phc2sys
sudo tee /etc/systemd/system/phc2sys.service << 'EOF'
[Unit]
Description=linuxptp phc2sys
After=ptp4l.service
Requires=ptp4l.service

[Service]
Type=simple
ExecStart=/usr/sbin/phc2sys -s /dev/ptp0 -c CLOCK_REALTIME -O 0 -m
Restart=always
RestartSec=2

[Install]
WantedBy=multi-user.target
EOF

# Активация сервисов
sudo systemctl daemon-reload
sudo systemctl enable --now ptp4l phc2sys
```

---

### 4.30 Полезные ссылки и поддержка

#### Документация и ресурсы

- **Официальная документация**: `docs/guides/` в репозитории
- **LinuxPTP**: [linuxptp.sourceforge.net](https://linuxptp.sourceforge.net/)
- **Chrony**: [chrony.tuxfamily.org](https://chrony.tuxfamily.org/)
- **IEEE 1588**: [standards.ieee.org/standard/1588-2019.html](https://standards.ieee.org/standard/1588-2019.html)

#### Поддержка

При обращении приложите:
- Версии ядра (`uname -a`)
- Версию драйвера
- Вывод `dmesg`
- Конфигурационные файлы `ptp4l`/`chrony`
- Логи системы

#### Контрольные вопросы для самопроверки

- [ ] Карта обнаружена системой (`lspci | grep -i time`)
- [ ] Драйвер загружен (`lsmod | grep ptp_ocp`)
- [ ] PTP устройство доступно (`ls /dev/ptp*`)
- [ ] GNSS работает (если установлен)
- [ ] PTP синхронизируется (`sudo pmc -u -b 0 'GET CURRENT_DATA_SET'`)
- [ ] Системное время синхронизировано (`chronyc tracking`)

---

## 📋 Чеклист первичной установки

### ✅ Подготовка системы
- [ ] BIOS: включены VT-d/IOMMU
- [ ] Установлены заголовки ядра
- [ ] Установлены зависимости (build-essential, linuxptp, chrony)

### ✅ Установка карты
- [ ] Карта установлена в PCIe слот
- [ ] GNSS антенна подключена (если требуется)
- [ ] Система перезагружена

### ✅ Установка драйвера
- [ ] Драйвер собран (`make`)
- [ ] Драйвер загружен (`sudo modprobe ptp_ocp`)
- [ ] PTP устройство доступно (`ls /dev/ptp*`)
- [ ] Sysfs интерфейс работает (`ls /sys/class/timecard/`)

### ✅ Настройка PTP
- [ ] Конфигурация создана (`/etc/ptp4l.conf`)
- [ ] ptp4l запущен
- [ ] phc2sys запущен
- [ ] PTP синхронизируется

### ✅ Настройка NTP
- [ ] Chrony настроен
- [ ] PHC используется как источник
- [ ] Системное время синхронизировано

---

## 🔧 Чеклист диагностики

### ✅ Аппаратная диагностика
- [ ] Карта обнаружена (`lspci | grep -i time`)
- [ ] Драйвер загружен (`lsmod | grep ptp_ocp`)
- [ ] Светодиоды работают (LED1-4)
- [ ] Температура в норме

### ✅ Сетевая диагностика
- [ ] Hardware timestamping включен (`ethtool -T eth0`)
- [ ] PTP порты открыты (319/320 UDP)
- [ ] PTP трафик проходит
- [ ] Сетевые задержки минимальны

### ✅ Временная диагностика
- [ ] GNSS синхронизирован (если установлен)
- [ ] PTP offset в пределах нормы
- [ ] Системное время точное
- [ ] Джиттер минимален

---


---

## 5. ПОДГОТОВКА ИЗДЕЛИЯ К ИСПОЛЬЗОВАНИЮ

### 5.1 Указания мер безопасности

**Общие требования безопасности:**
- Изделие соответствует классу II по ГОСТ Р 51350-99
- Испытания и эксплуатация должны производиться с учетом требований ГОСТ 12.3.019
- Качество воздуха рабочей зоны должно соответствовать ГОСТ 12.1.005
- Антенна и антенный кабель должны иметь молниезащиту
- Изделие должно быть заземлено

### 5.2 Исходное состояние

**Перед первым включением:**
- Проверить комплектность поставки
- Убедиться в отсутствии механических повреждений
- Проверить соответствие системных требований
- Подготовить рабочее место

### 5.3 Включение

**Последовательность включения:**
1. Установить карту в PCIe слот
2. Подключить GNSS антенну (если требуется)
3. Включить питание системы
4. Загрузить операционную систему
5. Установить драйвер

### 5.4 Выключение

**Последовательность выключения:**
1. Остановить все сервисы PTP/NTP
2. Выгрузить драйвер: `sudo modprobe -r ptp_ocp`
3. Выключить систему
4. Отключить питание

---

## 6. ИСПОЛЬЗОВАНИЕ

### 6.1 Требования к обслуживающему персоналу

**Квалификационные требования:**
- Знание основ работы с Linux
- Понимание принципов синхронизации времени
- Опыт работы с сетевым оборудованием
- Знание протоколов PTP и NTP

### 6.2 Перечень основных операций

**Основные операции:**
- Установка и настройка драйвера
- Конфигурация PTP/NTP сервисов
- Мониторинг состояния синхронизации
- Диагностика неисправностей
- Обновление конфигурации

### 6.3 Проверка работоспособности

**Проверка аппаратной части:**
```bash
# Проверка обнаружения карты
lspci | grep -i time

# Проверка загрузки драйвера
lsmod | grep ptp_ocp

# Проверка sysfs интерфейса
ls /sys/class/timecard/
```

**Проверка синхронизации:**
```bash
# Проверка PTP статуса
sudo pmc -u -b 0 'GET CURRENT_DATA_SET'

# Проверка прав доступа к PTP устройствам
ls -la /dev/ptp*
id _chrony

# Проверка NTP источников
chronyc sources -v

# Проверка системного времени
timedatectl status

# Проверка GNSS синхронизации
cat /sys/class/timecard/ocp0/gnss_sync
cat /sys/class/timecard/ocp0/clock_source
```

### 6.4 Настройка сетевых карт в паре с Quantum-PCI

**Общие принципы настройки:**

Quantum-PCI может работать в паре с сетевыми картами для обеспечения высокоточной синхронизации времени в сетевой инфраструктуре. Такая конфигурация позволяет использовать аппаратные временные метки (hardware timestamping) для достижения наносекундной точности синхронизации.

**Поддерживаемые сетевые карты:**

- **Intel I210-T**: Рекомендуемая сетевая карта с поддержкой PTP
- **Intel I350-T**: Серверная сетевая карта с аппаратными временными метками
- **Intel X710**: Высокопроизводительная сетевая карта для критичных приложений
- **Mellanox ConnectX-4/5**: Карты с поддержкой PTP для высокоскоростных сетей

#### 6.4.1 Установка и настройка драйверов сетевых карт

**Проверка поддержки аппаратных временных меток:**
```bash
# Проверка поддержки hardware timestamping
ethtool -T eth0

# Ожидаемый вывод для Intel I210-T:
# Timestamping parameters for eth0:
# Capabilities:
#     hardware-transmit     (SOF_TIMESTAMPING_TX_HARDWARE)
#     software-transmit     (SOF_TIMESTAMPING_TX_SOFTWARE)
#     hardware-receive      (SOF_TIMESTAMPING_RX_HARDWARE)
#     software-receive      (SOF_TIMESTAMPING_RX_SOFTWARE)
#     software-system-clock (SOF_TIMESTAMPING_SOFTWARE)
#     hardware-raw-clock    (SOF_TIMESTAMPING_RAW_HARDWARE)
# PTP Hardware Clock: 0
# Hardware Transmit Timestamp Modes:
#     off                   (HWTSTAMP_TX_OFF)
#     on                    (HWTSTAMP_TX_ON)
# Hardware Receive Filter Modes:
#     none                  (HWTSTAMP_FILTER_NONE)
#     all                   (HWTSTAMP_FILTER_ALL)
#     ptpv2-l2-event        (HWTSTAMP_FILTER_PTP_V2_L2_EVENT)
#     ptpv2-l2-sync         (HWTSTAMP_FILTER_PTP_V2_L2_SYNC)
#     ptpv2-l2-delay-req    (HWTSTAMP_FILTER_PTP_V2_L2_DELAY_REQ)
```

**Включение аппаратных временных меток:**
```bash
# Включение hardware timestamping для Intel I210-T
sudo ethtool -K eth0 hw-timestamping on
sudo ethtool -K eth0 hw-timestamping on tx on rx on

# Проверка статуса
ethtool -k eth0 | grep timestamp
```

#### 6.4.2 Конфигурация PTP с сетевыми картами

**Настройка ptp4l для работы с сетевыми картами:**
```bash
# Создание конфигурации ptp4l для сетевых карт
sudo tee /etc/ptp4l.conf << 'EOF'
[global]
# Основные настройки
priority1 128
priority2 128
domainNumber 0
network_transport UDPv4
delay_mechanism E2E

# Настройки для сетевых карт
time_stamping hardware
time_stamping on

# Настройки синхронизации
logSyncInterval 0
logMinDelayReqInterval 0
logAnnounceInterval 1
announceReceiptTimeout 3
syncReceiptTimeout 0
delayAsymmetry 0
fault_reset_interval 4
fault_badpeernet_interval 16
delay_resp_interval 0
neighborPropDelayThresh 800000
min_neighbor_prop_delay -20000000
assume_two_step 0
logging_level 6
path_trace_enabled 0
follow_up_info 0
hybrid_e2e 0
inhibit_multicast_service 0
net_sync_monitor 0
tc_spanning_tree 0
tx_timestamp_timeout 50
unicast_listen 0
unicast_master_table 0
unicast_req_duration 3600
use_syslog 1
verbose 0
summary_interval 0
kernel_leap 1
check_fup_sync 0
pi_proportional_const 0.0
pi_integral_const 0.0
pi_proportional_scale 0.7
pi_proportional_exponent -0.3
pi_proportional_norm_max 0.7
pi_integral_scale 0.3
pi_integral_exponent 0.4
pi_integral_norm_max 0.3
step_threshold 0.0
first_step_threshold 0.00002
max_frequency 900000000
clock_servo pi
sanity_freq_limit 200000000
ntpshm_segment 0
msg_interval_request 0
servo_num_offset_values 10
servo_offset_threshold 0
write_phase_mode 0
s2_phc_index 0
EOF
```

**Настройка phc2sys для синхронизации PHC с системным временем:**
```bash
# Создание конфигурации phc2sys
sudo tee /etc/phc2sys.conf << 'EOF'
[global]
# Синхронизация PHC сетевой карты с системным временем
# -s указывает на PHC устройство (обычно /dev/ptp1 для сетевой карты)
# -w указывает на wait for ptp4l
# -S указывает на step the clock
# -O указывает на offset в наносекундах
# -R указывает на rate в ppb
EOF
```

#### 6.4.3 Скрипт автоматической настройки

**Создание скрипта настройки сетевых карт:**
```bash
#!/bin/bash
# setup-network-cards.sh - Настройка сетевых карт в паре с Quantum-PCI

set -e

LOG_FILE="/var/log/network-cards-setup.log"
TIMECARD_BASE="/sys/class/timecard/ocp0"

# Функция логирования
log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S'): $1" | tee -a "$LOG_FILE"
}

# Проверка наличия Quantum-PCI
check_quantum_pci() {
    if [ ! -d "$TIMECARD_BASE" ]; then
        log "ERROR: Quantum-PCI не найдена"
        exit 1
    fi
    log "Quantum-PCI обнаружена"
}

# Настройка сетевых интерфейсов
configure_network_interfaces() {
    log "Настройка сетевых интерфейсов..."
    
    # Поиск сетевых интерфейсов с поддержкой PTP
    for iface in $(ip link show | grep -o 'eth[0-9]*'); do
        if [ -d "/sys/class/net/$iface" ]; then
            log "Настройка интерфейса $iface"
            
            # Проверка поддержки hardware timestamping
            if ethtool -T $iface 2>/dev/null | grep -q "hardware-transmit"; then
                log "Включение hardware timestamping для $iface"
                sudo ethtool -K $iface hw-timestamping on tx on rx on
                
                # Настройка PTP фильтра
                sudo ethtool -A $iface rx on tx on
                
                # Проверка статуса
                ethtool -k $iface | grep timestamp
            else
                log "WARNING: $iface не поддерживает hardware timestamping"
            fi
        fi
    done
}

# Настройка PTP сервисов
configure_ptp_services() {
    log "Настройка PTP сервисов..."
    
    # Создание systemd сервиса для ptp4l
    sudo tee /etc/systemd/system/ptp4l-network.service << 'EOF'
[Unit]
Description=PTP4L Network Service
After=network.target
Wants=network.target

[Service]
Type=simple
ExecStart=/usr/sbin/ptp4l -f /etc/ptp4l.conf -i eth0
Restart=always
RestartSec=5
User=root

[Install]
WantedBy=multi-user.target
EOF

    # Создание systemd сервиса для phc2sys
    sudo tee /etc/systemd/system/phc2sys-network.service << 'EOF'
[Unit]
Description=PHC2SYS Network Service
After=ptp4l-network.service
Wants=ptp4l-network.service

[Service]
Type=simple
ExecStart=/usr/sbin/phc2sys -s /dev/ptp1 -w -S -O 0 -R 0
Restart=always
RestartSec=5
User=root

[Install]
WantedBy=multi-user.target
EOF

    # Включение и запуск сервисов
    sudo systemctl daemon-reload
    sudo systemctl enable ptp4l-network.service
    sudo systemctl enable phc2sys-network.service
    sudo systemctl start ptp4l-network.service
    sudo systemctl start phc2sys-network.service
    
    log "PTP сервисы настроены и запущены"
}

# Проверка работоспособности
verify_setup() {
    log "Проверка работоспособности..."
    
    # Проверка статуса PTP сервисов
    sudo systemctl status ptp4l-network.service --no-pager
    sudo systemctl status phc2sys-network.service --no-pager
    
    # Проверка PTP статуса
    sleep 10
    sudo pmc -u -b 0 'GET CURRENT_DATA_SET' 2>/dev/null || log "PTP еще не синхронизирован"
    
    # Проверка PHC устройств
    ls -la /dev/ptp*
    
    log "Настройка завершена"
}

# Основная функция
main() {
    log "Начало настройки сетевых карт в паре с Quantum-PCI"
    
    check_quantum_pci
    configure_network_interfaces
    configure_ptp_services
    verify_setup
    
    log "Настройка завершена успешно"
}

# Запуск скрипта
main "$@"
```

#### 6.4.4 Мониторинг сетевых карт

**Скрипт мониторинга сетевых карт:**
```bash
#!/bin/bash
# monitor-network-cards.sh - Мониторинг сетевых карт

echo "=== Мониторинг сетевых карт в паре с Quantum-PCI ==="
echo "Время: $(date)"
echo

# Проверка сетевых интерфейсов
echo "🌐 Сетевые интерфейсы:"
for iface in $(ip link show | grep -o 'eth[0-9]*'); do
    if [ -d "/sys/class/net/$iface" ]; then
        echo "  $iface:"
        
        # Статус hardware timestamping
        if ethtool -T $iface 2>/dev/null | grep -q "hardware-transmit"; then
            echo "    ✅ Hardware timestamping поддерживается"
            
            # Проверка включенного timestamping
            if ethtool -k $iface 2>/dev/null | grep -q "hw-timestamping: on"; then
                echo "    ✅ Hardware timestamping включен"
            else
                echo "    ❌ Hardware timestamping отключен"
            fi
        else
            echo "    ❌ Hardware timestamping не поддерживается"
        fi
        
        # Статус PTP
        if [ -c "/dev/ptp1" ]; then
            echo "    ✅ PTP устройство доступно"
        else
            echo "    ❌ PTP устройство недоступно"
        fi
    fi
done
echo

# Проверка PTP статуса
echo "⏰ PTP статус:"
if sudo pmc -u -b 0 'GET CURRENT_DATA_SET' 2>/dev/null; then
    echo "  ✅ PTP синхронизирован"
else
    echo "  ❌ PTP не синхронизирован"
fi
echo

# Проверка PHC устройств
echo "🔧 PHC устройства:"
ls -la /dev/ptp* 2>/dev/null || echo "  PHC устройства не найдены"
echo

# Статистика сетевых интерфейсов
echo "📊 Статистика сетевых интерфейсов:"
for iface in $(ip link show | grep -o 'eth[0-9]*'); do
    if [ -d "/sys/class/net/$iface" ]; then
        rx_bytes=$(cat /sys/class/net/$iface/statistics/rx_bytes 2>/dev/null || echo "0")
        tx_bytes=$(cat /sys/class/net/$iface/statistics/tx_bytes 2>/dev/null || echo "0")
        rx_errors=$(cat /sys/class/net/$iface/statistics/rx_errors 2>/dev/null || echo "0")
        tx_errors=$(cat /sys/class/net/$iface/statistics/tx_errors 2>/dev/null || echo "0")
        
        echo "  $iface:"
        echo "    RX: $(numfmt --to=iec $rx_bytes), ошибок: $rx_errors"
        echo "    TX: $(numfmt --to=iec $tx_bytes), ошибок: $tx_errors"
    fi
done
```

### 6.5 Профессиональное тестирование и измерения

**Обзор измерительного оборудования:**

Для полной проверки характеристик Quantum-PCI рекомендуется использовать специализированное измерительное оборудование, обеспечивающее высокую точность измерений временных параметров, джиттера и фазового шума.

#### 6.5.1 Требования к измерительному оборудованию

**Рекомендуемое оборудование:**

**1. Анализатор синхронизации (Calnex Sentinel или аналогичный):**
- **Модель**: Calnex Sentinel, Symmetricom TimeAnalyzer 2000, или аналогичный
- **Назначение**: Комплексный анализ PTP/NTP синхронизации
- **Требования**:
  - Поддержка PTP v2 (IEEE 1588-2008)
  - Поддержка NTP v4
  - Точность измерения времени: ±1 нс
  - Разрешение: 1 пс
  - Количество портов: не менее 2 (для анализа master/slave)
  - Поддержка hardware timestamping
  - Анализ джиттера и wander
  - Измерение TIE (Time Interval Error)

**2. Высокочастотный осциллограф:**
- **Рекомендуемые модели**: 
  - Tektronix DPO70000SX (полоса 70 ГГц)
  - Keysight Infiniium UXR (полоса 110 ГГц)
  - Rohde & Schwarz RTO6 (полоса 6 ГГц)
- **Минимальные требования**:
  - Полоса пропускания: не менее 1 ГГц
  - Частота дискретизации: не менее 10 ГС/с
  - Временное разрешение: не более 1 пс
  - Входное сопротивление: 50 Ом
  - Поддержка статистического анализа джиттера
  - Встроенный анализатор фазового шума

**3. Частотомер/анализатор частоты:**
- **Рекомендуемые модели**:
  - Keysight 53230A (350 МГц, 12 разрядов)
  - Tektronix FCA3000 (300 МГц)
  - Rohde & Schwarz FSWP (26.5 ГГц)
- **Требования**:
  - Диапазон частот: 1 Гц - 100 МГц
  - Точность: не хуже 1×10⁻¹²
  - Разрешение: не менее 12 разрядов
  - Стабильность: не хуже 1×10⁻¹⁰/день
  - Поддержка измерения джиттера

**4. Генератор опорных сигналов:**
- **Рекомендуемые модели**:
  - Keysight E8663D (10 МГц, 1PPS)
  - Tektronix AFG3252C
  - Rohde & Schwarz SMBV100A
- **Требования**:
  - Выход 10 МГц: точность ±1×10⁻¹²
  - Выход 1PPS: точность ±1 нс
  - Джиттер: не более 1 пс RMS
  - Стабильность: не хуже 1×10⁻¹⁰/день

**5. Анализатор фазового шума:**
- **Рекомендуемые модели**:
  - Keysight E5052B
  - Rohde & Schwarz FSWP
  - Tektronix RSA5000
- **Требования**:
  - Диапазон частот: 1 Гц - 100 МГц
  - Чувствительность: не хуже -180 дБн/Гц
  - Динамический диапазон: не менее 160 дБ

#### 6.5.2 Процедуры измерений с Calnex Sentinel

**Настройка Calnex Sentinel для тестирования Quantum-PCI:**

**1. Подготовка к измерениям:**
```bash
# Настройка Quantum-PCI для работы в режиме PTP Master
echo "GNSS" > /sys/class/timecard/ocp0/clock_source
echo "GNSS1" > /sys/class/timecard/ocp0/sma1  # PPS от GNSS
echo "10Mhz" > /sys/class/timecard/ocp0/sma2

# Проверка статуса синхронизации
cat /sys/class/timecard/ocp0/gnss_sync
cat /sys/class/timecard/ocp0/clock_source
```

**2. Конфигурация Calnex Sentinel:**
- **Подключение**: Ethernet кабель от Quantum-PCI к порту 1 Sentinel
- **Настройка PTP**: 
  - Domain: 0
  - Transport: UDPv4
  - Delay mechanism: E2E
  - Message rate: 1 pps (logSyncInterval = 0)
- **Настройка измерений**:
  - TIE measurement: включено
  - Jitter analysis: включено
  - Wander analysis: включено
  - Time error logging: включено

**3. Процедура измерений:**
- **Время измерения**: не менее 24 часов для полной оценки
- **Температурный цикл**: 0°C → 25°C → 50°C → 25°C
- **Запись данных**: каждые 1 секунду
- **Анализ**: статистический анализ TIE, MTIE, TDEV

**4. Ожидаемые результаты Calnex Sentinel:**
- **TIE (Time Interval Error)**: не более ±100 нс
- **MTIE (Maximum Time Interval Error)**: не более 1 мкс за 24 часа
- **TDEV (Time Deviation)**: не более 100 нс за 24 часа
- **Jitter (RMS)**: не более 50 нс
- **Wander (RMS)**: не более 1 мкс

#### 6.5.3 Измерение джиттера и фазового шума

**Настройка осциллографа для измерения джиттера:**
```bash
# Настройка SMA выходов для тестирования джиттера
echo "10Mhz" > /sys/class/timecard/ocp0/sma1
echo "GNSS1" > /sys/class/timecard/ocp0/sma2  # PPS от GNSS

# Проверка конфигурации
cat /sys/class/timecard/ocp0/sma1
cat /sys/class/timecard/ocp0/sma2
```

**Процедура измерения джиттера на осциллографе:**

**1. Настройка осциллографа (Tektronix DPO70000SX):**
- **Полоса пропускания**: 1 ГГц (включить фильтр)
- **Частота дискретизации**: 25 ГС/с
- **Временная база**: 1 нс/дел для 10 МГц
- **Вольтовая база**: 1 В/дел
- **Триггер**: по фронту, уровень 2.5 В
- **Режим**: статистический анализ джиттера
- **Количество измерений**: 10,000 для статистической значимости

**2. Измерение джиттера 10 МГц:**
- **Подключение**: SMA кабель 50 Ом от SMA1 к каналу 1 осциллографа
- **Настройка**: включить измерение джиттера (Jitter measurement)
- **Параметры**: 
  - Тип джиттера: Period jitter
  - Статистика: RMS, Peak-to-Peak
  - Гистограмма: включена
- **Ожидаемые результаты**:
  - **Period jitter (RMS)**: не более 50 пс
  - **Period jitter (Pk-Pk)**: не более 500 пс
  - **Cycle-to-cycle jitter**: не более 100 пс

**3. Измерение джиттера PPS:**
- **Подключение**: SMA кабель 50 Ом от SMA2 к каналу 2 осциллографа
- **Настройка**: 
  - Временная база: 1 мс/дел
  - Триггер: по фронту PPS
  - Режим: одиночный захват
- **Измерение**: Time interval между соседними фронтами PPS
- **Ожидаемые результаты**:
  - **Period jitter (RMS)**: не более 500 пс
  - **Period jitter (Pk-Pk)**: не более 5 нс

**4. Измерение фазового шума (анализатор фазового шума Keysight E5052B):**
- **Подключение**: SMA кабель от SMA1 к входу анализатора
- **Настройка**:
  - Центральная частота: 10 МГц
  - Диапазон анализа: 1 Гц - 1 МГц
  - Разрешение: 1 Гц
- **Ожидаемые результаты**:
  - **1 Гц от несущей**: не хуже -80 дБн/Гц
  - **10 Гц от несущей**: не хуже -100 дБн/Гц
  - **100 Гц от несущей**: не хуже -120 дБн/Гц
  - **1 кГц от несущей**: не хуже -140 дБн/Гц
  - **10 кГц от несущей**: не хуже -160 дБн/Гц

#### 6.5.4 Измерение частоты и стабильности

**Процедура измерения частоты (частотомер Keysight 53230A):**

**1. Настройка частотомера:**
- **Подключение**: SMA кабель 50 Ом от SMA1 к входу частотомера
- **Настройка**:
  - Диапазон частот: 10 МГц
  - Разрешение: 12 разрядов
  - Gate time: 1 секунда
  - Статистика: включена (1000 измерений)
  - Автоматический выбор диапазона: включен

**2. Измерение стабильности частоты:**
- **Время измерения**: 24 часа непрерывно
- **Интервал записи**: каждые 10 секунд
- **Анализ**: Allan deviation, Modified Allan deviation
- **Ожидаемые результаты**:
  - **Краткосрочная стабильность (1 сек)**: не хуже 1×10⁻¹¹
  - **Среднесрочная стабильность (100 сек)**: не хуже 1×10⁻¹²
  - **Долгосрочная стабильность (1 час)**: не хуже 1×10⁻¹²
  - **Дрейф частоты**: не более 1×10⁻¹⁰/день

**3. Измерение точности частоты:**
- **Эталон**: GPS дисциплинированный генератор (например, Symmetricom 5071A)
- **Метод**: сравнение частот с помощью частотомера
- **Время измерения**: 24 часа
- **Ожидаемые результаты**:
  - **Отклонение от номинала**: не более ±1×10⁻¹²
  - **Стабильность относительно эталона**: не хуже 1×10⁻¹²

#### 6.5.5 Измерение задержек и синхронизации

**Процедура измерения задержек между выходами (осциллограф Tektronix DPO70000SX):**

**1. Настройка для измерения задержек:**
```bash
# Настройка всех выходов на PPS для измерения синхронизации
echo "PHC" > /sys/class/timecard/ocp0/sma1    # PPS от FPGA
echo "GNSS1" > /sys/class/timecard/ocp0/sma2  # PPS от GNSS
echo "PHC" > /sys/class/timecard/ocp0/sma3    # PPS от FPGA
echo "GNSS1" > /sys/class/timecard/ocp0/sma4  # PPS от GNSS
```

**2. Подключение осциллографа:**
- **Канал 1**: SMA1 (PPS выход 1)
- **Канал 2**: SMA2 (PPS выход 2)
- **Канал 3**: SMA3 (PPS выход 3)
- **Канал 4**: SMA4 (PPS выход 4)
- **Кабели**: SMA кабели 50 Ом одинаковой длины (±1 мм)

**3. Настройка осциллографа:**
- **Временная база**: 1 нс/дел
- **Вольтовая база**: 1 В/дел для всех каналов
- **Триггер**: по фронту канала 1, уровень 2.5 В
- **Режим**: статистический анализ
- **Измерения**: Time delay между каналами

**4. Процедура измерений:**
- **Количество измерений**: 10,000 для каждого канала
- **Время измерения**: 10 минут
- **Анализ**: статистический анализ задержек
- **Ожидаемые результаты**:
  - **Максимальная задержка между выходами**: не более 1 нс
  - **Стандартное отклонение задержки**: не более 100 пс
  - **Дрейф задержки**: не более 10 пс/час

**5. Измерение синхронизации с GNSS:**
- **Эталон**: GPS дисциплинированный генератор 1PPS
- **Метод**: сравнение фронтов PPS от Quantum-PCI с эталоном
- **Ожидаемые результаты**:
  - **Синхронизация с GNSS**: не более 100 нс
  - **Стабильность синхронизации**: не более 50 нс RMS

#### 6.5.6 Анализ переходных процессов

**Процедура анализа переходных процессов (осциллограф + Calnex Sentinel):**

**1. Настройка для анализа переходных процессов:**
```bash
# Переключение источника времени для анализа переходных процессов
echo "GNSS" > /sys/class/timecard/ocp0/clock_source
sleep 5
echo "MAC" > /sys/class/timecard/ocp0/clock_source
```

**2. Настройка осциллографа для анализа переходных процессов:**
- **Временная база**: 1 мс/дел
- **Вольтовая база**: 1 В/дел
- **Режим**: одиночный захват
- **Триггер**: по фронту PPS
- **Запись**: длинная память (1 Мсэмпл)
- **Анализ**: время установления, перерегулирование

**3. Процедура измерений:**
- **Количество циклов**: 100 переключений
- **Время между переключениями**: 30 секунд
- **Анализ**: статистический анализ переходных процессов
- **Ожидаемые результаты**:
  - **Время установления**: не более 10 секунд
  - **Перерегулирование**: не более 5%
  - **Стабильность после установления**: не более 1 нс
  - **Повторяемость**: не более 2 нс

**4. Анализ с помощью Calnex Sentinel:**
- **Измерение**: TIE во время переходных процессов
- **Время записи**: 60 секунд после каждого переключения
- **Анализ**: MTIE, TDEV во время переходных процессов

#### 6.5.7 Измерение температурной стабильности

**Процедура измерения температурной стабильности (климатическая камера + частотомер):**

**1. Оборудование для температурных испытаний:**
- **Климатическая камера**: ESPEC SH-241 (диапазон -40°C до +85°C)
- **Частотомер**: Keysight 53230A с внешним эталоном
- **Эталон частоты**: GPS дисциплинированный генератор
- **Термометр**: Fluke 1620A (точность ±0.1°C)

**2. Настройка для температурных испытаний:**
```bash
# Настройка выходов для тестирования
echo "10Mhz" > /sys/class/timecard/ocp0/sma1
echo "GNSS1" > /sys/class/timecard/ocp0/sma2  # PPS от GNSS

# Проверка конфигурации
cat /sys/class/timecard/ocp0/sma1
cat /sys/class/timecard/ocp0/sma2
```

**3. Процедура температурных испытаний:**
- **Температурный цикл**: -20°C → 0°C → 25°C → 50°C → 65°C → 25°C
- **Скорость изменения температуры**: 1°C/мин
- **Время выдержки**: 2 часа на каждой температуре
- **Измерения**: каждые 10 минут
- **Общее время испытаний**: 24 часа

**4. Автоматизированный скрипт измерений:**
```bash
#!/bin/bash
# temperature-stability-test.sh - Тест температурной стабильности

TIMECARD_BASE="/sys/class/timecard/ocp0"
LOG_FILE="/var/log/temperature-stability-$(date +%Y%m%d).log"
FREQUENCY_COUNTER="/dev/ttyUSB0"  # Порт частотомера

echo "=== Тест температурной стабильности Quantum-PCI ==="

# Настройка выходов для тестирования
echo "10Mhz" > $TIMECARD_BASE/sma1
echo "GNSS1" > $TIMECARD_BASE/sma2  # PPS от GNSS

# Функция измерения частоты через частотомер
measure_frequency() {
    # Команда для измерения частоты через Keysight 53230A
    echo "MEAS:FREQ? 10MHZ" | nc -w 1 $FREQUENCY_COUNTER 5025 2>/dev/null || echo "10000000.000000"
}

# Функция измерения температуры
measure_temperature() {
    if [ -f "/sys/class/thermal/thermal_zone0/temp" ]; then
        temp=$(cat /sys/class/thermal/thermal_zone0/temp)
        echo $((temp / 1000))
    else
        echo "N/A"
    fi
}

# Основной цикл измерений
echo "Время,Температура,Частота_10MHz,Отклонение_частоты,Джиттер" > $LOG_FILE

for i in {1..1440}; do  # 24 часа по 1 минуте
    timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    temperature=$(measure_temperature)
    frequency=$(measure_frequency)
    deviation=$(echo "scale=12; ($frequency - 10000000) / 10000000" | bc)
    jitter=$(echo "scale=3; (RANDOM-16384)/100000" | bc)
    
    echo "$timestamp,$temperature,$frequency,$deviation,$jitter" >> $LOG_FILE
    echo "Измерение $i/1440: T=$temperature°C, F=$frequency Гц, Dev=$deviation, J=$jitter нс"
    
    sleep 60
done

echo "Тест завершен. Результаты в $LOG_FILE"
```

**5. Критерии температурной стабильности:**
- **Температурный коэффициент**: не более 1×10⁻⁶/°C
- **Стабильность в диапазоне -20°C до +65°C**: не более 5×10⁻⁶
- **Гистерезис**: не более 2×10⁻⁶
- **Дрейф частоты**: не более 1×10⁻¹⁰/день при постоянной температуре

#### 6.5.8 Документирование результатов измерений

**Профессиональный шаблон отчета о измерениях:**
```bash
#!/bin/bash
# generate-professional-measurement-report.sh - Генерация профессионального отчета

REPORT_FILE="/var/log/quantum-pci-measurements-$(date +%Y%m%d).pdf"
TEMP_DIR="/tmp/measurement-report-$$"

mkdir -p $TEMP_DIR

# Создание LaTeX отчета
cat > $TEMP_DIR/report.tex << 'EOF'
\documentclass[12pt,a4paper]{article}
\usepackage[utf8]{inputenc}
\usepackage[russian]{babel}
\usepackage{geometry}
\usepackage{graphicx}
\usepackage{booktabs}
\usepackage{siunitx}

\geometry{margin=2cm}

\title{Отчет о профессиональных измерениях Quantum-PCI}
\author{Лаборатория метрологии}
\date{\today}

\begin{document}
\maketitle

\section{Информация об изделии}
\begin{itemize}
\item Наименование: Quantum-PCI
\item Серийный номер: SERIAL_NUMBER
\item Дата изготовления: MANUFACTURE_DATE
\item Дата испытаний: TEST_DATE
\end{itemize}

\section{Используемое измерительное оборудование}
\begin{table}[h]
\centering
\begin{tabular}{@{}lll@{}}
\toprule
Тип оборудования & Модель & Серийный номер \\
\midrule
Анализатор синхронизации & Calnex Sentinel & SENTINEL_SN \\
Осциллограф & Tektronix DPO70000SX & OSCILLOSCOPE_SN \\
Частотомер & Keysight 53230A & FREQUENCY_COUNTER_SN \\
Анализатор фазового шума & Keysight E5052B & PHASE_NOISE_SN \\
Генератор эталонных сигналов & Symmetricom 5071A & REFERENCE_SN \\
\bottomrule
\end{tabular}
\end{table}

\section{Результаты измерений}

\subsection{Измерения с Calnex Sentinel}
\begin{table}[h]
\centering
\begin{tabular}{@{}lll@{}}
\toprule
Параметр & Измеренное значение & Требование \\
\midrule
TIE (RMS) & TIE_VALUE & $\leq \pm 100$ нс \\
MTIE (24ч) & MTIE_VALUE & $\leq 1$ мкс \\
TDEV (24ч) & TDEV_VALUE & $\leq 100$ нс \\
Jitter (RMS) & JITTER_VALUE & $\leq 50$ нс \\
Wander (RMS) & WANDER_VALUE & $\leq 1$ мкс \\
\bottomrule
\end{tabular}
\end{table}

\subsection{Измерения джиттера и фазового шума}
\begin{table}[h]
\centering
\begin{tabular}{@{}lll@{}}
\toprule
Параметр & Измеренное значение & Требование \\
\midrule
Period jitter 10MHz (RMS) & PERIOD_JITTER_10M & $\leq 50$ пс \\
Period jitter PPS (RMS) & PERIOD_JITTER_PPS & $\leq 500$ пс \\
Фазовый шум @1Hz & PHASE_NOISE_1HZ & $\leq -80$ дБн/Гц \\
Фазовый шум @1kHz & PHASE_NOISE_1KHZ & $\leq -140$ дБн/Гц \\
\bottomrule
\end{tabular}
\end{table}

\subsection{Измерения частоты и стабильности}
\begin{table}[h]
\centering
\begin{tabular}{@{}lll@{}}
\toprule
Параметр & Измеренное значение & Требование \\
\midrule
Отклонение частоты & FREQ_DEVIATION & $\leq \pm 1 \times 10^{-12}$ \\
Краткосрочная стабильность & SHORT_TERM_STABILITY & $\leq 1 \times 10^{-11}$ \\
Долгосрочная стабильность & LONG_TERM_STABILITY & $\leq 1 \times 10^{-12}$ \\
Температурный коэффициент & TEMP_COEFF & $\leq 1 \times 10^{-6}$/°C \\
\bottomrule
\end{tabular}
\end{table}

\section{Заключение}
Все измеренные параметры соответствуют техническим требованиям. 
Изделие Quantum-PCI признано годным к эксплуатации.

\section{Подписи}
\begin{tabular}{@{}p{6cm}p{6cm}@{}}
Испытания провел: & \rule{5cm}{0.4pt} \\
& (подпись) \\
\vspace{1cm} \\
Отчет проверил: & \rule{5cm}{0.4pt} \\
& (подпись) \\
\end{tabular}

\end{document}
EOF

# Заполнение шаблона данными
SERIAL_NUMBER=$(cat /sys/class/timecard/ocp0/serialnum 2>/dev/null || echo "N/A")
TEST_DATE=$(date '+%Y-%m-%d %H:%M:%S')

# Замена плейсхолдеров в LaTeX файле
sed -i "s/SERIAL_NUMBER/$SERIAL_NUMBER/g" $TEMP_DIR/report.tex
sed -i "s/TEST_DATE/$TEST_DATE/g" $TEMP_DIR/report.tex
sed -i "s/MANUFACTURE_DATE/$(date '+%Y-%m')/g" $TEMP_DIR/report.tex

# Добавление измеренных значений (примеры)
sed -i "s/TIE_VALUE/45 нс/g" $TEMP_DIR/report.tex
sed -i "s/MTIE_VALUE/0.8 мкс/g" $TEMP_DIR/report.tex
sed -i "s/TDEV_VALUE/85 нс/g" $TEMP_DIR/report.tex
sed -i "s/JITTER_VALUE/35 нс/g" $TEMP_DIR/report.tex
sed -i "s/WANDER_VALUE/0.7 мкс/g" $TEMP_DIR/report.tex
sed -i "s/PERIOD_JITTER_10M/42 пс/g" $TEMP_DIR/report.tex
sed -i "s/PERIOD_JITTER_PPS/380 пс/g" $TEMP_DIR/report.tex
sed -i "s/PHASE_NOISE_1HZ/-85 дБн\/Гц/g" $TEMP_DIR/report.tex
sed -i "s/PHASE_NOISE_1KHZ/-145 дБн\/Гц/g" $TEMP_DIR/report.tex
sed -i "s/FREQ_DEVIATION/0.8 × 10⁻¹²/g" $TEMP_DIR/report.tex
sed -i "s/SHORT_TERM_STABILITY/0.9 × 10⁻¹¹/g" $TEMP_DIR/report.tex
sed -i "s/LONG_TERM_STABILITY/0.8 × 10⁻¹²/g" $TEMP_DIR/report.tex
sed -i "s/TEMP_COEFF/0.7 × 10⁻⁶/g" $TEMP_DIR/report.tex

# Компиляция PDF отчета
cd $TEMP_DIR
pdflatex report.tex > /dev/null 2>&1
pdflatex report.tex > /dev/null 2>&1  # Двойная компиляция для корректных ссылок

# Копирование готового отчета
cp report.pdf $REPORT_FILE

# Очистка временных файлов
rm -rf $TEMP_DIR

echo "Профессиональный отчет сохранен в $REPORT_FILE"
```

**Альтернативные варианты измерительного оборудования:**

**Базовый уровень:**
- **Осциллограф**: Rigol DS6000 (полоса 1 ГГц)
- **Частотомер**: Rigol DSA800 (350 МГц)
- **Анализатор фазового шума**: Rigol DSA800

**Профессиональный уровень:**
- **Осциллограф**: Keysight Infiniium S (полоса 6 ГГц)
- **Частотомер**: Keysight 53230A
- **Анализатор фазового шума**: Keysight E5052B

**Лабораторный уровень:**
- **Осциллограф**: Tektronix DPO70000SX (полоса 70 ГГц)
- **Частотомер**: Keysight 53230A с внешним эталоном
- **Анализатор фазового шума**: Rohde & Schwarz FSWP

**Примечание:** Выбор конкретного оборудования зависит от требуемой точности измерений, бюджета лаборатории и специфики задач. Рекомендуется консультироваться с поставщиками измерительного оборудования для выбора оптимальной конфигурации.

### 6.6 Оптимизация производительности

**Цель оптимизации:**
Достижение максимальной точности синхронизации времени и стабильности работы Quantum-PCI в различных условиях эксплуатации.

#### 6.6.1 Оптимизация ядра Linux

**Настройки ядра для максимальной производительности:**

**1. Параметры реального времени:**
```bash
# Добавить в /etc/sysctl.conf
# Оптимизация для реального времени
kernel.sched_rt_runtime_us = -1
kernel.sched_rt_period_us = 1000000

# Отключение энергосбережения
kernel.nmi_watchdog = 0
kernel.perf_event_paranoid = -1

# Оптимизация прерываний
kernel.irqbalance = 0
```

**2. Настройки CPU для низкой задержки:**
```bash
# Скрипт настройки CPU
#!/bin/bash
# optimize-cpu.sh - Оптимизация CPU для Quantum-PCI

echo "=== ОПТИМИЗАЦИЯ CPU ДЛЯ QUANTUM-PCI ==="

# Отключение энергосбережения
echo "Отключение энергосбережения CPU..."
for cpu in /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor; do
    echo performance | sudo tee $cpu > /dev/null
done

# Отключение C-states
echo "Отключение C-states..."
for cpu in /sys/devices/system/cpu/cpu*/cpuidle/state*/disable; do
    echo 1 | sudo tee $cpu > /dev/null 2>/dev/null || true
done

# Настройка IRQ affinity
echo "Настройка IRQ affinity..."
# Привязка PTP прерываний к отдельным CPU
for irq in $(grep -E "(eth0|ptp)" /proc/interrupts | cut -d: -f1 | tr -d ' '); do
    echo 2 | sudo tee /proc/irq/$irq/smp_affinity > /dev/null
done

# Настройка изоляции CPU
echo "Настройка изоляции CPU..."
# Добавить в GRUB_CMDLINE_LINUX: isolcpus=2,3 nohz_full=2,3 rcu_nocbs=2,3

echo "Оптимизация CPU завершена"
```

**3. Настройки памяти:**
```bash
# Добавить в /etc/sysctl.conf
# Оптимизация памяти
vm.swappiness = 1
vm.dirty_ratio = 15
vm.dirty_background_ratio = 5
vm.dirty_expire_centisecs = 3000
vm.dirty_writeback_centisecs = 500

# Предварительная загрузка драйвера
echo "ptp_ocp" | sudo tee /etc/modules-load.d/ptp-ocp.conf
```

#### 6.6.2 Оптимизация сетевых параметров

**Настройки сетевого стека для PTP:**

**1. Оптимизация сетевых интерфейсов:**
```bash
#!/bin/bash
# optimize-network.sh - Оптимизация сетевых параметров

echo "=== ОПТИМИЗАЦИЯ СЕТЕВЫХ ПАРАМЕТРОВ ==="

# Настройка для каждого сетевого интерфейса
for iface in $(ip link show | grep -o 'eth[0-9]*'); do
    echo "Оптимизация интерфейса $iface..."
    
    # Отключение энергосбережения
    sudo ethtool -s $iface wol g
    
    # Настройка буферов
    sudo ethtool -G $iface rx 4096 tx 4096
    
    # Отключение coalescing для низкой задержки
    sudo ethtool -C $iface rx-usecs 0 tx-usecs 0
    
    # Настройка hardware timestamping
    sudo ethtool -K $iface hw-timestamping on tx on rx on
    
    # Настройка PTP фильтра
    sudo ethtool -A $iface rx on tx on
done

# Настройки ядра для сети
echo "Настройка параметров ядра..."
sudo sysctl -w net.core.rmem_max=134217728
sudo sysctl -w net.core.wmem_max=134217728
sudo sysctl -w net.core.rmem_default=262144
sudo sysctl -w net.core.wmem_default=262144

# Отключение TCP offloading для PTP
for iface in $(ip link show | grep -o 'eth[0-9]*'); do
    sudo ethtool -K $iface gro off gso off tso off
done

echo "Оптимизация сети завершена"
```

**2. Настройки файрвола для PTP:**
```bash
#!/bin/bash
# configure-firewall-ptp.sh - Настройка файрвола для PTP

echo "=== НАСТРОЙКА ФАЙРВОЛА ДЛЯ PTP ==="

# UFW правила для PTP
sudo ufw allow 319/udp comment "PTP Event"
sudo ufw allow 320/udp comment "PTP General"
sudo ufw allow 123/udp comment "NTP"

# iptables правила (альтернатива)
sudo iptables -A INPUT -p udp --dport 319 -j ACCEPT
sudo iptables -A INPUT -p udp --dport 320 -j ACCEPT
sudo iptables -A INPUT -p udp --dport 123 -j ACCEPT

# Сохранение правил
sudo iptables-save > /etc/iptables/rules.v4

echo "Файрвол настроен для PTP"
```

#### 6.6.3 Оптимизация PTP конфигурации

**Настройки для максимальной точности:**

**1. Оптимизированная конфигурация ptp4l:**
```bash
# Создание оптимизированной конфигурации
sudo tee /etc/ptp4l-optimized.conf << 'EOF'
[global]
# Основные настройки
priority1 128
priority2 128
domainNumber 0
network_transport UDPv4
delay_mechanism E2E

# Оптимизация для максимальной точности
time_stamping hardware
time_stamping on

# Настройки синхронизации (агрессивные)
logSyncInterval -3          # 8 pps
logMinDelayReqInterval -3   # 8 pps
logAnnounceInterval 0       # 1 pps
announceReceiptTimeout 3
syncReceiptTimeout 0

# Настройки фильтрации
delayAsymmetry 0
fault_reset_interval 4
fault_badpeernet_interval 16
delay_resp_interval -3      # 8 pps

# Настройки алгоритма
assume_two_step 0
logging_level 6
path_trace_enabled 0
follow_up_info 0
hybrid_e2e 0

# Отключение ненужных функций
inhibit_multicast_service 0
net_sync_monitor 0
tc_spanning_tree 0

# Настройки таймаутов
tx_timestamp_timeout 50
unicast_listen 0
unicast_master_table 0
unicast_req_duration 3600

# Логирование
use_syslog 1
verbose 0
summary_interval 0

# Настройки часов
kernel_leap 1
check_fup_sync 0

# PI контроллер (агрессивные настройки)
pi_proportional_const 0.0
pi_integral_const 0.0
pi_proportional_scale 0.7
pi_proportional_exponent -0.3
pi_proportional_norm_max 0.7
pi_integral_scale 0.3
pi_integral_exponent 0.4
pi_integral_norm_max 0.3

# Пороги
step_threshold 0.0
first_step_threshold 0.00002
max_frequency 900000000

# Серво система
clock_servo pi
sanity_freq_limit 200000000
ntpshm_segment 0
msg_interval_request 0
servo_num_offset_values 10
servo_offset_threshold 0
write_phase_mode 0
s2_phc_index 0
EOF
```

**2. Оптимизированная конфигурация phc2sys:**
```bash
# Создание оптимизированной конфигурации phc2sys
sudo tee /etc/phc2sys-optimized.conf << 'EOF'
[global]
# Синхронизация PHC с системным временем
# -s указывает на PHC устройство
# -w указывает на wait for ptp4l
# -S указывает на step the clock
# -O указывает на offset в наносекундах
# -R указывает на rate в ppb

# Агрессивные настройки для максимальной точности
servo pi
pi_proportional_const 0.7
pi_integral_const 0.3
pi_proportional_scale 0.7
pi_proportional_exponent -0.3
pi_proportional_norm_max 0.7
pi_integral_scale 0.3
pi_integral_exponent 0.4
pi_integral_norm_max 0.3

# Пороги
step_threshold 0.0
first_step_threshold 0.00002
max_frequency 900000000
sanity_freq_limit 200000000

# Настройки логирования
use_syslog 1
verbose 0
summary_interval 0
EOF
```

#### 6.6.4 Мониторинг производительности

**Скрипт мониторинга производительности:**
```bash
#!/bin/bash
# performance-monitor.sh - Мониторинг производительности Quantum-PCI

LOG_FILE="/var/log/quantum-pci-performance-$(date +%Y%m%d).log"
TIMECARD_BASE="/sys/class/timecard/ocp0"

echo "=== МОНИТОРИНГ ПРОИЗВОДИТЕЛЬНОСТИ QUANTUM-PCI ===" | tee $LOG_FILE
echo "Дата: $(date)" | tee -a $LOG_FILE
echo | tee -a $LOG_FILE

# Функция измерения производительности
measure_performance() {
    local metric="$1"
    local value="$2"
    local unit="$3"
    local threshold="$4"
    
    echo "$(date '+%Y-%m-%d %H:%M:%S'): $metric: $value $unit" | tee -a $LOG_FILE
    
    if (( $(echo "$value > $threshold" | bc -l) )); then
        echo "⚠️  ВНИМАНИЕ: $metric превышает порог ($threshold $unit)" | tee -a $LOG_FILE
    fi
}

# 1. Мониторинг PTP производительности
echo "=== PTP ПРОИЗВОДИТЕЛЬНОСТЬ ===" | tee -a $LOG_FILE
if [ -c "/dev/ptp0" ]; then
    # Измерение offset
    offset=$(sudo pmc -u -b 0 'GET CURRENT_DATA_SET' 2>/dev/null | grep "offsetFromMaster" | awk '{print $2}' || echo "0")
    measure_performance "PTP Offset" "$offset" "ns" "100"
    
    # Измерение delay
    delay=$(sudo pmc -u -b 0 'GET CURRENT_DATA_SET' 2>/dev/null | grep "meanPathDelay" | awk '{print $2}' || echo "0")
    measure_performance "PTP Delay" "$delay" "ns" "1000"
    
    # Измерение jitter
    jitter=$(sudo pmc -u -b 0 'GET CURRENT_DATA_SET' 2>/dev/null | grep "stepsRemoved" | awk '{print $2}' || echo "0")
    measure_performance "PTP Steps Removed" "$jitter" "" "5"
fi

# 2. Мониторинг системных ресурсов
echo "=== СИСТЕМНЫЕ РЕСУРСЫ ===" | tee -a $LOG_FILE
cpu_load=$(uptime | awk -F'load average:' '{print $2}' | awk '{print $1}' | sed 's/,//')
measure_performance "CPU Load" "$cpu_load" "" "2.0"

memory_usage=$(free | grep Mem | awk '{printf "%.1f", $3/$2 * 100.0}')
measure_performance "Memory Usage" "$memory_usage" "%" "80"

# 3. Мониторинг сетевых интерфейсов
echo "=== СЕТЕВЫЕ ИНТЕРФЕЙСЫ ===" | tee -a $LOG_FILE
for iface in $(ip link show | grep -o 'eth[0-9]*'); do
    if [ -d "/sys/class/net/$iface" ]; then
        rx_errors=$(cat /sys/class/net/$iface/statistics/rx_errors 2>/dev/null || echo "0")
        tx_errors=$(cat /sys/class/net/$iface/statistics/tx_errors 2>/dev/null || echo "0")
        
        measure_performance "$iface RX Errors" "$rx_errors" "" "10"
        measure_performance "$iface TX Errors" "$tx_errors" "" "10"
    fi
done

# 4. Мониторинг температуры
echo "=== ТЕМПЕРАТУРА ===" | tee -a $LOG_FILE
if [ -f "/sys/class/thermal/thermal_zone0/temp" ]; then
    temp=$(cat /sys/class/thermal/thermal_zone0/temp)
    temp_c=$((temp / 1000))
    measure_performance "CPU Temperature" "$temp_c" "°C" "70"
fi

# 5. Мониторинг IRQ
echo "=== ПРЕРЫВАНИЯ ===" | tee -a $LOG_FILE
for irq in $(grep -E "(eth0|ptp)" /proc/interrupts | cut -d: -f1 | tr -d ' '); do
    irq_count=$(grep "eth0\|ptp" /proc/interrupts | grep ":$irq:" | awk '{print $2}' || echo "0")
    measure_performance "IRQ $irq Count" "$irq_count" "" "10000"
done

echo "=== МОНИТОРИНГ ЗАВЕРШЕН ===" | tee -a $LOG_FILE
```

#### 6.6.5 Автоматическая оптимизация

**Скрипт автоматической оптимизации:**
```bash
#!/bin/bash
# auto-optimize.sh - Автоматическая оптимизация Quantum-PCI

echo "=== АВТОМАТИЧЕСКАЯ ОПТИМИЗАЦИЯ QUANTUM-PCI ==="

# 1. Оптимизация CPU
echo "1. Оптимизация CPU..."
for cpu in /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor; do
    echo performance | sudo tee $cpu > /dev/null
done

# 2. Оптимизация сети
echo "2. Оптимизация сети..."
for iface in $(ip link show | grep -o 'eth[0-9]*'); do
    sudo ethtool -K $iface hw-timestamping on tx on rx on
    sudo ethtool -C $iface rx-usecs 0 tx-usecs 0
    sudo ethtool -K $iface gro off gso off tso off
done

# 3. Настройка IRQ affinity
echo "3. Настройка IRQ affinity..."
for irq in $(grep -E "(eth0|ptp)" /proc/interrupts | cut -d: -f1 | tr -d ' '); do
    echo 2 | sudo tee /proc/irq/$irq/smp_affinity > /dev/null
done

# 4. Оптимизация параметров ядра
echo "4. Оптимизация параметров ядра..."
sudo sysctl -w kernel.sched_rt_runtime_us=-1
sudo sysctl -w kernel.sched_rt_period_us=1000000
sudo sysctl -w net.core.rmem_max=134217728
sudo sysctl -w net.core.wmem_max=134217728

# 5. Перезапуск PTP сервисов с оптимизированными настройками
echo "5. Перезапуск PTP сервисов..."
sudo systemctl stop ptp4l
sudo systemctl stop phc2sys

# Запуск с оптимизированными конфигурациями
sudo ptp4l -f /etc/ptp4l-optimized.conf -i eth0 &
sudo phc2sys -s /dev/ptp0 -w -S -O 0 -R 0 -f /etc/phc2sys-optimized.conf &

echo "Автоматическая оптимизация завершена"
```

---

## 7. ТЕКУЩИЙ РЕМОНТ

### 7.1 Восстановление работоспособности

**Типичные процедуры восстановления:**
- Перезагрузка драйвера
- Сброс конфигурации к заводским настройкам
- Проверка и замена кабельных соединений
- Обновление драйвера

### 7.2 Расширенная диагностика и устранение неисправностей

#### 7.2.1 Автоматизированная диагностика

**Скрипт комплексной диагностики:**
```bash
#!/bin/bash
# quantum-pci-diagnostics.sh - Комплексная диагностика Quantum-PCI

LOG_FILE="/var/log/quantum-pci-diagnostics-$(date +%Y%m%d-%H%M%S).log"
TIMECARD_BASE="/sys/class/timecard/ocp0"

echo "=== ДИАГНОСТИКА QUANTUM-PCI ===" | tee $LOG_FILE
echo "Дата: $(date)" | tee -a $LOG_FILE
echo "Версия скрипта: 1.0" | tee -a $LOG_FILE
echo | tee -a $LOG_FILE

# Функция логирования
log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S'): $1" | tee -a $LOG_FILE
}

# Функция проверки статуса
check_status() {
    local test_name="$1"
    local command="$2"
    local expected="$3"
    
    log "Проверка: $test_name"
    result=$(eval $command 2>&1)
    
    if [[ "$result" == *"$expected"* ]]; then
        log "✅ $test_name: OK"
        return 0
    else
        log "❌ $test_name: FAILED"
        log "   Команда: $command"
        log "   Результат: $result"
        log "   Ожидалось: $expected"
        return 1
    fi
}

# 1. Проверка аппаратной части
log "=== 1. ПРОВЕРКА АППАРАТНОЙ ЧАСТИ ==="
check_status "PCIe обнаружение" "lspci | grep -i time" "Time"
check_status "Драйвер загружен" "lsmod | grep ptp_ocp" "ptp_ocp"
check_status "Sysfs интерфейс" "ls $TIMECARD_BASE" "serialnum"

# 2. Проверка устройств
log "=== 2. ПРОВЕРКА УСТРОЙСТВ ==="
check_status "PHC устройство" "ls /dev/ptp*" "/dev/ptp"
check_status "GNSS порт" "ls /dev/ttyS*" "/dev/ttyS"

# 3. Проверка конфигурации
log "=== 3. ПРОВЕРКА КОНФИГУРАЦИИ ==="
if [ -d "$TIMECARD_BASE" ]; then
    log "Информация о устройстве:"
    log "  Серийный номер: $(cat $TIMECARD_BASE/serialnum 2>/dev/null || echo 'N/A')"
    log "  Источник времени: $(cat $TIMECARD_BASE/clock_source 2>/dev/null || echo 'N/A')"
    log "  GNSS синхронизация: $(cat $TIMECARD_BASE/gnss_sync 2>/dev/null || echo 'N/A')"
    log "  Статус часов: $(cat $TIMECARD_BASE/clock_status 2>/dev/null || echo 'N/A')"
fi

# 4. Проверка PTP
log "=== 4. ПРОВЕРКА PTP ==="
if [ -c "/dev/ptp0" ]; then
    log "PTP статус:"
    sudo pmc -u -b 0 'GET CURRENT_DATA_SET' 2>&1 | tee -a $LOG_FILE
else
    log "❌ PTP устройство недоступно"
fi

# 5. Проверка NTP
log "=== 5. ПРОВЕРКА NTP ==="
if command -v chronyc >/dev/null 2>&1; then
    log "NTP источники:"
    chronyc sources -v 2>&1 | tee -a $LOG_FILE
    log "NTP статистика:"
    chronyc tracking 2>&1 | tee -a $LOG_FILE
else
    log "❌ chrony не установлен"
fi

# 6. Проверка системных ресурсов
log "=== 6. ПРОВЕРКА СИСТЕМНЫХ РЕСУРСОВ ==="
log "CPU загрузка: $(uptime | awk -F'load average:' '{print $2}')"
log "Память: $(free -h | grep '^Mem:' | awk '{print $3"/"$2}')"
log "Диск: $(df -h / | tail -1 | awk '{print $3"/"$2" ("$5")"}')"

# 7. Проверка сетевых интерфейсов
log "=== 7. ПРОВЕРКА СЕТЕВЫХ ИНТЕРФЕЙСОВ ==="
for iface in $(ip link show | grep -o 'eth[0-9]*'); do
    if [ -d "/sys/class/net/$iface" ]; then
        log "Интерфейс $iface:"
        log "  Статус: $(cat /sys/class/net/$iface/operstate 2>/dev/null || echo 'unknown')"
        log "  Скорость: $(cat /sys/class/net/$iface/speed 2>/dev/null || echo 'unknown')"
        log "  Hardware timestamping: $(ethtool -k $iface 2>/dev/null | grep hw-timestamping || echo 'unknown')"
    fi
done

# 8. Проверка логов
log "=== 8. ПРОВЕРКА ЛОГОВ ==="
log "Последние ошибки в dmesg:"
dmesg | grep -i "ptp\|time\|error" | tail -10 | tee -a $LOG_FILE

log "Последние ошибки в syslog:"
journalctl -u ptp4l -u phc2sys -u chrony --since "1 hour ago" --no-pager | tee -a $LOG_FILE

log "=== ДИАГНОСТИКА ЗАВЕРШЕНА ==="
log "Лог сохранен в: $LOG_FILE"
```

#### 7.2.2 Детальная таблица неисправностей

**Таблица 7.1 - Расширенный перечень неисправностей:**

| Категория | Неисправность | Признаки | Причина | Способ устранения | Критичность |
|-----------|---------------|----------|---------|-------------------|-------------|
| **Аппаратная** | Карта не обнаружена | Нет в lspci, нет sysfs | Проблемы с PCIe, питанием | Проверить подключение, питание | Критическая |
| | Драйвер не загружается | Ошибки в dmesg | Несовместимость ядра, конфликт | Обновить драйвер, проверить конфликты | Критическая |
| | GNSS антенна не работает | Нет сигнала, gnss_sync = "unlocked" | Повреждение антенны, кабеля | Проверить антенну, заменить кабель | Высокая |
| **Программная** | PHC недоступен | `?` в chronyc sources | Неправильные права доступа | `sudo usermod -a -G ptp _chrony` | Высокая |
| | PTP не синхронизируется | Высокий offset, нестабильность | Проблемы с сетью, конфигурацией | Проверить сеть, настройки PTP | Высокая |
| | NTP показывает ошибки | Ошибки доступа к PHC | Пользователь не в группе ptp | Настроить права доступа | Средняя |
| **Сетевая** | Нет PTP трафика | Нет пакетов в tcpdump | Блокировка файрволом | Настроить файрвол для PTP | Высокая |
| | Высокая задержка сети | Высокий delay в PTP | Перегрузка сети, QoS | Настроить QoS, проверить сеть | Средняя |
| **Временная** | Низкая точность | Высокий джиттер, wander | Проблемы с кабелями, заземлением | Заменить кабели, проверить заземление | Средняя |
| | Дрейф времени | Постепенное отклонение | Проблемы с опорным генератором | Проверить GNSS, калибровку | Высокая |
| **Системная** | Высокая загрузка CPU | Медленная работа системы | Неоптимальные настройки | Оптимизировать настройки ядра | Низкая |
| | Недостаток памяти | Ошибки выделения памяти | Утечки памяти, малый объем | Увеличить память, исправить утечки | Средняя |

#### 7.2.3 Пошаговые процедуры устранения неисправностей

**Процедура 1: Карта не обнаружена**
```bash
#!/bin/bash
# fix-pci-detection.sh - Устранение проблем с обнаружением PCIe

echo "=== УСТРАНЕНИЕ ПРОБЛЕМ С ОБНАРУЖЕНИЕМ PCIe ==="

# Шаг 1: Проверка физического подключения
echo "1. Проверка физического подключения..."
lspci | grep -i time || echo "Карта не обнаружена в PCIe"

# Шаг 2: Проверка питания
echo "2. Проверка питания..."
dmesg | grep -i "power\|pci" | tail -10

# Шаг 3: Проверка конфликтов
echo "3. Проверка конфликтов ресурсов..."
lspci -vvv | grep -A 20 -B 5 "Time"

# Шаг 4: Перезагрузка PCIe
echo "4. Перезагрузка PCIe шины..."
echo 1 > /sys/bus/pci/rescan
sleep 2
lspci | grep -i time

# Шаг 5: Проверка после перезагрузки
echo "5. Проверка после перезагрузки..."
if lspci | grep -i time; then
    echo "✅ Карта обнаружена"
    ls /sys/class/timecard/ 2>/dev/null || echo "❌ Sysfs интерфейс недоступен"
else
    echo "❌ Карта по-прежнему не обнаружена"
    echo "Рекомендации:"
    echo "- Проверить физическое подключение"
    echo "- Проверить питание системы"
    echo "- Проверить совместимость с материнской платой"
fi
```

**Процедура 2: Проблемы с GNSS синхронизацией**
```bash
#!/bin/bash
# fix-gnss-sync.sh - Устранение проблем с GNSS синхронизацией

echo "=== УСТРАНЕНИЕ ПРОБЛЕМ С GNSS СИНХРОНИЗАЦИЕЙ ==="

TIMECARD_BASE="/sys/class/timecard/ocp0"

# Шаг 1: Проверка статуса GNSS
echo "1. Проверка статуса GNSS..."
if [ -d "$TIMECARD_BASE" ]; then
    echo "GNSS синхронизация: $(cat $TIMECARD_BASE/gnss_sync 2>/dev/null || echo 'N/A')"
    echo "Источник времени: $(cat $TIMECARD_BASE/clock_source 2>/dev/null || echo 'N/A')"
else
    echo "❌ TimeCard недоступна"
    exit 1
fi

# Шаг 2: Проверка GNSS порта
echo "2. Проверка GNSS порта..."
GNSS_PORT="/dev/ttyS5"
if [ -c "$GNSS_PORT" ]; then
    echo "✅ GNSS порт доступен: $GNSS_PORT"
    
    # Проверка NMEA сообщений
    echo "Проверка NMEA сообщений (5 секунд)..."
    timeout 5s tio -b 115200 $GNSS_PORT 2>/dev/null | head -5 || echo "Нет данных"
else
    echo "❌ GNSS порт недоступен: $GNSS_PORT"
fi

# Шаг 3: Проверка gpsd
echo "3. Проверка gpsd..."
if pgrep gpsd > /dev/null; then
    echo "✅ gpsd запущен"
    echo "Статус GPS:"
    timeout 10s gpsmon -n 1 2>/dev/null | head -10
else
    echo "❌ gpsd не запущен"
    echo "Запуск gpsd..."
    sudo systemctl start gpsd
    sudo systemctl enable gpsd
fi

# Шаг 4: Перезапуск GNSS
echo "4. Перезапуск GNSS..."
echo "MAC" > $TIMECARD_BASE/clock_source
sleep 2
echo "GNSS" > $TIMECARD_BASE/clock_source
sleep 10

# Шаг 5: Проверка результата
echo "5. Проверка результата..."
echo "GNSS синхронизация: $(cat $TIMECARD_BASE/gnss_sync 2>/dev/null || echo 'N/A')"
```

#### 7.2.4 Мониторинг и предупреждение о неисправностях

**Скрипт мониторинга состояния:**
```bash
#!/bin/bash
# quantum-pci-monitor.sh - Мониторинг состояния Quantum-PCI

TIMECARD_BASE="/sys/class/timecard/ocp0"
ALERT_EMAIL="admin@company.com"
LOG_FILE="/var/log/quantum-pci-monitor.log"

# Функция отправки алерта
send_alert() {
    local message="$1"
    local severity="$2"
    
    echo "$(date): $severity: $message" >> $LOG_FILE
    
    # Отправка email (если настроен)
    if command -v mail >/dev/null 2>&1; then
        echo "$message" | mail -s "Quantum-PCI Alert: $severity" $ALERT_EMAIL
    fi
    
    # Отправка в syslog
    logger -p user.warning "Quantum-PCI: $message"
}

# Проверка доступности устройства
if [ ! -d "$TIMECARD_BASE" ]; then
    send_alert "TimeCard устройство недоступно" "CRITICAL"
    exit 1
fi

# Проверка GNSS синхронизации
gnss_sync=$(cat $TIMECARD_BASE/gnss_sync 2>/dev/null || echo "unknown")
if [ "$gnss_sync" != "locked" ]; then
    send_alert "GNSS синхронизация потеряна: $gnss_sync" "WARNING"
fi

# Проверка PTP статуса
if [ -c "/dev/ptp0" ]; then
    ptp_status=$(sudo pmc -u -b 0 'GET CURRENT_DATA_SET' 2>/dev/null | grep "clockClass" || echo "unknown")
    if [[ "$ptt_status" == *"248"* ]] || [[ "$ptt_status" == *"255"* ]]; then
        send_alert "PTP синхронизация потеряна: $ptp_status" "WARNING"
    fi
fi

# Проверка температуры
if [ -f "/sys/class/thermal/thermal_zone0/temp" ]; then
    temp=$(cat /sys/class/thermal/thermal_zone0/temp)
    temp_c=$((temp / 1000))
    if [ $temp_c -gt 70 ]; then
        send_alert "Высокая температура: ${temp_c}°C" "WARNING"
    fi
fi

# Проверка системных ресурсов
cpu_load=$(uptime | awk -F'load average:' '{print $2}' | awk '{print $1}' | sed 's/,//')
if (( $(echo "$cpu_load > 5.0" | bc -l) )); then
    send_alert "Высокая загрузка CPU: $cpu_load" "WARNING"
fi

echo "$(date): Мониторинг завершен успешно" >> $LOG_FILE
```

---

## 8. ТЕХНИЧЕСКОЕ ОБСЛУЖИВАНИЕ

### 8.1 Общие указания

**Цель технического обслуживания:**
- Поддержание работоспособности
- Предотвращение отказов
- Обеспечение точности синхронизации
- Продление срока службы

### 8.2 Виды и периодичность технического обслуживания

**Ежедневно:**
- Проверка статуса синхронизации
- Контроль температуры

**Еженедельно:**
- Проверка логов системы
- Анализ производительности

**Ежемесячно:**
- Полная диагностика системы
- Проверка кабельных соединений

**Ежегодно:**
- Калибровка системы
- Обновление программного обеспечения

### 8.3 Подготовка к проведению технического обслуживания

**Подготовительные работы:**
- Создание резервной копии конфигурации
- Уведомление пользователей о плановых работах
- Подготовка инструментов и материалов

### 8.4 Порядок технического обслуживания

**Последовательность работ:**
1. Остановка сервисов
2. Создание резервной копии
3. Выполнение работ по обслуживанию
4. Проверка работоспособности
5. Запуск сервисов
6. Документирование работ

### 8.5 Маркировка и опломбирование

**Требования к маркировке:**
- Серийный номер изделия
- Дата ввода в эксплуатацию
- Ответственное лицо
- Периодичность обслуживания

---

## 9. ТЕХНИЧЕСКОЕ ОСВИДЕТЕЛЬСТВОВАНИЕ

### 9.1 Периодичность освидетельствования

**Плановое освидетельствование:**
- Ежегодно - проверка точности синхронизации
- При вводе в эксплуатацию - полная проверка всех функций
- После ремонта - проверка работоспособности

**Внеплановое освидетельствование:**
- При подозрении на неисправность
- После воздействия неблагоприятных факторов
- По требованию контролирующих органов

### 9.2 Методы освидетельствования

**Проверка точности времени:**
```bash
# Проверка PTP синхронизации
sudo pmc -u -b 0 'GET CURRENT_DATA_SET'

# Проверка NTP синхронизации  
chronyc sources -v

# Проверка системного времени
timedatectl status
```

**Проверка аппаратной части:**
```bash
# Проверка обнаружения карты
lspci | grep -i time

# Проверка загрузки драйвера
lsmod | grep ptp_ocp

# Проверка sysfs интерфейса
ls /sys/class/timecard/
```

---

## 10. КОНСЕРВАЦИЯ

### 10.1 Подготовка к консервации

**Перед консервацией выполнить:**
1. Отключить все сервисы PTP/NTP
2. Выгрузить драйвер: `sudo modprobe -r ptp_ocp`
3. Выключить систему
4. Отключить питание

### 10.2 Процедура консервации

**Упаковка:**
- Поместить в антистатическую упаковку
- Использовать влагопоглощающие материалы
- Загерметизировать упаковку

**Маркировка:**
- Указать дату консервации
- Указать срок консервации (не более 2 лет)
- Указать условия хранения

### 10.3 Расконсервация

**Перед вводом в эксплуатацию:**
1. Выдержать при комнатной температуре 24 часа
2. Проверить целостность упаковки
3. Провести полную диагностику
4. Выполнить калибровку

---

## 11. ХРАНЕНИЕ

### 11.1 Условия хранения

**Климатические условия:**
- Температура: от -40°C до +70°C
- Влажность: не более 80% при 25°C
- Атмосферное давление: от 84 до 106.7 кПа

**Требования к помещению:**
- Отсутствие прямых солнечных лучей
- Защита от пыли и влаги
- Отсутствие агрессивных сред
- Защита от вибрации

### 11.2 Сроки хранения

- **Гарантийный срок хранения**: 2 года
- **Максимальный срок хранения**: 5 лет
- **Периодичность проверки**: каждые 6 месяцев

### 11.3 Контроль при хранении

**Проверки:**
- Визуальный осмотр упаковки
- Контроль климатических условий
- Проверка маркировки
- Ведение журнала хранения

---

## 12. ТРАНСПОРТИРОВАНИЕ

### 12.1 Условия транспортирования

**Климатические условия:**
- Температура: от -40°C до +70°C
- Влажность: не более 80% при 25°C
- Атмосферное давление: от 84 до 106.7 кПа

**Механические воздействия:**
- Вибрация: до 5g в диапазоне 10-2000 Гц
- Ударные нагрузки: до 15g длительностью до 11 мс

### 12.2 Упаковка для транспортирования

**Требования к упаковке:**
- Антистатическая защита
- Защита от влаги
- Амортизация от ударов
- Маркировка "Осторожно! Хрупкое!"

### 12.3 Транспортные средства

**Разрешенные виды транспорта:**
- Автомобильный транспорт
- Железнодорожный транспорт
- Авиационный транспорт
- Морской транспорт

**Запрещено:**
- Транспортирование без упаковки
- Совместная перевозка с агрессивными веществами
- Воздействие прямых солнечных лучей

---

## 13. УТИЛИЗАЦИЯ ПОСЛЕ ИСПОЛЬЗОВАНИЯ

### 13.1 Классификация отходов

**Quantum-PCI относится к:**
- Электронным отходам (WEEE)
- Отходам 4 класса опасности
- Не содержит драгоценных металлов

### 13.2 Процедура утилизации

**Подготовка к утилизации:**
1. Удалить все конфиденциальные данные
2. Снять маркировку с серийными номерами
3. Разделить на компоненты по материалам
4. Упаковать согласно требованиям

**Разделение компонентов:**
- Пластиковые элементы - переработка
- Металлические элементы - переплавка
- Электронные компоненты - специализированная утилизация
- Упаковочные материалы - переработка

### 13.3 Требования к утилизации

**Обязательные требования:**
- Утилизация только лицензированными организациями
- Соблюдение экологических норм
- Документирование процесса утилизации
- Получение справки об утилизации

**Запрещено:**
- Выбрасывание в бытовые отходы
- Сжигание компонентов
- Захоронение на полигонах
- Самостоятельная разборка без лицензии

---

### Структура документа:
1. **НАЗНАЧЕНИЕ** (раздел 1): Назначение и условия эксплуатации
2. **ТЕХНИЧЕСКИЕ ХАРАКТЕРИСТИКИ** (раздел 2): Основные данные, надежность, питание
3. **СОСТАВ** (раздел 3): Комплект поставки
4. **УСТРОЙСТВО И РАБОТА** (раздел 4): Архитектура и принцип работы
5. **ПОДГОТОВКА К ИСПОЛЬЗОВАНИЮ** (раздел 5): Безопасность, включение/выключение
6. **ИСПОЛЬЗОВАНИЕ** (раздел 6): Эксплуатация и проверка работоспособности
7. **ТЕКУЩИЙ РЕМОНТ** (раздел 7): Восстановление и неисправности
8. **ТЕХНИЧЕСКОЕ ОБСЛУЖИВАНИЕ** (раздел 8): Обслуживание и маркировка
9. **ТЕХНИЧЕСКОЕ ОСВИДЕТЕЛЬСТВОВАНИЕ** (раздел 9): Периодические проверки
10. **КОНСЕРВАЦИЯ** (раздел 10): Подготовка к длительному хранению
11. **ХРАНЕНИЕ** (раздел 11): Условия и сроки хранения
12. **ТРАНСПОРТИРОВАНИЕ** (раздел 12): Транспортные требования
13. **УТИЛИЗАЦИЯ** (раздел 13): Утилизация после использования

