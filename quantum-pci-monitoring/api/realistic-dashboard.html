 <!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quantum-PCI Realistic Monitoring</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 50%, #2c3e50 100%);
            min-height: 100vh;
            color: #ecf0f1;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header .subtitle {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .disclaimer {
            background: rgba(255, 193, 7, 0.9);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            border-left: 5px solid #ffc107;
        }
        
        .disclaimer h3 {
            color: #856404;
            margin-bottom: 10px;
        }
        
        .disclaimer ul {
            color: #856404;
            margin-left: 20px;
        }
        
        .disclaimer li {
            margin-bottom: 5px;
        }
        
        .status-bar {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
            min-width: 0;
        }
        
        .status-light {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #7f8c8d;
            flex-shrink: 0;
        }
        
        .status-light.ok {
            background: #27ae60;
            box-shadow: 0 0 10px rgba(39, 174, 96, 0.5);
        }
        
        .status-light.warning {
            background: #f39c12;
            box-shadow: 0 0 10px rgba(243, 156, 18, 0.5);
        }
        
        .status-light.critical {
            background: #e74c3c;
            box-shadow: 0 0 10px rgba(231, 76, 60, 0.5);
        }
        
        #connection-text {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px;
        }
        
        .status-light {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #28a745;
            animation: pulse 2s infinite;
        }
        
        .status-light.warning { background: #ffc107; }
        .status-light.critical { background: #dc3545; }
        .status-light.unknown { background: #6c757d; }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .metric-card {
            background: rgba(44, 62, 80, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            border: 2px solid rgba(52, 152, 219, 0.5);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            color: #ecf0f1;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
        }
        
        .metric-card h3 {
            margin-bottom: 15px;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .metric-value {
            font-size: 2.2em;
            font-weight: bold;
            margin: 10px 0;
            color: #3498db;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }
        
        .metric-unit {
            font-size: 0.9em;
            color: #95a5a6;
            font-weight: 500;
        }
        
        .metric-label {
            font-size: 0.9em;
            color: #bdc3c7;
            margin: 5px 0;
        }
        
        .metric-status {
            padding: 8px 12px;
            border-radius: 15px;
            font-size: 0.9em;
            display: inline-block;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .metric-status.ok { 
            background: rgba(46, 204, 113, 0.8); 
            color: #2c3e50;
            border: 1px solid #27ae60;
        }
        .metric-status.warning { 
            background: rgba(241, 196, 15, 0.8); 
            color: #2c3e50;
            border: 1px solid #f39c12;
        }
        .metric-status.critical { 
            background: rgba(231, 76, 60, 0.8); 
            color: #ecf0f1;
            border: 1px solid #e74c3c;
        }
        .metric-status.unknown { 
            background: rgba(149, 165, 166, 0.8); 
            color: #2c3e50;
            border: 1px solid #95a5a6;
        }
        .metric-status.inactive { 
            background: rgba(127, 140, 141, 0.8); 
            color: #2c3e50;
            border: 1px solid #7f8c8d;
        }
        .metric-status.error { 
            background: rgba(231, 76, 60, 0.8); 
            color: #ecf0f1;
            border: 1px solid #e74c3c;
        }
        
        /* Стили для крупных часов устройства */
        .device-clock-container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin: 20px 0;
            border: 2px solid rgba(255, 255, 255, 0.2);
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        .clock-title {
            color: white;
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }
        
        .device-clock {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }
        
        .clock-time {
            font-size: 72px;
            font-weight: bold;
            color: #ff6b6b;
            text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.7);
            font-family: 'Courier New', monospace;
            letter-spacing: 4px;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .clock-date {
            font-size: 28px;
            color: white;
            font-weight: 500;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            font-family: 'Arial', sans-serif;
        }
        
        .clock-status {
            font-size: 18px;
            padding: 8px 20px;
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-weight: 500;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }
        
        .clock-status.synced {
            background: rgba(40, 167, 69, 0.3);
            border: 2px solid rgba(40, 167, 69, 0.5);
        }
        
        .clock-status.syncing {
            background: rgba(255, 193, 7, 0.3);
            border: 2px solid rgba(255, 193, 7, 0.5);
        }
        
        .clock-status.error {
            background: rgba(220, 53, 69, 0.3);
            border: 2px solid rgba(220, 53, 69, 0.5);
        }
        
        .limitations-section {
            background: rgba(220, 53, 69, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin-top: 30px;
            border: 1px solid rgba(220, 53, 69, 0.3);
            color: white;
        }
        
        .limitations-section h3 {
            color: #ff6b6b;
            margin-bottom: 15px;
        }
        
        .limitations-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        
        .limitation-item {
            background: rgba(220, 53, 69, 0.1);
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #dc3545;
        }
        
        .limitation-item h4 {
            color: #ff6b6b;
            margin-bottom: 8px;
        }
        
        .device-info {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            color: white;
        }
        
        .sensor-section {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            color: white;
        }
        
        .sensor-section h2 {
            color: #3498db;
            margin-bottom: 20px;
            text-align: center;
            font-size: 2em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }
        
        .sensor-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .sensor-controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }
        
        .refresh-btn {
            background: rgba(52, 152, 219, 0.8);
            border: 2px solid #3498db;
            color: #ecf0f1;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9em;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .refresh-btn:hover {
            background: rgba(52, 152, 219, 1);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.4);
        }
        
        .last-update {
            color: #95a5a6;
            font-size: 0.9em;
            font-weight: 500;
            text-align: center;
        }
        
        @media (max-width: 768px) {
            .metrics-grid {
                grid-template-columns: 1fr;
            }
            
            .status-bar {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
        }
        
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🕐 Quantum-PCI Monitoring</h1>
        </div>
        
        
        <div class="status-bar">
            <div class="status-indicator">
                <div class="status-light" id="connection-status"></div>
                <span id="connection-text">Подключение...</span>
            </div>
            <div>
                <button class="refresh-btn" onclick="refreshData()">🔄 Обновить</button>
            </div>
            <div class="last-update" id="last-update">
                Последнее обновление: загрузка...
            </div>
        </div>
        
        <div class="metrics-grid">
            <!-- PTP Metrics -->
            <div class="metric-card">
                <h3>📊 PTP Offset</h3>
                <div class="metric-value" id="ptp-offset">--</div>
                <div class="metric-unit">наносекунды</div>
                <div class="metric-status" id="ptp-offset-status">unknown</div>
            </div>
            
            <div class="metric-card">
                <h3>📈 PTP Drift</h3>
                <div class="metric-value" id="ptp-drift">--</div>
                <div class="metric-unit">ppb (parts per billion)</div>
                <div class="metric-status" id="ptp-drift-status">unknown</div>
            </div>
            
            
            <!-- GNSS Status -->
            <div class="metric-card">
                <h3>🛰️ GNSS Status</h3>
                <div class="metric-value" id="gnss-status">--</div>
                <div class="metric-unit">статус синхронизации</div>
                <div class="metric-status" id="gnss-status-indicator">unknown</div>
            </div>
            
            <!-- SMA Configuration -->
            <div class="metric-card">
                <h3>🔌 SMA Connectors</h3>
                <div id="sma-list">
                    <div>SMA1: <span id="sma1-config">--</span></div>
                    <div>SMA2: <span id="sma2-config">--</span></div>
                    <div>SMA3: <span id="sma3-config">--</span></div>
                    <div>SMA4: <span id="sma4-config">--</span></div>
                </div>
            </div>
            
            <!-- Device Info -->
            <div class="metric-card">
                <h3>📋 Device Info</h3>
                <div>Serial: <span id="device-serial">--</span></div>
                <div>Type: <span id="device-type">--</span></div>
                <div>Driver: <span id="device-driver">ptp_ocp</span></div>
                <div class="metric-label">Available Clock Sources:</div>
                <div id="available-clock-sources">--</div>
                <div class="metric-label">Available SMA Inputs:</div>
                <div id="available-sma-inputs">--</div>
                <div class="metric-label">Available SMA Outputs:</div>
                <div id="available-sma-outputs">--</div>
            </div>
            
            <!-- Clock Source -->
            <div class="metric-card">
                <h3>🕐 Clock Source</h3>
                <div class="metric-value" id="clock-source-display">--</div>
                <div class="metric-label">Active Source</div>
                <div id="source-description" style="font-size: 0.9em; color: #7f8c8d; margin: 5px 0;">--</div>
                <div id="source-specific-info" style="margin-top: 10px; padding: 5px; background: rgba(255,255,255,0.1); border-radius: 3px; font-size: 0.85em;">
                    <!-- Динамическая информация о источнике -->
                </div>
            </div>
            
            <!-- Configuration Parameters -->
            <div class="metric-card">
                <h3>⚙️ Configuration</h3>
                <div class="metric-label">IRIG-B Mode:</div>
                <div class="metric-value" id="irig-b-mode">--</div>
                <div class="metric-label">TS Window Adjust:</div>
                <div class="metric-value" id="ts-window-adjust">--</div>
            </div>
            
            <!-- Clock Drift -->
            <div class="metric-card">
                <h3>📈 Clock Drift</h3>
                <div class="metric-value" id="clock-drift">--</div>
                <div class="metric-label">nanoseconds</div>
                <div class="metric-status" id="drift-status">inactive</div>
            </div>
            
            <!-- Clock Offset -->
            <div class="metric-card">
                <h3>📊 Clock Offset</h3>
                <div class="metric-value" id="clock-offset">--</div>
                <div class="metric-label">nanoseconds</div>
                <div class="metric-status" id="offset-status">inactive</div>
            </div>
            
            <!-- TOD Correction -->
            <div class="metric-card">
                <h3>🕒 TOD Correction</h3>
                <div class="metric-value" id="tod-correction">--</div>
                <div class="metric-label">nanoseconds</div>
                <div class="metric-status" id="tod-status">active</div>
            </div>
            
            <!-- UTC-TAI Offset -->
            <div class="metric-card">
                <h3>🌍 UTC-TAI Offset</h3>
                <div class="metric-value" id="utc-tai-offset">--</div>
                <div class="metric-label">seconds</div>
                <div class="metric-status" id="utc-status">active</div>
            </div>
        </div>
        
        <!-- BMP280 Sensor Section -->
        <div class="sensor-section" id="bmp280-section">
            <h2>🌡️ BMP280 Environmental Sensor</h2>
            <div class="sensor-grid">
                <div class="metric-card">
                    <h3>🌡️ Temperature</h3>
                    <div class="metric-value" id="bmp280-temperature">--</div>
                    <div class="metric-unit">°C</div>
                    <div class="metric-status" id="bmp280-temp-status">unknown</div>
                </div>
                
                <div class="metric-card">
                    <h3>📊 Pressure</h3>
                    <div class="metric-value" id="bmp280-pressure">--</div>
                    <div class="metric-unit">гПа</div>
                    <div class="metric-status" id="bmp280-press-status">unknown</div>
                </div>
                
                <div class="metric-card">
                    <h3>📋 Sensor Info</h3>
                    <div>Type: <span id="bmp280-type">BMP280</span></div>
                    <div>I2C: <span id="bmp280-i2c">0x76</span></div>
                    <div>Status: <span id="bmp280-status">--</span></div>
                    <div>Last Update: <span id="bmp280-last-update">--</span></div>
                </div>
            </div>
            
            <div class="sensor-controls">
                <button onclick="refreshBMP280()" class="refresh-btn">🔄 Refresh BMP280</button>
                <button onclick="toggleBMP280Monitoring()" class="refresh-btn" id="bmp280-monitor-btn">⏸️ Pause Monitoring</button>
            </div>
        </div>
        
        <!-- INA219 Voltage Monitor Section -->
        <div class="sensor-section" id="ina219-section">
            <h2>⚡ INA219 Voltage Monitor</h2>
            <div class="sensor-grid">
                <div class="metric-card">
                    <h3>🔌 INA219 #1 (3.3V)</h3>
                    <div class="metric-value" id="ina219-1-bus-voltage">--</div>
                    <div class="metric-unit">V</div>
                    <div class="metric-label">Bus Voltage</div>
                    <div class="metric-value" id="ina219-1-shunt-voltage">--</div>
                    <div class="metric-unit">mV</div>
                    <div class="metric-label">Shunt Voltage</div>
                    <div class="metric-status" id="ina219-1-status">unknown</div>
                </div>
                
                <div class="metric-card">
                    <h3>🔌 INA219 #2 (5V)</h3>
                    <div class="metric-value" id="ina219-2-bus-voltage">--</div>
                    <div class="metric-unit">V</div>
                    <div class="metric-label">Bus Voltage</div>
                    <div class="metric-value" id="ina219-2-shunt-voltage">--</div>
                    <div class="metric-unit">mV</div>
                    <div class="metric-label">Shunt Voltage</div>
                    <div class="metric-status" id="ina219-2-status">unknown</div>
                </div>
                
                <div class="metric-card">
                    <h3>🔌 INA219 #3 (12V)</h3>
                    <div class="metric-value" id="ina219-3-bus-voltage">--</div>
                    <div class="metric-unit">V</div>
                    <div class="metric-label">Bus Voltage</div>
                    <div class="metric-value" id="ina219-3-shunt-voltage">--</div>
                    <div class="metric-unit">mV</div>
                    <div class="metric-label">Shunt Voltage</div>
                    <div class="metric-status" id="ina219-3-status">unknown</div>
                </div>
                
                <div class="metric-card">
                    <h3>📋 INA219 Info</h3>
                    <div>Type: <span id="ina219-type">INA219BIDR</span></div>
                    <div>I2C Bus: <span id="ina219-i2c">1</span></div>
                    <div>Devices: <span id="ina219-devices">--</span></div>
                    <div>Status: <span id="ina219-status">--</span></div>
                    <div>Last Update: <span id="ina219-last-update">--</span></div>
                </div>
            </div>
            
            <div class="sensor-controls">
                <button onclick="refreshINA219()" class="refresh-btn">🔄 Refresh INA219</button>
                <button onclick="toggleINA219Monitoring()" class="refresh-btn" id="ina219-monitor-btn">⏸️ Pause Monitoring</button>
            </div>
        </div>
        
        <!-- BNO055 IMU Sensor Section -->
        <div class="sensor-section" id="bno055-section">
            <h2>🧭 BNO055 IMU Sensor</h2>
            <div class="sensor-grid">
                <div class="metric-card">
                    <h3>🧭 Euler Angles</h3>
                    <div class="metric-value" id="bno055-heading">--</div>
                    <div class="metric-unit">°</div>
                    <div class="metric-label">Heading</div>
                    <div class="metric-value" id="bno055-roll">--</div>
                    <div class="metric-unit">°</div>
                    <div class="metric-label">Roll</div>
                    <div class="metric-value" id="bno055-pitch">--</div>
                    <div class="metric-unit">°</div>
                    <div class="metric-label">Pitch</div>
                    <div class="metric-status" id="bno055-euler-status">unknown</div>
                </div>
                
                <div class="metric-card">
                    <h3>⚡ Linear Acceleration</h3>
                    <div class="metric-value" id="bno055-accel-x">--</div>
                    <div class="metric-unit">m/s²</div>
                    <div class="metric-label">X</div>
                    <div class="metric-value" id="bno055-accel-y">--</div>
                    <div class="metric-unit">m/s²</div>
                    <div class="metric-label">Y</div>
                    <div class="metric-value" id="bno055-accel-z">--</div>
                    <div class="metric-unit">m/s²</div>
                    <div class="metric-label">Z</div>
                    <div class="metric-status" id="bno055-accel-status">unknown</div>
                </div>
                
                <div class="metric-card">
                    <h3>🌡️ Temperature</h3>
                    <div class="metric-value" id="bno055-temperature">--</div>
                    <div class="metric-unit">°C</div>
                    <div class="metric-label">Sensor Temperature</div>
                    <div class="metric-status" id="bno055-temp-status">unknown</div>
                </div>
                
                <div class="metric-card">
                    <h3>📋 Sensor Info</h3>
                    <div>Type: <span id="bno055-type">BNO055</span></div>
                    <div>I2C: <span id="bno055-i2c">0x29</span></div>
                    <div>Mode: <span id="bno055-mode">--</span></div>
                    <div>Status: <span id="bno055-status">--</span></div>
                    <div>Last Update: <span id="bno055-last-update">--</span></div>
                </div>
            </div>
            
            <div class="sensor-controls">
                <button onclick="refreshBNO055()" class="refresh-btn">🔄 Refresh BNO055</button>
                <button onclick="toggleBNO055Monitoring()" class="refresh-btn" id="bno055-monitor-btn">⏸️ Pause Monitoring</button>
                <button onclick="checkBNO055Calibration()" class="refresh-btn">🔧 Check Calibration</button>
            </div>
        </div>
        
        
        <!-- Крупные часы устройства -->
        <div class="device-clock-container">
            <div class="clock-title">🕐 Время устройства Quantum-PCI</div>
            <div class="device-clock" id="device-clock">
                <div class="clock-time" id="clock-time">--:--:--</div>
                <div class="clock-date" id="clock-date">-- -- ----</div>
                <div class="clock-status" id="clock-status">Синхронизация...</div>
            </div>
        </div>

        <div class="device-info">
            <h3>📦 Обнаруженные устройства</h3>
            <div id="devices-list">Загрузка...</div>
        </div>
    </div>
    
    <script>
        let currentData = {};
        
        async function refreshData() {
            console.log('refreshData called at:', new Date().toLocaleTimeString()); // Отладка
            try {
                // Получение списка устройств
                const devicesResponse = await fetch('/api/devices');
                const devicesData = await devicesResponse.json();
                console.log('Devices response:', devicesData); // Отладка
                
                updateConnectionStatus('ok', `Подключено (${devicesData.count})`);
                updateDevicesList(devicesData.devices);
                
                if (devicesData.devices.length > 0) {
                    // Получение статуса первого устройства
                    const deviceId = devicesData.devices[0].device_id;
                    console.log('Fetching status for device:', deviceId); // Отладка
                    const statusResponse = await fetch(`/api/device/${deviceId}/status`);
                    const statusData = await statusResponse.json();
                    console.log('Received status data:', statusData); // Отладка
                    
                    updateMetrics(statusData);
                    currentData = statusData;
                } else {
                    console.log('No devices found'); // Отладка
                }
                
                updateLastUpdate();
                
                
            } catch (error) {
                console.error('Error fetching data:', error);
                updateConnectionStatus('critical', 'Ошибка подключения');
            }
        }
        
        function updateConnectionStatus(status, text) {
            const statusLight = document.getElementById('connection-status');
            const statusText = document.getElementById('connection-text');
            
            statusLight.className = `status-light ${status}`;
            statusText.textContent = text;
        }
        
        function updateMetrics(data) {
            console.log('updateMetrics called with data:', data); // Отладка
            
            // PTP Metrics
            if (data.ptp) {
                console.log('Updating PTP metrics:', data.ptp); // Отладка
                
                // Проверяем, что элементы существуют
                const offsetElement = document.getElementById('ptp-offset');
                const driftElement = document.getElementById('ptp-drift');
                
                if (offsetElement) {
                    offsetElement.textContent = data.ptp.offset_ns.toLocaleString();
                    console.log('Updated ptp-offset to:', data.ptp.offset_ns);
                } else {
                    console.error('Element ptp-offset not found!');
                }
                
                if (driftElement) {
                    driftElement.textContent = data.ptp.drift_ppb.toLocaleString();
                    console.log('Updated ptp-drift to:', data.ptp.drift_ppb);
                } else {
                    console.error('Element ptp-drift not found!');
                }
                
                updateStatusIndicator('ptp-offset-status', data.ptp.status);
                updateStatusIndicator('ptp-drift-status', data.ptp.status);
                
            } else {
                console.log('No PTP data found'); // Отладка
            }
            
            // GNSS Status
            if (data.gnss) {
                document.getElementById('gnss-status').textContent = data.gnss.sync_status;
                updateStatusIndicator('gnss-status-indicator', data.gnss.status);
            }
            
            // Clock Source
            if (data.ptp && data.ptp.clock_source) {
                document.getElementById('clock-source-display').textContent = data.ptp.clock_source;
                document.getElementById('source-description').textContent = `Active Source: ${data.ptp.clock_source}`;
            }
            
            // Clock Drift and Offset (дополнительные элементы)
            if (data.ptp) {
                // Обновляем clock-drift если элемент существует
                const clockDriftElement = document.getElementById('clock-drift');
                if (clockDriftElement) {
                    clockDriftElement.textContent = data.ptp.drift_ppb.toLocaleString();
                    updateStatusIndicator('drift-status', data.ptp.status);
                }
                
                // Обновляем clock-offset если элемент существует
                const clockOffsetElement = document.getElementById('clock-offset');
                if (clockOffsetElement) {
                    clockOffsetElement.textContent = data.ptp.offset_ns.toLocaleString();
                    updateStatusIndicator('offset-status', data.ptp.status);
                }
                
                // Обновляем UTC-TAI offset
                const utcTaiElement = document.getElementById('utc-tai-offset');
                if (utcTaiElement && data.ptp.utc_tai_offset !== undefined) {
                    utcTaiElement.textContent = data.ptp.utc_tai_offset.toLocaleString();
                    console.log('UTC-TAI offset updated:', data.ptp.utc_tai_offset); // Отладка
                }
                
                // Обновляем TOD Correction
                const todCorrectionElement = document.getElementById('tod-correction');
                if (todCorrectionElement && data.ptp.tod_correction !== undefined) {
                    todCorrectionElement.textContent = data.ptp.tod_correction.toLocaleString();
                    console.log('TOD Correction updated:', data.ptp.tod_correction); // Отладка
                }
                
                // Обновляем настраиваемые параметры
                const irigBModeElement = document.getElementById('irig-b-mode');
                if (irigBModeElement && data.ptp.irig_b_mode !== undefined) {
                    irigBModeElement.textContent = data.ptp.irig_b_mode;
                    console.log('IRIG-B Mode updated:', data.ptp.irig_b_mode); // Отладка
                }
                
                const tsWindowAdjustElement = document.getElementById('ts-window-adjust');
                if (tsWindowAdjustElement && data.ptp.ts_window_adjust !== undefined) {
                    tsWindowAdjustElement.textContent = data.ptp.ts_window_adjust;
                    console.log('TS Window Adjust updated:', data.ptp.ts_window_adjust); // Отладка
                }
            }
            
            // Device Info
            if (data.device_info) {
                document.getElementById('device-serial').textContent = data.device_info.serial_number || '--';
                document.getElementById('device-type').textContent = data.device_info.type || '--';
                
                // Available Clock Sources
                if (data.device_info.available_clock_sources) {
                    document.getElementById('available-clock-sources').textContent = data.device_info.available_clock_sources.join(', ');
                }
                
                // Available SMA Inputs
                if (data.device_info.available_sma_inputs) {
                    document.getElementById('available-sma-inputs').textContent = data.device_info.available_sma_inputs.join(', ');
                }
                
                // Available SMA Outputs
                if (data.device_info.available_sma_outputs) {
                    document.getElementById('available-sma-outputs').textContent = data.device_info.available_sma_outputs.join(', ');
                }
            }
            
            // SMA Configuration
            if (data.sma) {
                for (let i = 1; i <= 4; i++) {
                    const smaKey = `sma${i}`;
                    if (data.sma[smaKey]) {
                        document.getElementById(`sma${i}-config`).textContent = data.sma[smaKey].config;
                    }
                }
            }
            
            // Device Info
            if (data.device_info) {
                document.getElementById('device-serial').textContent = data.device_info.serial_number;
                document.getElementById('device-type').textContent = data.device_info.type;
            }
            
            // PTP Clock Status
            if (data.quantum_pci) {
                const qpci = data.quantum_pci;
                console.log('PTP Data:', qpci); // Отладка
                
                // Основные метрики (безопасное преобразование в числа)
                const drift = parseInt(qpci.clock_status_drift) || 0;
                const offset = parseInt(qpci.clock_status_offset) || 0;
                const tod = parseInt(qpci.tod_correction) || 0;
                const utc = parseInt(qpci.utc_tai_offset) || 0;
                
                document.getElementById('clock-drift').textContent = drift.toLocaleString();
                document.getElementById('clock-offset').textContent = offset.toLocaleString();
                document.getElementById('tod-correction').textContent = tod.toLocaleString();
                document.getElementById('utc-tai-offset').textContent = utc.toLocaleString();
                
                // Информация об источнике
                document.getElementById('clock-source-display').textContent = qpci.clock_source || 'Unknown';
                
                // Описание источника
                if (qpci.source_specific_metrics) {
                    const metrics = qpci.source_specific_metrics;
                    document.getElementById('source-description').textContent = metrics.description || '--';
                    
                    // Специфичная информация об источнике
                    updateSourceSpecificInfo(metrics);
                }
                
                // Цветовая индикация активных/неактивных метрик
                updateMetricStatus(qpci.source_specific_metrics);
            }
        }
        
        function updateStatusIndicator(elementId, status) {
            const element = document.getElementById(elementId);
            element.className = `metric-status ${status}`;
            element.textContent = status;
        }
        
        function updateSourceSpecificInfo(metrics) {
            const infoDiv = document.getElementById('source-specific-info');
            let html = '';
            
            if (metrics.source === 'PTP' && metrics.ptp_info) {
                html = `<strong>PTP Device:</strong> ${metrics.ptp_info.device}<br>`;
                html += `<strong>Status:</strong> ${metrics.ptp_info.status}<br>`;
                html += `<strong>Description:</strong> ${metrics.ptp_info.description}`;
            } else if (metrics.source === 'PPS' && metrics.pps_info) {
                html = `<strong>PPS Device:</strong> ${metrics.pps_info.device}<br>`;
                html += `<strong>Status:</strong> ${metrics.pps_info.status}<br>`;
                html += `<strong>Description:</strong> ${metrics.pps_info.description}`;
            } else if (metrics.source === 'GNSS' && metrics.gnss_info) {
                html = `<strong>GNSS Status:</strong> ${metrics.gnss_info.sync_status}<br>`;
                html += `<strong>Description:</strong> ${metrics.gnss_info.description}`;
            } else {
                html = `<strong>Source:</strong> ${metrics.source}<br>`;
                html += `<strong>Description:</strong> ${metrics.description}`;
            }
            
            infoDiv.innerHTML = html;
        }
        
        function updateMetricStatus(metrics) {
            if (!metrics) return;
            
            // Обновление статусов метрик
            updateMetricCardStatus('drift-status', 'clock_status_drift', metrics);
            updateMetricCardStatus('offset-status', 'clock_status_offset', metrics);
            updateMetricCardStatus('tod-status', 'tod_correction', metrics);
            updateMetricCardStatus('utc-status', 'utc_tai_offset', metrics);
        }
        
        function updateMetricCardStatus(statusElementId, metricName, metrics) {
            const statusElement = document.getElementById(statusElementId);
            const isActive = metrics.active_metrics && metrics.active_metrics.includes(metricName);
            const isInactive = metrics.inactive_metrics && metrics.inactive_metrics.includes(metricName);
            
            if (isActive) {
                statusElement.className = 'metric-status ok';
                statusElement.textContent = 'active';
            } else if (isInactive) {
                statusElement.className = 'metric-status warning';
                statusElement.textContent = 'inactive';
            } else {
                statusElement.className = 'metric-status unknown';
                statusElement.textContent = 'unknown';
            }
        }
        
        function updatePTPMetrics(qpci) {
            console.log('Updating PTP Metrics:', qpci); // Отладка
            
            // Основные метрики (безопасное преобразование в числа)
            const drift = parseInt(qpci.clock_status_drift) || 0;
            const offset = parseInt(qpci.clock_status_offset) || 0;
            const tod = parseInt(qpci.tod_correction) || 0;
            const utc = parseInt(qpci.utc_tai_offset) || 0;
            
            document.getElementById('clock-drift').textContent = drift.toLocaleString();
            document.getElementById('clock-offset').textContent = offset.toLocaleString();
            document.getElementById('tod-correction').textContent = tod.toLocaleString();
            document.getElementById('utc-tai-offset').textContent = utc.toLocaleString();
            
            // Информация об источнике
            document.getElementById('clock-source-display').textContent = qpci.clock_source || 'Unknown';
            
            // Описание источника
            if (qpci.source_specific_metrics) {
                const metrics = qpci.source_specific_metrics;
                document.getElementById('source-description').textContent = metrics.description || '--';
                
                // Специфичная информация об источнике
                updateSourceSpecificInfo(metrics);
                
                // Цветовая индикация активных/неактивных метрик
                updateMetricStatus(metrics);
            }
        }
        
        function updateDevicesList(devices) {
            const devicesList = document.getElementById('devices-list');
            if (devices.length === 0) {
                devicesList.innerHTML = '<p>⚠️ Устройства не найдены. Проверьте что драйвер ptp_ocp загружен.</p>';
                return;
            }
            
            let html = '';
            devices.forEach(device => {
                html += `
                    <div style="margin-bottom: 10px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 5px;">
                        <strong>${device.device_id}</strong> - ${device.type}<br>
                        Serial: ${device.serial_number}<br>
                        Sources: ${device.available_clock_sources.join(', ')}
                    </div>
                `;
            });
            devicesList.innerHTML = html;
        }
        
        function updateLastUpdate() {
            const now = new Date();
            document.getElementById('last-update').textContent = 
                `Последнее обновление: ${now.toLocaleTimeString()}`;
        }
        
        // Функция для обновления часов устройства
        function updateDeviceClock() {
            const now = new Date();
            
            // Форматируем время
            const timeString = now.toLocaleTimeString('ru-RU', {
                hour12: false,
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            
            // Форматируем дату
            const dateString = now.toLocaleDateString('ru-RU', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            // Обновляем элементы
            document.getElementById('clock-time').textContent = timeString;
            document.getElementById('clock-date').textContent = dateString;
            
            // Обновляем статус синхронизации
            updateClockStatus();
        }
        
        // Функция для обновления статуса часов
        function updateClockStatus() {
            const statusElement = document.getElementById('clock-status');
            
            // Проверяем статус PTP синхронизации
            if (currentData.ptp && currentData.ptp.status) {
                const ptpStatus = currentData.ptp.status;
                
                if (ptpStatus === 'ok') {
                    statusElement.textContent = '✅ Синхронизировано с PTP';
                    statusElement.className = 'clock-status synced';
                } else if (ptpStatus === 'warning') {
                    statusElement.textContent = '⚠️ Синхронизация в процессе';
                    statusElement.className = 'clock-status syncing';
                } else {
                    statusElement.textContent = '❌ Ошибка синхронизации';
                    statusElement.className = 'clock-status error';
                }
            } else {
                statusElement.textContent = '🔄 Получение данных...';
                statusElement.className = 'clock-status syncing';
            }
        }
        
        
        
        // Автоматическое обновление каждые 10 секунд
        setInterval(refreshData, 10000);
        
        // Обновление часов каждую секунду
        setInterval(updateDeviceClock, 1000);
        
        
        // === BMP280 Functions ===
        let bmp280MonitoringActive = true;
        let bmp280Interval = null;
        
        async function refreshBMP280() {
            try {
                const response = await fetch('/api/bmp280');
                const data = await response.json();
                
                if (data.available) {
                    // Обновляем температуру
                    document.getElementById('bmp280-temperature').textContent = 
                        data.temperature_c ? data.temperature_c.toFixed(2) : '--';
                    document.getElementById('bmp280-temp-status').textContent = 'ok';
                    document.getElementById('bmp280-temp-status').className = 'metric-status ok';
                    
                    // Обновляем давление
                    document.getElementById('bmp280-pressure').textContent = 
                        data.pressure_hpa ? data.pressure_hpa.toFixed(2) : '--';
                    document.getElementById('bmp280-press-status').textContent = 'ok';
                    document.getElementById('bmp280-press-status').className = 'metric-status ok';
                    
                    // Обновляем статус
                    document.getElementById('bmp280-status').textContent = 'Active';
                    document.getElementById('bmp280-last-update').textContent = 
                        new Date(data.timestamp * 1000).toLocaleTimeString('ru-RU');
                    
                    // Показываем секцию
                    document.getElementById('bmp280-section').style.display = 'block';
                } else {
                    // Ошибка или недоступность
                    document.getElementById('bmp280-temperature').textContent = '--';
                    document.getElementById('bmp280-pressure').textContent = '--';
                    document.getElementById('bmp280-temp-status').textContent = 'error';
                    document.getElementById('bmp280-temp-status').className = 'metric-status error';
                    document.getElementById('bmp280-press-status').textContent = 'error';
                    document.getElementById('bmp280-press-status').className = 'metric-status error';
                    document.getElementById('bmp280-status').textContent = 'Error';
                    document.getElementById('bmp280-last-update').textContent = '--';
                }
            } catch (error) {
                console.error('Ошибка получения данных BMP280:', error);
                document.getElementById('bmp280-temperature').textContent = '--';
                document.getElementById('bmp280-pressure').textContent = '--';
                document.getElementById('bmp280-temp-status').textContent = 'error';
                document.getElementById('bmp280-temp-status').className = 'metric-status error';
                document.getElementById('bmp280-press-status').textContent = 'error';
                document.getElementById('bmp280-press-status').className = 'metric-status error';
                document.getElementById('bmp280-status').textContent = 'Connection Error';
            }
        }
        
        function toggleBMP280Monitoring() {
            const btn = document.getElementById('bmp280-monitor-btn');
            
            if (bmp280MonitoringActive) {
                // Останавливаем мониторинг
                if (bmp280Interval) {
                    clearInterval(bmp280Interval);
                    bmp280Interval = null;
                }
                bmp280MonitoringActive = false;
                btn.textContent = '▶️ Start Monitoring';
                btn.style.background = 'rgba(40, 167, 69, 0.3)';
            } else {
                // Запускаем мониторинг
                refreshBMP280(); // Сразу обновляем
                bmp280Interval = setInterval(refreshBMP280, 5000); // Каждые 5 секунд
                bmp280MonitoringActive = true;
                btn.textContent = '⏸️ Pause Monitoring';
                btn.style.background = 'rgba(255, 193, 7, 0.3)';
            }
        }
        
        // Проверяем доступность BMP280 при загрузке
        async function checkBMP280Availability() {
            try {
                const response = await fetch('/api/bmp280/info');
                const data = await response.json();
                
                if (data.available) {
                    // BMP280 доступен, показываем секцию и запускаем мониторинг
                    document.getElementById('bmp280-section').style.display = 'block';
                    refreshBMP280();
                    bmp280Interval = setInterval(refreshBMP280, 5000);
                } else {
                    // BMP280 недоступен, скрываем секцию
                    document.getElementById('bmp280-section').style.display = 'none';
                    console.log('BMP280 sensor not available');
                }
            } catch (error) {
                console.error('Ошибка проверки доступности BMP280:', error);
                document.getElementById('bmp280-section').style.display = 'none';
            }
        }
        
        // === INA219 Functions ===
        let ina219MonitoringActive = true;
        let ina219Interval = null;
        
        async function refreshINA219() {
            try {
                const response = await fetch('/api/ina219');
                const data = await response.json();
                
                if (data.data && data.data.available) {
                    const devices = data.data.devices;
                    
                    // Обновляем INA219 #1 (адрес 44)
                    if (devices['44'] && devices['44'].available) {
                        const device1 = devices['44'];
                        document.getElementById('ina219-1-bus-voltage').textContent = 
                            device1.bus_voltage.value.toFixed(3);
                        document.getElementById('ina219-1-shunt-voltage').textContent = 
                            (device1.shunt_voltage.value * 1000).toFixed(2);
                        document.getElementById('ina219-1-status').textContent = 'ok';
                        document.getElementById('ina219-1-status').className = 'metric-status ok';
                    } else {
                        document.getElementById('ina219-1-bus-voltage').textContent = '--';
                        document.getElementById('ina219-1-shunt-voltage').textContent = '--';
                        document.getElementById('ina219-1-status').textContent = 'error';
                        document.getElementById('ina219-1-status').className = 'metric-status error';
                    }
                    
                    // Обновляем INA219 #2 (адрес 41)
                    if (devices['41'] && devices['41'].available) {
                        const device2 = devices['41'];
                        document.getElementById('ina219-2-bus-voltage').textContent = 
                            device2.bus_voltage.value.toFixed(3);
                        document.getElementById('ina219-2-shunt-voltage').textContent = 
                            (device2.shunt_voltage.value * 1000).toFixed(2);
                        document.getElementById('ina219-2-status').textContent = 'ok';
                        document.getElementById('ina219-2-status').className = 'metric-status ok';
                    } else {
                        document.getElementById('ina219-2-bus-voltage').textContent = '--';
                        document.getElementById('ina219-2-shunt-voltage').textContent = '--';
                        document.getElementById('ina219-2-status').textContent = 'error';
                        document.getElementById('ina219-2-status').className = 'metric-status error';
                    }
                    
                    // Обновляем INA219 #3 (адрес 40)
                    if (devices['40'] && devices['40'].available) {
                        const device3 = devices['40'];
                        document.getElementById('ina219-3-bus-voltage').textContent = 
                            device3.bus_voltage.value.toFixed(3);
                        document.getElementById('ina219-3-shunt-voltage').textContent = 
                            (device3.shunt_voltage.value * 1000).toFixed(2);
                        document.getElementById('ina219-3-status').textContent = 'ok';
                        document.getElementById('ina219-3-status').className = 'metric-status ok';
                    } else {
                        document.getElementById('ina219-3-bus-voltage').textContent = '--';
                        document.getElementById('ina219-3-shunt-voltage').textContent = '--';
                        document.getElementById('ina219-3-status').textContent = 'error';
                        document.getElementById('ina219-3-status').className = 'metric-status error';
                    }
                    
                    // Обновляем общую информацию
                    document.getElementById('ina219-devices').textContent = 
                        `${data.data.summary.active_devices}/${data.data.summary.total_devices}`;
                    document.getElementById('ina219-status').textContent = 'Active';
                    document.getElementById('ina219-last-update').textContent = 
                        new Date(data.timestamp * 1000).toLocaleTimeString();
                } else {
                    // INA219 недоступен
                    document.getElementById('ina219-1-bus-voltage').textContent = '--';
                    document.getElementById('ina219-1-shunt-voltage').textContent = '--';
                    document.getElementById('ina219-1-status').textContent = 'error';
                    document.getElementById('ina219-1-status').className = 'metric-status error';
                    document.getElementById('ina219-2-bus-voltage').textContent = '--';
                    document.getElementById('ina219-2-shunt-voltage').textContent = '--';
                    document.getElementById('ina219-2-status').textContent = 'error';
                    document.getElementById('ina219-2-status').className = 'metric-status error';
                    document.getElementById('ina219-3-bus-voltage').textContent = '--';
                    document.getElementById('ina219-3-shunt-voltage').textContent = '--';
                    document.getElementById('ina219-3-status').textContent = 'error';
                    document.getElementById('ina219-3-status').className = 'metric-status error';
                    document.getElementById('ina219-status').textContent = 'Error';
                    document.getElementById('ina219-last-update').textContent = '--';
                }
            } catch (error) {
                console.error('Ошибка получения данных INA219:', error);
                document.getElementById('ina219-1-bus-voltage').textContent = '--';
                document.getElementById('ina219-1-shunt-voltage').textContent = '--';
                document.getElementById('ina219-1-status').textContent = 'error';
                document.getElementById('ina219-1-status').className = 'metric-status error';
                document.getElementById('ina219-2-bus-voltage').textContent = '--';
                document.getElementById('ina219-2-shunt-voltage').textContent = '--';
                document.getElementById('ina219-2-status').textContent = 'error';
                document.getElementById('ina219-2-status').className = 'metric-status error';
                document.getElementById('ina219-3-bus-voltage').textContent = '--';
                document.getElementById('ina219-3-shunt-voltage').textContent = '--';
                document.getElementById('ina219-3-status').textContent = 'error';
                document.getElementById('ina219-3-status').className = 'metric-status error';
                document.getElementById('ina219-status').textContent = 'Connection Error';
            }
        }
        
        function toggleINA219Monitoring() {
            const btn = document.getElementById('ina219-monitor-btn');
            
            if (ina219MonitoringActive) {
                // Останавливаем мониторинг
                if (ina219Interval) {
                    clearInterval(ina219Interval);
                    ina219Interval = null;
                }
                ina219MonitoringActive = false;
                btn.textContent = '▶️ Start Monitoring';
                btn.style.background = 'rgba(40, 167, 69, 0.3)';
            } else {
                // Запускаем мониторинг
                refreshINA219(); // Сразу обновляем
                ina219Interval = setInterval(refreshINA219, 5000); // Каждые 5 секунд
                ina219MonitoringActive = true;
                btn.textContent = '⏸️ Pause Monitoring';
                btn.style.background = 'rgba(255, 193, 7, 0.3)';
            }
        }
        
        
        // Проверяем доступность INA219 при загрузке
        async function checkINA219Availability() {
            try {
                const response = await fetch('/api/ina219');
                const data = await response.json();
                
                if (data.data && data.data.available) {
                    // INA219 доступен, показываем секцию и запускаем мониторинг
                    document.getElementById('ina219-section').style.display = 'block';
                    refreshINA219();
                    ina219Interval = setInterval(refreshINA219, 5000);
                } else {
                    // INA219 недоступен, скрываем секцию
                    document.getElementById('ina219-section').style.display = 'none';
                    console.log('INA219 sensors not available');
                }
            } catch (error) {
                console.error('Ошибка проверки доступности INA219:', error);
                document.getElementById('ina219-section').style.display = 'none';
            }
        }
        
        // === BNO055 Functions ===
        let bno055MonitoringActive = true;
        let bno055Interval = null;
        
        async function refreshBNO055() {
            try {
                const response = await fetch('/api/bno055');
                const data = await response.json();
                
                if (data.available && data.data) {
                    const sensorData = data.data;
                    
                    // Обновляем Euler angles
                    if (sensorData.euler_angles) {
                        document.getElementById('bno055-heading').textContent = sensorData.euler_angles.heading.toFixed(1);
                        document.getElementById('bno055-roll').textContent = sensorData.euler_angles.roll.toFixed(1);
                        document.getElementById('bno055-pitch').textContent = sensorData.euler_angles.pitch.toFixed(1);
                        document.getElementById('bno055-euler-status').textContent = 'ok';
                        document.getElementById('bno055-euler-status').className = 'metric-status ok';
                    }
                    
                    // Обновляем Linear acceleration
                    if (sensorData.linear_acceleration) {
                        document.getElementById('bno055-accel-x').textContent = sensorData.linear_acceleration.x.toFixed(2);
                        document.getElementById('bno055-accel-y').textContent = sensorData.linear_acceleration.y.toFixed(2);
                        document.getElementById('bno055-accel-z').textContent = sensorData.linear_acceleration.z.toFixed(2);
                        document.getElementById('bno055-accel-status').textContent = 'ok';
                        document.getElementById('bno055-accel-status').className = 'metric-status ok';
                    }
                    
                    // Обновляем температуру
                    if (sensorData.temperature !== undefined) {
                        document.getElementById('bno055-temperature').textContent = sensorData.temperature.toFixed(1);
                        document.getElementById('bno055-temp-status').textContent = 'ok';
                        document.getElementById('bno055-temp-status').className = 'metric-status ok';
                    }
                    
                    // Обновляем информацию
                    document.getElementById('bno055-mode').textContent = sensorData.operation_mode || 'unknown';
                    document.getElementById('bno055-status').textContent = 'Active';
                    document.getElementById('bno055-last-update').textContent = new Date().toLocaleTimeString();
                } else {
                    // BNO055 недоступен
                    document.getElementById('bno055-heading').textContent = '--';
                    document.getElementById('bno055-roll').textContent = '--';
                    document.getElementById('bno055-pitch').textContent = '--';
                    document.getElementById('bno055-euler-status').textContent = 'unavailable';
                    document.getElementById('bno055-euler-status').className = 'metric-status error';
                    
                    document.getElementById('bno055-accel-x').textContent = '--';
                    document.getElementById('bno055-accel-y').textContent = '--';
                    document.getElementById('bno055-accel-z').textContent = '--';
                    document.getElementById('bno055-accel-status').textContent = 'unavailable';
                    document.getElementById('bno055-accel-status').className = 'metric-status error';
                    
                    document.getElementById('bno055-temperature').textContent = '--';
                    document.getElementById('bno055-temp-status').textContent = 'unavailable';
                    document.getElementById('bno055-temp-status').className = 'metric-status error';
                    
                    document.getElementById('bno055-mode').textContent = 'unknown';
                    document.getElementById('bno055-status').textContent = 'Unavailable';
                    document.getElementById('bno055-last-update').textContent = '--';
                }
            } catch (error) {
                console.error('Ошибка получения данных BNO055:', error);
                document.getElementById('bno055-heading').textContent = '--';
                document.getElementById('bno055-roll').textContent = '--';
                document.getElementById('bno055-pitch').textContent = '--';
                document.getElementById('bno055-euler-status').textContent = 'error';
                document.getElementById('bno055-euler-status').className = 'metric-status error';
                
                document.getElementById('bno055-accel-x').textContent = '--';
                document.getElementById('bno055-accel-y').textContent = '--';
                document.getElementById('bno055-accel-z').textContent = '--';
                document.getElementById('bno055-accel-status').textContent = 'error';
                document.getElementById('bno055-accel-status').className = 'metric-status error';
                
                document.getElementById('bno055-temperature').textContent = '--';
                document.getElementById('bno055-temp-status').textContent = 'error';
                document.getElementById('bno055-temp-status').className = 'metric-status error';
                
                document.getElementById('bno055-status').textContent = 'Connection Error';
            }
        }
        
        function toggleBNO055Monitoring() {
            const btn = document.getElementById('bno055-monitor-btn');
            
            if (bno055MonitoringActive) {
                // Останавливаем мониторинг
                if (bno055Interval) {
                    clearInterval(bno055Interval);
                }
                bno055MonitoringActive = false;
                btn.textContent = '▶️ Start Monitoring';
                btn.style.background = 'rgba(40, 167, 69, 0.3)';
            } else {
                // Запускаем мониторинг
                refreshBNO055(); // Сразу обновляем
                bno055Interval = setInterval(refreshBNO055, 5000); // Каждые 5 секунд
                bno055MonitoringActive = true;
                btn.textContent = '⏸️ Pause Monitoring';
                btn.style.background = 'rgba(255, 193, 7, 0.3)';
            }
        }
        
        async function checkBNO055Calibration() {
            try {
                const response = await fetch('/api/bno055/calibration');
                const data = await response.json();
                
                if (data.available && data.calibration) {
                    const cal = data.calibration;
                    alert(`BNO055 Calibration Status:\n\nSystem: ${cal.system}/3\nGyro: ${cal.gyro}/3\nAccel: ${cal.accel}/3\nMag: ${cal.mag}/3`);
                } else {
                    alert('BNO055 calibration status unavailable');
                }
            } catch (error) {
                console.error('Ошибка получения статуса калибровки BNO055:', error);
                alert('Ошибка получения статуса калибровки BNO055');
            }
        }
        
        // Проверяем доступность BNO055 при загрузке
        async function checkBNO055Availability() {
            try {
                const response = await fetch('/api/bno055/info');
                const data = await response.json();
                
                if (data.available) {
                    // BNO055 доступен, показываем секцию и запускаем мониторинг
                    document.getElementById('bno055-section').style.display = 'block';
                    refreshBNO055();
                    bno055Interval = setInterval(refreshBNO055, 5000);
                } else {
                    // BNO055 недоступен, скрываем секцию
                    document.getElementById('bno055-section').style.display = 'none';
                    console.log('BNO055 sensor not available');
                }
            } catch (error) {
                console.error('Ошибка проверки доступности BNO055:', error);
                document.getElementById('bno055-section').style.display = 'none';
            }
        }
        
        // Первоначальная загрузка
        console.log('Starting dashboard initialization...'); // Отладка
        
        // Принудительное обновление данных
        setTimeout(() => {
            console.log('Force refreshing data...'); // Отладка
        refreshData();
        }, 1000);
        
        updateDeviceClock();
        checkBMP280Availability();
        checkINA219Availability();
        checkBNO055Availability();
        console.log('Dashboard initialization complete'); // Отладка
    </script>
</body>
</html>
