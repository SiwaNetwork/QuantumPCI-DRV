<!DOCTYPE html>
<html>
<head>
    <title>TimeCard Advanced Monitor</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
        }
        
        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .dashboard-header {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px 30px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        
        .dashboard-header h1 {
            color: #2c3e50;
            font-size: 2.2em;
            font-weight: 600;
        }
        
        .device-selector select {
            padding: 10px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            background: white;
        }
        
        .overall-health {
            text-align: center;
        }
        
        .health-score {
            font-size: 2.5em;
            font-weight: bold;
            color: #27ae60;
        }
        
        .health-label {
            font-size: 0.9em;
            color: #7f8c8d;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 25px;
        }
        
        .panel {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            transition: transform 0.3s ease;
        }
        
        .panel:hover {
            transform: translateY(-5px);
        }
        
        .panel h3 {
            color: #2c3e50;
            font-size: 1.4em;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .metric-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
        }
        
        .metric {
            text-align: center;
            padding: 15px;
            background: linear-gradient(145deg, #f8f9fa, #e9ecef);
            border-radius: 10px;
            border: 1px solid #dee2e6;
        }
        
        .metric-value {
            font-size: 1.8em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .metric-label {
            font-size: 0.8em;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .status-normal { color: #28a745; }
        .status-warning { color: #ffc107; }
        .status-critical { color: #dc3545; }
        
        .thermal-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }
        
        .temp-gauge {
            text-align: center;
            padding: 20px;
            background: linear-gradient(145deg, #f1f3f4, #e8eaed);
            border-radius: 15px;
            position: relative;
            overflow: hidden;
        }
        
        .temp-gauge::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #4CAF50, #FF9800, #F44336);
        }
        
        .temp-value {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        .temp-label {
            font-size: 0.9em;
            color: #666;
            font-weight: 500;
        }
        
        .gnss-overview {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
        }
        
        .satellite-count {
            text-align: center;
        }
        
        .count-display {
            font-size: 2.5em;
            font-weight: bold;
            color: #2196F3;
        }
        
        .count-label {
            font-size: 0.9em;
            color: #666;
        }
        
        .fix-indicator {
            font-size: 1.5em;
            font-weight: bold;
            padding: 10px 20px;
            background: #4CAF50;
            color: white;
            border-radius: 25px;
            display: inline-block;
        }
        
        .constellation-breakdown {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
        }
        
        .constellation {
            text-align: center;
            padding: 10px;
        }
        
        .const-name {
            display: block;
            font-size: 0.8em;
            color: #666;
            margin-bottom: 5px;
        }
        
        .const-count {
            font-size: 1.5em;
            font-weight: bold;
            color: #2196F3;
        }
        
        .oscillator-status {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .osc-metric {
            text-align: center;
            padding: 15px;
            background: linear-gradient(145deg, #e3f2fd, #bbdefb);
            border-radius: 10px;
        }
        
        .osc-value {
            font-size: 1.6em;
            font-weight: bold;
            color: #1976d2;
            margin-bottom: 5px;
        }
        
        .osc-label {
            font-size: 0.8em;
            color: #424242;
        }
        
        .hardware-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .hw-section {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #007bff;
        }
        
        .hw-section h4 {
            color: #495057;
            margin-bottom: 10px;
        }
        
        .led-status {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .led {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 5px 10px;
            background: white;
            border-radius: 20px;
            font-size: 0.9em;
        }
        
        .led-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        
        .led-green { background-color: #28a745; }
        .led-red { background-color: #dc3545; }
        .led-yellow { background-color: #ffc107; }
        .led-off { background-color: #6c757d; }
        
        .alerts-panel {
            grid-column: 1 / -1;
        }
        
        .alert {
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .alert-critical {
            background: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }
        
        .alert-warning {
            background: #fff3cd;
            border-color: #ffc107;
            color: #856404;
        }
        
        .alert-info {
            background: #d1ecf1;
            border-color: #17a2b8;
            color: #0c5460;
        }
        
        .charts-panel {
            grid-column: 1 / -1;
            min-height: 300px;
        }
        
        .chart-container {
            width: 100%;
            height: 250px;
            background: #f8f9fa;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            font-size: 1.1em;
        }
        
        .controls {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background 0.3s ease;
        }
        
        .btn:hover {
            background: #0056b3;
        }
        
        .btn-success { background: #28a745; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-danger { background: #dc3545; }
        
        .last-update {
            text-align: right;
            font-size: 0.8em;
            color: #6c757d;
            margin-top: 15px;
        }
        
        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            background: rgba(0,0,0,0.8);
            color: white;
            border-radius: 20px;
            font-size: 0.9em;
            z-index: 1000;
        }
        
        .status-connected { background: rgba(40, 167, 69, 0.9); }
        .status-disconnected { background: rgba(220, 53, 69, 0.9); }
        
        @media (max-width: 768px) {
            .dashboard-header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .metric-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .thermal-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .constellation-breakdown {
                flex-wrap: wrap;
                gap: 10px;
            }
        }
        
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
        
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.js"></script>
</head>
<body>
    <div class="connection-status" id="connection-status">
        üîå Connecting...
    </div>
    
    <div class="dashboard-container">
        <header class="dashboard-header">
            <h1>üïê TimeCard PTP OCP Monitor</h1>
            <div class="device-selector">
                <select id="device-select">
                    <option value="timecard0">TimeCard 0</option>
                </select>
            </div>
            <div class="overall-health">
                <div class="health-score" id="health-score">--</div>
                <div class="health-label">System Health</div>
            </div>
        </header>
        
        <div class="dashboard-grid">
            <!-- Thermal Panel -->
            <div class="panel thermal-panel">
                <h3>üå°Ô∏è Thermal Status</h3>
                <div class="thermal-grid">
                    <div class="temp-gauge">
                        <div class="temp-value" id="fpga-temp">--¬∞C</div>
                        <div class="temp-label">FPGA</div>
                    </div>
                    <div class="temp-gauge">
                        <div class="temp-value" id="osc-temp">--¬∞C</div>
                        <div class="temp-label">Oscillator</div>
                    </div>
                    <div class="temp-gauge">
                        <div class="temp-value" id="board-temp">--¬∞C</div>
                        <div class="temp-label">Board</div>
                    </div>
                    <div class="temp-gauge">
                        <div class="temp-value" id="ambient-temp">--¬∞C</div>
                        <div class="temp-label">Ambient</div>
                    </div>
                    <div class="temp-gauge">
                        <div class="temp-value" id="pll-temp">--¬∞C</div>
                        <div class="temp-label">PLL</div>
                    </div>
                    <div class="temp-gauge">
                        <div class="temp-value" id="ddr-temp">--¬∞C</div>
                        <div class="temp-label">DDR</div>
                    </div>
                </div>
                <div class="metric" style="margin-top: 15px;">
                    <div class="metric-value" id="fan-speed">-- RPM</div>
                    <div class="metric-label">Fan Speed</div>
                </div>
            </div>
            
            <!-- GNSS Panel -->
            <div class="panel gnss-panel">
                <h3>üõ∞Ô∏è GNSS Receiver</h3>
                <div class="gnss-overview">
                    <div class="satellite-count">
                        <div class="count-display">
                            <span id="sats-used">--</span>/<span id="sats-visible">--</span>
                        </div>
                        <div class="count-label">Satellites (Used/Visible)</div>
                    </div>
                    <div class="fix-status">
                        <div id="fix-type" class="fix-indicator">--</div>
                        <div class="count-label" style="margin-top: 10px;">Fix Type</div>
                    </div>
                </div>
                
                <div class="constellation-breakdown">
                    <div class="constellation">
                        <span class="const-name">GPS</span>
                        <span class="const-count" id="gps-count">--</span>
                    </div>
                    <div class="constellation">
                        <span class="const-name">GLONASS</span>
                        <span class="const-count" id="glonass-count">--</span>
                    </div>
                    <div class="constellation">
                        <span class="const-name">Galileo</span>
                        <span class="const-count" id="galileo-count">--</span>
                    </div>
                    <div class="constellation">
                        <span class="const-name">BeiDou</span>
                        <span class="const-count" id="beidou-count">--</span>
                    </div>
                </div>
                
                <div class="metric-grid">
                    <div class="metric">
                        <div class="metric-value" id="time-accuracy">--ns</div>
                        <div class="metric-label">Time Accuracy</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="pdop-value">--</div>
                        <div class="metric-label">PDOP</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="antenna-status">--</div>
                        <div class="metric-label">Antenna</div>
                    </div>
                </div>
            </div>
            
            <!-- Oscillator Panel -->
            <div class="panel oscillator-panel">
                <h3>‚ö° Oscillator</h3>
                <div class="oscillator-status">
                    <div class="osc-metric">
                        <div class="osc-value" id="disciplining-state">--</div>
                        <div class="osc-label">Disciplining</div>
                    </div>
                    <div class="osc-metric">
                        <div class="osc-value" id="freq-error">-- ppb</div>
                        <div class="osc-label">Frequency Error</div>
                    </div>
                    <div class="osc-metric">
                        <div class="osc-value" id="stability-1s">--</div>
                        <div class="osc-label">Stability (1s)</div>
                    </div>
                    <div class="osc-metric">
                        <div class="osc-value" id="holdover-grade">--</div>
                        <div class="osc-label">Holdover Grade</div>
                    </div>
                </div>
            </div>
            
            <!-- PTP Advanced Panel -->
            <div class="panel ptp-advanced-panel">
                <h3>üì° PTP Advanced</h3>
                <div class="metric-grid">
                    <div class="metric">
                        <div class="metric-value" id="ptp-offset">-- ns</div>
                        <div class="metric-label">Offset</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="path-delay">-- ns</div>
                        <div class="metric-label">Path Delay</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="path-variance">-- ns</div>
                        <div class="metric-label">Path Variance</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="packet-loss">-- %</div>
                        <div class="metric-label">Packet Loss</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="master-clock">--</div>
                        <div class="metric-label">Master Clock</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="ptp-performance">-- %</div>
                        <div class="metric-label">Performance</div>
                    </div>
                </div>
            </div>
            
            <!-- Hardware Panel -->
            <div class="panel hardware-panel">
                <h3>üîß Hardware Status</h3>
                <div class="hardware-grid">
                    <div class="hw-section">
                        <h4>LED Status</h4>
                        <div class="led-status">
                            <div class="led">
                                <div class="led-indicator led-green" id="power-led"></div>
                                <span>Power</span>
                            </div>
                            <div class="led">
                                <div class="led-indicator led-green" id="sync-led"></div>
                                <span>Sync</span>
                            </div>
                            <div class="led">
                                <div class="led-indicator led-green" id="gnss-led"></div>
                                <span>GNSS</span>
                            </div>
                            <div class="led">
                                <div class="led-indicator led-off" id="alarm-led"></div>
                                <span>Alarm</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="hw-section">
                        <h4>FPGA Info</h4>
                        <div class="metric">
                            <div class="metric-value" id="fpga-version">--</div>
                            <div class="metric-label">Version</div>
                        </div>
                        <div class="metric">
                            <div class="metric-value" id="fpga-utilization">-- %</div>
                            <div class="metric-label">Utilization</div>
                        </div>
                    </div>
                    
                    <div class="hw-section">
                        <h4>Network Ports</h4>
                        <div class="metric">
                            <div class="metric-value" id="port1-status">--</div>
                            <div class="metric-label">Port 1</div>
                        </div>
                        <div class="metric">
                            <div class="metric-value" id="port2-status">--</div>
                            <div class="metric-label">Port 2</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Power Panel -->
            <div class="panel power-panel">
                <h3>‚ö° Power Consumption</h3>
                <div class="metric-grid">
                    <div class="metric">
                        <div class="metric-value" id="voltage-3v3">-- V</div>
                        <div class="metric-label">3.3V Rail</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="voltage-1v8">-- V</div>
                        <div class="metric-label">1.8V Rail</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="current-total">-- mA</div>
                        <div class="metric-label">Total Current</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="power-total">-- W</div>
                        <div class="metric-label">Total Power</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="power-efficiency">-- %</div>
                        <div class="metric-label">Efficiency</div>
                    </div>
                </div>
            </div>
            
            <!-- Alerts Panel -->
            <div class="panel alerts-panel">
                <h3>üö® System Alerts</h3>
                <div id="alerts-container">
                    <div class="alert alert-info">
                        <span>Loading alerts...</span>
                        <span class="spinner"></span>
                    </div>
                </div>
            </div>
            
            <!-- Historical Charts Panel -->
            <div class="panel charts-panel">
                <h3>üìà Historical Data</h3>
                <div class="chart-container">
                    <span>Historical charts will be displayed here<br>
                    üìä PTP Offset trends, üå°Ô∏è Temperature history, üõ∞Ô∏è GNSS performance</span>
                </div>
            </div>
        </div>
        
        <div class="controls">
            <button class="btn" onclick="refreshData()">üîÑ Refresh All</button>
            <button class="btn btn-success" onclick="exportLogs()">üìã Export Logs</button>
            <button class="btn btn-warning" onclick="showConfig()">‚öôÔ∏è Configuration</button>
            <button class="btn btn-danger" onclick="restartServices()">üîÑ Restart Services</button>
        </div>
        
        <div class="last-update" id="last-update">Last update: Never</div>
    </div>

    <script>
        class TimeCardDashboard {
            constructor() {
                this.deviceId = 'timecard0';
                this.updateInterval = 5000; // 5 seconds
                this.socket = null;
                this.isConnected = false;
                this.setupEventListeners();
                this.connectWebSocket();
                this.startUpdates();
            }
            
            setupEventListeners() {
                document.getElementById('device-select').addEventListener('change', (e) => {
                    this.deviceId = e.target.value;
                    this.updateAllPanels();
                });
            }
            
            connectWebSocket() {
                try {
                    this.socket = io();
                    
                    this.socket.on('connect', () => {
                        console.log('Connected to WebSocket');
                        this.isConnected = true;
                        this.updateConnectionStatus(true);
                    });
                    
                    this.socket.on('disconnect', () => {
                        console.log('Disconnected from WebSocket');
                        this.isConnected = false;
                        this.updateConnectionStatus(false);
                    });
                    
                    this.socket.on('metrics_update', (data) => {
                        if (data.device_id === this.deviceId) {
                            this.updateQuickMetrics(data.metrics);
                        }
                    });
                    
                    this.socket.on('log_update', (data) => {
                        console.log('Log update:', data.message);
                    });
                    
                    this.socket.on('device_update', (data) => {
                        if (data.device_id === this.deviceId) {
                            this.updateQuickMetrics(data);
                        }
                    });
                    
                } catch (error) {
                    console.error('WebSocket connection error:', error);
                    this.updateConnectionStatus(false);
                }
            }
            
            updateConnectionStatus(connected) {
                const statusEl = document.getElementById('connection-status');
                if (connected) {
                    statusEl.textContent = 'üîó Connected';
                    statusEl.className = 'connection-status status-connected';
                } else {
                    statusEl.textContent = 'üîå Disconnected';
                    statusEl.className = 'connection-status status-disconnected';
                }
            }
            
            async updateAllPanels() {
                try {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                    document.querySelector('.dashboard-container').classList.add('loading');
                    
                    const [deviceStatus, extendedMetrics] = await Promise.all([
                        fetch(`/api/device/${this.deviceId}/status`).then(r => r.json()),
                        fetch('/api/metrics/extended').then(r => r.json())
                    ]);
                    
                    if (deviceStatus.error) {
                        console.error('Device not found:', deviceStatus.error);
                        this.showError('Device not found: ' + deviceStatus.error);
                        return;
                    }
                    
                    const deviceData = extendedMetrics[this.deviceId] || {};
                    
                    this.updateThermalPanel(deviceData.thermal || {});
                    this.updateGNSSPanel(deviceData.gnss || {});
                    this.updateOscillatorPanel(deviceData.oscillator || {});
                    this.updatePTPPanel(deviceData.ptp_advanced || {});
                    this.updateHardwarePanel(deviceData.hardware || {});
                    this.updatePowerPanel(deviceData.power || {});
                    this.updateAlertsPanel(deviceStatus.alerts || []);
                    this.updateOverallHealth(deviceStatus.overall_health_score || 100);
                    
                    document.getElementById('last-update').textContent = 
                        'Last update: ' + new Date().toLocaleString();
                    
                } catch (error) {
                    console.error('Error updating dashboard:', error);
                    this.showConnectionError();
                } finally {
                    // –£–±–∏—Ä–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                    document.querySelector('.dashboard-container').classList.remove('loading');
                }
            }
            
            updateThermalPanel(thermal) {
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–Ω—ã—Ö –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤
                Object.entries(thermal).forEach(([sensor, data]) => {
                    if (typeof data === 'object' && data.value !== undefined) {
                        const elementId = sensor.replace('_', '-');
                        const element = document.getElementById(elementId);
                        if (element) {
                            element.textContent = `${data.value}¬∞C`;
                            element.className = `temp-value status-${data.status}`;
                        }
                    }
                });
                
                // Fan speed
                if (thermal.cooling && thermal.cooling.fan_speed) {
                    const fanEl = document.getElementById('fan-speed');
                    if (fanEl) {
                        fanEl.textContent = `${thermal.cooling.fan_speed} RPM`;
                    }
                }
            }
            
            updateGNSSPanel(gnss) {
                if (gnss.fix) {
                    this.updateElement('sats-used', gnss.fix.satellites_used || '--');
                    this.updateElement('sats-visible', gnss.fix.satellites_visible || '--');
                    this.updateElement('fix-type', gnss.fix.fix_type || '--');
                }
                
                if (gnss.constellations) {
                    this.updateElement('gps-count', gnss.constellations.gps || '0');
                    this.updateElement('glonass-count', gnss.constellations.glonass || '0');
                    this.updateElement('galileo-count', gnss.constellations.galileo || '0');
                    this.updateElement('beidou-count', gnss.constellations.beidou || '0');
                }
                
                if (gnss.accuracy) {
                    this.updateElement('time-accuracy', `${Math.round(gnss.accuracy.time_accuracy || 0)}ns`);
                    this.updateElement('pdop-value', `${(gnss.accuracy.pdop || 0).toFixed(1)}`);
                }
                
                if (gnss.antenna) {
                    this.updateElement('antenna-status', gnss.antenna.status || '--');
                }
            }
            
            updateOscillatorPanel(oscillator) {
                if (oscillator.basic) {
                    this.updateElement('disciplining-state', oscillator.basic.disciplining_state || '--');
                }
                
                if (oscillator.frequency) {
                    this.updateElement('freq-error', 
                        `${(oscillator.frequency.frequency_error_ppb || 0).toFixed(1)} ppb`);
                    this.updateElement('stability-1s', 
                        `${(oscillator.frequency.frequency_stability_1s || 0).toExponential(1)}`);
                }
                
                if (oscillator.holdover) {
                    this.updateElement('holdover-grade', 
                        oscillator.holdover.holdover_performance_grade || '--');
                }
            }
            
            updatePTPPanel(ptp) {
                if (ptp.basic) {
                    this.updateElement('ptp-offset', `${ptp.basic.offset_ns || 0} ns`);
                    this.updateElement('path-delay', `${ptp.basic.path_delay_ns || 0} ns`);
                }
                
                if (ptp.delay_stats) {
                    this.updateElement('path-variance', 
                        `${Math.round(ptp.delay_stats.path_delay_variance || 0)} ns`);
                }
                
                if (ptp.packet_stats) {
                    this.updateElement('packet-loss', 
                        `${(ptp.packet_stats.packet_loss_percent || 0).toFixed(2)} %`);
                }
                
                if (ptp.master) {
                    const masterId = ptp.master.master_clock_id || '--';
                    this.updateElement('master-clock', 
                        masterId.length > 8 ? masterId.substring(0, 8) + '...' : masterId);
                }
                
                this.updateElement('ptp-performance', `${Math.round(ptp.performance_score || 0)} %`);
            }
            
            updateHardwarePanel(hardware) {
                if (hardware.leds) {
                    Object.entries(hardware.leds).forEach(([led, status]) => {
                        const elementId = led.replace('_', '-');
                        const element = document.getElementById(elementId);
                        if (element) {
                            element.className = `led-indicator led-${status === 'green' ? 'green' : 
                                                                  status === 'red' ? 'red' : 
                                                                  status === 'yellow' ? 'yellow' : 'off'}`;
                        }
                    });
                }
                
                if (hardware.fpga) {
                    this.updateElement('fpga-version', hardware.fpga.version || '--');
                    this.updateElement('fpga-utilization', `${hardware.fpga.utilization_percent || 0} %`);
                }
                
                if (hardware.phy) {
                    this.updateElement('port1-status', 
                        hardware.phy.port1.link_up ? `${hardware.phy.port1.speed_mbps}M` : 'Down');
                    this.updateElement('port2-status', 
                        hardware.phy.port2.link_up ? `${hardware.phy.port2.speed_mbps}M` : 'Down');
                }
            }
            
            updatePowerPanel(power) {
                if (power.voltage_3v3) {
                    this.updateElement('voltage-3v3', `${power.voltage_3v3.value || 0} V`);
                }
                if (power.voltage_1v8) {
                    this.updateElement('voltage-1v8', `${power.voltage_1v8.value || 0} V`);
                }
                if (power.current_total) {
                    this.updateElement('current-total', `${power.current_total.value || 0} mA`);
                }
                if (power.power_consumption) {
                    this.updateElement('power-total', `${power.power_consumption.total_watts || 0} W`);
                    this.updateElement('power-efficiency', `${power.power_consumption.efficiency_percent || 0} %`);
                }
            }
            
            updateAlertsPanel(alerts) {
                const container = document.getElementById('alerts-container');
                
                if (!alerts || alerts.length === 0) {
                    container.innerHTML = `
                        <div class="alert alert-info">
                            <span>‚úÖ No active alerts - System operating normally</span>
                            <span>${new Date().toLocaleTimeString()}</span>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = alerts.map(alert => `
                    <div class="alert alert-${alert.severity}">
                        <span>
                            ${alert.severity === 'critical' ? 'üö®' : '‚ö†Ô∏è'} 
                            ${alert.message}
                        </span>
                        <span>${new Date(alert.timestamp * 1000).toLocaleTimeString()}</span>
                    </div>
                `).join('');
            }
            
            updateOverallHealth(score) {
                const element = document.getElementById('health-score');
                element.textContent = `${Math.round(score)}%`;
                
                if (score >= 90) {
                    element.style.color = '#27ae60';
                } else if (score >= 70) {
                    element.style.color = '#f39c12';
                } else {
                    element.style.color = '#e74c3c';
                }
            }
            
            updateQuickMetrics(metrics) {
                // –ë—ã—Å—Ç—Ä–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω—ã—Ö –º–µ—Ç—Ä–∏–∫ —á–µ—Ä–µ–∑ WebSocket
                if (metrics.offset_ns !== undefined || metrics.ptp_offset !== undefined) {
                    const offset = metrics.offset_ns || metrics.ptp_offset;
                    this.updateElement('ptp-offset', `${offset} ns`);
                }
                if (metrics.path_delay_ns !== undefined) {
                    this.updateElement('path-delay', `${metrics.path_delay_ns} ns`);
                }
                if (metrics.fpga_temp !== undefined) {
                    this.updateElement('fpga-temp', `${metrics.fpga_temp}¬∞C`);
                }
                if (metrics.satellites_used !== undefined) {
                    this.updateElement('sats-used', metrics.satellites_used);
                }
            }
            
            updateElement(id, value) {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = value;
                }
            }
            
            showConnectionError() {
                const container = document.getElementById('alerts-container');
                container.innerHTML = `
                    <div class="alert alert-critical">
                        <span>üîå Connection Error - Unable to fetch data from API</span>
                        <span>${new Date().toLocaleTimeString()}</span>
                    </div>
                `;
            }
            
            showError(message) {
                const container = document.getElementById('alerts-container');
                container.innerHTML = `
                    <div class="alert alert-critical">
                        <span>‚ùå ${message}</span>
                        <span>${new Date().toLocaleTimeString()}</span>
                    </div>
                `;
            }
            
            startUpdates() {
                // –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
                this.updateAllPanels();
                
                // –†–µ–≥—É–ª—è—Ä–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                setInterval(() => {
                    this.updateAllPanels();
                }, this.updateInterval);
                
                // –ó–∞–ø—Ä–æ—Å –±—ã—Å—Ç—Ä–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ WebSocket
                if (this.socket && this.isConnected) {
                    setInterval(() => {
                        this.socket.emit('request_device_update', { device_id: this.deviceId });
                    }, 2000); // –ö–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã
                }
            }
        }
        
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫
        function refreshData() {
            dashboard.updateAllPanels();
        }
        
        async function exportLogs() {
            try {
                const response = await fetch('/api/logs/export');
                const logs = await response.text();
                
                const blob = new Blob([logs], { type: 'text/plain' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `timecard-logs-${Date.now()}.log`;
                a.click();
                window.URL.revokeObjectURL(url);
            } catch (error) {
                alert('Error exporting logs: ' + error.message);
            }
        }
        
        function showConfig() {
            window.open('/api/config', '_blank');
        }
        
        async function restartServices() {
            const services = ['ptp4l', 'phc2sys', 'chronyd', 'timecard-driver'];
            const service = prompt(`Restart which service?\nOptions: ${services.join(', ')}`);
            
            if (service && services.includes(service)) {
                if (confirm(`Are you sure you want to restart ${service} service?`)) {
                    try {
                        const response = await fetch(`/api/restart/${service}`, {
                            method: 'POST'
                        });
                        const result = await response.json();
                        
                        if (response.ok) {
                            alert(`‚úÖ ${result.message}`);
                            // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞
                            setTimeout(() => dashboard.updateAllPanels(), 2000);
                        } else {
                            alert(`‚ùå Error: ${result.error}`);
                        }
                    } catch (error) {
                        alert(`‚ùå Error: ${error.message}`);
                    }
                }
            }
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è dashboard
        const dashboard = new TimeCardDashboard();
        
        console.log('üïê TimeCard Advanced Dashboard loaded');
        console.log('‚ú® Features: Thermal, GNSS, Oscillator, PTP, Hardware, Power monitoring');
    </script>
</body>
</html>