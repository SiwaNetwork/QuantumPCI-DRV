# alertmanager.yml - AlertManager configuration for TimeCard monitoring

global:
  smtp_smarthost: 'localhost:587'
  smtp_from: 'timecard-alerts@example.com'
  smtp_auth_username: 'alerts'
  smtp_auth_password: 'password'

# –®–∞–±–ª–æ–Ω—ã –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
templates:
  - '/etc/alertmanager/templates/*.tmpl'

# –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –∞–ª–µ—Ä—Ç–æ–≤
route:
  group_by: ['alertname', 'device_id', 'severity']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 1h
  receiver: 'web.hook'
  
  routes:
    # –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∞–ª–µ—Ä—Ç—ã - –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    - match:
        severity: critical
      receiver: 'critical-alerts'
      group_wait: 5s
      repeat_interval: 5m
      
    # PTP –∞–ª–µ—Ä—Ç—ã
    - match:
        component: ptp
      receiver: 'ptp-team'
      group_wait: 30s
      repeat_interval: 30m
      
    # –¢–µ–ø–ª–æ–≤—ã–µ –∞–ª–µ—Ä—Ç—ã
    - match:
        component: thermal
      receiver: 'thermal-alerts'
      group_wait: 1m
      repeat_interval: 15m
      
    # GNSS –∞–ª–µ—Ä—Ç—ã
    - match:
        component: gnss
      receiver: 'gnss-team'
      group_wait: 2m
      repeat_interval: 1h
      
    # –ê–ª–µ—Ä—Ç—ã –ø–∏—Ç–∞–Ω–∏—è
    - match:
        component: power
      receiver: 'power-team'
      group_wait: 1m
      repeat_interval: 30m
      
    # –°–∏—Å—Ç–µ–º–Ω—ã–µ –∞–ª–µ—Ä—Ç—ã
    - match:
        component: system
      receiver: 'system-admin'
      group_wait: 30s
      repeat_interval: 1h

# –ü–æ–ª—É—á–∞—Ç–µ–ª–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
receivers:
  - name: 'web.hook'
    webhook_configs:
      - url: 'http://localhost:5001/webhook'
        
  - name: 'critical-alerts'
    email_configs:
      - to: 'critical-alerts@example.com'
        subject: 'üö® CRITICAL: TimeCard Alert on {{ .GroupLabels.device_id }}'
        body: |
          TimeCard Critical Alert
          
          Device: {{ .GroupLabels.device_id }}
          Severity: {{ .GroupLabels.severity }}
          
          Alerts:
          {{ range .Alerts }}
          - {{ .Annotations.summary }}
            {{ .Annotations.description }}
          {{ end }}
          
          Dashboard: http://localhost:3000/d/timecard
          
    slack_configs:
      - api_url: 'https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK'
        channel: '#critical-alerts'
        color: 'danger'
        title: 'üö® Critical TimeCard Alert'
        text: |
          Device: {{ .GroupLabels.device_id }}
          {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}
        
  - name: 'ptp-team'
    email_configs:
      - to: 'ptp-team@example.com'
        subject: '‚è∞ PTP Alert: {{ .GroupLabels.device_id }}'
        body: |
          PTP System Alert
          
          Device: {{ .GroupLabels.device_id }}
          Component: PTP
          
          Details:
          {{ range .Alerts }}
          - {{ .Annotations.summary }}
            {{ .Annotations.description }}
          {{ end }}
          
          Grafana: http://localhost:3000/d/timecard?var-device={{ .GroupLabels.device_id }}
          
  - name: 'thermal-alerts'
    email_configs:
      - to: 'thermal-team@example.com'
        subject: 'üå°Ô∏è Thermal Alert: {{ .GroupLabels.device_id }}'
        body: |
          Thermal System Alert
          
          Device: {{ .GroupLabels.device_id }}
          Component: Thermal Management
          
          Details:
          {{ range .Alerts }}
          - {{ .Annotations.summary }}
            Temperature: {{ .Annotations.description }}
          {{ end }}
          
          Action Required: Check cooling system and ambient temperature
          Dashboard: http://localhost:3000/d/timecard?var-device={{ .GroupLabels.device_id }}
          
  - name: 'gnss-team'
    email_configs:
      - to: 'gnss-team@example.com'
        subject: 'üõ∞Ô∏è GNSS Alert: {{ .GroupLabels.device_id }}'
        body: |
          GNSS System Alert
          
          Device: {{ .GroupLabels.device_id }}
          Component: GNSS Receiver
          
          Details:
          {{ range .Alerts }}
          - {{ .Annotations.summary }}
            {{ .Annotations.description }}
          {{ end }}
          
          Possible Causes:
          - Antenna position/connection
          - Signal interference
          - Satellite visibility
          
          Dashboard: http://localhost:3000/d/timecard?var-device={{ .GroupLabels.device_id }}
          
  - name: 'power-team'
    email_configs:
      - to: 'power-team@example.com'
        subject: '‚ö° Power Alert: {{ .GroupLabels.device_id }}'
        body: |
          Power System Alert
          
          Device: {{ .GroupLabels.device_id }}
          Component: Power Management
          
          Details:
          {{ range .Alerts }}
          - {{ .Annotations.summary }}
            {{ .Annotations.description }}
          {{ end }}
          
          Check:
          - Power supply stability
          - Voltage rail health
          - Current consumption
          
          Dashboard: http://localhost:3000/d/timecard?var-device={{ .GroupLabels.device_id }}
          
  - name: 'system-admin'
    email_configs:
      - to: 'admin@example.com'
        subject: 'üîß System Alert: {{ .GroupLabels.device_id }}'
        body: |
          System Alert
          
          Device: {{ .GroupLabels.device_id }}
          Component: {{ .GroupLabels.component }}
          
          Details:
          {{ range .Alerts }}
          - {{ .Annotations.summary }}
            {{ .Annotations.description }}
          {{ end }}
          
          Monitoring Dashboard: http://localhost:3000/d/timecard
          API Status: http://localhost:8080/api/health

# –ü–æ–¥–∞–≤–ª–µ–Ω–∏–µ –∞–ª–µ—Ä—Ç–æ–≤
inhibit_rules:
  # –ü–æ–¥–∞–≤–ª—è–µ–º warning –µ—Å–ª–∏ –µ—Å—Ç—å critical
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['device_id', 'component']
    
  # –ü–æ–¥–∞–≤–ª—è–µ–º –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∞–ª–µ—Ä—Ç—ã
  - source_match:
      alertname: 'SystemHealthCritical'
    target_match_re:
      alertname: '.*(Warning|Low).*'
    equal: ['device_id']