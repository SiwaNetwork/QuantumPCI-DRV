# 🏗️ TimeCard PTP OCP - Архитектура системы

## 📐 Общая архитектура

```
┌─────────────────────────────────────────────────────────────────────┐
│                         TimeCard PTP OCP                            │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌───────────┐ │
│  │    GNSS     │  │   Atomic    │  │   IRIG-B    │  │ External  │ │
│  │  Receiver   │  │   Clock     │  │  Receiver   │  │   PPS     │ │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘  └─────┬─────┘ │
│         │                 │                 │               │       │
│  ┌──────▼─────────────────▼─────────────────▼───────────────▼────┐ │
│  │                    FPGA (Xilinx)                               │ │
│  │  ┌───────────┐  ┌──────────┐  ┌──────────┐  ┌──────────────┐ │ │
│  │  │ Timestamp │  │   PLL    │  │ Frequency │  │ GPIO/LED     │ │ │
│  │  │  Engine   │  │ Control  │  │ Synthesis │  │ Controller   │ │ │
│  │  └───────────┘  └──────────┘  └──────────┘  └──────────────┘ │ │
│  └────────────────────────┬───────────────────────────────────────┘ │
│                           │                                         │
│  ┌────────────────────────▼───────────────────────────────────────┐ │
│  │                    PCIe Interface                               │ │
│  └────────────────────────┬───────────────────────────────────────┘ │
│                           │                                         │
│  ┌─────────────┐  ┌───────▼────────┐  ┌─────────────┐            │
│  │ SMA1 (IN)   │  │ Linux Driver   │  │ SMA3 (OUT)  │            │
│  │ • 10MHz     │  │   ptp_ocp      │  │ • 10MHz     │            │
│  │ • PPS       │  │                │  │ • PPS       │            │
│  │ • IRIG-B    │  └────────────────┘  │ • GEN1-4    │            │
│  └─────────────┘                      └─────────────┘            │
│                                                                     │
│  ┌─────────────┐                      ┌─────────────┐            │
│  │ SMA2 (IN)   │                      │ SMA4 (OUT)  │            │
│  │ • 10MHz     │                      │ • 10MHz     │            │
│  │ • PPS       │                      │ • PPS       │            │
│  │ • TS1-4     │                      │ • GEN1-4    │            │
│  └─────────────┘                      └─────────────┘            │
└─────────────────────────────────────────────────────────────────────┘
```

## 🔄 Поток данных

```
┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│   Hardware   │────▶│    Driver    │────▶│    Sysfs     │
│  (TimeCard)  │     │  (ptp_ocp)   │     │ Interface    │
└──────────────┘     └──────────────┘     └──────┬───────┘
                                                  │
                           ┌──────────────────────┼──────────────────────┐
                           │                      │                      │
                     ┌─────▼──────┐        ┌──────▼───────┐      ┌──────▼──────┐
                     │   PTP4L    │        │  Monitoring  │      │   User      │
                     │  PHC2SYS   │        │     API      │      │  Scripts    │
                     └────────────┘        └──────┬───────┘      └─────────────┘
                                                  │
                     ┌────────────────────────────┼────────────────────────────┐
                     │                            │                            │
               ┌─────▼──────┐            ┌────────▼────────┐          ┌────────▼────────┐
               │  Dashboard │            │   Prometheus    │          │     Grafana     │
               │   (Web)    │            │    Exporter     │          │   Dashboards    │
               └────────────┘            └─────────────────┘          └─────────────────┘
```

## 🧩 Компоненты системы

### 1️⃣ Аппаратный уровень
```
┌─────────────────────────────────────┐
│         Источники времени           │
├─────────────────────────────────────┤
│ • GNSS (GPS/GLONASS/Galileo/BeiDou)│
│ • Atomic Clock (Rubidium/Cesium)   │
│ • IRIG-B временной код              │
│ • External PPS/10MHz                │
└─────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────┐
│      Обработка сигналов (FPGA)      │
├─────────────────────────────────────┤
│ • Timestamp engine (8ns resolution) │
│ • PLL для синхронизации частоты     │
│ • Frequency synthesis (10MHz)       │
│ • GPIO и LED контроллеры            │
└─────────────────────────────────────┘
```

### 2️⃣ Программный уровень
```
┌─────────────────────────────────────┐
│        Linux Kernel Driver          │
├─────────────────────────────────────┤
│ • PCI device management             │
│ • PTP clock registration            │
│ • Sysfs interface creation          │
│ • Interrupt handling                │
└─────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────┐
│         User Space Tools            │
├─────────────────────────────────────┤
│ • ptp4l - PTP daemon                │
│ • phc2sys - clock sync              │
│ • ts2phc - timestamp sync           │
│ • pmc - PTP management client       │
└─────────────────────────────────────┘
```

### 3️⃣ Мониторинг и управление
```
┌─────────────────────────────────────┐
│      Monitoring Stack               │
├─────────────────────────────────────┤
│ • TimeCard Extended API (Port 8080) │
│ • Prometheus Exporter (Port 9090)   │
│ • Grafana Dashboards (Port 3000)    │
│ • AlertManager (Port 9093)          │
└─────────────────────────────────────┘
```

## 📊 Интерфейсы взаимодействия

### Sysfs структура
```
/sys/class/timecard/ocp0/
├── clock_source          # Источник синхронизации
├── gnss_sync            # Статус GNSS
├── sma[1-4]_in/out      # Конфигурация SMA
├── *_cable_delay        # Калибровка задержек
├── temperature_*        # Температурные сенсоры
├── voltage_*            # Напряжения питания
└── ptp -> /dev/ptp4     # Ссылка на PTP устройство
```

### API endpoints
```
http://localhost:8080/
├── /api/health          # Проверка состояния
├── /api/metrics/        # Все метрики
│   ├── extended         # Расширенные метрики
│   ├── ptp/advanced     # PTP метрики
│   ├── thermal          # Температуры
│   ├── power            # Питание
│   ├── gnss             # GNSS данные
│   └── oscillator       # Осциллятор
├── /api/devices         # Список устройств
└── /api/alerts          # Активные алерты
```

## 🔗 Связи между компонентами

```
                    ┌─────────────┐
                    │   Browser   │
                    │ (Dashboard) │
                    └──────┬──────┘
                           │ WebSocket/HTTP
                    ┌──────▼──────┐
                    │  Flask API  │
                    │  (Port 8080)│
                    └──────┬──────┘
                           │ Read sysfs
                    ┌──────▼──────┐
                    │    Sysfs    │
                    │ /sys/class/ │
                    └──────┬──────┘
                           │ Kernel interface
                    ┌──────▼──────┐
                    │  ptp_ocp    │
                    │   driver    │
                    └──────┬──────┘
                           │ PCIe
                    ┌──────▼──────┐
                    │  TimeCard   │
                    │  Hardware   │
                    └─────────────┘
```

## 🚦 Состояния системы

### LED индикаторы
| LED | Цвет | Значение |
|-----|------|----------|
| PWR | 🟢 | Питание включено |
| SYNC | 🟢 | PTP синхронизирован |
| GNSS | 🟢 | GNSS fix получен |
| ALARM | 🔴 | Ошибка/предупреждение |

### Состояния синхронизации
```
┌─────────┐     ┌─────────┐     ┌─────────┐     ┌─────────┐
│  INIT   │────▶│ ACQUIRE │────▶│  LOCK   │────▶│  HOLD   │
└─────────┘     └─────────┘     └─────────┘     └─────────┘
     │                                                  │
     └──────────────────────────────────────────────────┘
                        (При потере сигнала)
```

---

*Эта диаграмма показывает полную архитектуру TimeCard PTP OCP системы*