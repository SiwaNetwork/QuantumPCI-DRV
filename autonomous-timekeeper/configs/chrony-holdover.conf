# Конфигурация Chrony для автономного хранения времени
# Сценарий: NTP сервер с fallback на Quantum-PCI при потере сети
# /etc/chrony/chrony.conf
# Версия: 4.5+
# Дата: 2025-10-06

# =============================================================================
# ИСТОЧНИКИ ВРЕМЕНИ (в порядке приоритета)
# =============================================================================

# 1. NTP серверы из интернета как ОСНОВНЫЕ источники времени
# Используются для синхронизации с UTC
server 0.pool.ntp.org iburst minpoll 4 maxpoll 10 prefer
server 1.pool.ntp.org iburst minpoll 4 maxpoll 10 prefer
server 2.pool.ntp.org iburst minpoll 4 maxpoll 10 prefer
server 3.pool.ntp.org iburst minpoll 4 maxpoll 10 prefer

# 2. Дополнительные высокоточные NTP серверы
server time.google.com iburst minpoll 4 maxpoll 10
server time.cloudflare.com iburst minpoll 4 maxpoll 10
server ntp.ubuntu.com iburst minpoll 4 maxpoll 10

# 3. Quantum-PCI как резервный источник (низший приоритет)
# Высокоточный генератор используется при недоступности NTP
# Используем /dev/ptp1 - правильное устройство Quantum-PCI
refclock PHC /dev/ptp1 poll 3 dpoll -2 offset 0 stratum 2 precision 1e-9

# =============================================================================
# НАСТРОЙКИ АВТОНОМНОГО ХРАНЕНИЯ (HOLDOVER)
# =============================================================================

# Автономное хранение времени реализуется через:
# 1. Настройку driftfile для сохранения дрейфа часов
# 2. Увеличенные интервалы опроса источников
# 3. Настройку maxdrift для контроля точности

# Файл для сохранения информации о дрейфе часов
driftfile /var/lib/chrony/drift

# =============================================================================
# НАСТРОЙКИ СИНХРОНИЗАЦИИ
# =============================================================================

# Быстрая начальная синхронизация
makestep 1.0 3

# Синхронизация RTC с системными часами
rtcsync

# Плавная коррекция времени (важно для стабильности)
smoothtime 400 0.01 leaponly

# =============================================================================
# НАСТРОЙКИ ТОЧНОСТИ И СТАБИЛЬНОСТИ
# =============================================================================

# Максимальное отклонение частоты (ppm)
maxupdateskew 100.0

# Соотношение коррекции времени
corrtimeratio 3

# Максимальный дрейф частоты (ppm) - увеличен для автономной работы
maxdrift 1000

# Максимальная дистанция до источника (секунды)
maxdistance 1.0

# Минимальное количество источников для синхронизации
# Требуем минимум 2 источника для надежности
minsources 2

# Настройки для точной синхронизации с NTP
# Строгие ограничения для точной подстройки
maxchange 100 1 2

# =============================================================================
# НАСТРОЙКИ NTP СЕРВЕРА
# =============================================================================

# Локальный NTP сервер для сети
local stratum 2

# Разрешение доступа для локальной сети
allow 192.168.0.0/16
allow 10.0.0.0/8
allow 172.16.0.0/12

# Порт NTP
port 123

# =============================================================================
# ЛОГИРОВАНИЕ И МОНИТОРИНГ
# =============================================================================

# Директория для логов
logdir /var/log/chrony

# Типы логируемой информации
log tracking measurements statistics

# Логирование изменений больше указанного значения (секунды)
logchange 0.001

# =============================================================================
# БЕЗОПАСНОСТЬ
# =============================================================================

# Адреса для команд управления
bindcmdaddress 127.0.0.1
bindcmdaddress ::1

# Разрешение команд
cmdallow 127.0.0.1
cmdallow ::1

# =============================================================================
# ОБРАБОТКА LEAP SECONDS
# =============================================================================

# Режим обработки leap seconds
leapsecmode slew
maxslewrate 83333.333

# =============================================================================
# НАСТРОЙКИ ДЛЯ ВЫСОКОЙ НАГРУЗКИ
# =============================================================================

# Ограничение скорости запросов
ratelimit interval 1 burst 16 leak 2

# Ограничения для клиентов
clientloglimit 1048576

# =============================================================================
# КОММЕНТАРИИ ПО СЦЕНАРИЮ
# =============================================================================

# СЦЕНАРИЙ РАБОТЫ:
# 1. По умолчанию: NTP серверы как ОСНОВНЫЕ источники времени (UTC синхронизация)
# 2. Quantum-PCI подстраивается под NTP и используется как высокоточный генератор
# 3. При потере сети: переключение на Quantum-PCI с сохранением точности
# 4. При восстановлении сети: подстройка Quantum-PCI под NTP серверы
#
# ПРЕИМУЩЕСТВА:
# - Синхронизация с UTC через надежные NTP серверы
# - Высокоточный генератор Quantum-PCI для стабильности
# - Автономная работа при потере сети
# - NTP сервер stratum 2 для локальной сети
#
# МОНИТОРИНГ:
# - chronyc tracking - статус синхронизации
# - chronyc sources -v - источники времени
# - chronyc sourcestats - статистика источников
# - /var/log/chrony/ - логи системы
