# üöÄ –ü–ª–∞–Ω –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –¥—Ä–∞–π–≤–µ—Ä–∞ ptp_ocp.c

## üìä –ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è

### –û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ —É–∑–∫–∏–µ –º–µ—Å—Ç–∞

#### 1. –ß–∞—Å—Ç—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —á—Ç–µ–Ω–∏—è/–∑–∞–ø–∏—Å–∏ —Ä–µ–≥–∏—Å—Ç—Ä–æ–≤
**–ü—Ä–æ–±–ª–µ–º–∞**: –í –∫–æ–¥–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ 203+ –æ–ø–µ—Ä–∞—Ü–∏–π `ioread32`/`iowrite32`
- –ö–∞–∂–¥–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è —Ç—Ä–µ–±—É–µ—Ç –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ PCIe —à–∏–Ω–µ
- –ù–µ—Ç –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
- –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ —á—Ç–µ–Ω–∏—è –æ–¥–Ω–∏—Ö –∏ —Ç–µ—Ö –∂–µ —Ä–µ–≥–∏—Å—Ç—Ä–æ–≤

**–ü—Ä–∏–º–µ—Ä—ã –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö –º–µ—Å—Ç:**
```c
// –í ptp_ocp_gettime() - –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —á—Ç–µ–Ω–∏—è
ctrl = ioread32(&bp->reg->ctrl);
time_ns = ioread32(&bp->reg->time_ns);
time_sec = ioread32(&bp->reg->time_sec);

// –í ptp_ocp_adjtime() - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ/–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ select
select = ioread32(&bp->reg->select);
iowrite32(OCP_SELECT_CLK_REG, &bp->reg->select);
// ... –æ–ø–µ—Ä–∞—Ü–∏–∏ ...
iowrite32(select >> 16, &bp->reg->select);
```

#### 2. –ù–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–π
**–ü—Ä–æ–±–ª–µ–º–∞**: MSI-X –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –±–µ–∑ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
- –ö–∞–∂–¥–æ–µ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ –≤—ã–∑—ã–≤–∞–µ—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —á—Ç–µ–Ω–∏—è —Ä–µ–≥–∏—Å—Ç—Ä–æ–≤
- –ù–µ—Ç –±–∞—Ç—á–∏–Ω–≥–∞ –æ–ø–µ—Ä–∞—Ü–∏–π
- –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ø—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–π

#### 3. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
**–ü—Ä–æ–±–ª–µ–º–∞**: –ù–µ—Ç –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
- –°—Ç–∞—Ç—É—Å —Ä–µ–≥–∏—Å—Ç—Ä—ã —á–∏—Ç–∞—é—Ç—Å—è –ø–æ–≤—Ç–æ—Ä–Ω–æ
- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –Ω–µ –∫—ç—à–∏—Ä—É—é—Ç—Å—è
- –í—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏ —á–∏—Ç–∞—é—Ç—Å—è –±–µ–∑ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

## üéØ –ü–ª–∞–Ω –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

### –§–∞–∑–∞ 1: –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–≥–∏—Å—Ç—Ä–æ–≤ (1-2 –Ω–µ–¥–µ–ª–∏)

#### 1.1 –°–æ–∑–¥–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
```c
// –ù–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–µ–≥–∏—Å—Ç—Ä–æ–≤
struct ptp_ocp_register_cache {
    // –ö—ç—à —Å—Ç–∞—Ç—É—Å–Ω—ã—Ö —Ä–µ–≥–∏—Å—Ç—Ä–æ–≤
    u32 status_cache;
    u32 ctrl_cache;
    u32 select_cache;
    u64 last_status_update;
    u64 last_ctrl_update;
    u64 last_select_update;
    
    // –ö—ç—à –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
    u32 time_ns_cache;
    u32 time_sec_cache;
    u64 last_time_update;
    
    // –§–ª–∞–≥–∏ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ –∫—ç—à–∞
    bool status_valid;
    bool ctrl_valid;
    bool select_valid;
    bool time_valid;
    
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
    u32 cache_timeout_ns;  // –¢–∞–π–º–∞—É—Ç –∫—ç—à–∞ –≤ –Ω–∞–Ω–æ—Å–µ–∫—É–Ω–¥–∞—Ö
    bool cache_enabled;
};

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∫—ç—à–µ–º
static inline u32 ptp_ocp_read_cached_status(struct ptp_ocp *bp);
static inline u32 ptp_ocp_read_cached_ctrl(struct ptp_ocp *bp);
static inline void ptp_ocp_invalidate_cache(struct ptp_ocp *bp, u32 reg_mask);
static inline void ptp_ocp_update_cache(struct ptp_ocp *bp, u32 reg_mask);
```

#### 1.2 –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ —á—Ç–µ–Ω–∏—è/–∑–∞–ø–∏—Å–∏
```c
// –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —á—Ç–µ–Ω–∏–µ —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º
static inline u32 ptp_ocp_read_reg_cached(struct ptp_ocp *bp, 
                                         void __iomem *reg, 
                                         u32 *cache, 
                                         u64 *last_update,
                                         bool *valid)
{
    u64 now = ktime_get_ns();
    
    if (*valid && (now - *last_update) < bp->cache.cache_timeout_ns) {
        return *cache;
    }
    
    *cache = ioread32(reg);
    *last_update = now;
    *valid = true;
    
    return *cache;
}

// –ë–∞—Ç—á–µ–≤–æ–µ —á—Ç–µ–Ω–∏–µ —Ä–µ–≥–∏—Å—Ç—Ä–æ–≤
static void ptp_ocp_read_regs_batch(struct ptp_ocp *bp, 
                                   struct ptp_ocp_reg_batch *batch)
{
    // –ß–∏—Ç–∞–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–µ–≥–∏—Å—Ç—Ä–æ–≤ –∑–∞ –æ–¥–∏–Ω —Ä–∞–∑
    // –ú–∏–Ω–∏–º–∏–∑–∏—Ä—É–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±—Ä–∞—â–µ–Ω–∏–π –∫ PCIe
}
```

### –§–∞–∑–∞ 2: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–π (2-3 –Ω–µ–¥–µ–ª–∏)

#### 2.1 –ü—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–π
```c
// –ù–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è–º–∏
struct ptp_ocp_interrupt_manager {
    // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–π
    u32 critical_irqs;      // –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ (PPS, GNSS)
    u32 normal_irqs;        // –û–±—ã—á–Ω—ã–µ (—Å–∏–≥–Ω–∞–ª—ã, –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏)
    u32 low_priority_irqs;  // –ù–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (—Å—Ç–∞—Ç—É—Å)
    
    // –ë–∞—Ç—á–∏–Ω–≥ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–π
    struct workqueue_struct *irq_workqueue;
    struct delayed_work batch_work;
    struct list_head pending_irqs;
    
    // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    u64 irq_count[32];
    u64 irq_latency_ns[32];
    u64 max_latency_ns;
};
```

#### 2.2 –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–π
```c
// –ë—ã—Å—Ç—Ä—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–π
static irqreturn_t ptp_ocp_critical_irq(int irq, void *priv)
{
    struct ptp_ocp_ext_src *ext = priv;
    struct ptp_ocp *bp = ext->bp;
    
    // –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ - —Ç–æ–ª—å–∫–æ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
    // –û—Å—Ç–∞–ª—å–Ω–æ–µ –æ—Ç–∫–ª–∞–¥—ã–≤–∞–µ–º –≤ workqueue
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à —Å—Ç–∞—Ç—É—Å–∞
    ptp_ocp_invalidate_cache(bp, OCP_CACHE_STATUS);
    
    // –ü–ª–∞–Ω–∏—Ä—É–µ–º –¥–µ—Ç–∞–ª—å–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É
    queue_work(bp->irq_manager->irq_workqueue, &ext->irq_work);
    
    return IRQ_HANDLED;
}

// –ë–∞—Ç—á–µ–≤–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–π
static void ptp_ocp_batch_irq_work(struct work_struct *work)
{
    struct ptp_ocp *bp = container_of(work, struct ptp_ocp, batch_work);
    struct list_head *pos, *next;
    
    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤—Å–µ –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–µ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è –∑–∞ –æ–¥–∏–Ω —Ä–∞–∑
    list_for_each_safe(pos, next, &bp->irq_manager->pending_irqs) {
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è
    }
}
```

### –§–∞–∑–∞ 3: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è DMA (1-2 –Ω–µ–¥–µ–ª–∏)

#### 3.1 DMA –¥–ª—è –±–æ–ª—å—à–∏—Ö –±–ª–æ–∫–æ–≤ –¥–∞–Ω–Ω—ã—Ö
```c
// –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è DMA –æ–ø–µ—Ä–∞—Ü–∏–π
struct ptp_ocp_dma_manager {
    struct dma_chan *dma_chan;
    dma_addr_t dma_addr;
    void *dma_buffer;
    size_t dma_size;
    
    // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ DMA
    u64 dma_transfers;
    u64 dma_bytes;
    u64 dma_errors;
};

// DMA –æ–ø–µ—Ä–∞—Ü–∏–∏ –¥–ª—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
static int ptp_ocp_dma_write_config(struct ptp_ocp *bp, 
                                   const void *data, 
                                   size_t size)
{
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º DMA –¥–ª—è –∑–∞–ø–∏—Å–∏ –±–æ–ª—å—à–∏—Ö –±–ª–æ–∫–æ–≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
    // –í–º–µ—Å—Ç–æ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö iowrite32
}
```

### –§–∞–∑–∞ 4: –ü—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ (1 –Ω–µ–¥–µ–ª—è)

#### 4.1 –°–∏—Å—Ç–µ–º–∞ –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏—è
```c
// –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏—è
struct ptp_ocp_performance_stats {
    // –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π
    u64 gettime_latency_ns;
    u64 settime_latency_ns;
    u64 adjtime_latency_ns;
    u64 irq_latency_ns;
    
    // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–ø–µ—Ä–∞—Ü–∏–π
    u64 gettime_count;
    u64 settime_count;
    u64 adjtime_count;
    u64 irq_count;
    
    // –ö—ç—à —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    u64 cache_hits;
    u64 cache_misses;
    u64 cache_hit_ratio;  // –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö
};

// –§—É–Ω–∫—Ü–∏–∏ –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏—è
static void ptp_ocp_start_timer(struct ptp_ocp_timer *timer);
static u64 ptp_ocp_stop_timer(struct ptp_ocp_timer *timer);
static void ptp_ocp_update_stats(struct ptp_ocp *bp, 
                                enum ptp_ocp_operation op, 
                                u64 latency_ns);
```

#### 4.2 Sysfs –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
```bash
# –ù–æ–≤—ã–µ –∞—Ç—Ä–∏–±—É—Ç—ã –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
/sys/class/timecard/ocp0/performance_stats
/sys/class/timecard/ocp0/cache_stats
/sys/class/timecard/ocp0/irq_stats
/sys/class/timecard/ocp0/dma_stats
/sys/class/timecard/ocp0/latency_stats
```

## üõ†Ô∏è –î–µ—Ç–∞–ª—å–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

### –®–∞–≥ 1: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä—É ptp_ocp

```c
// –î–æ–±–∞–≤–ª—è–µ–º –≤ struct ptp_ocp
struct ptp_ocp {
    // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—è ...
    
    // –ù–æ–≤—ã–µ –ø–æ–ª—è –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
    struct ptp_ocp_register_cache cache;
    struct ptp_ocp_interrupt_manager *irq_manager;
    struct ptp_ocp_dma_manager *dma_manager;
    struct ptp_ocp_performance_stats perf_stats;
    
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
    u32 cache_timeout_ns;
    bool performance_mode;
    u32 irq_batch_size;
};
```

### –®–∞–≥ 2: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π

#### ptp_ocp_gettime() - –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è
```c
static int ptp_ocp_gettime_optimized(struct ptp_clock_info *ptp_info, 
                                    struct timespec64 *ts)
{
    struct ptp_ocp *bp = container_of(ptp_info, struct ptp_ocp, ptp_info);
    u32 ctrl, time_ns, time_sec;
    u64 start_time, end_time;
    
    // –ü—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ
    start_time = ktime_get_ns();
    
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –≥–¥–µ –≤–æ–∑–º–æ–∂–Ω–æ
    ctrl = ptp_ocp_read_reg_cached(bp, &bp->reg->ctrl, 
                                  &bp->cache.ctrl_cache,
                                  &bp->cache.last_ctrl_update,
                                  &bp->cache.ctrl_valid);
    
    // –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å –≤—Ä–µ–º—è
    if (!(ctrl & OCP_CTRL_READ_TIME_DONE)) {
        ctrl = OCP_CTRL_READ_TIME_REQ | OCP_CTRL_ENABLE;
        iowrite32(ctrl, &bp->reg->ctrl);
        
        // –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å —Ç–∞–π–º–∞—É—Ç–æ–º
        for (int i = 0; i < 100; i++) {
            ctrl = ptp_ocp_read_reg_cached(bp, &bp->reg->ctrl, 
                                          &bp->cache.ctrl_cache,
                                          &bp->cache.last_ctrl_update,
                                          &bp->cache.ctrl_valid);
            if (ctrl & OCP_CTRL_READ_TIME_DONE)
                break;
            udelay(10);
        }
    }
    
    // –ß–∏—Ç–∞–µ–º –≤—Ä–µ–º—è –∏–∑ –∫—ç—à–∞ –∏–ª–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞
    time_ns = ptp_ocp_read_reg_cached(bp, &bp->reg->time_ns,
                                     &bp->cache.time_ns_cache,
                                     &bp->cache.last_time_update,
                                     &bp->cache.time_valid);
    
    time_sec = ptp_ocp_read_reg_cached(bp, &bp->reg->time_sec,
                                      &bp->cache.time_sec_cache,
                                      &bp->cache.last_time_update,
                                      &bp->cache.time_valid);
    
    ts->tv_sec = time_sec;
    ts->tv_nsec = time_ns;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    end_time = ktime_get_ns();
    ptp_ocp_update_stats(bp, PTP_OCP_OP_GETTIME, end_time - start_time);
    
    return 0;
}
```

### –®–∞–≥ 3: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è

```c
// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫—ç—à–∞
static int ptp_ocp_init_cache(struct ptp_ocp *bp)
{
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫—ç—à–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    bp->cache.cache_timeout_ns = 1000000;  // 1 –º—Å
    bp->cache.cache_enabled = true;
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–ª–∞–≥–æ–≤
    bp->cache.status_valid = false;
    bp->cache.ctrl_valid = false;
    bp->cache.select_valid = false;
    bp->cache.time_valid = false;
    
    return 0;
}

// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —á–µ—Ä–µ–∑ sysfs
static ssize_t cache_timeout_store(struct device *dev,
                                  struct device_attribute *attr,
                                  const char *buf, size_t count)
{
    struct ptp_ocp *bp = dev_get_drvdata(dev);
    u32 timeout_ns;
    
    if (kstrtou32(buf, 10, &timeout_ns))
        return -EINVAL;
    
    bp->cache.cache_timeout_ns = timeout_ns;
    
    return count;
}
```

## üìà –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- **–°–Ω–∏–∂–µ–Ω–∏–µ –∑–∞–¥–µ—Ä–∂–∫–∏ gettime()**: —Å ~10 –º–∫—Å –¥–æ ~1 –º–∫—Å
- **–°–Ω–∏–∂–µ–Ω–∏–µ –∑–∞–¥–µ—Ä–∂–∫–∏ settime()**: —Å ~15 –º–∫—Å –¥–æ ~2 –º–∫—Å
- **–°–Ω–∏–∂–µ–Ω–∏–µ –∑–∞–¥–µ—Ä–∂–∫–∏ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–π**: —Å ~5 –º–∫—Å –¥–æ ~0.5 –º–∫—Å
- **–£–≤–µ–ª–∏—á–µ–Ω–∏–µ –ø—Ä–æ–ø—É—Å–∫–Ω–æ–π —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏**: –≤ 5-10 —Ä–∞–∑

### –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
- **–°–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ PCIe**: –Ω–∞ 60-80%
- **–°–Ω–∏–∂–µ–Ω–∏–µ CPU usage**: –Ω–∞ 30-50%
- **–£–ª—É—á—à–µ–Ω–∏–µ –æ—Ç–∑—ã–≤—á–∏–≤–æ—Å—Ç–∏**: –≤ 3-5 —Ä–∞–∑

### –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å
- **–°–Ω–∏–∂–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –æ—à–∏–±–æ–∫**: –Ω–∞ 90%
- **–£–ª—É—á—à–µ–Ω–∏–µ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏**: –±–æ–ª–µ–µ –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ
- **–õ—É—á—à–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞**: –¥–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

## üß™ –ü–ª–∞–Ω —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
1. **–¢–µ—Å—Ç —Ç–æ—á–Ω–æ—Å—Ç–∏ –≤—Ä–µ–º–µ–Ω–∏**: —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å —ç—Ç–∞–ª–æ–Ω–Ω—ã–º–∏ —á–∞—Å–∞–º–∏
2. **–¢–µ—Å—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏**: –¥–ª–∏—Ç–µ–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ –±–µ–∑ —Å–±–æ–µ–≤
3. **–¢–µ—Å—Ç –Ω–∞–≥—Ä—É–∑–∫–∏**: —Ä–∞–±–æ—Ç–∞ –ø–æ–¥ –≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–æ–π
4. **–¢–µ—Å—Ç –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–π**: –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–π

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
1. **–ë–µ–Ω—á–º–∞—Ä–∫ gettime()**: –∏–∑–º–µ—Ä–µ–Ω–∏–µ –∑–∞–¥–µ—Ä–∂–∫–∏
2. **–ë–µ–Ω—á–º–∞—Ä–∫ settime()**: –∏–∑–º–µ—Ä–µ–Ω–∏–µ –∑–∞–¥–µ—Ä–∂–∫–∏
3. **–¢–µ—Å—Ç –ø—Ä–æ–ø—É—Å–∫–Ω–æ–π —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏**: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–ø–µ—Ä–∞—Ü–∏–π –≤ —Å–µ–∫—É–Ω–¥—É
4. **–¢–µ—Å—Ç –ø–∞–º—è—Ç–∏**: –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —É—Ç–µ—á–µ–∫ –ø–∞–º—è—Ç–∏

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
1. **–¢–µ—Å—Ç —Å PTP4L**: —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å linuxptp
2. **–¢–µ—Å—Ç —Å Chrony**: –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å NTP
3. **–¢–µ—Å—Ç —Å GNSS**: —Ä–∞–±–æ—Ç–∞ —Å GPS/–ì–õ–û–ù–ê–°–°
4. **–¢–µ—Å—Ç —Å —Å–µ—Ç–µ–≤—ã–º–∏ –∫–∞—Ä—Ç–∞–º–∏**: –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Intel I210/I225/I226

## üìÖ –í—Ä–µ–º–µ–Ω–Ω–æ–π –ø–ª–∞–Ω

### –ù–µ–¥–µ–ª—è 1-2: –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–≥–∏—Å—Ç—Ä–æ–≤
- [ ] –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
- [ ] –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Ñ—É–Ω–∫—Ü–∏–π –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
- [ ] –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è ptp_ocp_gettime()
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è

### –ù–µ–¥–µ–ª—è 3-5: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–π
- [ ] –°–æ–∑–¥–∞–Ω–∏–µ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–π
- [ ] –ü—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–π
- [ ] –ë–∞—Ç—á–µ–≤–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–π

### –ù–µ–¥–µ–ª—è 6-7: DMA –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è
- [ ] –°–æ–∑–¥–∞–Ω–∏–µ DMA –º–µ–Ω–µ–¥–∂–µ—Ä–∞
- [ ] –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø–∏—Å–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ DMA

### –ù–µ–¥–µ–ª—è 8: –ü—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
- [ ] –°–∏—Å—Ç–µ–º–∞ –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏—è
- [ ] Sysfs –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
- [ ] –§–∏–Ω–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- [ ] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

## üîß –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

### –ü—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ
- **perf**: –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- **ftrace**: –¥–ª—è —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∏ —Ñ—É–Ω–∫—Ü–∏–π
- **eBPF**: –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
- **valgrind**: –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –ø–∞–º—è—Ç–∏

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- **kunit**: –¥–ª—è unit —Ç–µ—Å—Ç–æ–≤
- **kselftest**: –¥–ª—è —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤
- **stress-ng**: –¥–ª—è –Ω–∞–≥—Ä—É–∑–æ—á–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- **cyclictest**: –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–¥–µ—Ä–∂–µ–∫

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
- **sysfs**: –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
- **debugfs**: –¥–ª—è –æ—Ç–ª–∞–¥–æ—á–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
- **procfs**: –¥–ª—è —Å–∏—Å—Ç–µ–º–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
- **perf events**: –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞

---

*–î–æ–∫—É–º–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω: $(date)*  
*–í–µ—Ä—Å–∏—è: 1.0*  
*–ê–≤—Ç–æ—Ä: AI Assistant*
