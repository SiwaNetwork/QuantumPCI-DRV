# BNO055 I2C Driver

Драйвер для работы с 9-DOF IMU датчиком BNO055 через I2C интерфейс.

## Описание

BNO055 - это интегрированный датчик 9-DOF (9 степеней свободы), который включает в себя:
- 3-осевой акселерометр
- 3-осевой гироскоп  
- 3-осевой магнетометр
- Встроенный алгоритм сенсорного слияния (Sensor Fusion)

Драйвер реализован на bash и использует стандартные утилиты i2c-tools для взаимодействия с датчиком.

## Возможности

✅ **Ориентация** - Углы Эйлера (Heading, Roll, Pitch)  
✅ **Кватернионы** - W, X, Y, Z компоненты  
✅ **Линейное ускорение** - Ускорение без гравитации  
✅ **Вектор гравитации** - Направление силы тяжести  
✅ **Акселерометр** - Сырые данные ускорения  
✅ **Гироскоп** - Угловая скорость  
✅ **Магнетометр** - Магнитное поле  
✅ **Температура** - Температура датчика  
✅ **Калибровка** - Статус калибровки всех сенсоров  
✅ **Непрерывный мониторинг** - Режим реального времени  

## Требования

- Linux система с поддержкой I2C
- Установленные i2c-tools: `sudo apt-get install i2c-tools`
- Права доступа к I2C шине (обычно требует sudo)
- Подключенный датчик BNO055 к I2C шине

## Установка

1. Скопируйте файлы в нужную директорию
2. Сделайте скрипты исполняемыми:
   ```bash
   chmod +x bno055_driver.sh
   chmod +x test_bno055.sh
   chmod +x demo.sh
   ```

## Использование

### Основной драйвер (bno055_driver.sh)

```bash
# Показать справку
./bno055_driver.sh help

# Инициализация датчика
./bno055_driver.sh init

# Статус калибровки
./bno055_driver.sh calib

# Углы Эйлера
./bno055_driver.sh euler

# Кватернионы
./bno055_driver.sh quat

# Линейное ускорение
./bno055_driver.sh linear

# Вектор гравитации
./bno055_driver.sh gravity

# Температура
./bno055_driver.sh temp

# Акселерометр
./bno055_driver.sh accel

# Гироскоп
./bno055_driver.sh gyro

# Магнетометр
./bno055_driver.sh mag

# Все сенсоры
./bno055_driver.sh sensors

# Все данные
./bno055_driver.sh all

# Непрерывный мониторинг (каждые 5 секунд)
./bno055_driver.sh monitor

# Непрерывный мониторинг с кастомным интервалом
./bno055_driver.sh monitor 10
```

### Тестовый скрипт (test_bno055.sh)

```bash
# Запуск полного теста
./test_bno055.sh
```

### Демонстрационный скрипт (demo.sh)

```bash
# Запуск демонстрации
./demo.sh
```

### Настройка мультиплексора I2C

```bash
# Настройка мультиплексора через Makefile
make setup-mux

# Или вручную
sudo i2cset -y 1 0x70 0x0F
```

## Конфигурация

По умолчанию драйвер настроен на:
- I2C шина: 1
- Адрес датчика: 0x28 (может быть 0x28 или 0x29)

Для изменения этих параметров отредактируйте переменные в начале файла `bno055_driver.sh`:

```bash
I2CBUS=1      # Номер I2C шины
DEVADDR=0x28  # Адрес датчика
```

## Подключение датчика

### Схема подключения BNO055:

```
VCC (3.3V) ---- BNO055 VIN
GND ---------- BNO055 GND
SDA ---------- I2C SDA (GPIO2 на Raspberry Pi)
SCL ---------- I2C SCL (GPIO3 на Raspberry Pi)
```

### Мультиплексор I2C

Если используется мультиплексор I2C (например, PCA9548A по адресу 0x70), драйвер автоматически настраивает его для активации всех шин:

```bash
# Автоматическая настройка мультиплексора
i2cset -y 1 0x70 0x0F
```

### Проверка подключения:

```bash
# Сканирование I2C устройств
i2cdetect -y 1

# Должен показать устройство по адресу 0x28 или 0x29
```

## Режимы работы BNO055

| Режим | Код | Описание |
|-------|-----|----------|
| CONFIG | 0x00 | Конфигурация |
| ACCONLY | 0x01 | Только акселерометр |
| MAGONLY | 0x02 | Только магнетометр |
| GYROONLY | 0x03 | Только гироскоп |
| ACCMAG | 0x04 | Акселерометр + магнетометр |
| ACCGYRO | 0x05 | Акселерометр + гироскоп |
| MAGGYRO | 0x06 | Магнетометр + гироскоп |
| AMG | 0x07 | Акселерометр + магнетометр + гироскоп |
| IMU | 0x08 | IMU (без магнетометра) |
| COMPASS | 0x09 | Компас |
| M4G | 0x0A | M4G (без гироскопа) |
| NDOF_FMC_OFF | 0x0B | NDOF без fast magnetometer calibration |
| NDOF | 0x0C | NDOF (9-DOF fusion) |

## Регистры датчика

### Регистры режимов работы
| Регистр | Адрес | Описание |
|---------|-------|----------|
| OPR_MODE | 0x3D | Режим работы |
| PWR_MODE | 0x3E | Режим питания |
| SYS_TRIGGER | 0x3F | Системный триггер |

### Регистры данных
| Регистр | Адрес | Описание |
|---------|-------|----------|
| EUL_DATA_H | 0x1A | Углы Эйлера (Heading) |
| EUL_DATA_R | 0x1B | Углы Эйлера (Roll) |
| EUL_DATA_P | 0x1C | Углы Эйлера (Pitch) |
| QUA_DATA_W | 0x20 | Кватернионы (W) |
| QUA_DATA_X | 0x22 | Кватернионы (X) |
| QUA_DATA_Y | 0x24 | Кватернионы (Y) |
| QUA_DATA_Z | 0x26 | Кватернионы (Z) |
| LIA_DATA_X | 0x28 | Линейное ускорение (X) |
| LIA_DATA_Y | 0x2A | Линейное ускорение (Y) |
| LIA_DATA_Z | 0x2C | Линейное ускорение (Z) |
| GRV_DATA_X | 0x2E | Вектор гравитации (X) |
| GRV_DATA_Y | 0x30 | Вектор гравитации (Y) |
| GRV_DATA_Z | 0x32 | Вектор гравитации (Z) |

## Калибровка

BNO055 имеет встроенную калибровку для всех сенсоров. Статус калибровки можно проверить командой:

```bash
./bno055_driver.sh calib
```

### Процесс калибровки:

1. **Акселерометр**: Держите датчик в 6 различных ориентациях
2. **Гироскоп**: Держите датчик неподвижно
3. **Магнетометр**: Вращайте датчик в 3D пространстве
4. **Система**: Автоматически после калибровки всех сенсоров

## Алгоритм работы

1. **Инициализация**: Сброс датчика и установка режима NDOF
2. **Калибровка**: Проверка статуса калибровки всех сенсоров
3. **Чтение данных**: Получение данных ориентации и движения
4. **Обработка**: Применение масштабирования согласно даташиту
5. **Вывод результатов**: Отображение в удобном формате

## Устранение неполадок

### Ошибка "Датчик BNO055 не найден"
- Проверьте физическое подключение
- Убедитесь, что I2C шина активирована
- Проверьте адрес датчика (0x28 или 0x29)

### Ошибка "I2C шина недоступна"
- Установите i2c-tools: `sudo apt-get install i2c-tools`
- Загрузите модуль i2c-dev: `sudo modprobe i2c-dev`
- Добавьте пользователя в группу i2c: `sudo usermod -a -G i2c $USER`

### Датчик не найден при использовании мультиплексора
- Убедитесь, что мультиплексор настроен: `sudo i2cset -y 1 0x70 0x0F`
- Проверьте адрес мультиплексора (обычно 0x70)
- Убедитесь, что датчик подключен к правильной шине мультиплексора

### Неточные показания
- Убедитесь, что датчик откалиброван
- Проверьте, что датчик не подвергается вибрациям
- Убедитесь, что рядом нет магнитных помех

### Проблемы с калибровкой
- Выполните полную калибровку всех сенсоров
- Убедитесь, что датчик неподвижен во время калибровки гироскопа
- Вращайте датчик медленно при калибровке магнетометра

## Примеры вывода

```
=== Показания датчика BNO055 ===
Статус калибровки:
  Система: 3/3
  Гироскоп: 3/3
  Магнетометр: 3/3
  Акселерометр: 3/3

Чтение углов Эйлера...
Углы Эйлера (градусы):
  Heading (Yaw) = 45.250°
  Roll = 0.125°
  Pitch = -1.875°

Чтение кватернионов...
Кватернионы:
  W = 0.9238795325
  X = 0.0000000000
  Y = 0.0000000000
  Z = 0.3826834324

Чтение линейного ускорения...
Линейное ускорение (м/с²):
  X = 0.120 м/с²
  Y = -0.050 м/с²
  Z = 0.000 м/с²
================================
```

## Применения

- **Робототехника**: Ориентация и навигация
- **Дроны**: Стабилизация и управление
- **Игровые контроллеры**: Отслеживание движений
- **Навигация**: Компас и ориентация
- **Мониторинг**: Анализ движений и вибраций

## Лицензия

Данный код предоставляется "как есть" без каких-либо гарантий.

## Автор

Разработано для проекта QuantumPCI-DRV 