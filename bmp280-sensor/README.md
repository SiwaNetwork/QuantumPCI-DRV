# BMP280 I2C Driver

Драйвер для работы с датчиком температуры и давления BMP280 через I2C интерфейс.

## Описание

Данный пакет содержит скрипты для работы с датчиком BMP280, который измеряет температуру и атмосферное давление. Драйвер реализован на bash и использует стандартные утилиты i2c-tools для взаимодействия с датчиком.

## Требования

- Linux система с поддержкой I2C
- Установленные i2c-tools: `sudo apt-get install i2c-tools`
- Права доступа к I2C шине (обычно требует sudo)
- Подключенный датчик BMP280 к I2C шине

## Установка

1. Скопируйте файлы в нужную директорию
2. Сделайте скрипты исполняемыми:
   ```bash
   chmod +x bmp280_driver.sh
   chmod +x test_bmp280.sh
   ```

## Использование

### Основной драйвер (bmp280_driver.sh)

```bash
# Показать справку
./bmp280_driver.sh help

# Инициализация датчика
./bmp280_driver.sh init

# Чтение температуры
./bmp280_driver.sh temp

# Чтение давления
./bmp280_driver.sh press

# Чтение всех параметров
./bmp280_driver.sh all

# Непрерывный мониторинг (каждые 5 секунд)
./bmp280_driver.sh monitor

# Непрерывный мониторинг с кастомным интервалом
./bmp280_driver.sh monitor 10
```

### Тестовый скрипт (test_bmp280.sh)

```bash
# Запуск полного теста
./test_bmp280.sh
```

### Настройка мультиплексора I2C

```bash
# Настройка мультиплексора через Makefile
make setup-mux

# Или вручную
sudo i2cset -y 1 0x70 0x0F
```

## Конфигурация

По умолчанию драйвер настроен на:
- I2C шина: 1
- Адрес датчика: 0x76

Для изменения этих параметров отредактируйте переменные в начале файла `bmp280_driver.sh`:

```bash
I2CBUS=1      # Номер I2C шины
DEVADDR=0x76  # Адрес датчика
```

## Подключение датчика

### Схема подключения BMP280:

```
VCC (3.3V) ---- BMP280 VCC
GND ---------- BMP280 GND
SDA ---------- I2C SDA (GPIO2 на Raspberry Pi)
SCL ---------- I2C SCL (GPIO3 на Raspberry Pi)
```

### Мультиплексор I2C

Если используется мультиплексор I2C (например, PCA9548A по адресу 0x70), драйвер автоматически настраивает его для активации всех шин:

```bash
# Автоматическая настройка мультиплексора
i2cset -y 1 0x70 0x0F
```

### Проверка подключения:

```bash
# Сканирование I2C устройств
i2cdetect -y 1

# Должен показать устройство по адресу 0x76
```

## Алгоритм работы

1. **Инициализация**: Настройка регистров CONFIG и CTRL_MEAS
2. **Чтение калибровочных данных**: Загрузка коэффициентов из памяти датчика
3. **Чтение сырых данных**: Получение ADC значений температуры и давления
4. **Компенсация**: Применение калибровочных коэффициентов согласно даташиту BMP280
5. **Вывод результатов**: Отображение температуры в °C и давления в Па

## Регистры датчика

| Регистр | Адрес | Описание |
|---------|-------|----------|
| CONFIG | 0xF5 | Конфигурация |
| CTRL_MEAS | 0xF4 | Управление измерениями |
| TEMP_MSB | 0xFA | Старший байт температуры |
| TEMP_LSB | 0xFB | Младший байт температуры |
| TEMP_XLSB | 0xFC | Младший бит температуры |
| PRESS_MSB | 0xF7 | Старший байт давления |
| PRESS_LSB | 0xF8 | Младший байт давления |
| PRESS_XLSB | 0xF9 | Младший бит давления |

## Калибровочные коэффициенты

Датчик содержит 12 калибровочных коэффициентов:
- DIG_T1, DIG_T2, DIG_T3 - для температуры
- DIG_P1-DIG_P9 - для давления

Эти коэффициенты уникальны для каждого датчика и хранятся в его памяти.

## Устранение неполадок

### Ошибка "Датчик BMP280 не найден"
- Проверьте физическое подключение
- Убедитесь, что I2C шина активирована
- Проверьте адрес датчика (может быть 0x76 или 0x77)

### Ошибка "I2C шина недоступна"
- Установите i2c-tools: `sudo apt-get install i2c-tools`
- Загрузите модуль i2c-dev: `sudo modprobe i2c-dev`
- Добавьте пользователя в группу i2c: `sudo usermod -a -G i2c $USER`

### Датчик не найден при использовании мультиплексора
- Убедитесь, что мультиплексор настроен: `sudo i2cset -y 1 0x70 0x0F`
- Проверьте адрес мультиплексора (обычно 0x70)
- Убедитесь, что датчик подключен к правильной шине мультиплексора

### Неточные показания
- Убедитесь, что датчик не подвергается нагреву от других компонентов
- Проверьте стабильность питания 3.3V
- Дайте датчику время на стабилизацию после включения

## Примеры вывода

```
=== Показания датчика BMP280 ===
Чтение температуры...
Температура = 23.45 °C
Чтение давления...
Давление = 101325.123 Па
================================
```

## Лицензия

Данный код предоставляется "как есть" без каких-либо гарантий.

## Автор

Разработано для проекта QuantumPCI-DRV 